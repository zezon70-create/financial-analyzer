<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© â€” Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ (Dashboard)</title>

  <!-- CDN libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --glass: rgba(255,255,255,0.04);
      --accent1:#0d6efd; --accent2:#6610f2; --muted:#9aa6b2; --text:#e6eef6;
      --success:#198754; --danger:#dc3545; --warning:#ffc107;
    }
    html,body{height:100%;margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{background:linear-gradient(120deg,#071427 0%, #071a2a 40%, #0b1226 100%);color:var(--text);-webkit-font-smoothing:antialiased;}
    body[data-theme="light"]{ --bg:#f6f8fb; --card:#fff; --glass: rgba(255,255,255,0.65); --text:#0b1220; --muted:#6c757d; background:linear-gradient(120deg,#f8fbff 0%,#f6f8fb 60%);}
    .container-main{max-width:1200px;margin:18px auto;padding:16px;}
    .site-header{position:sticky;top:8px;padding:10px 14px;border-radius:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;backdrop-filter: blur(8px);background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;border-radius:8px;box-shadow:0 8px 30px rgba(6,10,15,0.25)}
    .brand .title{font-weight:800;font-size:1.05rem}
    .controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .btn {background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:.45rem .6rem;border-radius:8px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 8px 30px rgba(102,16,242,0.09)}
    .btn.ghost{background:transparent}
    .select, .input {padding:.35rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(2,6,23,0.3);margin-bottom:14px}
    body[data-theme="light"] .panel{box-shadow: 0 8px 20px rgba(2,6,23,0.03);}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column: span 4;}
    .col-8{grid-column: span 8;}
    .col-6{grid-column: span 6;}
    .kpi{padding:12px;border-radius:10px;background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02));display:flex;flex-direction:column;gap:6px}
    .kpi .label{color:var(--muted);font-size:.85rem}
    .kpi .value{font-weight:800;font-size:1.15rem}
    h3.section-title{margin:0 0 8px 0;font-size:1rem;color:var(--text)}

    table{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden}
    th,td{padding:8px 10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:.95rem}
    thead th{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:700}
    .muted{color:var(--muted);font-size:.9rem}
    .small{font-size:.85rem}
    .comment{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-top:8px}

    /* responsive */
    @media (max-width:900px){
      .grid{grid-template-columns:repeat(6,1fr)}
      .col-4{grid-column:span 6}
      .col-8{grid-column:span 6}
      .col-6{grid-column:span 6}
    }
  </style>
</head>
<body data-theme="dark">
  <div class="container-main" id="root">
    <header class="site-header" role="banner" aria-label="Header">
      <div class="brand" title="Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ">
        <img src="assets/logo.png" alt="logo" id="brandLogo" onerror="this.style.display='none'">
        <div>
          <div class="title" id="brandTitle">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
          <div class="muted small" id="brandDesc">Ù„ÙˆØ­Ø© Ù‚ÙŠØ§Ø¯ÙŠØ© - Dashboard</div>
        </div>
      </div>

      <div class="controls" role="navigation" aria-label="Controls">
        <button class="btn ghost" id="homeBtn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"><i class="bi bi-house"></i></button>
        <button class="btn ghost" id="reportBtn" title="Ø§Ù„ØªÙ‚Ø±ÙŠØ±"><i class="bi bi-file-earmark-text"></i></button>
        <button class="btn ghost" id="advancedBtn" title="Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©"><i class="bi bi-graph-up"></i></button>

        <select id="sourceSelect" class="select" title="Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
          <!-- populated dynamically -->
        </select>

        <select id="currencySelect" class="select" title="Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶">
          <option value="EGP">EGP</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>

        <select id="langSelect" class="select" title="Ø§Ù„Ù„ØºØ©">
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="en">English</option>
        </select>

        <button class="btn" id="themeToggle" title="ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ">ğŸŒ™</button>
        <button class="btn primary" id="exportPdfBtn" title="ØªØµØ¯ÙŠØ± PDF"><i class="bi bi-file-earmark-pdf"></i>&nbsp;<span id="exportLabel">ØªØµØ¯ÙŠØ± PDF</span></button>
      </div>
    </header>

    <!-- content -->
    <main style="margin-top:14px">
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <h2 id="pageTitle" style="margin:0">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© â€” Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
            <div class="muted small" id="subtitle">Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Reports Ø£Ùˆ Advanced Ù…Ù† Ø£Ø¬Ù„ ØªÙØµÙŠÙ„ Ø£ÙƒØ«Ø±</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted small" for="yearFilter" id="lblYear">Ø§Ù„Ø³Ù†Ø©</label>
            <select id="yearFilter" class="select"></select>
          </div>
        </div>
      </section>

      <section class="grid" aria-live="polite">
        <div class="col-4 panel kpi">
          <div class="label small-muted" id="kpiAccountsLabel">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
          <div class="value" id="kpiAccounts">0</div>
          <div class="muted small" id="kpiAccountsComment">Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª</div>
        </div>

        <div class="col-4 panel kpi">
          <div class="label small-muted" id="kpiAssetsLabel">Ø§Ù„Ø£ØµÙˆÙ„ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</div>
          <div class="value" id="kpiAssets">0</div>
          <div class="muted small" id="kpiAssetsComment">â€”</div>
        </div>

        <div class="col-4 panel kpi">
          <div class="label small-muted" id="kpiLiabLabel">Ø§Ù„Ø®ØµÙˆÙ… (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</div>
          <div class="value" id="kpiLiab">0</div>
          <div class="muted small" id="kpiLiabComment">â€”</div>
        </div>

        <div class="col-6 panel">
          <h3 class="section-title" id="profitTitle">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ â€” Ù…Ø¤Ø´Ø±Ø§Øª</h3>
          <table id="profitTable">
            <thead><tr><th id="colItem">Ø§Ù„Ø¨Ù†Ø¯</th><th id="colValue">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th id="colComment">ØªØ¹Ù„ÙŠÙ‚</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="comment" id="profitComment"></div>
        </div>

        <div class="col-6 panel">
          <h3 class="section-title" id="bsTitle">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© â€” Ù…Ø¤Ø´Ø±Ø§Øª</h3>
          <table id="bsTable">
            <thead><tr><th id="colItem2">Ø§Ù„Ø¨Ù†Ø¯</th><th id="colValue2">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th id="colComment2">ØªØ¹Ù„ÙŠÙ‚</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="comment" id="bsComment"></div>
        </div>

        <div class="col-8 panel">
          <h3 class="section-title" id="chartTitle">Ø±Ø³Ù… Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù…</h3>
          <canvas id="trendChart" height="160"></canvas>
          <div class="muted small" id="trendComment">â€”</div>
        </div>

        <div class="col-4 panel">
          <h3 class="section-title" id="forecastTitle">ØªÙ†Ø¨Ø¤ Ø¨Ø³ÙŠØ· Ù„Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
          <div id="forecastValue" class="value">â€”</div>
          <div class="muted small" id="forecastComment">â€”</div>
        </div>

      </section>
    </main>
  </div>

<script>
/* =========================
   Dashboard logic
   - Reads data from localStorage keys (trialData, inputData, uploadedData, reportData, advancedData)
   - Provides language translations + theme toggle + export pdf
   - Computes KPIs, chart, comments, simple forecast
   ========================= */

const LO_KEYS = [
  {k:'trialData', label_ar:'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (trialData)', label_en:'Data (trialData)'},
  {k:'inputData', label_ar:'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (inputData)', label_en:'Input (inputData)'},
  {k:'uploadedData', label_ar:'Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ÙÙˆØ¹Ø© (uploadedData)', label_en:'Uploaded (uploadedData)'},
  {k:'reportData', label_ar:'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± (reportData)', label_en:'Report (reportData)'},
  {k:'advancedData', label_ar:'Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© (advancedData)', label_en:'Advanced (advancedData)'}
];

const translations = {
  ar: {
    pageTitle:'Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© â€” Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹',
    subtitle:'Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ù„Ù„ØºØ©ØŒ Ø§Ù„Ø¹Ù…Ù„Ø©ØŒ Ø£Ùˆ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©.',
    exportPdf:'ØªØµØ¯ÙŠØ± PDF',
    lblYear:'Ø§Ù„Ø³Ù†Ø©',
    kpiAccounts:'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª',
    kpiAssets:'Ø§Ù„Ø£ØµÙˆÙ„ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)',
    kpiLiab:'Ø§Ù„Ø®ØµÙˆÙ… (ØªÙ‚Ø±ÙŠØ¨ÙŠ)',
    profitTitle:'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ â€” Ù…Ø¤Ø´Ø±Ø§Øª',
    bsTitle:'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© â€” Ù…Ø¤Ø´Ø±Ø§Øª',
    chartTitle:'Ø±Ø³Ù… Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù…',
    forecastTitle:'ØªÙ†Ø¨Ø¤ Ø¨Ø³ÙŠØ· Ù„Ù„Ø£Ø±Ø¨Ø§Ø­',
    colItem:'Ø§Ù„Ø¨Ù†Ø¯', colValue:'Ø§Ù„Ù‚ÙŠÙ…Ø©', colComment:'ØªØ¹Ù„ÙŠÙ‚',
    noData:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯.',
    selectSource:'Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...',
    sourceLabel:'Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
    home:'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
    report:'Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
    advanced:'Ø§Ù„Ù…ØªÙ‚Ø¯Ù…'
  },
  en: {
    pageTitle:'Dashboard â€” Quick Summary',
    subtitle:'Pick data source, language, currency, or navigate to Reports/Advanced.',
    exportPdf:'Export PDF',
    lblYear:'Year',
    kpiAccounts:'Accounts',
    kpiAssets:'Assets (approx)',
    kpiLiab:'Liabilities (approx)',
    profitTitle:'Income Statement â€” Metrics',
    bsTitle:'Balance Sheet â€” Metrics',
    chartTitle:'Overview Trend Chart',
    forecastTitle:'Simple Profit Forecast',
    colItem:'Item', colValue:'Value', colComment:'Comment',
    noData:'No data in selected source.',
    selectSource:'Select data source...',
    sourceLabel:'Data source',
    home:'Home',
    report:'Report',
    advanced:'Advanced'
  }
};

/* helpers */
const $ = id => document.getElementById(id);
function showToast(msg){ console.info('toast:', msg); /* simple console notice; extend if UI toasts needed */ }

let state = {
  lang: localStorage.getItem('dashboard_lang') || 'ar',
  theme: localStorage.getItem('dashboard_theme') || 'dark',
  currency: localStorage.getItem('dashboard_currency') || 'EGP',
  sourceKey: localStorage.getItem('dashboard_source') || null,
  yearFilter: null,
  rawData: [], // normalized rows {Account, Type, Code, Debit, Credit, Year?}
};

function initControls(){
  // populate sourceSelect from LO_KEYS (include only keys present or all)
  const sel = $('sourceSelect');
  sel.innerHTML = '';
  const optAll = document.createElement('option');
  optAll.value = '';
  optAll.textContent = t('selectSource');
  sel.appendChild(optAll);
  LO_KEYS.forEach(s=>{
    const o = document.createElement('option');
    o.value = s.k;
    o.textContent = (state.lang==='ar' ? s.label_ar : s.label_en);
    sel.appendChild(o);
  });
  if(localStorage.getItem('dashboard_source')) sel.value = localStorage.getItem('dashboard_source');
  $('currencySelect').value = state.currency;
  $('langSelect').value = state.lang;
  applyTheme();
  applyTranslations();
  attachEvents();
  populateYearFilter();
  refreshAll();
}

function t(key){
  return translations[state.lang] && translations[state.lang][key] ? translations[state.lang][key] : key;
}

function applyTranslations(){
  // texts
  $('pageTitle').textContent = t('pageTitle');
  $('subtitle').textContent = t('subtitle');
  $('exportLabel').textContent = t('exportPdf');
  $('lblYear').textContent = t('lblYear');
  $('kpiAccountsLabel').textContent = t('kpiAccounts');
  $('kpiAssetsLabel').textContent = t('kpiAssets');
  $('kpiLiabLabel').textContent = t('kpiLiab');
  $('profitTitle').textContent = t('profitTitle');
  $('bsTitle').textContent = t('bsTitle');
  $('chartTitle').textContent = t('chartTitle');
  $('forecastTitle').textContent = t('forecastTitle');

  // table headers
  document.querySelectorAll('#profitTable thead th').forEach((th,i)=> {
    if(i===0) th.textContent = t('colItem');
    if(i===1) th.textContent = t('colValue');
    if(i===2) th.textContent = t('colComment');
  });
  document.querySelectorAll('#bsTable thead th').forEach((th,i)=> {
    if(i===0) th.textContent = t('colItem');
    if(i===1) th.textContent = t('colValue');
    if(i===2) th.textContent = t('colComment');
  });

  // nav buttons (tooltips)
  $('homeBtn').title = t('home');
  $('reportBtn').title = t('report');
  $('advancedBtn').title = t('advanced');

  // source select label if exists
}

function applyTheme(){
  if(state.theme === 'light') document.body.setAttribute('data-theme','light');
  else document.body.setAttribute('data-theme','dark');
  $('themeToggle').textContent = (state.theme==='light'? 'ğŸŒ' : 'ğŸŒ™');
  localStorage.setItem('dashboard_theme', state.theme);
}

function attachEvents(){
  $('langSelect').addEventListener('change', (e)=> {
    state.lang = e.target.value; localStorage.setItem('dashboard_lang', state.lang); applyTranslations(); initControls(); /* re-init to refresh source labels */ 
  });
  $('currencySelect').addEventListener('change', (e)=> { state.currency = e.target.value; localStorage.setItem('dashboard_currency', state.currency); refreshAll(); });
  $('themeToggle').addEventListener('click', ()=> { state.theme = state.theme==='light' ? 'dark' : 'light'; applyTheme(); });
  $('exportPdfBtn').addEventListener('click', exportPdf);
  $('homeBtn').addEventListener('click', ()=> window.location.href = 'index.html');
  $('reportBtn').addEventListener('click', ()=> window.location.href = 'report.html');
  $('advancedBtn').addEventListener('click', ()=> window.location.href = 'advanced.html');

  $('sourceSelect').addEventListener('change', (e)=> {
    state.sourceKey = e.target.value || null; localStorage.setItem('dashboard_source', state.sourceKey || '');
    loadSourceData();
  });

  $('yearFilter').addEventListener('change', ()=> {
    state.yearFilter = $('yearFilter').value || null; refreshAll();
  });
}

/* Load & normalize source data from localStorage */
function loadSourceData(){
  const key = state.sourceKey;
  if(!key){ state.rawData = []; renderNoData(); return; }
  try{
    const raw = JSON.parse(localStorage.getItem(key) || 'null');
    if(!raw){ state.rawData = []; renderNoData(); return; }
    // raw can be array of rows with variety of keys; normalize to objects with Account, Type, Code, Debit, Credit, Year (optional)
    const normalized = [];
    if(Array.isArray(raw)){
      raw.forEach(r=>{
        if(typeof r === 'object'){
          const Account = r.Account || r.account || r['Account Name'] || r['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'] || r['Ø§Ù„Ø­Ø³Ø§Ø¨'] || r.name || r.Name || '';
          const Type = r.Type || r.type || r['Type'] || r['Ù†ÙˆØ¹'] || '';
          const Code = r.Code || r.code || r['Code'] || r['ÙƒÙˆØ¯'] || '';
          const Debit = toNum(r.Debit || r.debit || r['Dr'] || r['Ù…Ø¯ÙŠÙ†'] || 0);
          const Credit = toNum(r.Credit || r.credit || r['Cr'] || r['Ø¯Ø§Ø¦Ù†'] || 0);
          const Year = r.Year || r.year || null;
          normalized.push({Account,Type,Code,Debit,Credit,Year});
        }
      });
    } else if(typeof raw === 'object'){
      // maybe it's an object with named sections (e.g., reportData)
      // Try to extract arrays inside
      const keys = Object.keys(raw);
      keys.forEach(k=>{
        if(Array.isArray(raw[k])) raw[k].forEach(r=>{
          const Account = r.Account || r.account || r.name || '';
          const Type = r.Type || r.type || '';
          const Code = r.Code || r.code || '';
          const Debit = toNum(r.Debit || r.debit || r.dr || 0);
          const Credit = toNum(r.Credit || r.credit || r.cr || 0);
          const Year = r.Year || r.year || null;
          normalized.push({Account,Type,Code,Debit,Credit,Year});
        });
      });
    }
    state.rawData = normalized;
    refreshAll();
  }catch(e){
    console.error('Failed to parse source', e);
    state.rawData = [];
    renderNoData();
  }
}

/* Rendering when no data */
function renderNoData(){
  $('kpiAccounts').textContent = '0';
  $('kpiAssets').textContent = formatCurrency(0);
  $('kpiLiab').textContent = formatCurrency(0);
  clearTable('profitTable');
  clearTable('bsTable');
  $('profitComment').textContent = t('noData');
  $('bsComment').textContent = t('noData');
  renderChart([],[],[]);
  $('forecastValue').textContent = 'â€”'; $('forecastComment').textContent = t('noData');
}

/* Utility */
function toNum(v){ const n = Number(String(v||'').toString().replace(/[, ]+/g,'')); return isNaN(n) ? 0 : n; }
function formatCurrency(v){
  // simple formatting based on selected currency
  const c = state.currency || 'EGP';
  const nf = Number(Math.round((v + Number.EPSILON) * 100)/100).toLocaleString();
  if(c === 'EGP') return `${nf} Ø¬.Ù…`;
  if(c === 'USD') return `$ ${nf}`;
  if(c === 'EUR') return `â‚¬ ${nf}`;
  return `${nf} ${c}`;
}
function clearTable(id){
  const tb = document.querySelector(`#${id} tbody`);
  if(tb) tb.innerHTML = '';
}

/* KPI calculations & rendering */
function computeKPIs(){
  const rows = state.rawData || [];
  const accounts = rows.length;
  // Sum debit and credit
  let totalDebit = 0, totalCredit = 0;
  rows.forEach(r => { totalDebit += toNum(r.Debit); totalCredit += toNum(r.Credit); });

  // heuristics to estimate assets/liabilities: based on Type or Account text
  let assets = 0, liabilities = 0, revenue = 0, expense = 0;
  rows.forEach(r => {
    const net = toNum(r.Debit) - toNum(r.Credit);
    const s = (r.Type || r.Account || '').toString().toLowerCase();
    if(/asset|Ø£ØµÙ„|Ù†Ù‚Ø¯|bank|cash|current asset|fixed asset|Ø£ØµÙˆÙ„/.test(s)) assets += net;
    else if(/liab|Ø®ØµÙˆÙ…|payable|Ø¯Ø§Ø¦Ù†|Ù‚Ø±Ø¶|loan/.test(s)) liabilities += -net;
    else if(/revenue|sale|Ø¥ÙŠØ±Ø§Ø¯|Ù…Ø¨ÙŠØ¹Ø§Øª|income/.test(s)) revenue += -net;
    else if(/expense|Ù…ØµØ±ÙˆÙ|ØªÙƒÙ„ÙØ©|expense|cogs/.test(s)) expense += net;
    else {
      // decide by simple keywords in Account
      const a = (r.Account||'').toLowerCase();
      if(/Ø§Ù„Ù†Ù‚Ø¯|bank|cash/.test(a)) assets += net;
      else if(/Ù…ÙˆØ±Ø¯|payable|Ø¯Ø§Ø¦Ù†/.test(a)) liabilities += -net;
      else if(/Ù…Ø¨ÙŠØ¹Ø§Øª|revenue|sale/.test(a)) revenue += -net;
      else if(/Ù…ØµØ±ÙˆÙ|expense|ØªÙƒÙ„ÙØ©/.test(a)) expense += net;
      else assets += net * 0.0; // keep ambiguous out
    }
  });

  return { accounts, assets, liabilities, totalDebit, totalCredit, revenue, expense };
}

/* Render KPI widgets & tables */
function renderKPIs(kpis){
  $('kpiAccounts').textContent = kpis.accounts;
  $('kpiAssets').textContent = formatCurrency(Math.abs(kpis.assets));
  $('kpiLiab').textContent = formatCurrency(Math.abs(kpis.liabilities));

  // Profit table: Revenue, Expense, Net Profit, Margins
  const profitRows = [
    {item: state.lang==='ar' ? 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' : 'Revenue', value: kpis.revenue},
    {item: state.lang==='ar' ? 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' : 'Expenses', value: kpis.expense},
    {item: state.lang==='ar' ? 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­' : 'Net Profit', value: kpis.revenue - kpis.expense},
    {item: state.lang==='ar' ? 'Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­' : 'Profit Margin', value: (kpis.revenue ? (kpis.revenue - kpis.expense)/Math.abs(kpis.revenue) : 0)}
  ];
  populateTable('profitTable', profitRows, (row)=>{
    // comment generator for profit metrics
    if(row.item.includes('Ù‡Ø§Ù…Ø´') || row.item.includes('Profit Margin')){
      const m = row.value;
      if(m >= 0.2) return state.lang==='ar' ? 'Ù‡Ø§Ù…Ø´ Ù‚ÙˆÙŠ â€” Ø£Ø¯Ø§Ø¡ Ø±Ø¨Ø­ÙŠØ© Ø¬ÙŠØ¯.' : 'Healthy margin â€” good profitability.';
      if(m >= 0.1) return state.lang==='ar' ? 'Ù‡Ø§Ù…Ø´ Ù…Ù‚Ø¨ÙˆÙ„ â€” ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡.' : 'Acceptable margin â€” room for improvement.';
      if(m > 0) return state.lang==='ar' ? 'Ù‡Ø§Ù…Ø´ Ø¶Ø¹ÙŠÙ â€” Ø±Ø§Ø¬Ø¹ ØªÙƒØ§Ù„ÙŠÙÙƒ.' : 'Low margin â€” review costs.';
      return state.lang==='ar' ? 'Ø®Ø³Ø§Ø±Ø© â€” ØªØ­Ù‚Ù‚ ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª.' : 'Loss â€” investigate revenue/expenses.';
    } else {
      // currency value comment
      if(row.value === 0) return state.lang==='ar' ? 'Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª.' : 'No data.';
      return state.lang==='ar' ? `Ø§Ù„Ù…Ø¨Ù„Øº: ${formatCurrency(row.value)}` : `Amount: ${formatCurrency(row.value)}`;
    }
  });

  // Balance sheet indicators: Assets, Liabilities, Equity (assets - liabilities), Liquidity ratio approximate
  const equity = kpis.assets - kpis.liabilities;
  const liquidity = (kpis.assets !== 0) ? (kpis.assets / (kpis.liabilities || 1)) : 0;
  const bsRows = [
    {item: state.lang==='ar' ? 'Ø§Ù„Ø£ØµÙˆÙ„ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)' : 'Assets (approx)', value: kpis.assets},
    {item: state.lang==='ar' ? 'Ø§Ù„Ø®ØµÙˆÙ… (ØªÙ‚Ø±ÙŠØ¨ÙŠ)' : 'Liabilities (approx)', value: kpis.liabilities},
    {item: state.lang==='ar' ? 'Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (ØªÙ‚Ø±ÙŠØ¨ÙŠ)' : 'Equity (approx)', value: equity},
    {item: state.lang==='ar' ? 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø© (ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)' : 'Liquidity ratio (approx)', value: liquidity}
  ];
  populateTable('bsTable', bsRows, (row)=>{
    if(row.item.includes('Ù†Ø³Ø¨Ø©') || row.item.includes('Liquidity')){
      const r = row.value;
      if(r >= 1.5) return state.lang==='ar' ? 'Ø³ÙŠÙˆÙ„Ø© Ø¬ÙŠØ¯Ø©.' : 'Good liquidity.';
      if(r >= 1) return state.lang==='ar' ? 'Ø³ÙŠÙˆÙ„Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©.' : 'Acceptable liquidity.';
      return state.lang==='ar' ? 'Ø³ÙŠÙˆÙ„Ø© Ø¶Ø¹ÙŠÙØ© â€” Ù‚Ø¯ ØªÙˆØ§Ø¬Ù‡ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù‚ØµÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù„.' : 'Low liquidity â€” short-term obligations risk.';
    } else {
      return state.lang==='ar' ? `Ø§Ù„Ù…Ø¨Ù„Øº: ${formatCurrency(row.value)}` : `Amount: ${formatCurrency(row.value)}`;
    }
  });

  // comments under tables (overview)
  $('profitComment').textContent = generateProfitOverview(kpis);
  $('bsComment').textContent = generateBalanceOverview(kpis);
}

/* populate a table with rows [{item,value}] and commentFn(row) -> comment string */
function populateTable(tblId, rows, commentFn){
  const tb = document.querySelector(`#${tblId} tbody`); tb.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = r.item;
    const td2 = document.createElement('td'); td2.textContent = (typeof r.value === 'number' && !r.item.includes('Ù†Ø³Ø¨Ø©') && !r.item.includes('Liquidity')) ? formatCurrency(r.value) : (typeof r.value === 'number' ? ( (Math.abs(r.value) < 1 && Math.abs(r.value) !== 0) ? `${(r.value*100).toFixed(2)}%` : `${(r.value).toLocaleString()}` ) : r.value);
    const td3 = document.createElement('td'); td3.textContent = commentFn(r) || '';
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tb.appendChild(tr);
  });
}

/* comments generation */
function generateProfitOverview(kpis){
  const net = kpis.revenue - kpis.expense;
  if(kpis.revenue === 0 && kpis.expense === 0) return t('noData');
  if(net > 0){
    if(net / Math.max(1, kpis.revenue) >= 0.2) return state.lang==='ar' ? 'Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¨Ø­ÙŠ Ù‚ÙˆÙŠ ÙˆÙŠÙˆÙØ± Ù‡Ø§Ù…Ø´ Ø£Ù…Ø§Ù†.' : 'Profitability is strong, providing a good safety margin.';
    if(net / Math.max(1, kpis.revenue) >= 0.05) return state.lang==='ar' ? 'Ø±Ø¨Ø­ÙŠØ© Ù…Ø¹ØªØ¯Ù„Ø©Ø› ÙŠÙØ¶Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ¶Ø®Ù… ÙˆØ§Ù„ØªÙƒÙ„ÙØ©.' : 'Moderate profits; monitor costs and inflation.';
    return state.lang==='ar' ? 'Ø±Ø¨Ø­ÙŠØ© Ø¶Ø¹ÙŠÙØ©Ø› Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø£Ùˆ Ø§Ù„ØªÙƒÙ„ÙØ©.' : 'Weak profits; review pricing or costs.';
  } else {
    return state.lang==='ar' ? 'Ù‡Ù†Ø§Ùƒ Ø®Ø³Ø§Ø±Ø© ØµØ§ÙÙŠØ© â€” Ù…Ø·Ù„ÙˆØ¨ ØªØ­Ù„ÙŠÙ„ Ø¹Ø§Ø¬Ù„ Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª.' : 'Net loss â€” urgent review of expenses and revenue required.';
  }
}
function generateBalanceOverview(kpis){
  if(kpis.assets === 0 && kpis.liabilities === 0) return t('noData');
  const equity = kpis.assets - kpis.liabilities;
  if(equity > 0) return state.lang==='ar' ? `Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© (${formatCurrency(equity)}).` : `Positive equity (${formatCurrency(equity)}).`;
  return state.lang==='ar' ? `Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø³Ø§Ù„Ø¨Ø© (${formatCurrency(equity)}) â€” Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø®Ø§Ø·Ø± Ù…Ø§Ù„ÙŠØ©.` : `Negative equity (${formatCurrency(equity)}) â€” potential financial risk.`;
}

/* Chart rendering */
let trendChart = null;
function renderChart(labels, datasets, options = {}){
  const ctx = document.getElementById('trendChart').getContext('2d');
  if(trendChart) try{ trendChart.destroy(); }catch(e){}
  trendChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: Object.assign({
      responsive:true,
      plugins:{legend:{position:'bottom'}}
    }, options)
  });
}

/* Build trend data from raw rows by Year (if years exist) otherwise by index */
function buildTrend(){
  const rows = state.rawData || [];
  // group by Year if present
  const years = {};
  let hasYear = false;
  rows.forEach(r=>{
    if(r.Year){ hasYear = true; years[r.Year] = years[r.Year] || {revenue:0, expense:0, net:0}; years[r.Year].revenue += toNum(r.Credit) < 0 ? 0 : toNum(r.Credit); years[r.Year].expense += toNum(r.Debit) < 0 ? 0 : toNum(r.Debit); /* heuristic */ }
  });
  if(hasYear){
    const labels = Object.keys(years).sort();
    const dataNet = labels.map(y => (years[y].revenue - years[y].expense));
    const datasets = [
      {label: state.lang==='ar' ? 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­' : 'Net Profit', data: dataNet, tension:0.3, borderColor: getAccent(0), fill:false}
    ];
    return {labels, datasets};
  } else {
    // fallback: use cumulative net of rows grouped by chunk (e.g., 10 rows per point)
    const chunk = 10;
    const points = [];
    for(let i=0;i<rows.length;i+=chunk){
      const slice = rows.slice(i,i+chunk);
      const net = slice.reduce((s,r)=> s + (toNum(r.Credit) - toNum(r.Debit)),0);
      points.push(net);
    }
    const labels = points.map((_,i)=> `P${i+1}`);
    const datasets = [{label: state.lang==='ar' ? 'ØµØ§ÙÙŠ (Ù†Ù‚Ø§Ø·)' : 'Net (pts)', data: points, tension:0.3, borderColor:getAccent(0), fill:false}];
    return {labels,datasets};
  }
}

/* Forecast (simple linear regression on trend points) */
function computeForecast(){
  try{
    const tr = buildTrend();
    if(!tr.labels || tr.labels.length < 2) return null;
    const y = tr.datasets[0].data.map(v => Number(v));
    const x = y.map((_,i)=> i+1);
    const n = x.length;
    const sumX = x.reduce((a,b)=>a+b,0), sumY = y.reduce((a,b)=>a+b,0);
    const sumXY = x.reduce((s,xi,i)=> s + xi*y[i],0);
    const sumX2 = x.reduce((s,xi)=> s + xi*xi,0);
    const denom = (n*sumX2 - sumX*sumX) || 1;
    const slope = (n*sumXY - sumX*sumY)/denom;
    const intercept = (sumY - slope*sumX)/n;
    const nextX = n+1;
    const pred = intercept + slope * nextX;
    return {pred, slope, intercept};
  }catch(e){ return null; }
}

/* Utilities */
function getAccent(i){ const colors = ['#0d6efd','#6610f2','#198754','#dc3545','#ffc107']; return colors[i % colors.length]; }

/* Refresh everything */
function refreshAll(){
  // ensure source data loaded if selected
  if(state.sourceKey && (!state.rawData || state.rawData.length === 0)) loadSourceData();
  const kpis = computeKPIs();
  renderKPIs(kpis);

  // chart
  const tr = buildTrend();
  renderChart(tr.labels || [], tr.datasets || []);

  // forecast
  const fc = computeForecast();
  if(fc){
    $('forecastValue').textContent = formatCurrency(fc.pred);
    const sign = fc.slope > 0 ? (state.lang==='ar' ? 'Ø§ØªØ¬Ø§Ù‡ ØµØ§Ø¹Ø¯' : 'Uptrend') : (state.lang==='ar' ? 'Ø§ØªØ¬Ø§Ù‡ Ù‡Ø§Ø¨Ø·' : 'Downtrend');
    $('forecastComment').textContent = (state.lang==='ar' ? `Ø§Ù„ØªÙˆÙ‚Ø¹ Ø§Ù„ØªØ§Ù„ÙŠ: ${formatCurrency(fc.pred)} â€” ${sign}` : `Next forecast: ${formatCurrency(fc.pred)} â€” ${sign}`);
  } else {
    $('forecastValue').textContent = 'â€”';
    $('forecastComment').textContent = t('noData');
  }
}

/* Populate year filter (try to detect years from data) */
function populateYearFilter(){
  const yr = $('yearFilter'); yr.innerHTML = '';
  const years = new Set();
  const possibleKeys = ['Year','year','YYYY'];
  LO_KEYS.forEach(k=>{
    const raw = JSON.parse(localStorage.getItem(k.k) || 'null'); 
    if(Array.isArray(raw)) raw.forEach(r => { possibleKeys.forEach(pk=>{ if(r && r[pk]) years.add(String(r[pk])); }); });
  });
  const sorted = Array.from(years).sort();
  if(sorted.length){
    const oAll = document.createElement('option'); oAll.value=''; oAll.textContent = state.lang==='ar' ? 'Ø§Ù„ÙƒÙ„' : 'All';
    yr.appendChild(oAll);
    sorted.forEach(y => { const o = document.createElement('option'); o.value = y; o.textContent = y; yr.appendChild(o); });
  } else {
    // fallback years from current date range
    const o = document.createElement('option'); o.value=''; o.textContent = state.lang==='ar' ? 'Ø§Ù„ÙƒÙ„' : 'All';
    yr.appendChild(o);
  }
}

/* Export PDF */
function exportPdf(){
  // Save a temporary copy of root for printable PDF
  const el = document.querySelector('.container-main');
  const opt = {
    margin:0.3, filename: 'dashboard_report.pdf',
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,useCORS:true,allowTaint:true},
    jsPDF:{unit:'in',format:'a4',orientation:'portrait'}
  };
  // set temporary light bg for print readability if dark
  const oldTheme = document.body.getAttribute('data-theme');
  document.body.setAttribute('data-theme','light');
  html2pdf().set(opt).from(el).save().finally(()=> { document.body.setAttribute('data-theme', oldTheme || 'dark'); });
}

/* helper to format numbers nicely (already used) */

/* Initialization */
(function init(){
  // set defaults
  state.lang = localStorage.getItem('dashboard_lang') || state.lang;
  state.theme = localStorage.getItem('dashboard_theme') || state.theme;
  state.currency = localStorage.getItem('dashboard_currency') || state.currency;
  state.sourceKey = localStorage.getItem('dashboard_source') || state.sourceKey;

  initControls();
  // load source if preselected
  if(state.sourceKey) loadSourceData();
})();

</script>
</body>
</html>
