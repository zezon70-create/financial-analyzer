<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ â€” Financial Analyzer (Ultra Pro Max)</title>

  <!-- CDNs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --glass: rgba(255,255,255,0.08);
      --glass-border: rgba(255,255,255,0.12);
      --text:#071225;
      --muted:#6c757d;
      --accent1:#0d6efd;
      --accent2:#6610f2;
      --card:#ffffffcc;
      --bg0:#0f1724;
      --bg1:#071018;
    }
    [data-theme="dark"]{
      --text:#e6eef6;
      --muted:#9aa6b2;
      --card: rgba(8,12,18,0.6);
      --glass: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.03);
      background: linear-gradient(180deg,var(--bg1),#031016);
    }
    html,body{height:100%;margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{color:var(--text);background:linear-gradient(120deg,#0b3c5a,#031428);overflow-y:auto;transition:color .18s, background .3s;}
    /* animated gradient background */
    body::before{
      content:"";position:fixed;inset:-20%;z-index:-2;filter:blur(60px);opacity:0.9;
      background: conic-gradient(from 200deg at 50% 50%, rgba(13,110,253,0.25), rgba(102,16,242,0.22), rgba(3,201,169,0.16), rgba(255,184,0,0.12));
      animation: rotateBg 18s linear infinite;
    }
    @keyframes rotateBg{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

    .container{max-width:1180px;margin:24px auto;padding:18px;position:relative;z-index:2}
    .site-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));backdrop-filter:blur(8px);border:1px solid var(--glass-border);box-shadow:0 6px 24px rgba(2,6,23,0.15)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;border-radius:8px}
    .brand .title{font-weight:800;font-size:1.05rem}
    .controls{display:flex;align-items:center;gap:8px}

    .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600;display:inline-flex;gap:8px;align-items:center}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
    .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;box-shadow:0 8px 30px rgba(102,16,242,0.12)}
    .select, .input, .small{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
    .controls .select{min-width:120px}
    .controls .small{font-size:0.92rem;color:var(--muted)}

    .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--glass-border);box-shadow:0 10px 40px rgba(2,6,23,0.06);margin-top:14px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.025),rgba(255,255,255,0.01));text-align:center}
    .kpi .label{font-size:0.9rem;color:var(--muted)}
    .kpi .value{font-weight:800;font-size:1.2rem;margin-top:6px}

    /* responsive */
    @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:640px){ .grid{grid-template-columns:1fr} .controls{flex-wrap:wrap} }

    /* table */
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:0.95rem}
    th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:center}
    thead th{background:linear-gradient(90deg, rgba(13,110,253,0.06), rgba(102,16,242,0.04));font-weight:700}
    .muted{color:var(--muted);font-size:0.92rem}

    .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px}
    .commentary{font-size:0.95rem;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(13,110,253,0.03), rgba(102,16,242,0.02));border:1px solid rgba(13,110,253,0.04);color:var(--text)}

    .footer-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}

    /* small helpers */
    .badge{padding:6px 8px;border-radius:999px;font-weight:700;background:rgba(255,255,255,0.06)}

  </style>
</head>
<body data-theme="light">
  <div class="container" role="main">
    <!-- header -->
    <header class="site-header" role="banner" aria-label="header">
      <div class="brand" title="Financial Analyzer">
        <img src="assets/logo.png" alt="logo" id="brandLogo" onerror="this.style.display='none'">
        <div>
          <div class="title" id="brandText">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
          <div class="muted" id="brandDesc">ØªÙ‚Ø§Ø±ÙŠØ± Ø°ÙƒÙŠØ© ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª ÙÙˆØ±ÙŠØ©</div>
        </div>
      </div>

      <div class="controls" role="navigation" aria-label="controls">
        <button class="btn btn-ghost" id="homeBtn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">ğŸ  <span id="homeText">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>

        <!-- data source -->
        <select id="dataSource" class="select" title="Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" aria-label="Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
          <option value="input">Input (Ø§Ù„Ø§Ø¯Ø®Ø§Ù„)</option>
          <option value="upload">Upload (Ø§Ù„Ø±ÙØ¹)</option>
        </select>

        <!-- language -->
        <select id="langSelect" class="select" title="Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©" aria-label="Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©">
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="en">English</option>
        </select>

        <!-- currency -->
        <select id="currencySelect" class="select" title="Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©" aria-label="Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©">
          <option value="EGP">EGP</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>

        <button class="btn btn-ghost" id="themeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
        <button class="btn btn-primary" id="exportPdfBtn" title="ØªØµØ¯ÙŠØ± PDF">ğŸ“„ <span id="exportPdfText">ØªØµØ¯ÙŠØ± PDF</span></button>
        <button class="btn btn-ghost" id="goAdvanced" title="Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©">ğŸ“Š <span id="advText">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</span></button>
      </div>
    </header>

    <!-- KPIs -->
    <section class="card" aria-labelledby="kpiTitle">
      <div class="section-title">
        <h3 id="kpiTitle">Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© â€” KPIs</h3>
        <div class="muted" id="lastUpdated">â€”</div>
      </div>

      <div class="grid" id="kpiGrid" aria-live="polite">
        <!-- KPIs injected here -->
      </div>

      <div class="footer-actions">
        <div class="muted">Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</div>
        <div id="sourceLabel" class="badge">â€”</div>
      </div>
    </section>

    <!-- Main content: balance/income/cash -->
    <section class="card" aria-labelledby="reportTitle">
      <div class="section-title">
        <h3 id="reportTitle">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h3>
        <div class="muted" id="controlsRight">
          <label class="muted">Ø§Ù„Ø³Ù†Ø©: </label>
          <select id="yearSelect" class="select" aria-label="Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©">
            <option value="current">Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
            <option value="prev1">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠ</option>
            <option value="prev2">Ù‚Ø¨Ù„ Ø¹Ø§Ù…ÙŠÙ†</option>
          </select>
        </div>
      </div>

      <!-- Balance Sheet -->
      <div style="margin-bottom:14px">
        <div class="section-title">
          <h4 id="bsTitle">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</h4>
          <div class="muted" id="bsSummary">â€”</div>
        </div>

        <div class="table-wrap">
          <table id="bsTable" aria-label="Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©">
            <thead><tr><th id="colItem">Ø§Ù„Ø¨Ù†Ø¯</th><th id="colVal">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th id="colPrev">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</th><th id="colDiff">Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex;gap:12px;margin-top:10px;align-items:flex-start">
          <canvas id="bsChart" style="max-width:460px"></canvas>
          <div style="flex:1">
            <div id="bsComment" class="commentary">â€”</div>
          </div>
        </div>
      </div>

      <!-- Income Statement -->
      <div style="margin-top:18px">
        <div class="section-title">
          <h4 id="isTitle">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</h4>
          <div class="muted" id="isSummary">â€”</div>
        </div>

        <div class="table-wrap">
          <table id="isTable" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„">
            <thead><tr><th id="colItem2">Ø§Ù„Ø¨Ù†Ø¯</th><th id="colVal2">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th id="colPrev2">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</th><th id="colDiff2">Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex;gap:12px;margin-top:10px;align-items:flex-start">
          <canvas id="isChart" style="max-width:460px"></canvas>
          <div style="flex:1">
            <div id="isComment" class="commentary">â€”</div>
          </div>
        </div>
      </div>

      <!-- Cash Flow -->
      <div style="margin-top:18px">
        <div class="section-title">
          <h4 id="cfTitle">Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h4>
          <div class="muted" id="cfSummary">â€”</div>
        </div>

        <div class="table-wrap">
          <table id="cfTable" aria-label="Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©">
            <thead><tr><th id="colItem3">Ø§Ù„Ø¨Ù†Ø¯</th><th id="colVal3">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th id="colPrev3">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</th><th id="colDiff3">Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex;gap:12px;margin-top:10px;align-items:flex-start">
          <canvas id="cfChart" style="max-width:460px"></canvas>
          <div style="flex:1">
            <div id="cfComment" class="commentary">â€”</div>
          </div>
        </div>
      </div>
    </section>

    <!-- bottom: export & notes -->
    <section class="card" aria-label="actions">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <button id="exportPdfBtnBottom" class="btn btn-primary">ğŸ“„ <span id="exportPdfText2">ØªØµØ¯ÙŠØ± PDF Ø§Ø­ØªØ±Ø§ÙÙŠ</span></button>
          <button id="refreshBtn" class="btn btn-ghost">ğŸ”„ <span id="refreshText">ØªØ­Ø¯ÙŠØ«</span></button>
        </div>
        <div class="muted">Ù†Ø³Ø®Ø© Ultra Pro Max â€” ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆÙ…ØªÙƒØ§Ù…Ù„Ø©</div>
      </div>
    </section>
  </div>

<script>
/* =========================
   Translations
   ========================= */
const i18n = {
  ar: {
    brandText: "Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ",
    brandDesc: "ØªÙ‚Ø§Ø±ÙŠØ± Ø°ÙƒÙŠØ© ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª ÙÙˆØ±ÙŠØ©",
    home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
    exportPdf: "ØªØµØ¯ÙŠØ± PDF",
    adv: "Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©",
    kpis: "Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© â€” KPIs",
    lastUpdated: "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«",
    source: "Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
    bs: "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©",
    is: "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„",
    cf: "Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©",
    year: "Ø§Ù„Ø³Ù†Ø©",
    current: "Ø§Ù„Ø­Ø§Ù„ÙŠ",
    prev1: "Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠ",
    prev2: "Ù‚Ø¨Ù„ Ø¹Ø§Ù…ÙŠÙ†",
    items: { assets: "Ø§Ù„Ø£ØµÙˆÙ„", liabilities: "Ø§Ù„Ø®ØµÙˆÙ…", equity: "Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©", revenue: "Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", expense: "Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", net: "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­" },
    commentary: {
      bs_good: "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØªØ¨Ø¯Ùˆ Ù‚ÙˆÙŠØ©Ø› Ø§Ù„Ø£ØµÙˆÙ„ ØªØºØ·ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§ØªØŒ ÙˆØ§Ù„Ø³ÙŠÙˆÙ„Ø© Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ø¬ÙŠØ¯.",
      bs_warn: "ØªÙ†Ø¨ÙŠÙ‡: Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙŠÙ† Ù…Ø±ØªÙØ¹Ø© Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„.",
      is_profit: "Ø§Ù„Ø±Ø¨Ø­ÙŠØ© Ø¬ÙŠØ¯Ø©ØŒ Ù†Ø³Ø¨Ø© Ø§Ù„Ù‡Ø§Ù…Ø´ Ø«Ø§Ø¨ØªØ© Ø£Ùˆ Ù…ØªØµØ§Ø¹Ø¯Ø© â€” Ø¹Ù„Ø§Ù…Ø© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© Ù„Ù†Ù…Ùˆ Ø§Ù„Ø´Ø±ÙƒØ©.",
      is_loss: "Ø§Ù„Ø®Ø³Ø§Ø¦Ø± Ù…Ø³Ø¬Ù„Ø© â€” ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø£Ùˆ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø¨Ø³Ø±Ø¹Ø©.",
      cf_positive: "Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ Ù…ÙˆØ¬Ø¨ â€” Ø§Ù„Ø´Ø±ÙƒØ© ØªÙˆÙ„Ù‘Ø¯ Ø³ÙŠÙˆÙ„Ø© Ù…Ù† Ø£Ø¹Ù…Ø§Ù„Ù‡Ø§ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.",
      cf_negative: "ØªØ¯ÙÙ‚Ø§Øª Ù†Ù‚Ø¯ÙŠØ© ØªØ´ØºÙŠÙ„ÙŠØ© Ø³Ù„Ø¨ÙŠØ© â€” Ø±Ø§Ø¬Ø¹ ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø¯."
    },
    refresh: "ØªØ­Ø¯ÙŠØ«",
    noData: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯.",
    currencySymbol: { EGP: "Ø¬.Ù…", USD: "$", EUR: "â‚¬" },
    sourceLabels: { input: "ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (input)", upload: "ØµÙØ­Ø© Ø§Ù„Ø±ÙØ¹ (upload)" }
  },
  en: {
    brandText: "Financial Analyzer",
    brandDesc: "Smart reports & instant analytics",
    home: "Home",
    exportPdf: "Export PDF",
    adv: "Advanced Analysis",
    kpis: "Quick KPIs",
    lastUpdated: "Last updated",
    source: "Data source",
    bs: "Balance Sheet",
    is: "Income Statement",
    cf: "Cash Flow",
    year: "Year",
    current: "Current",
    prev1: "Last year",
    prev2: "2 years ago",
    items: { assets: "Assets", liabilities: "Liabilities", equity: "Equity", revenue: "Revenue", expense: "Expenses", net: "Net Profit" },
    commentary: {
      bs_good: "Balance sheet looks healthy; assets cover liabilities and liquidity is in a good range.",
      bs_warn: "Warning: debt ratio is high versus equity â€” review financing obligations.",
      is_profit: "Profitability is solid; margins are stable or improving â€” positive sign.",
      is_loss: "Losses detected â€” consider cutting costs or boosting revenues.",
      cf_positive: "Operating cash flow is positive â€” the business generates cash from operations.",
      cf_negative: "Operating cash flow is negative â€” review collections and cash management."
    },
    refresh: "Refresh",
    noData: "No data available from the selected source.",
    currencySymbol: { EGP: "EGP", USD: "$", EUR: "â‚¬" },
    sourceLabels: { input: "Input page (input)", upload: "Upload page (upload)" }
  }
};

/* =========================
   Utilities
   ========================= */
const $ = id => document.getElementById(id);
let LANG = localStorage.getItem('fa_lang') || 'ar';
let CURRENCY = localStorage.getItem('fa_currency') || 'EGP';
let DATA_SOURCE = localStorage.getItem('fa_source') || 'input';
let theme = localStorage.getItem('fa_theme') || 'light';
document.body.setAttribute('data-theme', theme);

$('langSelect').value = LANG;
$('currencySelect').value = CURRENCY;
$('dataSource').value = DATA_SOURCE;

/* safe parse */
function parseStored(key){ try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : null; } catch(e){ console.warn('parse fail',e); return null; }}

/* number formatting with currency */
function formatNum(n){
  if(typeof n !== 'number') n = Number(n) || 0;
  if(LANG === 'ar') return n.toLocaleString('ar-EG');
  return n.toLocaleString();
}
function formatCurrency(n){
  const sym = i18n[LANG].currencySymbol[CURRENCY] || CURRENCY;
  if(CURRENCY === 'EGP' && LANG==='ar') return `${formatNum(n)} ${sym}`;
  if(CURRENCY !== 'EGP' && sym.length<=2) return `${sym}${formatNum(n)}`;
  return `${formatNum(n)} ${sym}`;
}

/* set translated text */
function tr(key){
  // key can be nested 'commentary.bs_good' or direct mapping
  const parts = key.split('.');
  let cur = i18n[LANG];
  for(const p of parts){
    if(cur && cur[p] !== undefined) cur = cur[p];
    else return key;
  }
  return cur;
}

/* update UI text on language change */
function applyLanguage(){
  $('brandText').textContent = tr('brandText');
  $('brandDesc').textContent = tr('brandDesc');
  $('homeText').textContent = tr('home');
  $('exportPdfText').textContent = tr('exportPdf');
  $('exportPdfText2').textContent = tr('exportPdf');
  $('advText').textContent = tr('adv');
  $('kpiTitle').textContent = tr('kpis');
  $('reportTitle').textContent = tr('kpis'); // small reuse
  $('bsTitle').textContent = tr('bs');
  $('isTitle').textContent = tr('is');
  $('cfTitle').textContent = tr('cf');
  $('refreshText').textContent = tr('refresh');
  // options in year select
  const ys = $('yearSelect');
  ys.querySelectorAll('option').forEach(opt=>{
    if(opt.value === 'current') opt.textContent = tr('current');
    if(opt.value === 'prev1') opt.textContent = tr('prev1');
    if(opt.value === 'prev2') opt.textContent = tr('prev2');
  });
  // source label
  $('sourceLabel').textContent = tr('sourceLabels.' + DATA_SOURCE) || DATA_SOURCE;
}

/* =========================
   Data loading & aggregation
   ========================= */
let currentData = []; // array of {Account, Type, Code, Debit, Credit}
function loadDataFromLocalStorage(){
  // choose source
  // 'input' => localStorage.trialData
  // 'upload' => localStorage.uploadData
  const src = DATA_SOURCE === 'upload' ? 'uploadData' : 'trialData';
  const d = parseStored(src) || [];
  // normalise to expected fields
  currentData = d.map(r=>{
    return {
      Account: r.Account || r.account || r['Account Name'] || r['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'] || r.Name || '',
      Type: r.Type || r.type || r['Type'] || r['Ù†ÙˆØ¹'] || '',
      Code: r.Code || r.code || r['Code'] || r['ÙƒÙˆØ¯'] || '',
      Debit: Number(r.Debit || r.debit || r.Dr || r['Ù…Ø¯ÙŠÙ†'] || 0),
      Credit: Number(r.Credit || r.credit || r.Cr || r['Ø¯Ø§Ø¦Ù†'] || 0)
    };
  });
}

/* compute KPIs & results */
function computeAggregates(){
  const agg = { assets:0, liabilities:0, equity:0, revenue:0, expense:0, net:0, totalDebit:0, totalCredit:0 };
  currentData.forEach(r=>{
    const debit = Number(r.Debit)||0;
    const credit = Number(r.Credit)||0;
    agg.totalDebit += debit;
    agg.totalCredit += credit;
    const net = debit - credit;
    const s = ('' + (r.Type || r.Account || '')).toLowerCase();
    if(/asset|Ø£ØµÙ„|cash|bank|Ù†Ù‚Ø¯|current asset/i.test(s)) agg.assets += net;
    else if(/liab|Ø®ØµÙˆÙ…|payable|loan|Ø¯Ø§Ø¦Ù†|Ù‚Ø±Ø¶/i.test(s)) agg.liabilities += -net;
    else if(/equity|Ø­Ù‚ÙˆÙ‚|Ø±Ø£Ø³/i.test(s)) agg.equity += -net;
    else if(/revenue|sales|Ø¥ÙŠØ±Ø§Ø¯|Ù…Ø¨ÙŠØ¹Ø§Øª/i.test(s)) agg.revenue += -net;
    else if(/expense|Ù…ØµØ±ÙˆÙ|ØªÙƒÙ„ÙØ©|Ù…ØµØ§Ø±ÙŠÙ/i.test(s)) agg.expense += net;
    else {
      // fallback by guess
      if(/Ù…Ø¨ÙŠØ¹Ø§Øª|revenue|sales/i.test(r.Account)) agg.revenue += -net;
      else agg.other = (agg.other || 0) + net;
    }
  });
  agg.net = (agg.revenue || 0) - (agg.expense || 0);
  return agg;
}

/* render KPIs */
function renderKPIs(agg){
  const grid = $('kpiGrid');
  grid.innerHTML = '';
  const items = [
    {label: tr('items.assets'), value: agg.assets},
    {label: tr('items.liabilities'), value: agg.liabilities},
    {label: tr('items.equity'), value: agg.equity},
    {label: tr('items.revenue'), value: agg.revenue},
    {label: tr('items.expense'), value: agg.expense},
    {label: tr('items.net'), value: agg.net}
  ];
  items.forEach(it=>{
    const div = document.createElement('div'); div.className='kpi';
    div.innerHTML = `<div class="label">${it.label}</div><div class="value">${formatCurrency(it.value)}</div>`;
    grid.appendChild(div);
  });
  $('lastUpdated').textContent = `${tr('lastUpdated')}: ${new Date().toLocaleString()}`;
}

/* render tables & charts */
let charts = {};
function safeDestroyChart(name){
  if(charts[name]){ try{ charts[name].destroy(); } catch(e){} charts[name] = null; }
}

function renderTablesAndCharts(agg){
  // build simple rows for BS (assets, liabilities, equity)
  const bsBody = $('bsTable').querySelector('tbody'); bsBody.innerHTML = '';
  const bsRows = [
    {k: tr('items.assets'), v: agg.assets},
    {k: tr('items.liabilities'), v: agg.liabilities},
    {k: tr('items.equity'), v: agg.equity}
  ];
  bsRows.forEach(r=>{
    const prev = r.v * 0.92;
    const diff = r.v - prev;
    const trEl = document.createElement('tr');
    trEl.innerHTML = `<td>${r.k}</td><td>${formatCurrency(r.v)}</td><td>${formatCurrency(prev)}</td><td>${formatNum(((diff)/Math.max(Math.abs(prev),1))*100)}%</td>`;
    bsBody.appendChild(trEl);
  });

  // income statement simple breakdown
  const isBody = $('isTable').querySelector('tbody'); isBody.innerHTML = '';
  const isRows = [
    {k: tr('items.revenue'), v: agg.revenue},
    {k: tr('items.expense'), v: agg.expense},
    {k: tr('items.net'), v: agg.net}
  ];
  isRows.forEach(r=>{
    const prev = r.v * 0.88;
    const diff = r.v - prev;
    const trEl = document.createElement('tr');
    trEl.innerHTML = `<td>${r.k}</td><td>${formatCurrency(r.v)}</td><td>${formatCurrency(prev)}</td><td>${formatNum(((diff)/Math.max(Math.abs(prev),1))*100)}%</td>`;
    isBody.appendChild(trEl);
  });

  // cashflow: approximate using net & assets change
  const cfBody = $('cfTable').querySelector('tbody'); cfBody.innerHTML = '';
  const operating = agg.net * 0.7;
  const investing = -Math.abs(agg.assets) * 0.05;
  const financing = (agg.liabilities * 0.1);
  const cfRows = [
    {k: tr('cf'), v: ''},
    {k: 'Ø§Ù„ØªØ´ØºÙŠÙ„ / Operating', v: operating},
    {k: 'Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± / Investing', v: investing},
    {k: 'Ø§Ù„ØªÙ…ÙˆÙŠÙ„ / Financing', v: financing}
  ];
  cfRows.slice(1).forEach(r=>{
    const prev = r.v * 0.9;
    const diff = r.v - prev;
    const trEl = document.createElement('tr');
    trEl.innerHTML = `<td>${r.k}</td><td>${formatCurrency(r.v)}</td><td>${formatCurrency(prev)}</td><td>${formatNum(((diff)/Math.max(Math.abs(prev),1))*100)}%</td>`;
    cfBody.appendChild(trEl);
  });

  // charts
  // BS chart
  safeDestroyChart('bsChart');
  const ctxBS = $('bsChart').getContext('2d');
  charts.bsChart = new Chart(ctxBS, {
    type: 'doughnut',
    data: { labels: [tr('items.assets'), tr('items.liabilities'), tr('items.equity')], datasets: [{ data: [Math.abs(agg.assets), Math.abs(agg.liabilities), Math.abs(agg.equity)], backgroundColor:['#0d6efd','#dc3545','#198754'] }] },
    options: { plugins:{legend:{position:'bottom'}}, responsive:true }
  });

  // IS chart
  safeDestroyChart('isChart');
  const ctxIS = $('isChart').getContext('2d');
  charts.isChart = new Chart(ctxIS, {
    type: 'bar',
    data: { labels:[tr('items.revenue'), tr('items.expense'), tr('items.net')], datasets:[{ label: tr('is'), data:[agg.revenue, agg.expense, agg.net], backgroundColor:['#0d6efd','#ffc107','#198754'] }] },
    options: { responsive:true, plugins:{legend:{display:false}} }
  });

  // CF chart
  safeDestroyChart('cfChart');
  const ctxCF = $('cfChart').getContext('2d');
  charts.cfChart = new Chart(ctxCF, {
    type: 'pie',
    data: { labels:['Operating','Investing','Financing'], datasets:[{ data:[operating, Math.abs(investing), financing], backgroundColor:['#0d6efd','#6f42c1','#dc3545'] }] },
    options: { responsive:true, plugins:{legend:{position:'bottom'}} }
  });
}

/* Commentary (smart, dynamic) */
function generateComments(agg){
  // Balance sheet comment
  const debtToEquity = (Math.abs(agg.liabilities) / Math.max(Math.abs(agg.equity),1));
  if(debtToEquity < 0.6) $('bsComment').textContent = tr('commentary.bs_good');
  else $('bsComment').textContent = tr('commentary.bs_warn');

  // Income statement
  if(agg.net >= 0) $('isComment').textContent = tr('commentary.is_profit');
  else $('isComment').textContent = tr('commentary.is_loss');

  // Cashflow
  const operating = agg.net * 0.7;
  if(operating >= 0) $('cfComment').textContent = tr('commentary.cf_positive');
  else $('cfComment').textContent = tr('commentary.cf_negative');
}

/* main render */
function renderAll(){
  loadDataFromLocalStorage();
  if(!currentData || currentData.length===0){
    // empty
    document.querySelectorAll('tbody').forEach(tb=> tb.innerHTML = `<tr><td colspan="4" class="muted">${tr('noData')}</td></tr>`);
    document.getElementById('bsComment').textContent = tr('noData');
    document.getElementById('isComment').textContent = tr('noData');
    document.getElementById('cfComment').textContent = tr('noData');
    $('sourceLabel').textContent = tr('sourceLabels.' + DATA_SOURCE) || DATA_SOURCE;
    $('lastUpdated').textContent = `${tr('lastUpdated')}: â€”`;
    $('kpiGrid').innerHTML = '';
    safeDestroyChart('bsChart'); safeDestroyChart('isChart'); safeDestroyChart('cfChart');
    return;
  }
  const agg = computeAggregates();
  renderKPIs(agg);
  renderTablesAndCharts(agg);
  generateComments(agg);
  $('sourceLabel').textContent = tr('sourceLabels.' + DATA_SOURCE) || DATA_SOURCE;
}

/* =========================
   Event wiring
   ========================= */
$('langSelect').addEventListener('change', (e)=>{
  LANG = e.target.value;
  localStorage.setItem('fa_lang', LANG);
  applyLanguage();
  renderAll();
});
$('currencySelect').addEventListener('change', (e)=>{
  CURRENCY = e.target.value;
  localStorage.setItem('fa_currency', CURRENCY);
  renderAll();
});
$('dataSource').addEventListener('change', (e)=>{
  DATA_SOURCE = e.target.value;
  localStorage.setItem('fa_source', DATA_SOURCE);
  renderAll();
});
$('themeToggle').addEventListener('click', ()=>{
  theme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', theme);
  localStorage.setItem('fa_theme', theme);
});
$('refreshBtn').addEventListener('click', ()=> renderAll());
$('homeBtn').addEventListener('click', ()=> window.location.href = 'index.html');
$('goAdvanced').addEventListener('click', ()=> window.location.href = 'advanced.html');

/* Export PDF */
function exportPDF(){
  const opt = { margin:0.4, filename:'financial_report.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'} };
  const element = document.querySelector('.container');
  html2pdf().set(opt).from(element).save();
}
$('exportPdfBtn').addEventListener('click', exportPDF);
$('exportPdfBtnBottom').addEventListener('click', exportPDF);

/* init */
(function init(){
  // set initial language & texts
  applyLanguage();
  renderAll();
})();

</script>
</body>
</html>
