<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة القيادة — المحلل المالي (Dashboard)</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.06);
      --card-glass: rgba(255,255,255,0.04);
      --accent1: #0d6efd; --accent2:#6610f2;
      --muted-dark:#9aa6b2; --muted-light:#6c757d;
      --success:#198754; --danger:#dc3545; --warning:#ffc107;
      --radius:12px;
    }
    html,body{height:100%;margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{background:linear-gradient(120deg,#071427 0%, #071a2a 40%, #0b1226 100%);color:#e6eef6;-webkit-font-smoothing:antialiased;}
    body[data-theme="light"]{
      background:linear-gradient(120deg,#f8fbff 0%,#f6f8fb 60%);
      color:#0b1220;
      --glass-bg: rgba(15,23,36,0.03);
      --card-glass: rgba(6,10,15,0.02);
    }

    .container-main{max-width:1200px;margin:18px auto;padding:18px}
    .site-header{position:sticky;top:12px;padding:10px 14px;border-radius:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;backdrop-filter: blur(8px);background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;border-radius:8px;box-shadow:0 8px 30px rgba(6,10,15,0.25)}
    .brand .title{font-weight:800;font-size:1.05rem}
    .controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .btn {background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:.45rem .6rem;border-radius:8px;cursor:pointer;font-size:0.92rem}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 8px 30px rgba(102,16,242,0.09)}
    .select, .input {padding:.35rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;font-size:0.92rem}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(2,6,23,0.28);margin-bottom:14px}
    body[data-theme="light"] .panel{box-shadow:0 8px 18px rgba(2,6,23,0.04)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column: span 4;}
    .col-8{grid-column: span 8;}
    .col-6{grid-column: span 6;}
    .kpi{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));display:flex;flex-direction:column;gap:6px}
    .kpi .label{color:var(--muted-dark);font-size:.88rem}
    .kpi .value{font-weight:800;font-size:1.18rem}
    h3.section-title{margin:0 0 8px 0;font-size:1rem}
    table{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden;background:transparent}
    th,td{padding:8px 10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:.95rem}
    thead th{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:700}
    .muted{color:var(--muted-dark);font-size:.9rem}
    .small{font-size:.85rem}
    .comment{padding:10px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));margin-top:8px;font-size:.95rem}

    /* responsive */
    @media (max-width:980px){
      .grid{grid-template-columns:repeat(6,1fr)}
      .col-4{grid-column:span 6}
      .col-8{grid-column:span 6}
      .col-6{grid-column:span 6}
      .controls{gap:6px}
    }
  </style>
</head>
<body data-theme="dark">
  <div class="container-main" id="root">
    <header class="site-header" role="banner" aria-label="Header">
      <div class="brand" title="المحلل المالي">
        <img src="assets/logo.png" alt="logo" id="brandLogo" onerror="this.style.display='none'">
        <div>
          <div class="title" id="brandTitle">المحلل المالي</div>
          <div class="muted small" id="brandDesc">لوحة قيادية — Dashboard</div>
        </div>
      </div>

      <div class="controls" role="navigation" aria-label="Controls">
        <button class="btn" id="homeBtn" title="الرئيسية"><i class="bi bi-house"></i></button>
        <button class="btn" id="reportBtn" title="التقرير"><i class="bi bi-file-earmark-text"></i></button>
        <button class="btn" id="advancedBtn" title="التحليلات المتقدمة"><i class="bi bi-graph-up"></i></button>

        <select id="sourceSelect" class="select" title="مصدر البيانات" aria-label="مصدر البيانات"></select>

        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="combineSources" style="width:18px;height:18px">
          <span class="small muted" id="combineLabel">دمج مصادر متعددة</span>
        </label>

        <select id="currencySelect" class="select" title="عملة العرض" aria-label="عملة العرض">
          <option value="EGP">EGP</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>

        <select id="langSelect" class="select" title="اللغة" aria-label="اللغة">
          <option value="ar">العربية</option>
          <option value="en">English</option>
        </select>

        <button class="btn" id="themeToggle" title="وضع ليلي/نهاري">🌙</button>
        <button class="btn primary" id="exportPdfBtn" title="تصدير PDF"><i class="bi bi-file-earmark-pdf"></i>&nbsp;<span id="exportLabel">تصدير PDF</span></button>
      </div>
    </header>

    <main style="margin-top:14px">
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <h2 id="pageTitle" style="margin:0">لوحة القيادة — ملخص سريع</h2>
            <div class="muted small" id="subtitle">اختر مصدر البيانات لتحديث اللوحة تلقائياً</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="muted small" for="yearFilter" id="lblYear">السنة</label>
            <select id="yearFilter" class="select"></select>
          </div>
        </div>
      </section>

      <section class="grid" aria-live="polite">
        <div class="col-4 panel kpi">
          <div class="label small-muted" id="kpiAccountsLabel">عدد الحسابات</div>
          <div class="value" id="kpiAccounts">0</div>
          <div class="muted small" id="kpiAccountsComment">لا بيانات</div>
        </div>

        <div class="col-4 panel kpi">
          <div class="label small-muted" id="kpiAssetsLabel">الأصول (تقريبي)</div>
          <div class="value" id="kpiAssets">0</div>
          <div class="muted small" id="kpiAssetsComment">—</div>
        </div>

        <div class="col-4 panel kpi">
          <div class="label small-muted" id="kpiLiabLabel">الخصوم (تقريبي)</div>
          <div class="value" id="kpiLiab">0</div>
          <div class="muted small" id="kpiLiabComment">—</div>
        </div>

        <div class="col-6 panel">
          <h3 class="section-title" id="profitTitle">قائمة الدخل — مؤشرات</h3>
          <table id="profitTable" aria-label="Profit metrics">
            <thead><tr><th id="colItem">البند</th><th id="colValue">القيمة</th><th id="colComment">تعليق</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="comment" id="profitComment"></div>
        </div>

        <div class="col-6 panel">
          <h3 class="section-title" id="bsTitle">الميزانية — مؤشرات</h3>
          <table id="bsTable" aria-label="Balance metrics">
            <thead><tr><th id="colItem2">البند</th><th id="colValue2">القيمة</th><th id="colComment2">تعليق</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="comment" id="bsComment"></div>
        </div>

        <div class="col-8 panel">
          <h3 class="section-title" id="chartTitle">رسم الاتجاه العام</h3>
          <canvas id="trendChart" height="160" aria-label="Trend chart"></canvas>
          <div class="muted small" id="trendComment">—</div>
        </div>

        <div class="col-4 panel">
          <h3 class="section-title" id="forecastTitle">تنبؤ بسيط للأرباح</h3>
          <div id="forecastValue" class="value">—</div>
          <div class="muted small" id="forecastComment">—</div>
        </div>

      </section>
    </main>
  </div>

<script>
/* =========================
   Ultra-Pro Dashboard JS
   - Uses localStorage keys: reportData, advancedData, inputData, uploadedData, trialData
   - Features: translations, theme, currency, combine sources, KPI calc, charts, forecast, export PDF
   ========================= */

const SOURCE_KEYS = [
  {k:'reportData', ar:'تقرير (reportData)', en:'Report (reportData)'},
  {k:'advancedData', ar:'متقدم (advancedData)', en:'Advanced (advancedData)'},
  {k:'inputData', ar:'إدخال (inputData)', en:'Input (inputData)'},
  {k:'uploadedData', ar:'مرفوع (uploadedData)', en:'Uploaded (uploadedData)'},
  {k:'trialData', ar:'ميزان المراجعة (trialData)', en:'Trial Balance (trialData)'}
];

const translations = {
  ar: {
    pageTitle:'لوحة القيادة — ملخص سريع',
    subtitle:'اختر مصدر البيانات لتحديث اللوحة تلقائياً',
    exportPdf:'تصدير PDF',
    lblYear:'السنة',
    kpiAccounts:'عدد الحسابات',
    kpiAssets:'الأصول (تقريبي)',
    kpiLiab:'الخصوم (تقريبي)',
    profitTitle:'قائمة الدخل — مؤشرات',
    bsTitle:'الميزانية — مؤشرات',
    chartTitle:'رسم الاتجاه العام',
    forecastTitle:'تنبؤ بسيط للأرباح',
    colItem:'البند', colValue:'القيمة', colComment:'تعليق',
    noData:'لا توجد بيانات في المصدر المحدد.',
    selectSource:'اختر مصدر البيانات...',
    sourceLabel:'مصدر البيانات',
    combineLabel:'دمج مصادر متعددة',
    home:'الرئيسية', report:'التقرير', advanced:'المتقدم',
    trendComment:'الرسم يظهر صافي الأداء عبر الفترات المتاحة.',
    forecastUp:'اتجاه صاعد — توقع إيجابي للمستقبل القريب.',
    forecastDown:'اتجاه هابط — توقع تراجع إذا لم تتغير الاتجاهات.',
    forecastNo:'لا توجد بيانات كافية للتنبؤ.'
  },
  en: {
    pageTitle:'Dashboard — Quick Summary',
    subtitle:'Pick data source to update the dashboard automatically',
    exportPdf:'Export PDF',
    lblYear:'Year',
    kpiAccounts:'Accounts',
    kpiAssets:'Assets (approx)',
    kpiLiab:'Liabilities (approx)',
    profitTitle:'Income Statement — Metrics',
    bsTitle:'Balance Sheet — Metrics',
    chartTitle:'Overview Trend Chart',
    forecastTitle:'Simple Profit Forecast',
    colItem:'Item', colValue:'Value', colComment:'Comment',
    noData:'No data in selected source.',
    selectSource:'Select data source...',
    sourceLabel:'Data source',
    combineLabel:'Combine multiple sources',
    home:'Home', report:'Report', advanced:'Advanced',
    trendComment:'Chart shows net performance across available periods.',
    forecastUp:'Uptrend — positive near-term outlook.',
    forecastDown:'Downtrend — negative outlook unless things change.',
    forecastNo:'Not enough data to forecast.'
  }
};

const $ = id => document.getElementById(id);
let state = {
  lang: localStorage.getItem('dash_lang') || 'ar',
  theme: localStorage.getItem('dash_theme') || 'dark',
  currency: localStorage.getItem('dash_currency') || 'EGP',
  sourceKey: localStorage.getItem('dash_source') || '',
  combine: localStorage.getItem('dash_combine') === '1',
  yearFilter: null,
  rawData: []
};

function t(key){ return translations[state.lang][key] || key; }

function init(){
  populateSourceSelect();
  applyTheme();
  applyLanguage();
  attachHandlers();
  populateYearFilter();
  if(state.sourceKey) loadData(); else renderNoData();
}

function populateSourceSelect(){
  const sel = $('sourceSelect');
  sel.innerHTML = '';
  const o0 = document.createElement('option'); o0.value=''; o0.textContent = t('selectSource'); sel.appendChild(o0);
  SOURCE_KEYS.forEach(s=>{
    const o = document.createElement('option'); o.value = s.k; o.textContent = (state.lang==='ar' ? s.ar : s.en); sel.appendChild(o);
  });
  sel.value = state.sourceKey || '';
  $('currencySelect').value = state.currency;
  $('langSelect').value = state.lang;
  $('combineSources').checked = state.combine;
}

function applyLanguage(){
  $('pageTitle').textContent = t('pageTitle');
  $('subtitle').textContent = t('subtitle');
  $('exportLabel').textContent = t('exportPdf');
  $('lblYear').textContent = t('lblYear');
  $('kpiAccountsLabel').textContent = t('kpiAccounts');
  $('kpiAssetsLabel').textContent = t('kpiAssets');
  $('kpiLiabLabel').textContent = t('kpiLiab');
  $('profitTitle').textContent = t('profitTitle');
  $('bsTitle').textContent = t('bsTitle');
  $('chartTitle').textContent = t('chartTitle');
  $('forecastTitle').textContent = t('forecastTitle');
  $('combineLabel').textContent = t('combineLabel');
  // table headers
  document.querySelectorAll('#profitTable thead th').forEach((th,i)=> { if(i===0) th.textContent = t('colItem'); if(i===1) th.textContent = t('colValue'); if(i===2) th.textContent = t('colComment'); });
  document.querySelectorAll('#bsTable thead th').forEach((th,i)=> { if(i===0) th.textContent = t('colItem'); if(i===1) th.textContent = t('colValue'); if(i===2) th.textContent = t('colComment'); });
  // titles attributes
  $('homeBtn').title = t('home'); $('reportBtn').title = t('report'); $('advancedBtn').title = t('advanced');
}

function applyTheme(){
  document.body.setAttribute('data-theme', state.theme === 'light' ? 'light' : 'dark');
  $('themeToggle').textContent = (state.theme === 'light' ? '🌞' : '🌙');
  localStorage.setItem('dash_theme', state.theme);
}

function attachHandlers(){
  $('langSelect').addEventListener('change', e => { state.lang = e.target.value; localStorage.setItem('dash_lang', state.lang); populateSourceSelect(); applyLanguage(); populateYearFilter(); refreshAll(); });
  $('currencySelect').addEventListener('change', e => { state.currency = e.target.value; localStorage.setItem('dash_currency', state.currency); refreshAll(); });
  $('themeToggle').addEventListener('click', ()=>{ state.theme = state.theme === 'light' ? 'dark' : 'light'; applyTheme(); });
  $('exportPdfBtn').addEventListener('click', exportPdf);
  $('homeBtn').addEventListener('click', ()=> window.location.href = 'index.html');
  $('reportBtn').addEventListener('click', ()=> window.location.href = 'report.html');
  $('advancedBtn').addEventListener('click', ()=> window.location.href = 'advanced.html');

  $('sourceSelect').addEventListener('change', e => { state.sourceKey = e.target.value; localStorage.setItem('dash_source', state.sourceKey || ''); if(!state.combine) loadData(); else loadCombined(); });
  $('combineSources').addEventListener('change', e => { state.combine = e.target.checked; localStorage.setItem('dash_combine', state.combine ? '1' : '0'); if(state.combine) loadCombined(); else loadData(); });

  $('yearFilter').addEventListener('change', e => { state.yearFilter = e.target.value || null; refreshAll(); });
}

function loadCombined(){
  // merge all available keys into one dataset
  const combined = [];
  SOURCE_KEYS.forEach(s=>{
    try{
      const raw = JSON.parse(localStorage.getItem(s.k) || 'null');
      if(raw) {
        const norm = normalizeRaw(raw);
        if(norm && norm.length) combined.push(...norm);
      }
    }catch(e){ console.warn('parse', s.k, e); }
  });
  state.rawData = combined;
  refreshAll();
}

function loadData(){
  if(!state.sourceKey){ state.rawData = []; renderNoData(); return; }
  try{
    const raw = JSON.parse(localStorage.getItem(state.sourceKey) || 'null');
    if(!raw){ state.rawData = []; renderNoData(); return; }
    state.rawData = normalizeRaw(raw) || [];
    refreshAll();
  }catch(e){ console.error(e); state.rawData = []; renderNoData(); }
}

/* Normalize variety of possible shapes into rows array */
function normalizeRaw(raw){
  const out = [];
  if(Array.isArray(raw)){
    raw.forEach(r => {
      if(!r || typeof r !== 'object') return;
      out.push({
        Account: r.Account || r.account || r['Account Name'] || r['اسم الحساب'] || r.name || '',
        Type: r.Type || r.type || r['نوع'] || '',
        Code: r.Code || r.code || r['كود'] || '',
        Debit: toNum(r.Debit || r.debit || r.Dr || r.dr || r.Deb || 0),
        Credit: toNum(r.Credit || r.credit || r.Cr || r.cr || r.Cred || 0),
        Year: r.Year || r.year || r.YYYY || null
      });
    });
  } else if(typeof raw === 'object'){
    // look for arrays inside object
    Object.values(raw).forEach(v => {
      if(Array.isArray(v)){
        v.forEach(item => {
          if(item && typeof item === 'object'){
            out.push({
              Account: item.Account || item.account || item.name || '',
              Type: item.Type || item.type || '',
              Code: item.Code || item.code || '',
              Debit: toNum(item.Debit || item.debit || item.Dr || 0),
              Credit: toNum(item.Credit || item.credit || item.Cr || 0),
              Year: item.Year || item.year || null
            });
          }
        });
      }
    });
  }
  return out;
}

function renderNoData(){
  $('kpiAccounts').textContent = '0';
  $('kpiAssets').textContent = formatCurrency(0);
  $('kpiLiab').textContent = formatCurrency(0);
  clearTable('profitTable'); clearTable('bsTable');
  $('profitComment').textContent = t('noData');
  $('bsComment').textContent = t('noData');
  renderChart([],[]);
  $('forecastValue').textContent = '—';
  $('forecastComment').textContent = t('noData');
}

function toNum(v){ const n = Number(String(v||'').toString().replace(/[, ]+/g,'')); return isNaN(n) ? 0 : n; }

function formatCurrency(v){
  const c = state.currency || 'EGP';
  const sign = v < 0 ? '-' : '';
  const abs = Math.abs(Number(Math.round((v + Number.EPSILON) * 100)/100));
  const nf = abs.toLocaleString();
  if(c === 'EGP') return `${sign}${nf} ج.م`;
  if(c === 'USD') return `${sign}$ ${nf}`;
  if(c === 'EUR') return `${sign}€ ${nf}`;
  return `${sign}${nf} ${c}`;
}

function clearTable(id){ const tb = document.querySelector(`#${id} tbody`); if(tb) tb.innerHTML = ''; }

function computeKPIs(){
  const rows = state.rawData || [];
  const accounts = rows.length;
  let totalDebit = 0, totalCredit = 0;
  let assets = 0, liabilities = 0, revenue = 0, expense = 0;
  rows.forEach(r=>{
    totalDebit += toNum(r.Debit);
    totalCredit += toNum(r.Credit);
    const net = toNum(r.Debit) - toNum(r.Credit);
    const s = (r.Type || r.Account || '').toString().toLowerCase();
    if(/asset|أصل|نقد|bank|cash|current asset|fixed asset|أصول/.test(s)) assets += net;
    else if(/liab|خصوم|payable|دائن|قرض|loan/.test(s)) liabilities += -net;
    else if(/revenue|sale|إيراد|مبيعات|income/.test(s)) revenue += -net;
    else if(/expense|مصروف|تكلفة|expense|cogs/.test(s)) expense += net;
    else {
      const a = (r.Account||'').toLowerCase();
      if(/النقد|bank|cash/.test(a)) assets += net;
      else if(/مورد|payable|دائن/.test(a)) liabilities += -net;
      else if(/مبيعات|revenue|sale/.test(a)) revenue += -net;
      else if(/مصروف|expense|تكلفة/.test(a)) expense += net;
      else { /* ambiguous - ignore */ }
    }
  });
  return {accounts, assets, liabilities, totalDebit, totalCredit, revenue, expense};
}

function renderKPIs(kpis){
  $('kpiAccounts').textContent = kpis.accounts;
  $('kpiAssets').textContent = formatCurrency(Math.round(kpis.assets));
  $('kpiLiab').textContent = formatCurrency(Math.round(kpis.liabilities));

  // Profit rows
  const profitRows = [
    {item: state.lang==='ar' ? 'الإيرادات' : 'Revenue', value: kpis.revenue},
    {item: state.lang==='ar' ? 'المصروفات' : 'Expenses', value: kpis.expense},
    {item: state.lang==='ar' ? 'صافي الربح' : 'Net Profit', value: kpis.revenue - kpis.expense},
    {item: state.lang==='ar' ? 'هامش الربح' : 'Profit Margin', value: (kpis.revenue? (kpis.revenue - kpis.expense)/Math.abs(kpis.revenue) : 0)}
  ];
  populateTable('profitTable', profitRows, profitCommentForRow);

  const equity = kpis.assets - kpis.liabilities;
  const liquidity = (kpis.liabilities !== 0) ? (kpis.assets / Math.abs(kpis.liabilities)) : (kpis.assets ? 9999 : 0);
  const bsRows = [
    {item: state.lang==='ar' ? 'الأصول (تقريبي)' : 'Assets (approx)', value: kpis.assets},
    {item: state.lang==='ar' ? 'الخصوم (تقريبي)' : 'Liabilities (approx)', value: kpis.liabilities},
    {item: state.lang==='ar' ? 'حقوق الملكية (تقريبي)' : 'Equity (approx)', value: equity},
    {item: state.lang==='ar' ? 'نسبة السيولة (تقريبية)' : 'Liquidity ratio (approx)', value: liquidity}
  ];
  populateTable('bsTable', bsRows, bsCommentForRow);

  $('profitComment').textContent = generateProfitOverview(kpis);
  $('bsComment').textContent = generateBalanceOverview(kpis);
}

function populateTable(tblId, rows, commentFn){
  const tb = document.querySelector(`#${tblId} tbody`); tb.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = r.item;
    const td2 = document.createElement('td');
    if(typeof r.value === 'number' && !r.item.toLowerCase().includes('margin') && !r.item.includes('نسبة')) td2.textContent = formatCurrency(Math.round(r.value));
    else if(typeof r.value === 'number') td2.textContent = (Math.abs(r.value) < 1 && r.value !== 0) ? `${(r.value*100).toFixed(2)}%` : `${(r.value).toLocaleString()}`;
    else td2.textContent = r.value;
    const td3 = document.createElement('td'); td3.textContent = commentFn ? commentFn(r) : '';
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tb.appendChild(tr);
  });
}

function profitCommentForRow(row){
  const key = (row.item||'').toString();
  if(key.includes('Margin') || key.includes('هامش')) {
    const m = row.value;
    if(m >= 0.2) return state.lang==='ar' ? 'هامش قوي — أداء ربحي ممتاز.' : 'Strong margin — excellent profitability.';
    if(m >= 0.1) return state.lang==='ar' ? 'هامش جيد — أداء مناسب.' : 'Good margin — decent performance.';
    if(m > 0) return state.lang==='ar' ? 'هامش ضعيف — راجع التكلفة والأسعار.' : 'Low margin — review costs/pricing.';
    return state.lang==='ar' ? 'خسارة — مطلوب تحقيق عاجل.' : 'Loss — immediate investigation needed.';
  } else {
    if(row.value === 0) return state.lang==='ar' ? 'لا بيانات.' : 'No data.';
    return state.lang==='ar' ? `المبلغ: ${formatCurrency(row.value)}` : `Amount: ${formatCurrency(row.value)}`;
  }
}

function bsCommentForRow(row){
  if((row.item||'').toString().toLowerCase().includes('liquidity') || (row.item||'').toString().includes('السيولة')){
    const r = row.value;
    if(r >= 1.5) return state.lang==='ar' ? 'سيولة جيدة.' : 'Good liquidity.';
    if(r >= 1) return state.lang==='ar' ? 'سيولة مقبولة.' : 'Acceptable liquidity.';
    return state.lang==='ar' ? 'سيولة ضعيفة — قد تواجه التزامات قصيرة الأجل.' : 'Low liquidity — short-term risk.';
  } else {
    return state.lang==='ar' ? `المبلغ: ${formatCurrency(row.value)}` : `Amount: ${formatCurrency(row.value)}`;
  }
}

/* high-level comments */
function generateProfitOverview(kpis){
  const net = kpis.revenue - kpis.expense;
  if(kpis.revenue === 0 && kpis.expense === 0) return t('noData');
  const ratio = (kpis.revenue ? net / Math.abs(kpis.revenue) : 0);
  if(net > 0){
    if(ratio >= 0.2) return state.lang==='ar' ? 'الأداء الربحي قوي ويوفر هامش أمان.' : 'Profitability is strong and provides a good safety margin.';
    if(ratio >= 0.05) return state.lang==='ar' ? 'ربحية معتدلة — تابع التكاليف.' : 'Moderate profitability — monitor costs.';
    return state.lang==='ar' ? 'هامش ضئيل — راجع الأسعار والتكاليف.' : 'Thin margin — review pricing/costs.';
  } else {
    return state.lang==='ar' ? 'خسارة صافية — مطلوب تحليل فوري للمصروفات والإيرادات.' : 'Net loss — immediate review of expenses and revenue required.';
  }
}

function generateBalanceOverview(kpis){
  if(kpis.assets === 0 && kpis.liabilities === 0) return t('noData');
  const equity = kpis.assets - kpis.liabilities;
  if(equity > 0) return state.lang==='ar' ? `حقوق الملكية إيجابية (${formatCurrency(equity)}).` : `Positive equity (${formatCurrency(equity)}).`;
  return state.lang==='ar' ? `حقوق الملكية سالبة (${formatCurrency(equity)}) — خطر مالي.` : `Negative equity (${formatCurrency(equity)}) — financial risk.`;
}

/* Chart */
let trendChart = null;
function renderChart(labels, datasets){
  const ctx = document.getElementById('trendChart').getContext('2d');
  if(trendChart) try{ trendChart.destroy(); }catch(e){}
  trendChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive:true,
      plugins:{ legend:{ position:'bottom' } },
      scales: { x: { ticks: { color: state.theme==='light' ? '#0b1220' : '#e6eef6' } }, y: { ticks: { color: state.theme==='light' ? '#0b1220' : '#e6eef6' } } }
    }
  });
}

/* Build trend points grouped by year if present, else chunk */
function buildTrend(){
  const rows = state.rawData || [];
  const yearsMap = {};
  let hasYear = false;
  rows.forEach(r=>{
    if(r.Year){ hasYear = true; const y = String(r.Year); yearsMap[y] = yearsMap[y] || {revenue:0, expense:0}; yearsMap[y].revenue += toNum(r.Credit); yearsMap[y].expense += toNum(r.Debit); }
  });
  if(hasYear){
    const labels = Object.keys(yearsMap).sort();
    const net = labels.map(y => Math.round(yearsMap[y].revenue - yearsMap[y].expense));
    const datasets = [{ label: state.lang==='ar' ? 'صافي الربح' : 'Net Profit', data: net, borderColor:getAccent(0), tension:0.3, fill:false }];
    return {labels, datasets};
  } else {
    // chunk by N items
    const chunk = 10;
    const points = [];
    for(let i=0;i<rows.length;i+=chunk){
      const slice = rows.slice(i,i+chunk);
      const net = slice.reduce((s,r)=> s + (toNum(r.Credit) - toNum(r.Debit)),0);
      points.push(Math.round(net));
    }
    const labels = points.map((_,i)=> `P${i+1}`);
    const datasets = [{ label: state.lang==='ar' ? 'صافي (نقاط)' : 'Net (pts)', data: points, borderColor:getAccent(0), tension:0.3, fill:false }];
    return {labels, datasets};
  }
}

/* Simple linear forecast from trend */
function computeForecast(){
  try{
    const tr = buildTrend();
    if(!tr.labels || tr.labels.length < 2) return null;
    const y = tr.datasets[0].data.map(v => Number(v));
    const x = y.map((_,i)=> i+1);
    const n = x.length;
    const sumX = x.reduce((a,b)=>a+b,0), sumY = y.reduce((a,b)=>a+b,0);
    const sumXY = x.reduce((s,xi,i)=> s + xi*y[i],0);
    const sumX2 = x.reduce((s,xi)=> s + xi*xi,0);
    const denom = (n*sumX2 - sumX*sumX) || 1;
    const slope = (n*sumXY - sumX*sumY)/denom;
    const intercept = (sumY - slope*sumX)/n;
    const nextX = n+1;
    const pred = intercept + slope * nextX;
    return {pred, slope, intercept};
  }catch(e){ return null; }
}

function getAccent(i){ const colors = ['#0d6efd','#6610f2','#198754','#dc3545','#ffc107']; return colors[i % colors.length]; }

function refreshAll(){
  // apply filter by year if set
  let data = state.rawData || [];
  if(state.yearFilter){
    data = data.filter(r => String(r.Year) === String(state.yearFilter));
  }
  // set rawData view
  const kpis = computeKPIsForData(data);
  renderKPIs(kpis);

  // chart & forecast
  const tr = buildTrendForData(data);
  renderChart(tr.labels || [], tr.datasets || []);
  const fc = computeForecastForData(data);
  if(fc){
    $('forecastValue').textContent = formatCurrency(fc.pred);
    const sign = fc.slope > 0 ? (state.lang==='ar' ? t('forecastUp') : t('forecastUp')) : (state.lang==='ar' ? t('forecastDown') : t('forecastDown'));
    $('forecastComment').textContent = `${state.lang==='ar' ? 'التوقع التالي:' : 'Next forecast:'} ${formatCurrency(fc.pred)} — ${sign}`;
  } else {
    $('forecastValue').textContent = '—';
    $('forecastComment').textContent = t('forecastNo');
  }
}

/* compute KPIs for a filtered dataset */
function computeKPIsForData(rows){
  rows = rows || [];
  const accounts = rows.length;
  let totalDebit = 0, totalCredit = 0;
  let assets = 0, liabilities = 0, revenue = 0, expense = 0;
  rows.forEach(r=>{
    totalDebit += toNum(r.Debit); totalCredit += toNum(r.Credit);
    const net = toNum(r.Debit) - toNum(r.Credit);
    const s = (r.Type || r.Account || '').toString().toLowerCase();
    if(/asset|أصل|نقد|bank|cash|current asset|fixed asset|أصول/.test(s)) assets += net;
    else if(/liab|خصوم|payable|دائن|قرض|loan/.test(s)) liabilities += -net;
    else if(/revenue|sale|إيراد|مبيعات|income/.test(s)) revenue += -net;
    else if(/expense|مصروف|تكلفة|expense|cogs/.test(s)) expense += net;
    else {
      const a = (r.Account||'').toLowerCase();
      if(/النقد|bank|cash/.test(a)) assets += net;
      else if(/مورد|payable|دائن/.test(a)) liabilities += -net;
      else if(/مبيعات|revenue|sale/.test(a)) revenue += -net;
      else if(/مصروف|expense|تكلفة/.test(a)) expense += net;
    }
  });
  return {accounts, assets, liabilities, totalDebit, totalCredit, revenue, expense};
}

/* trend/forecast for given dataset (same logic as before but local) */
function buildTrendForData(rows){
  rows = rows || [];
  const yearsMap = {}; let hasYear = false;
  rows.forEach(r=>{
    if(r.Year){ hasYear = true; const y = String(r.Year); yearsMap[y] = yearsMap[y] || {revenue:0, expense:0}; yearsMap[y].revenue += toNum(r.Credit); yearsMap[y].expense += toNum(r.Debit); }
  });
  if(hasYear){
    const labels = Object.keys(yearsMap).sort();
    const net = labels.map(y => Math.round(yearsMap[y].revenue - yearsMap[y].expense));
    const datasets = [{ label: state.lang==='ar' ? 'صافي الربح' : 'Net Profit', data: net, borderColor:getAccent(0), tension:0.3, fill:false }];
    return {labels, datasets};
  } else {
    const chunk = 10; const points = [];
    for(let i=0;i<rows.length;i+=chunk){
      const slice = rows.slice(i,i+chunk);
      const net = slice.reduce((s,r)=> s + (toNum(r.Credit) - toNum(r.Debit)),0);
      points.push(Math.round(net));
    }
    const labels = points.map((_,i)=> `P${i+1}`);
    const datasets = [{ label: state.lang==='ar' ? 'صافي (نقاط)' : 'Net (pts)', data: points, borderColor:getAccent(0), tension:0.3, fill:false }];
    return {labels, datasets};
  }
}

function computeForecastForData(rows){
  try{
    const tr = buildTrendForData(rows);
    if(!tr.labels || tr.labels.length < 2) return null;
    const y = tr.datasets[0].data.map(v => Number(v));
    const x = y.map((_,i)=> i+1);
    const n = x.length;
    const sumX = x.reduce((a,b)=>a+b,0), sumY = y.reduce((a,b)=>a+b,0);
    const sumXY = x.reduce((s,xi,i)=> s + xi*y[i],0);
    const sumX2 = x.reduce((s,xi)=> s + xi*xi,0);
    const denom = (n*sumX2 - sumX*sumX) || 1;
    const slope = (n*sumXY - sumX*sumY)/denom;
    const intercept = (sumY - slope*sumX)/n;
    const nextX = n+1;
    const pred = intercept + slope * nextX;
    return {pred, slope, intercept};
  }catch(e){ return null; }
}

/* utility: populate year filter from available localStorage data */
function populateYearFilter(){
  const yr = $('yearFilter'); yr.innerHTML = '';
  const years = new Set();
  SOURCE_KEYS.forEach(s=>{
    try{
      const raw = JSON.parse(localStorage.getItem(s.k) || 'null');
      if(Array.isArray(raw)){
        raw.forEach(r => {
          if(r && (r.Year || r.year || r.YYYY)) years.add(String(r.Year || r.year || r.YYYY));
        });
      } else if(typeof raw === 'object' && raw !== null){
        Object.values(raw).forEach(v=>{
          if(Array.isArray(v)) v.forEach(it => { if(it && (it.Year || it.year || it.YYYY)) years.add(String(it.Year || it.year || it.YYYY)); });
        });
      }
    }catch(e){}
  });
  const sorted = Array.from(years).sort();
  if(sorted.length){
    const oAll = document.createElement('option'); oAll.value=''; oAll.textContent = state.lang==='ar' ? 'الكل' : 'All'; yr.appendChild(oAll);
    sorted.forEach(y => { const o = document.createElement('option'); o.value = y; o.textContent = y; yr.appendChild(o); });
  } else {
    const o = document.createElement('option'); o.value=''; o.textContent = state.lang==='ar' ? 'الكل' : 'All'; yr.appendChild(o);
  }
}

/* Export PDF using html2pdf */
function exportPdf(){
  const el = document.querySelector('.container-main');
  const oldTheme = document.body.getAttribute('data-theme');
  // force light theme for print readability
  document.body.setAttribute('data-theme','light');
  const opt = {
    margin:0.35, filename: 'dashboard_report.pdf',
    image:{type:'jpeg',quality:0.95},
    html2canvas:{scale:2,useCORS:true},
    jsPDF:{unit:'in',format:'a4',orientation:'portrait'}
  };
  html2pdf().set(opt).from(el).save().finally(()=> { document.body.setAttribute('data-theme', oldTheme || 'dark'); });
}

/* Init runner */
(function bootstrap(){
  // restore state
  state.lang = localStorage.getItem('dash_lang') || state.lang;
  state.theme = localStorage.getItem('dash_theme') || state.theme;
  state.currency = localStorage.getItem('dash_currency') || state.currency;
  state.sourceKey = localStorage.getItem('dash_source') || state.sourceKey;
  state.combine = localStorage.getItem('dash_combine') === '1' ? true : state.combine;

  init();
  // if there's a preselected source & not combine -> load it
  if(state.combine) loadCombined();
  else if(state.sourceKey) loadData();
})();
</script>
</body>
</html>
