<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± â€” Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

<style>
body { font-family: Arial, sans-serif; background: #f8f9fa; }
.site-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #0d6efd; color: #fff; }
.site-header img.logo { height: 40px; margin-left:10px; }
.controls select, .controls button { margin-left: 8px; }
.watermark { position: fixed; top: 30%; left: 30%; z-index: 0; opacity: 0.06; filter: grayscale(100%); pointer-events:none; }
.report-block table { width:100%; border-collapse: collapse; margin-top:5px; }
.report-block th, .report-block td { border:1px solid #ccc; padding:6px 10px; text-align:center; }
.report-block th { background:#e9ecef; }
.card { position: relative; z-index:1; }
</style>
</head>
<body>

<header class="site-header">
  <div class="d-flex align-items-center">
    <img src="assets/logo.png" class="logo" alt="logo">
    <strong>Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ</strong>
  </div>
  <div class="controls d-flex align-items-center">
    <label style="margin-left:8px;">
      <input type="checkbox" id="darkModeToggle" /> ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ†
    </label>
    <select id="currencySelect">
      <option value="EGP">Ø¬Ù†ÙŠÙ‡</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
    </select>
    <select id="langSelect">
      <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
      <option value="en">English</option>
    </select>
    <button id="exportAll" class="btn btn-warning btn-sm">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
    <button id="printReport" class="btn btn-secondary btn-sm">ğŸ–¨ï¸ PDF</button>
  </div>
</header>

<div class="watermark">
  <img src="assets/logo.png" style="height:220px;">
</div>

<main class="container py-4" id="report-area">
  <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ÙØµÙ„Ø©</h2>
  <p>Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ÙØµÙ„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹.</p>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <div class="report-title">ğŸ“Š Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
        <div id="trialBalanceReport" class="report-block"></div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <div class="report-title">ğŸ“‘ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</div>
        <div id="incomeStatementReport" class="report-block"></div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <div class="report-title">ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</div>
        <div id="balanceSheetReport" class="report-block"></div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <div class="report-title">ğŸ’µ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</div>
        <div id="cashFlowReport" class="report-block"></div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
// ====== Dark Mode ======
const darkToggle = document.getElementById('darkModeToggle');
darkToggle.addEventListener('change', ()=> {
  document.body.classList.toggle('bg-dark');
  document.body.classList.toggle('text-light');
});

// ====== Render Reports ======
function renderReports() {
  const session = loadSession();
  if (!session || !session.trial) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ±');

  document.getElementById('trialBalanceReport').innerHTML = renderTrialBalance(session.trial);
  document.getElementById('incomeStatementReport').innerHTML = renderIncomeStatement(session.trial);
  document.getElementById('balanceSheetReport').innerHTML = renderBalanceSheet(session.trial);
  document.getElementById('cashFlowReport').innerHTML = renderCashFlow(session.trial);
}

// ====== Export PDF ======
function exportReportToPdf(elementId, filename){
  const element = document.getElementById(elementId);
  const opt = { margin:0.5, filename, image:{type:'jpeg', quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'a4', orientation:'landscape'} };
  html2pdf().set(opt).from(element).save();
}

// ====== Export Excel ======
function exportActiveReportExcel(){
  const wb = XLSX.utils.book_new();
  const session = loadSession();
  if(!session || !session.trial) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');

  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportTrialBalance(session.trial)), 'Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportIncomeStatement(session.trial)), 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportBalanceSheet(session.trial)), 'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportCashFlow(session.trial)), 'Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©');

  XLSX.writeFile(wb, 'financial-report.xlsx');
}

// ====== Event Listeners ======
document.getElementById('exportAll').addEventListener('click', exportActiveReportExcel);
document.getElementById('printReport').addEventListener('click', ()=> exportReportToPdf('report-area','financial-report.pdf'));

// ====== Initial Render ======
renderReports();
</script>
</body>
</html>
