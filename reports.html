<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© | Financial Analyzer</title>

<!-- Bootstrap RTL -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f9f9f9; transition:0.3s; }
  header { background:#007bff; color:white; padding:0.5rem 1rem; display:flex; justify-content:space-between; align-items:center; }
  header .logo { height:40px; margin-left:0.5rem; }
  header .controls select, header .controls button { margin-left:0.5rem; }
  .watermark { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); opacity:0.05; z-index:0; pointer-events:none; }
  main { position:relative; z-index:1; padding:2rem; }
  .card { box-shadow:0 0 10px rgba(0,0,0,0.1); }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; text-align:center; border:1px solid #ccc; }
  th { background:#f0f0f0; }
  .tab { display:flex; border-bottom:1px solid #ddd; margin-bottom:1rem; }
  .tab button { background:none; border:none; padding:0.5rem 1rem; cursor:pointer; }
  .tab button.active { border-bottom:2px solid #007bff; font-weight:bold; }
  .dark-mode { background:#121212; color:#f0f0f0; }
  .dark-mode table th { background:#1f1f1f; }
  .dark-mode table td, .dark-mode table th { border-color:#333; }
</style>
</head>
<body class="light-mode">

<header>
  <div class="d-flex align-items-center">
    <img src="assets/logo.png" alt="logo" class="logo">
    <strong>Financial Analyzer</strong>
  </div>
  <div class="controls d-flex align-items-center">
    <select id="currencySelect" class="form-select form-select-sm">
      <option value="EGP">Ø¬Ù†ÙŠÙ‡</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
    </select>
    <button id="toggleDarkMode" class="btn btn-outline-light btn-sm">Dark/Light</button>
    <select id="langSelect" class="form-select form-select-sm">
      <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
      <option value="en">English</option>
    </select>
  </div>
</header>

<div class="watermark">
  <img src="assets/logo.png" alt="watermark" style="height:200px;">
</div>

<main>
  <h2 class="mb-4 text-center">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>

  <!-- Tabs -->
  <div class="tab mb-3">
    <button class="tablinks active" data-tab="trialBalance">Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
    <button class="tablinks" data-tab="incomeStatement">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</button>
    <button class="tablinks" data-tab="balanceSheet">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</button>
    <button class="tablinks" data-tab="cashFlow">Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</button>
    <button class="tablinks" data-tab="advancedAnalysis">ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù…</button>
  </div>

  <!-- Tab Contents -->
  <div id="trialBalance" class="tabcontent">
    <div class="card p-3 mb-3">
      <h5>ğŸ“Š Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h5>
      <div id="trialBalanceReport"></div>
    </div>
  </div>

  <div id="incomeStatement" class="tabcontent" style="display:none;">
    <div class="card p-3 mb-3">
      <h5>ğŸ“‘ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</h5>
      <div id="incomeStatementReport"></div>
    </div>
  </div>

  <div id="balanceSheet" class="tabcontent" style="display:none;">
    <div class="card p-3 mb-3">
      <h5>ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</h5>
      <div id="balanceSheetReport"></div>
    </div>
  </div>

  <div id="cashFlow" class="tabcontent" style="display:none;">
    <div class="card p-3 mb-3">
      <h5>ğŸ’µ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</h5>
      <div id="cashFlowReport"></div>
    </div>
  </div>

  <div id="advancedAnalysis" class="tabcontent" style="display:none;">
    <div class="card p-3 mb-3">
      <h5>âš¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h5>
      <div id="advancedRatios"></div>
      <canvas id="advancedChart" height="300"></canvas>
    </div>
  </div>

  <div class="mt-4 text-center">
    <button id="exportExcel" class="btn btn-success">ğŸ“¤ ØªØµØ¯ÙŠØ± Excel</button>
    <button id="exportPDF" class="btn btn-primary">ğŸ–¨ï¸ ØªØµØ¯ÙŠØ± PDF</button>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
  // ---- Tabs ----
  const tablinks = document.querySelectorAll(".tablinks");
  const tabcontents = document.querySelectorAll(".tabcontent");
  tablinks.forEach(btn => {
    btn.addEventListener("click", () => {
      tabcontents.forEach(tc => tc.style.display = "none");
      tablinks.forEach(tl => tl.classList.remove("active"));
      document.getElementById(btn.dataset.tab).style.display = "block";
      btn.classList.add("active");
    });
  });

  // ---- Dark Mode ----
  document.getElementById("toggleDarkMode").addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
  });

  // ---- Language Change ----
  document.getElementById("langSelect").addEventListener("change", (e) => {
    const lang = e.target.value;
    // Ù…Ø«Ø§Ù„: ØªØºÙŠÙŠØ± Ø§Ù„Ù†ØµÙˆØµ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      if(lang==="en"){ el.innerText = el.dataset.i18n; }
      else{ el.innerText = el.dataset.i18n; } // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªØ±Ø¬Ù…Ø© ÙØ¹Ù„ÙŠØ©
    });
  });

  // ---- Currency Change ----
  document.getElementById("currencySelect").addEventListener("change", (e)=>{
    const currency = e.target.value;
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    // Ù…Ø«Ø§Ù„: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
  });

  // ---- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù€Report ----
  function loadReportData() {
    // Ù…Ø«Ø§Ù„: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€sessionStorage Ø£Ùˆ Ø£ÙŠ Ù…ØµØ¯Ø±
    const data = JSON.parse(sessionStorage.getItem("financialReport"));
    return data || {};
  }

  function renderReports() {
    const data = loadReportData();
    if(!data.trialBalance){ document.getElementById("trialBalanceReport").innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"; return; }

    // --- Ù…Ø«Ø§Ù„ Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„Ø© ---
    const trialTable = `<table>
      <thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th></tr></thead>
      <tbody>
        ${data.trialBalance.map(r=>`<tr><td>${r.account}</td><td>${r.debit}</td><td>${r.credit}</td></tr>`).join("")}
      </tbody>
    </table>`;
    document.getElementById("trialBalanceReport").innerHTML = trialTable;

    // Ù†ÙØ³ Ø§Ù„ÙÙƒØ±Ø© Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    document.getElementById("incomeStatementReport").innerHTML = `<pre>${JSON.stringify(data.incomeStatement,null,2)}</pre>`;
    document.getElementById("balanceSheetReport").innerHTML = `<pre>${JSON.stringify(data.balanceSheet,null,2)}</pre>`;
    document.getElementById("cashFlowReport").innerHTML = `<pre>${JSON.stringify(data.cashFlow,null,2)}</pre>`;

    // ---- Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ----
    const advancedRatiosHTML = `
      <table>
        <thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„Ø´Ø±Ø­</th></tr></thead>
        <tbody>
          <tr><td>Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</td><td>${(Math.random()*20+5).toFixed(2)}%</td><td>ØªÙˆÙ‚Ø¹ Ù†Ù…Ùˆ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</td></tr>
          <tr><td>Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒ</td><td>${(Math.random()*10).toFixed(2)}</td><td>ØªÙ‚ÙŠÙŠÙ… ØªÙ‚Ù„Ø¨Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ ÙˆØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©</td></tr>
          <tr><td>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</td><td>${(Math.random()*5000).toFixed(0)}</td><td>Ù‚ÙŠÙ…Ø© Ù…Ø¶Ø§ÙØ© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø¹Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„</td></tr>
        </tbody>
      </table>
    `;
    document.getElementById("advancedRatios").innerHTML = advancedRatiosHTML;

    // ---- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù…ØªÙ‚Ø¯Ù… ----
    const ctx = document.getElementById("advancedChart").getContext("2d");
    new Chart(ctx,{
      type:'bar',
      data:{
        labels:['Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹','Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒ','Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©'],
        datasets:[{label:'Ø§Ù„Ù‚ÙŠÙ…Ø©',data:[15,5,3000],backgroundColor:['#007bff','#dc3545','#28a745'] }]
      },
      options:{ responsive:true, plugins:{legend:{display:false}} }
    });
  }

  // ---- Export Excel ----
  document.getElementById("exportExcel").addEventListener("click",()=>{
    const data = loadReportData();
    if(!data.trialBalance){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±"); return; }
    const wb = XLSX.utils.book_new();
    wb.Props = {Title:"Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©", Author:"Financial Analyzer"};
    wb.SheetNames.push("Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");
    wb.Sheets["Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"] = XLSX.utils.json_to_sheet(data.trialBalance);
    XLSX.writeFile(wb,"advanced-financial-report.xlsx");
  });

  // ---- Export PDF ----
  document.getElementById("exportPDF").addEventListener("click",()=>{
    const element = document.body;
    html2pdf().set({margin:0.5,filename:"advanced-financial-report.pdf"}).from(element).save();
  });

  renderReports();
</script>
</body>
</html>
