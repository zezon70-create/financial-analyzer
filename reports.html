<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>التقارير — المحلل المالي</title>

  <!-- Bootstrap RTL -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
    .site-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #0d6efd; color: #fff; }
    .site-header .logo { height: 40px; margin-left: 10px; }
    .controls select, .controls input[type=checkbox], .controls button { margin-left: 10px; }
    .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.05; z-index: 0; }
    .watermark img { width: 300px; }
    main { position: relative; z-index: 1; }
    .report-block table { width: 100%; border-collapse: collapse; }
    .report-block th, .report-block td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
    .report-block th { background: #f5f5f5; }
    .report-title { margin-bottom: 10px; font-weight: bold; font-size: 1.1rem; }
    .nav-tabs .nav-link.active { background-color: #0d6efd; color: #fff; }
    .nav-tabs .nav-link { color: #0d6efd; }
    .dark-mode { background-color: #121212 !important; color: #eee; }
    .dark-mode table, .dark-mode th, .dark-mode td { border-color: #555; }
    .dark-mode th { background-color: #1e1e1e; }
  </style>
</head>
<body>

<header class="site-header">
  <div class="d-flex align-items-center">
    <img src="assets/logo.png" class="logo" alt="logo">
    <strong>المحلل المالي</strong>
  </div>
  <div class="controls d-flex align-items-center">
    <label><input type="checkbox" id="toggleDark"> Dark Mode</label>
    <select id="currencySelect" class="form-select form-select-sm">
      <option value="EGP">جنيه</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
    </select>
    <select id="languageSelect" class="form-select form-select-sm">
      <option value="ar">العربية</option>
      <option value="en">English</option>
    </select>
    <button id="exportExcel" class="btn btn-warning btn-sm">تصدير Excel</button>
    <button id="printPDF" class="btn btn-secondary btn-sm">طباعة PDF</button>
  </div>
</header>

<div class="watermark">
  <img src="assets/logo.png" alt="watermark">
</div>

<nav>
  <ul class="nav nav-tabs justify-content-center mt-3" id="reportTabs">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#trialBalanceTab">📊 ميزان المراجعة</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#incomeStatementTab">📑 قائمة الدخل</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#balanceSheetTab">💰 الميزانية العمومية</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#cashFlowTab">💵 التدفقات النقدية</a>
    </li>
  </ul>
</nav>

<main class="container py-4">
  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="trialBalanceTab">
      <div class="card shadow-sm p-3">
        <div class="report-title">📊 ميزان المراجعة</div>
        <div id="trialBalanceReport" class="report-block"></div>
      </div>
    </div>
    <div class="tab-pane fade" id="incomeStatementTab">
      <div class="card shadow-sm p-3">
        <div class="report-title">📑 قائمة الدخل</div>
        <div id="incomeStatementReport" class="report-block"></div>
      </div>
    </div>
    <div class="tab-pane fade" id="balanceSheetTab">
      <div class="card shadow-sm p-3">
        <div class="report-title">💰 الميزانية العمومية</div>
        <div id="balanceSheetReport" class="report-block"></div>
      </div>
    </div>
    <div class="tab-pane fade" id="cashFlowTab">
      <div class="card shadow-sm p-3">
        <div class="report-title">💵 التدفقات النقدية</div>
        <div id="cashFlowReport" class="report-block"></div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
  // Dark Mode
  const toggleDark = document.getElementById('toggleDark');
  toggleDark.addEventListener('change', () => {
    document.body.classList.toggle('dark-mode', toggleDark.checked);
  });

  // Currency & Language
  const currencySelect = document.getElementById('currencySelect');
  const languageSelect = document.getElementById('languageSelect');

  currencySelect.addEventListener('change', () => {
    // تحديث كل القيم المعروضة حسب العملة
    renderReports();
  });

  languageSelect.addEventListener('change', () => {
    // تحديث النصوص حسب اللغة
    renderReports();
  });

  // بيانات تجريبية (يمكن استبدالها بالبيانات الحقيقية القادمة من Advanced.html)
  const session = {
    trial: [
      { account: "النقدية", debit: 50000, credit: 0 },
      { account: "المبيعات", debit: 0, credit: 120000 },
      { account: "المصروفات", debit: 30000, credit: 0 }
    ]
  };

  // دوال عرض القوائم المالية
  function renderTrialBalance(trial) {
    let html = '<table><thead><tr><th>الحساب</th><th>مدين</th><th>دائن</th></tr></thead><tbody>';
    trial.forEach(t => {
      html += `<tr><td>${t.account}</td><td>${t.debit}</td><td>${t.credit}</td></tr>`;
    });
    html += '</tbody></table>';
    return html;
  }

  function renderIncomeStatement(trial) {
    let revenue = trial.filter(t => t.credit > 0).reduce((a,b)=>a+b.credit,0);
    let expenses = trial.filter(t => t.debit > 0).reduce((a,b)=>a+b.debit,0);
    let netIncome = revenue - expenses;
    return `<table>
      <thead><tr><th>الوصف</th><th>المبلغ</th></tr></thead>
      <tbody>
        <tr><td>الإيرادات</td><td>${revenue}</td></tr>
        <tr><td>المصروفات</td><td>${expenses}</td></tr>
        <tr><td>صافي الدخل</td><td>${netIncome}</td></tr>
      </tbody>
    </table>`;
  }

  function renderBalanceSheet(trial) {
    let assets = trial.filter(t=>t.debit>0).reduce((a,b)=>a+b.debit,0);
    let liabilities = trial.filter(t=>t.credit>0).reduce((a,b)=>a+b.credit,0);
    return `<table>
      <thead><tr><th>البند</th><th>المبلغ</th></tr></thead>
      <tbody>
        <tr><td>الأصول</td><td>${assets}</td></tr>
        <tr><td>الخصوم</td><td>${liabilities}</td></tr>
      </tbody>
    </table>`;
  }

  function renderCashFlow(trial) {
    let inflow = trial.filter(t=>t.credit>0).reduce((a,b)=>a+b.credit,0);
    let outflow = trial.filter(t=>t.debit>0).reduce((a,b)=>a+b.debit,0);
    let netCash = inflow - outflow;
    return `<table>
      <thead><tr><th>البند</th><th>المبلغ</th></tr></thead>
      <tbody>
        <tr><td>التدفقات الداخلة</td><td>${inflow}</td></tr>
        <tr><td>التدفقات الخارجة</td><td>${outflow}</td></tr>
        <tr><td>صافي النقدية</td><td>${netCash}</td></tr>
      </tbody>
    </table>`;
  }

  // تصدير Excel
  document.getElementById('exportExcel').addEventListener('click', () => {
    const wb = XLSX.utils.book_new();
    wb.Props = { Title: "Financial Report" };
    wb.SheetNames.push("Trial Balance");
    wb.SheetNames.push("Income Statement");
    wb.SheetNames.push("Balance Sheet");
    wb.SheetNames.push("Cash Flow");

    const toSheet = arr => XLSX.utils.json_to_sheet(arr.map(t=>({الحساب:t.account, مدين:t.debit, دائن:t.credit})));
    wb.Sheets["Trial Balance"] = toSheet(session.trial);
    wb.Sheets["Income Statement"] = XLSX.utils.json_to_sheet([{الإيرادات: 120000, المصروفات: 30000, صافي_الدخل: 90000}]);
    wb.Sheets["Balance Sheet"] = XLSX.utils.json_to_sheet([{الأصول:50000, الخصوم:120000}]);
    wb.Sheets["Cash Flow"] = XLSX.utils.json_to_sheet([{التدفقات_الداخل:120000, التدفقات_الخارج:50000, صافي_النقدية:70000}]);

    XLSX.writeFile(wb, 'financial-report.xlsx');
  });

  // Print PDF
  document.getElementById('printPDF').addEventListener('click', () => {
    const element = document.body;
    html2pdf().from(element).set({ filename: 'financial-report.pdf' }).save();
  });

  function renderReports() {
    document.getElementById('trialBalanceReport').innerHTML = renderTrialBalance(session.trial);
    document.getElementById('incomeStatementReport').innerHTML = renderIncomeStatement(session.trial);
    document.getElementById('balanceSheetReport').innerHTML = renderBalanceSheet(session.trial);
    document.getElementById('cashFlowReport').innerHTML = renderCashFlow(session.trial);
  }

  renderReports();
</script>

</body>
</html>
