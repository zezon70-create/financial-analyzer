<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>التحليلات المالية التفاعلية | Financial Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; transition: background 0.3s, color 0.3s;}
.light-mode { background:#f4f4f4; color:#333;}
.dark-mode { background:#1e1e1e; color:#f4f4f4;}
header { background:#007bff; color:white; display:flex; align-items:center; justify-content:space-between; padding:0.5rem 1rem; }
header .logo { height:40px; }
header select, header button { margin-left:0.5rem; cursor:pointer;}
.watermark { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); opacity:0.05; z-index:-1;}
main { padding:1rem; max-width:1400px; margin:auto;}
.card { background:white; border-radius:0.5rem; box-shadow:0 2px 12px rgba(0,0,0,0.15); margin-bottom:1rem; padding:1rem; transition: transform 0.2s;}
.card:hover { transform: translateY(-3px);}
.dark-mode .card { background:#2b2b2b; color:#f4f4f4;}
.card-header { font-weight:bold; font-size:1rem; margin-bottom:0.5rem; }
table { width:100%; border-collapse:collapse; margin-top:0.5rem;}
th, td { padding:0.5rem; border:1px solid #ccc; text-align:center; font-size:0.9rem;}
th { background:#eee; }
.dark-mode th { background:#444; }
.chart-container { width:100%; height:300px; margin-top:1rem; }
.slider-container { display:flex; align-items:center; margin:0.5rem 0; gap:0.5rem;}
footer { text-align:center; padding:1rem; background:#eee; margin-top:2rem; font-size:0.9rem;}
</style>
</head>
<body class="light-mode">

<header>
  <div class="d-flex align-items-center">
    <img src="assets/logo.png" alt="logo" class="logo">
    <span style="margin-right:0.5rem;">Financial Analyzer</span>
  </div>
  <div>
    <select id="currencySelect">
      <option value="EGP">جنيه</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
    </select>
    <button id="toggleDarkMode">وضع</button>
    <button id="toggleLanguage">EN / AR</button>
  </div>
</header>

<div class="watermark">
  <img src="assets/logo.png" alt="watermark" height="300">
</div>

<main>
  <h1 style="text-align:center;">💎 التحليلات المالية التفاعلية</h1>
  <p style="text-align:center;">تفاعلات ديناميكية لجميع المؤشرات المالية والقيم المضافة والمخاطر والتنبؤات بناءً على بيانات ميزان المراجعة.</p>

  <div class="slider-container">
    <label for="riskMultiplier">مستوى المخاطر:</label>
    <input type="range" id="riskMultiplier" min="0.8" max="1.5" step="0.05" value="1">
    <span id="riskValue">1.00</span>
  </div>

  <div id="ratiosContainer"></div>
  <div id="chartsContainer"></div>
</main>

<footer>
  &copy; 2025 المحلل المالي — Financial Analyzer
</footer>

<script>
let isDarkMode = false;
let currentLang = localStorage.getItem('lang')||'ar';
let currentCurrency = localStorage.getItem('currency')||'EGP';
let trialData = JSON.parse(localStorage.getItem('trialData')||'[]');

function calculateTotals(data){
  let totals = {assets:0, liabilities:0, equity:0, revenue:0, netProfit:0, cost:0, inventory:0, cash:0, accountsReceivable:0, interest:0};
  data.forEach(row=>{
    totals.assets += parseFloat(row.Debit||0);
    totals.liabilities += parseFloat(row.Credit||0);
    totals.equity += parseFloat(row.Credit||0)*0.5;
    totals.revenue += parseFloat(row.Credit||0);
    totals.netProfit += parseFloat(row.Credit||0)-parseFloat(row.Debit||0);
    totals.cost += parseFloat(row.Debit||0)*0.7;
    totals.inventory += parseFloat(row.Debit||0)*0.5;
    totals.cash += parseFloat(row.Debit||0)*0.3;
    totals.accountsReceivable += parseFloat(row.Debit||0)*0.4;
    totals.interest += parseFloat(row.Debit||0)*0.1;
  });
  return totals;
}

function calculateRatios(data,riskMultiplier){
  const totals = calculateTotals(data);
  const predictiveMultiplier = { best:1.2*riskMultiplier, normal:1.1*riskMultiplier, conservative:1.05*riskMultiplier };
  return {
    السيولة:[
      { name:'النسبة الحالية', value:(totals.assets/totals.liabilities).toFixed(2), explanation:'قدرة الشركة على تغطية الالتزامات القصيرة الأجل.'},
      { name:'النسبة السريعة', value:((totals.assets - totals.inventory)/totals.liabilities).toFixed(2), explanation:'السيولة بدون المخزون.'},
      { name:'السيولة النقدية', value:(totals.cash/totals.liabilities).toFixed(2), explanation:'قدرة النقد الفوري على تغطية الالتزامات.'}
    ],
    الربحية:[
      { name:'هامش الربح الصافي', value:((totals.netProfit/totals.revenue*100).toFixed(2))+'%', explanation:'نسبة صافي الربح من الإيرادات.'},
      { name:'العائد على الأصول', value:((totals.netProfit/totals.assets*100).toFixed(2))+'%', explanation:'كفاءة استخدام الأصول لتحقيق الأرباح.'},
      { name:'العائد على حقوق الملكية', value:((totals.netProfit/totals.equity*100).toFixed(2))+'%', explanation:'العائد على الأموال المستثمرة.'}
    ],
    النشاط:[
      { name:'دوران المخزون', value:(totals.cost/totals.inventory).toFixed(2), explanation:'عدد مرات دوران المخزون.'},
      { name:'دوران الذمم المدينة', value:(totals.revenue/totals.accountsReceivable).toFixed(2), explanation:'سرعة تحصيل المستحقات.'},
      { name:'مؤشر النشاط الشامل', value:(totals.revenue/totals.assets).toFixed(2), explanation:'كفاءة استخدام الأصول لتوليد الإيرادات.'}
    ],
    المديونية:[
      { name:'نسبة المديونية', value:((totals.liabilities/totals.assets*100).toFixed(2))+'%', explanation:'نسبة التمويل بالدين مقارنة بالأصول.'},
      { name:'الدين إلى حقوق الملكية', value:(totals.liabilities/totals.equity).toFixed(2), explanation:'هيكل رأس المال.'},
      { name:'مؤشر المخاطر المالي', value:((totals.liabilities/(totals.assets+totals.equity)*100).toFixed(2))+'%', explanation:'تقدير لمخاطر الشركة المالية.'}
    ],
    القيم_المضافة:[
      { name:'القيمة المضافة الصافية', value:(totals.netProfit - totals.interest).toFixed(2), explanation:'القيمة المالية المضافة بعد الفوائد.'},
      { name:'العائد على القيمة المضافة', value:(((totals.netProfit - totals.interest)/totals.assets*100).toFixed(2))+'%', explanation:'العائد على القيمة المضافة للأصول.'}
    ],
    التنبؤات:[
      { name:'توقع الإيرادات (أفضل سيناريو)', value:(totals.revenue*predictiveMultiplier.best).toFixed(2), explanation:'تقدير الإيرادات في أفضل السيناريوهات.'},
      { name:'توقع الإيرادات (سيناريو عادي)', value:(totals.revenue*predictiveMultiplier.normal).toFixed(2), explanation:'تقدير الإيرادات في السيناريو الطبيعي.'},
      { name:'توقع الإيرادات (سيناريو محافظ)', value:(totals.revenue*predictiveMultiplier.conservative).toFixed(2), explanation:'تقدير الإيرادات في السيناريو المحافظ.'}
    ]
  };
}

function renderTables(ratios){
  const container = document.getElementById('ratiosContainer'); container.innerHTML='';
  for (let category in ratios){
    let card = document.createElement('div'); card.className='card';
    card.innerHTML=`<div class="card-header">${category}</div>
      <div class="card-body">
        <table>
          <thead><tr><th>النسبة</th><th>القيمة</th><th>التفسير</th></tr></thead>
          <tbody>${ratios[category].map(r=>`<tr><td>${r.name}</td><td>${r.value}</td><td>${r.explanation}</td></tr>`).join('')}</tbody>
        </table>
      </div>`;
    container.appendChild(card);
  }
}

let chartInstances = {};
function renderCharts(ratios){
  const chartsContainer=document.getElementById('chartsContainer'); chartsContainer.innerHTML='';
  for(let category in ratios){
    let card=document.createElement('div'); card.className='card'; card.style.marginTop='1rem';
    card.innerHTML=`<div class="card-header">رسم بياني ثلاثي الأبعاد: ${category}</div>
      <div class="card-body"><canvas id="${category}Chart" height="250"></canvas></div>`;
    chartsContainer.appendChild(card);

    if(chartInstances[category]) chartInstances[category].destroy();
    chartInstances[category]=new Chart(document.getElementById(category+'Chart').getContext('2d'),{
      type:'bar',
      data:{ labels:ratios[category].map(r=>r.name), datasets:[{ label:'القيمة', data:ratios[category].map(r=>parseFloat(r.value)), backgroundColor:'rgba(0,123,255,0.6)', borderColor:'#0056b3', borderWidth:2, borderRadius:10, hoverBackgroundColor:'rgba(0,123,255,0.9)'}]},
      options:{
        responsive:true,
        plugins:{ legend:{ display:false } },
        scales:{ y:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,0.1)' } }, x:{ grid:{ color:'rgba(0,0,0,0.1)' } } }
      }
    });
  }
}

document.getElementById('toggleDarkMode').onclick = ()=>{
  isDarkMode=!isDarkMode;
  document.body.className=isDarkMode?'dark-mode':'light-mode';
};

document.getElementById('toggleLanguage').onclick = ()=>{
  currentLang=currentLang==='ar'?'en':'ar';
  localStorage.setItem('lang',currentLang);
  alert('تم تغيير اللغة إلى '+currentLang);
};

document.getElementById('currencySelect').onchange = (e)=>{
  currentCurrency=e.target.value;
  localStorage.setItem('currency',currentCurrency);
  alert('تم تغيير العملة إلى '+currentCurrency);
};

document.getElementById('riskMultiplier').oninput = (e)=>{
  let val=parseFloat(e.target.value).toFixed(2);
  document.getElementById('riskValue').innerText=val;
  const ratios=calculateRatios(trialData,val);
  renderTables(ratios); renderCharts(ratios);
};

function init(){
  if(trialData.length===0){ alert('لا توجد بيانات ميزان المراجعة، يرجى ملؤها في صفحة الإدخال.'); return; }
  const ratios=calculateRatios(trialData,1);
  renderTables(ratios);
  renderCharts(ratios);
}

init();
</script>
</body>
</html>
