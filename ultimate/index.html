<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Financial Analyzer — Ultimate</title>
  <meta name="description" content="Ultimate Production-ready Financial Analyzer">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS for XLSX parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>html,body,#app{height:100%} body{font-family:Cairo,Inter,system-ui;} .fade-enter{opacity:0;transform:translateY(6px)} .fade-enter-active{transition:all .25s ease;opacity:1;transform:none}</style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div id="app" class="min-h-screen flex flex-col">
    <header class="bg-white shadow-sm">
      <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="assets/logo.png" alt="logo" class="w-10 h-10 rounded" />
          <div>
            <h1 class="text-lg font-semibold">المحلل المالي — Ultimate</h1>
            <p class="text-sm text-gray-500">تحليلات ونسب وتقارير احترافية</p>
          </div>
        </div>
        <nav class="flex items-center gap-3">
          <button id="nav-upload" class="btn-primary px-3 py-2 rounded bg-blue-600 text-white">رفع بيانات</button>
          <button id="nav-dashboard" class="px-3 py-2 rounded hover:bg-gray-100">لوحة التحكم</button>
          <button id="nav-report" class="px-3 py-2 rounded hover:bg-gray-100">تقرير</button>
          <button id="nav-compare" class="px-3 py-2 rounded hover:bg-gray-100">مقارنة</button>
        </nav>
      </div>
    </header>

    <main class="container mx-auto px-4 py-6 flex-1">
      <div id="view-root">
        <!-- Views injected here -->
      </div>
    </main>

    <footer class="bg-white border-t">
      <div class="container mx-auto px-4 py-4 text-sm text-gray-500">© 2025 Financial Analyzer — Ultimate</div>
    </footer>
  </div>

<script type="module">
const year = new Date().getFullYear();
document.querySelector('footer div').textContent = `© $2025 Financial Analyzer — Ultimate`;

// Router-like navigation
const views = {
  upload: uploadView,
  dashboard: dashboardView,
  report: reportView,
  compare: compareView
};
function render(viewName){ document.getElementById('view-root').innerHTML = ''; views[viewName](); }
document.getElementById('nav-upload').addEventListener('click', ()=>render('upload'));
document.getElementById('nav-dashboard').addEventListener('click', ()=>render('dashboard'));
document.getElementById('nav-report').addEventListener('click', ()=>render('report'));
document.getElementById('nav-compare').addEventListener('click', ()=>render('compare'));

render('dashboard'); // initial

// Utilities
function sanitizeText(s){ return String(s).replace(/[<>]/g,''); }
function parseCSV(text){ const rows = text.split(/\r?\n/).map(r=>r.trim()).filter(r=>r); return rows.map(r=>{ const cols = r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/); return cols.map(c=>c.replace(/^"|"$/g,'').trim()); }); }

// IndexedDB simple wrapper
const DB = (function(){
  const name = 'fa_ultimate_db', ver = 1;
  let db = null;
  function open(){ return new Promise((res,rej)=>{ if(db) return res(db); const rq = indexedDB.open(name, ver); rq.onupgradeneeded = e=>{ db = e.target.result; if(!db.objectStoreNames.contains('projects')) db.createObjectStore('projects',{keyPath:'id'}); }; rq.onsuccess = e=>{ db = e.target.result; res(db); }; rq.onerror = e=>rej(e); }); }
  async function put(obj){ const d = await open(); return new Promise((res,rej)=>{ const tx = d.transaction('projects','readwrite'); const store = tx.objectStore('projects'); store.put(obj).onsuccess = ()=>res(true); tx.onerror = e=>rej(e); }); }
  async function get(id){ const d = await open(); return new Promise((res,rej)=>{ const tx = d.transaction('projects','readonly'); const store = tx.objectStore('projects'); const rq = store.get(id); rq.onsuccess = ()=>res(rq.result); rq.onerror = e=>rej(e); }); }
  async function all(){ const d = await open(); return new Promise((res,rej)=>{ const tx = d.transaction('projects','readonly'); const store = tx.objectStore('projects'); const rq = store.getAll(); rq.onsuccess = ()=>res(rq.result); rq.onerror = e=>rej(e); }); }
  return {open,put,get,all};
})();

// Views
function uploadView(){
  const root = document.getElementById('view-root');
  const el = document.createElement('div');
  el.innerHTML = `
    <section class="bg-white rounded shadow p-6">
      <h2 class="text-xl font-semibold mb-4">رفع ملف ميزان المراجعة</h2>
      <input id="file-input" type="file" accept=".csv,.xlsx" class="mb-3" />
      <div class="flex gap-2">
        <button id="btn-parse" class="btn-primary px-4 py-2 bg-green-600 text-white rounded">استيراد</button>
        <button id="btn-sample" class="px-4 py-2 rounded border" >استخدم ملف العيّنة</button>
      </div>
      <div id="tb-area" class="mt-4 overflow-auto"></div>
    </section>
  `;
  root.appendChild(el);

  el.querySelector('#btn-sample').addEventListener('click', async ()=>{
    const res = await fetch('samples/sample_trial_balance_ar.csv'); const txt = await res.text(); buildTableFromCSV(txt);
  });

  el.querySelector('#btn-parse').addEventListener('click', ()=>{
    const fi = el.querySelector('#file-input'); if(!fi.files.length){ alert('اختر ملف أولاً'); return; }
    const f = fi.files[0];
    const reader = new FileReader();
    reader.onload = ev=>{
      const txt = ev.target.result;
      // if large use worker
      if(window.Worker && txt.length>20000){
        const w = new Worker('js/worker_parser.js');
        w.postMessage({cmd:'parseCSV', payload: txt});
        w.onmessage = ev2=>{ if(ev2.data.status==='ok'){ buildTableFromRows(ev2.data.rows); } else { buildTableFromCSV(txt); } w.terminate(); };
      } else {
        buildTableFromCSV(txt);
      }
    };
    // If the file is XLSX, use SheetJS parser
    if(f.name.toLowerCase().endsWith('.xlsx')){
      parseXLSX(f, function(rows){ buildTableFromRows(rows); });
      return;
    }
    
    reader.readAsText(f,'utf-8');
  });

  function buildTableFromCSV(txt){ const rows = parseCSV(txt); buildTableFromRows(rows); }
  function buildTableFromRows(rows){
    const area = el.querySelector('#tb-area'); area.innerHTML = '';
    const table = document.createElement('table'); table.className = 'min-w-full text-right'; const thead = document.createElement('thead'); thead.innerHTML = '<tr class="bg-gray-100"><th>الحساب</th><th>مدين</th><th>دائن</th></tr>'; const tbody = document.createElement('tbody');
    rows.forEach(r=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${sanitizeText(r[0]||'')}</td><td>${sanitizeText(r[1]||'0')}</td><td>${sanitizeText(r[2]||'0')}</td>`; tbody.appendChild(tr); });
    table.appendChild(thead); table.appendChild(tbody); area.appendChild(table);
    // save to indexedDB
    const proj = {id: 'last', rows: rows, createdAt: new Date().toISOString()};
    DB.put(proj).then(()=>console.log('saved')).catch(e=>console.warn(e));
  }
}

function dashboardView(){
  const root = document.getElementById('view-root');
  const el = document.createElement('div');
  el.innerHTML = `
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white rounded shadow p-4">
        <h3 class="text-sm text-gray-500">نسب السيولة</h3>
        <div id="kpis" class="mt-3 space-y-2"></div>
      </div>
      <div class="bg-white rounded shadow p-4 col-span-2">
        <canvas id="chartMain" height="160"></canvas>
      </div>
    </section>
  `;
  root.appendChild(el);

  // load last project
  DB.get('last').then(proj=>{
    const rows = (proj && proj.rows) || [['المخزون','15000','0'],['المبيعات','0','20000']];
    // compute simple KPI example: current ratio = current assets / current liabilities (demo)
    const assets = rows.reduce((s,r)=> s + (parseFloat(r[1])||0), 0);
    const liabilities = rows.reduce((s,r)=> s + (parseFloat(r[2])||0), 0);
    const curr = (liabilities===0)? '—' : (assets/liabilities).toFixed(2);
    document.getElementById('kpis').innerHTML = `<div class="text-2xl font-bold">${curr}</div><div class="text-xs text-gray-500">نسبة السيولة</div>`;

    // chart demo
    const labels = rows.map(r=>r[0]);
    const data = rows.map(r=> parseFloat(r[1]||r[2]) || 0);
    const ctx = document.getElementById('chartMain').getContext('2d');
    window.mainChart = new Chart(ctx, { type:'bar', data:{labels, datasets:[{label:'قيمة', data}]}, options:{responsive:true, maintainAspectRatio:false}});
  }).catch(e=>console.warn(e));
}

function reportView(){
  const root = document.getElementById('view-root');
  const el = document.createElement('div');
  el.innerHTML = `
    <section class="bg-white rounded shadow p-6">
      <h2 class="text-lg font-semibold mb-4">تقرير سريع</h2>
      <div id="report-area"></div>
      <div class="mt-4 flex gap-2">
        <button id="btn-export-pdf" class="px-4 py-2 rounded bg-blue-600 text-white">تصدير PDF</button>
        <button id="btn-export-chart" class="px-4 py-2 rounded border" id="expchart">تصدير الرسم</button>
      </div>
    </section>
  `;
  root.appendChild(el);

  DB.get('last').then(proj=>{
    const rows = (proj && proj.rows) || [];
    const area = el.querySelector('#report-area');
    area.innerHTML = `<pre class="text-xs">${JSON.stringify(rows.slice(0,20),null,2)}</pre>`;
  });

  el.querySelector('#btn-export-pdf').addEventListener('click', ()=>{
    const elr = document.querySelector('#report-area');
    const proj = window.mainProjectRows || [];
    const summary = generateReportSummary(proj);
    // inject summary into report area for export
    const sumDiv = document.createElement('div'); sumDiv.id='auto_summary'; sumDiv.className='mb-3'; sumDiv.innerHTML = `<pre style="font-size:12px">${summary}</pre>`;
    elr.insertBefore(sumDiv, elr.firstChild);
    if(window.html2pdf){ try{ html2pdf().from(elr).save('report.pdf'); }catch(e){ alert('فشل تصدير PDF'); }
    } else { alert('html2pdf not loaded'); }
    // cleanup
    if(sumDiv && sumDiv.parentNode) sumDiv.parentNode.removeChild(sumDiv);
  });
  el.querySelector('#btn-export-chart').addEventListener('click', ()=>{
    if(window.mainChart && window.mainChart.canvas) window.mainChart.canvas.toDataURL && (function(){ const a=document.createElement('a'); a.href=window.mainChart.canvas.toDataURL('image/png'); a.download='chart.png'; a.click(); })();
  });
}

function compareView(){
  const root = document.getElementById('view-root');
  const el = document.createElement('div');
  el.innerHTML = `<section class="bg-white rounded shadow p-6"><h2 class="text-lg font-semibold mb-4">مقارنة</h2><p class="text-sm text-gray-500">مقارنة سريعة بين شركتين (قيد التطوير)</p></section>`;
  root.appendChild(el);
}

// register service worker
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').catch(()=>console.warn('sw failed')); }



// XLSX parsing helper (SheetJS)
function parseXLSX(file, cb){
  const reader = new FileReader();
  reader.onload = function(e){
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type:'array'});
    const first = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(first, {header:1, defval:''});
    cb(rows);
  };
  reader.readAsArrayBuffer(file);
}

// Extended ratios calculator (simple example)
function computeFinancialRatios(rows){
  // rows: array of [account, debit, credit] (strings)
  const nums = rows.map(r=>[String(r[0]||''), parseFloat(String(r[1]||'').replace(/,/g,''))||0, parseFloat(String(r[2]||'').replace(/,/g,''))||0]);
  const totalAssets = nums.reduce((s,r)=> s + r[1], 0);
  const totalLiabilities = nums.reduce((s,r)=> s + r[2], 0);
  const netIncome = nums.reduce((s,r)=> s + (r[2]-r[1]), 0); // naive
  const currentRatio = totalLiabilities === 0 ? null : (totalAssets/totalLiabilities);
  const debtToEquity = totalLiabilities === 0 ? null : (totalLiabilities / Math.max(totalAssets - totalLiabilities,1));
  return {totalAssets, totalLiabilities, netIncome, currentRatio, debtToEquity};
}



// Advanced ratios calculation
function computeAdvancedRatios(rows){
  const nums = rows.map(r=>[String(r[0]||''), parseFloat(String(r[1]||'').replace(/,/g,''))||0, parseFloat(String(r[2]||'').replace(/,/g,''))||0]);
  // compute totals
  const totals = nums.reduce((acc,r)=>{
    acc.assets += r[1];
    acc.liabilities += r[2];
    acc.netIncome += (r[2]-r[1]);
    // classify
    const name = r[0].toLowerCase();
    if(/inventory|stock|المخزون/.test(name)) acc.inventory += r[1]-r[2];
    if(/cogs|cost of goods sold|تكلفة البضاعة|تكلفة المبيعات/.test(name)) acc.cogs += r[1]-r[2];
    if(/sales|revenue|income|المبيعات|الايرادات/.test(name)) acc.revenue += r[2]-r[1];
    if(/equity|retained earnings|حقوق الملكية|رأس المال/.test(name)) acc.equity += r[2]-r[1] + r[1]-r[2]; // naive
    return acc;
  }, {assets:0, liabilities:0, netIncome:0, inventory:0, cogs:0, revenue:0, equity:0});
  // ratios
  const roa = totals.assets? (totals.netIncome / totals.assets) : null;
  const roe = totals.equity? (totals.netIncome / totals.equity) : null;
  const grossMargin = totals.revenue? ((totals.revenue - totals.cogs) / totals.revenue) : null;
  const currentRatio = totals.liabilities? (totals.assets / totals.liabilities) : null;
  const quickRatio = (totals.assets - totals.inventory) && totals.liabilities ? ((totals.assets - totals.inventory) / totals.liabilities) : null;
  const assetTurnover = totals.assets? (totals.revenue / totals.assets) : null;
  return {roa, roe, grossMargin, currentRatio, quickRatio, assetTurnover, totals};
}


// Generate human-readable summary from ratios and totals
function generateReportSummary(rows){
  const r = computeAdvancedRatios(rows);
  const lines = [];
  lines.push(`ملخص التحليل (${new Date().toLocaleDateString()}):`);
  if(r.roa!=null) lines.push(`• العائد على الأصول (ROA): ${(r.roa*100).toFixed(2)}%`);
  if(r.roe!=null) lines.push(`• العائد على حقوق الملكية (ROE): ${(r.roe*100).toFixed(2)}%`);
  if(r.grossMargin!=null) lines.push(`• هامش مجمل الربح: ${(r.grossMargin*100).toFixed(2)}%`);
  if(r.currentRatio!=null) lines.push(`• نسبة السيولة الحالية: ${r.currentRatio.toFixed(2)}`);
  if(r.quickRatio!=null) lines.push(`• النسبة السريعة (Quick Ratio): ${r.quickRatio.toFixed(2)}`);
  if(r.assetTurnover!=null) lines.push(`• دوران الأصول: ${r.assetTurnover.toFixed(2)}`);
  // qualitative hints
  if(r.currentRatio && r.currentRatio < 1) lines.push("ملاحظة: نسبة السيولة أقل من 1 — قد تواجه الشركة صعوبات في تغطية الالتزامات قصيرة الأجل.");
  if(r.grossMargin && r.grossMargin < 0.2) lines.push("ملاحظة: هامش الربح الإجمالي منخفض — راجع تكاليف الإنتاج أو التسعير.");
  return lines.join('\n');
}

</script>
</body>
</html>