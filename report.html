<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>تقرير القوائم — المحلل المالي</title>

<!-- Styles & Fonts -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
:root{
  --accent-1:#0d6efd; --accent-2:#6610f2;
  --bg:#f6f8fb; --card:#fff; --text:#0b1220; --muted:#6c757d;
  --glass: rgba(255,255,255,0.75);
  --radius:14px;
}
body{font-family:"Cairo",system-ui,sans-serif;margin:0;background:var(--bg);color:var(--text);transition:background .2s,color .2s}
body[data-theme="dark"]{
  --bg:#08121a; --card:#0b1720; --text:#eef6ff; --muted:#9aa6b2; --glass:rgba(6,10,15,0.6);
}

/* Layout */
.header{position:sticky;top:0;z-index:1300;background:var(--glass);backdrop-filter: blur(6px);border-bottom:1px solid rgba(0,0,0,0.06);padding:.7rem 1rem;display:flex;align-items:center;gap:.6rem;justify-content:space-between}
.brand{display:flex;gap:.6rem;align-items:center}
.brand img{height:44px;border-radius:8px}
.controls{display:flex;gap:.5rem;align-items:center}

/* Main */
.container-main{max-width:1200px;margin:24px auto;padding:12px}
.panel{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,0.06);padding:18px;margin-bottom:18px}

/* Hero */
.hero{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.hero-left h1{margin:0;font-size:1.5rem}
.hero-left p{margin:0;color:var(--muted)}

/* KPIs */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:12px}
.kpi{background:linear-gradient(180deg,var(--card),#f8fbff);padding:12px;border-radius:10px;text-align:center}
.kpi .label{color:var(--muted);font-size:.9rem}
.kpi .value{font-weight:800;font-size:1.15rem;margin-top:6px}

/* Tables */
.table thead th{border-bottom:1px solid rgba(0,0,0,0.06)}
.section-title{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}

/* watermark (visible in DOM and exported in PDF) */
.watermark{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:0;opacity:0.04}
.watermark img{max-width:520px;filter:grayscale(100%);opacity:0.12}

/* small helpers */
.badge-note{background:linear-gradient(90deg,#ffc107,#ffb020);padding:6px 10px;border-radius:999px;color:#111;font-weight:800}
.controls select, .controls input{min-width:110px}

/* Responsive */
@media (max-width:900px){ .hero{flex-direction:column;align-items:flex-start} .controls{flex-wrap:wrap} }
</style>
</head>
<body data-theme="light">

<!-- Watermark/logo for PDF -->
<div class="watermark" aria-hidden="true"><img src="assets/logo.png" alt="logo" id="wmLogo"></div>

<!-- Header -->
<header class="header" role="banner">
  <div class="brand" title="المحلل المالي">
    <img src="assets/logo.png" alt="logo" id="brandLogo">
    <div>
      <div style="font-weight:800" id="brandTitle">المحلل المالي</div>
      <div style="font-size:.85rem;color:var(--muted)" id="brandSub">تقرير القوائم المالية المفصل</div>
    </div>
  </div>

  <div class="controls" role="navigation" aria-label="controls">
    <a class="btn btn-sm btn-outline-secondary" href="index.html" title="الصفحة الرئيسية"><i class="bi bi-house"></i></a>
    <a class="btn btn-sm btn-outline-secondary" href="input.html" title="إدخال البيانات"><i class="bi bi-box-arrow-in-up-right"></i></a>
    <a class="btn btn-sm btn-outline-secondary" href="dashboard.html" title="لوحة التحكم"><i class="bi bi-speedometer2"></i></a>
    <a class="btn btn-sm btn-outline-secondary" href="analysis.html" title="التحليلات المتقدمة"><i class="bi bi-graph-up"></i></a>

    <select id="languageSelect" class="form-select form-select-sm" title="اللغة">
      <option value="ar">العربية</option>
      <option value="en">English</option>
    </select>

    <select id="currencySelect" class="form-select form-select-sm" title="العملة">
      <option>EGP</option><option>USD</option><option>EUR</option>
    </select>

    <input id="fxInput" class="form-control form-control-sm" style="width:110px" placeholder="سعر الصرف" title="سعر الصرف يدوي (للتحويل)"/>

    <div class="form-check form-switch mb-0" title="الوضع الليلي">
      <input class="form-check-input" id="darkModeToggle" type="checkbox" role="switch">
    </div>

    <button id="exportPdfBtn" class="btn btn-outline-primary btn-sm" title="تصدير PDF"><i class="bi bi-file-earmark-pdf"></i></button>
    <button id="exportExcelBtn" class="btn btn-outline-success btn-sm" title="تصدير Excel"><i class="bi bi-file-earmark-excel"></i></button>
  </div>
</header>

<!-- Main -->
<main class="container-main" id="mainArea" role="main">
  <!-- Hero & comparison controls -->
  <section class="panel hero" id="controlsPanel">
    <div class="hero-left">
      <h1 id="reportTitle">تقرير القوائم المالية</h1>
      <p id="reportDesc">ملف شامل يقسم القوائم، يوضح النتائج، وشروحات مبسطة لكل قائمة. اختر فترتين للمقارنة (اختياري).</p>
      <div class="mt-2 small-muted">ملاحظة: للمقارنة الزمنية، يجب أن تحتوي بيانات الإدخال على حقل تاريخ `Date` أو `date` بصيغة ISO (YYYY-MM-DD).</div>
    </div>

    <div class="hero-right" style="min-width:320px;display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <label class="form-label small mb-0" id="periodALabel">الفترة A</label>
          <input type="date" id="pA_from" class="form-control form-control-sm"/>
          <input type="date" id="pA_to" class="form-control form-control-sm mt-1"/>
        </div>
        <div style="flex:1">
          <label class="form-label small mb-0" id="periodBLabel">الفترة B</label>
          <input type="date" id="pB_from" class="form-control form-control-sm"/>
          <input type="date" id="pB_to" class="form-control form-control-sm mt-1"/>
        </div>
      </div>

      <div style="display:flex;gap:8px">
        <button id="compareBtn" class="btn btn-glow btn-sm" style="flex:1"><i class="bi bi-bar-chart-line"></i> <span id="compareText">قارن</span></button>
        <button id="refreshBtn" class="btn btn-outline-secondary btn-sm" style="width:110px"><i class="bi bi-arrow-clockwise"></i></button>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="panel" id="summaryPanel" aria-live="polite">
    <div class="section-title"><h5>ملخص</h5><div><span id="dataInfo" class="small-muted"></span></div></div>
    <div class="kpi-row" id="kpiRow"></div>
  </section>

  <!-- Detailed Lists -->
  <section class="panel" id="balancePanel">
    <div class="section-title"><h5 id="bsTitle">المركز المالي (قائمة المركز المالي)</h5><div class="small-muted" id="bsNote">شرح موجز عن الهدف من هذه القائمة.</div></div>

    <div class="row g-3">
      <div class="col-lg-6">
        <h6 id="assetsTitle">الأصول</h6>
        <div id="assetsTable"></div>
      </div>
      <div class="col-lg-6">
        <h6 id="liabilitiesTitle">الخصوم & حقوق الملكية</h6>
        <div id="liabilitiesTable"></div>
      </div>
    </div>
  </section>

  <section class="panel" id="incomePanel">
    <div class="section-title"><h5 id="isTitle">قائمة الدخل</h5><div class="small-muted" id="isNote">توضح الإيرادات والمصروفات وصافي الربح / الخسارة خلال الفترة.</div></div>
    <div id="incomeTable"></div>
  </section>

  <section class="panel" id="cashPanel">
    <div class="section-title"><h5 id="cfTitle">تقرير التدفقات النقدية (مبسط)</h5><div class="small-muted" id="cfNote">مبسط: يعتمد على حسابات النقد/البنك المتاحة في البيانات.</div></div>
    <div id="cashTable"></div>
  </section>

  <!-- Comparison Charts -->
  <section class="panel" id="chartsPanel">
    <div class="section-title"><h5 id="chartsTitle">رسوم بيانية & مقارنة</h5></div>
    <div class="row g-3">
      <div class="col-md-6"><canvas id="compChart1" height="220"></canvas></div>
      <div class="col-md-6"><canvas id="compChart2" height="220"></canvas></div>
    </div>
  </section>

  <footer class="text-center mt-3 small">&copy; 2025 المحلل المالي — جميع الحقوق محفوظة</footer>
</main>

<!-- Script -->
<script>
// --- Helpers
const $ = id => document.getElementById(id);
const esc = s => String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
const toNum = v => { const n = Number(String(v).replace(/[, ]+/g,'')); return isNaN(n) ? 0 : n; };
const defaultFX = JSON.parse(localStorage.getItem('fa_fx')||'null') || {USD:31,EUR:34};

// --- Translations (small set)
const L = {
  ar:{
    compare:'قارن', refresh:'تحديث', dataInfo:'مصدر البيانات: localStorage (trialData)',
    accounts:'عدد الحسابات', assets:'الأصول (تقريبي)', liabilities:'الخصوم (تقريبي)',
    revenue:'الإيرادات', expense:'المصروفات', other:'أخرى', noData:'لا توجد بيانات في localStorage (trialData).',
    noDate:'لا توجد تواريخ في البيانات — المقارنة الزمنية تتطلب وجود حقل Date في بيانات الإدخال.'
  },
  en:{
    compare:'Compare', refresh:'Refresh', dataInfo:'Data source: localStorage (trialData)',
    accounts:'Accounts', assets:'Assets (approx)', liabilities:'Liabilities (approx)',
    revenue:'Revenue', expense:'Expense', other:'Other', noData:'No data found in localStorage (trialData).',
    noDate:'No date field found in data — time comparison requires a Date column in input.'
  }
};
function t(k){ const lang = $('languageSelect').value||'ar'; return (L[lang]&&L[lang][k])?L[lang][k]:k; }

// --- State
let trialData = JSON.parse(localStorage.getItem('trialData')||'[]');
let compChart1=null, compChart2=null;
let fxRates = defaultFX;

// --- UI init
function initControls(){
  // language and theme
  $('languageSelect').value = localStorage.getItem('fa_lang') || localStorage.getItem('lang') || 'ar';
  $('currencySelect').value = localStorage.getItem('fa_currency') || localStorage.getItem('currency') || 'EGP';
  $('fxInput').value = localStorage.getItem('fa_manual_fx') || '';
  const theme = localStorage.getItem('fa_theme') || localStorage.getItem('theme') || 'light';
  document.body.dataset.theme = theme;
  $('darkModeToggle').checked = theme === 'dark';

  // language change
  $('languageSelect').addEventListener('change', ()=> { localStorage.setItem('fa_lang',$('languageSelect').value); redrawAll(); });
  $('currencySelect').addEventListener('change', ()=> { localStorage.setItem('fa_currency',$('currencySelect').value); redrawAll(); });
  $('fxInput').addEventListener('input', ()=> { localStorage.setItem('fa_manual_fx',$('fxInput').value); redrawAll(); });

  $('darkModeToggle').addEventListener('change', e => { document.body.dataset.theme = e.target.checked ? 'dark' : 'light'; localStorage.setItem('fa_theme', document.body.dataset.theme); adjustTextColors(); });

  $('compareBtn').addEventListener('click', ()=> comparePeriods());
  $('refreshBtn').addEventListener('click', ()=> { loadData(); redrawAll(); showToast('Refreshed'); });

  $('exportPdfBtn').addEventListener('click', ()=> exportPDF());
  $('exportExcelBtn').addEventListener('click', ()=> exportExcel());
}
function showToast(msg, type='info'){
  const area = document.createElement('div');
  area.className = `toast align-items-center text-bg-${type} border-0 show`;
  area.style.minWidth='220px'; area.style.margin='6px';
  area.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.toast').remove()"></button></div>`;
  document.body.appendChild(area);
  setTimeout(()=> area.remove(), 2800);
}
function adjustTextColors(){
  // ensure readability in dark mode: bootstrap handles many colors, but ensure canvas legends and texts are visible by re-drawing charts on theme change
  if(compChart1) compChart1.update();
  if(compChart2) compChart2.update();
}

// --- Data load
function loadData(){
  trialData = JSON.parse(localStorage.getItem('trialData')||'[]') || [];
  // normalize keys to consistent names (Account, Type, Code, Debit, Credit, Date)
  trialData = trialData.map(r=>{
    const obj = {};
    obj.Account = r.Account || r.account || r['اسم الحساب'] || r['Account'] || r['Name'] || '';
    obj.Type = r.Type || r.type || r['نوع'] || r['Type'] || '';
    obj.Code = r.Code || r.code || r['كود'] || '';
    obj.Debit = toNum(r.Debit||r.debit||r['مدين']||r['Dr']||0);
    obj.Credit = toNum(r.Credit||r.credit||r['دائن']||r['Cr']||0);
    obj.Date = r.Date || r.date || r['التاريخ'] || '';
    return obj;
  });
}
function hasDateField(){
  return trialData.some(r=> r.Date && !isNaN(Date.parse(r.Date)));
}

// --- Currency conversion
function getFXRateFor(cur){
  const manual = parseFloat($('fxInput').value);
  if(!isNaN(manual) && manual>0){
    // user-specified: store as EGP per cur
    return manual;
  }
  // if not provided, use stored fxRates or defaults
  const stored = JSON.parse(localStorage.getItem('fa_fx')||'null') || fxRates;
  if(cur === 'EGP') return 1;
  if(cur === 'USD') return stored.USD || defaultFX.USD;
  if(cur === 'EUR') return stored.EUR || defaultFX.EUR;
  return 1;
}
function convertForDisplay(value){
  const cur = $('currencySelect').value || 'EGP';
  if(cur === 'EGP') return toNum(value);
  const rate = getFXRateFor(cur);
  if(!rate || rate===0) return toNum(value);
  return toNum(value) / rate;
}
function currencySymbol(){
  const cur = $('currencySelect').value || 'EGP';
  if(cur==='USD') return '$';
  if(cur==='EUR') return '€';
  return 'ج.م';
}

// --- Aggregation: classify rows into buckets
function classifyTotals(rows){
  const agg = { assets:0, liabilities:0, equity:0, revenue:0, expense:0, other:0 };
  rows.forEach(r=>{
    const net = toNum(r.Debit) - toNum(r.Credit);
    const s = (r.Type || r.Account || '').toString().toLowerCase();
    // heuristics — similar to input logic
    if(/asset|أصل|cash|bank|current asset|نقد|bank/i.test(s)) agg.assets += net;
    else if(/liab|خصوم|payable|loan|دائن|قرض/i.test(s)) agg.liabilities += (-net);
    else if(/equity|حقوق|رأس/i.test(s)) agg.equity += (-net);
    else if(/revenue|sales|إيراد|مبيعات/i.test(s)) agg.revenue += (-net);
    else if(/expense|مصروف|cogs|تكلفة|مصاريف/i.test(s)) agg.expense += net;
    else {
      const acc = (r.Account||'').toLowerCase();
      if(/النقد|bank|cash|نقد/.test(acc)) agg.assets += net;
      else if(/المورد|payable|دائن/.test(acc)) agg.liabilities += (-net);
      else if(/رأس|equity/.test(acc)) agg.equity += (-net);
      else if(/إيراد|sales/.test(acc)) agg.revenue += (-net);
      else if(/مصروف|expense|تكلفة/.test(acc)) agg.expense += net;
      else agg.other += net;
    }
  });
  return agg;
}

// --- Build UI tables & charts
function redrawAll(){
  // data info
  $('dataInfo').textContent = t('dataInfo');
  if(!trialData.length){ $('kpiRow').innerHTML = `<div class="empty-hint">${t('noData')}</div>`; return; }

  // KPIs
  const aggAll = classifyTotals(trialData);
  const kpis = [
    {label: t('accounts'), value: trialData.length},
    {label: t('assets'), value: aggAll.assets},
    {label: t('liabilities'), value: aggAll.liabilities},
    {label: t('revenue'), value: aggAll.revenue},
    {label: t('expense'), value: aggAll.expense},
    {label: t('other'), value: aggAll.other}
  ];
  const kpiRow = $('kpiRow'); kpiRow.innerHTML = '';
  kpis.forEach(k=>{
    const div = document.createElement('div'); div.className='kpi';
    div.innerHTML = `<div class="label">${esc(k.label)}</div><div class="value">${esc( (typeof k.value==='number')? formatNum(convertForDisplay(k.value)) : k.value )} ${currencySymbol()}</div>`;
    kpiRow.appendChild(div);
  });

  // Balance sheet panels
  renderBalance(aggAll);
  renderIncome(aggAll);
  renderCashFlow(aggAll);

  // default charts: totals across categories
  drawCharts(aggAll, null, null);

  // show warning about date availability for comparison
  if(!hasDateField()){
    // show gentle notice
    const note = document.createElement('div');
    note.className='small-muted mt-2';
    note.textContent = t('noDate');
    if(!document.querySelector('#controlsPanel .no-date-note')) {
      note.classList.add('no-date-note');
      $('controlsPanel').appendChild(note);
    }
  } else {
    const ex = document.querySelector('#controlsPanel .no-date-note');
    if(ex) ex.remove();
  }
}

function renderBalance(agg){
  $('assetsTable').innerHTML = buildTableHtml([
    {name: 'Current/Estimated Assets', value: agg.assets}
  ], 'Assets — تفصيل الأصول', 'توضح هذه القائمة إجمالي الأصول وفقًا للتصنيف التلقائي من البيانات.');

  $('liabilitiesTable').innerHTML = buildTableHtml([
    {name:'Liabilities (estimated)', value: agg.liabilities},
    {name:'Equity (estimated)', value: agg.equity}
  ], 'Liabilities & Equity — تفصيل', 'الخصوم وحقوق الملكية المشتقة من الحسابات المدخلة.');
}

function renderIncome(agg){
  $('incomeTable').innerHTML = buildTableHtml([
    {name:'Revenue', value: agg.revenue},
    {name:'Expenses', value: agg.expense},
    {name:'Net Income', value: (agg.revenue - agg.expense)}
  ], 'Income Statement — قائمة الدخل', 'تعرض الإيرادات والمصروفات وصافي النتيجة للفترة.');
}

function renderCashFlow(agg){
  // Very simplified: cash change approximated by asset cash accounts net
  $('cashTable').innerHTML = buildTableHtml([
    {name:'Net cash (approx)', value: agg.assets} // rough
  ], 'Cash Flow (Simplified)', 'تقرير مبسط مستنتج من حسابات النقد/البنك.');
}

function buildTableHtml(rows, title, note){
  // rows: [{name,value}]
  let html = `<div class="mb-2"><strong>${esc(title)}</strong><div class="small-muted">${esc(note)}</div></div>`;
  html += `<div class="table-responsive"><table class="table table-sm table-borderless"><tbody>`;
  rows.forEach(r=>{
    const v = typeof r.value === 'number' ? formatNum(convertForDisplay(r.value)) + ' ' + currencySymbol() : esc(r.value);
    html += `<tr><td>${esc(r.name)}</td><td class="text-end fw-bold">${v}</td></tr>`;
  });
  html += `</tbody></table></div>`;
  return html;
}

function formatNum(v){ return Number(v).toLocaleString(undefined,{maximumFractionDigits:2}); }

// --- Charts
function drawCharts(baseAgg, aggA, aggB){
  // Chart 1: donut of baseAgg
  const labels = [ t('assets'), t('liabilities'), t('revenue'), t('expense'), t('other') ];
  const data = [Math.abs(baseAgg.assets), Math.abs(baseAgg.liabilities), Math.abs(baseAgg.revenue), Math.abs(baseAgg.expense), Math.abs(baseAgg.other)];
  const ctx1 = $('compChart1').getContext('2d');
  if(compChart1) try{ compChart1.destroy(); }catch(e){}
  compChart1 = new Chart(ctx1, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor:['#0d6efd','#dc3545','#198754','#ffc107','#6c757d'] }] },
    options: { plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{label:ctx=> `${ctx.label}: ${formatNum(ctx.parsed)} `+currencySymbol()}}} }
  });

  // Chart 2: comparison bar if aggA/aggB provided, else simple bar of baseAgg
  const ctx2 = $('compChart2').getContext('2d');
  if(compChart2) try{ compChart2.destroy(); }catch(e){}
  if(aggA && aggB){
    const dsA = [Math.abs(aggA.assets),Math.abs(aggA.liabilities),Math.abs(aggA.revenue),Math.abs(aggA.expense),Math.abs(aggA.other)];
    const dsB = [Math.abs(aggB.assets),Math.abs(aggB.liabilities),Math.abs(aggB.revenue),Math.abs(aggB.expense),Math.abs(aggB.other)];
    compChart2 = new Chart(ctx2, {
      type: 'bar',
      data: { labels, datasets:[
        {label: 'Period A', data: dsA, backgroundColor:'#0d6efd'},
        {label: 'Period B', data: dsB, backgroundColor:'#6610f2'}
      ]},
      options: { responsive:true, plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{label:ctx=> `${ctx.dataset.label}: ${formatNum(ctx.parsed.y)} `+currencySymbol()}}} }
    });
  } else {
    compChart2 = new Chart(ctx2, {
      type: 'bar',
      data: { labels, datasets:[{label: 'Totals', data, backgroundColor:'#0d6efd'}] },
      options: { responsive:true, plugins:{legend:{display:false}, tooltip:{callbacks:{label:ctx=> `${formatNum(ctx.parsed.y)} `+currencySymbol()}}} }
    });
  }
}

// --- Comparison logic
function parseDateSafe(v){ const d = Date.parse(v); return isNaN(d)?null:new Date(d); }
function filterByRange(rows, from, to){
  if(!from && !to) return rows.slice();
  return rows.filter(r=>{
    const dt = parseDateSafe(r.Date);
    if(!dt) return false;
    if(from && dt < from) return false;
    if(to && dt > to) return false;
    return true;
  });
}

function comparePeriods(){
  // get date inputs
  const pA_from = $('pA_from').value ? new Date($('pA_from').value) : null;
  const pA_to = $('pA_to').value ? new Date($('pA_to').value) : null;
  const pB_from = $('pB_from').value ? new Date($('pB_from').value) : null;
  const pB_to = $('pB_to').value ? new Date($('pB_to').value) : null;

  if(!hasDateField()){
    showToast(t('noDate'),'warning');
    return;
  }

  const rowsA = filterByRange(trialData, pA_from, pA_to);
  const rowsB = filterByRange(trialData, pB_from, pB_to);

  const aggA = classifyTotals(rowsA);
  const aggB = classifyTotals(rowsB);

  // render side-by-side tables for A and B
  // show KPIs comparison
  const kpiRow = $('kpiRow'); kpiRow.innerHTML = '';
  const items = [
    {label: 'Accounts (A / B)', value: `${rowsA.length} / ${rowsB.length}`},
    {label: t('assets'), value: `${formatNum(convertForDisplay(aggA.assets))} / ${formatNum(convertForDisplay(aggB.assets))}`},
    {label: t('liabilities'), value: `${formatNum(convertForDisplay(aggA.liabilities))} / ${formatNum(convertForDisplay(aggB.liabilities))}`},
    {label: t('revenue'), value: `${formatNum(convertForDisplay(aggA.revenue))} / ${formatNum(convertForDisplay(aggB.revenue))}`},
    {label: t('expense'), value: `${formatNum(convertForDisplay(aggA.expense))} / ${formatNum(convertForDisplay(aggB.expense))}`},
  ];
  items.forEach(it=>{
    const div = document.createElement('div'); div.className='kpi';
    div.innerHTML = `<div class="label">${esc(it.label)}</div><div class="value">${esc(it.value)} ${currencySymbol()}</div>`;
    kpiRow.appendChild(div);
  });

  // show detailed comparison tables
  $('assetsTable').innerHTML = buildTableHtml([{name:'Assets A', value:aggA.assets},{name:'Assets B',value:aggB.assets}], 'Assets — Comparison', 'مقارنة الأصول بين الفترتين.');
  $('liabilitiesTable').innerHTML = buildTableHtml([{name:'Liabilities A', value:aggA.liabilities},{name:'Liabilities B',value:aggB.liabilities},{name:'Equity A',value:aggA.equity},{name:'Equity B',value:aggB.equity}], 'Liabilities & Equity — Comparison', '');

  $('incomeTable').innerHTML = buildTableHtml([{name:'Revenue A',value:aggA.revenue},{name:'Revenue B',value:aggB.revenue},{name:'Net A',value:aggA.revenue-aggA.expense},{name:'Net B',value:aggB.revenue-aggB.expense}], 'Income Statement — Comparison', '');

  drawCharts({}, aggA, aggB);
  showToast('Comparison generated','success');
}

// --- Export
function exportPDF(){
  // ensure watermark visible and logo present
  const wm = $('wmLogo');
  const prevOpacity = wm.style.opacity || '';
  wm.style.opacity = '0.12';

  // add header logo to DOM (so captured)
  // create a clone to ensure visibility in printing
  const clone = document.querySelector('header').cloneNode(true);
  clone.style.position='static';
  clone.style.boxShadow='none';
  clone.style.background='transparent';
  clone.id = 'exportHeaderClone';
  document.body.insertBefore(clone, document.getElementById('mainArea'));

  const opt = { margin:0.35, filename:'financial_report.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'in', format:'a4', orientation:'landscape'} };
  html2pdf().set(opt).from(document.getElementById('mainArea')).toPdf().get('pdf').then(function(pdf){
    // can add page headers/footers via pdf API here if needed
  }).save().finally(()=> {
    wm.style.opacity = prevOpacity;
    document.getElementById('exportHeaderClone')?.remove();
  });
}

function exportExcel(){
  if(!trialData.length){ showToast(t('noDataExport'),'warning'); return; }
  const ws = XLSX.utils.json_to_sheet(trialData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'TrialBalance');
  XLSX.writeFile(wb, 'financial_report.xlsx');
}

// --- Init + boot
function boot(){
  initControls();
  loadData();
  redrawAll();
  adjustTextColors();
}

boot();

// --- listen to storage updates (if input page saves)
window.addEventListener('storage', (e)=>{
  if(e.key === 'trialData'){
    loadData();
    redrawAll();
    showToast('Data updated from another tab','info');
  }
});
</script>
</body>
</html>
