<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>التقارير — المحلل المالي</title>

<!-- Bootstrap RTL & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>

<!-- Chart + html2pdf (already used in input page) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
:root{
  --accent-1:#0d6efd;
  --accent-2:#6610f2;
  --bg:#f6f8fb; --card:#fff; --text:#0b1220; --muted:#6c757d;
  --glass: rgba(255,255,255,0.7);
  --glass-border: rgba(13,110,253,0.06);
  --radius:12px;
  --logo-size:44px;
}
html,body{height:100%;}
body{font-family:"Cairo",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; margin:0; background:var(--bg); color:var(--text); transition:background .2s, color .2s; -webkit-font-smoothing:antialiased;}
body[data-theme="dark"]{
  --bg:#071018; --card:#07131a; --text:#e6eef6; --muted:#9aa6b2; --glass:rgba(6,10,15,0.5); --glass-border: rgba(255,255,255,0.04);
  background:var(--bg); color:var(--text);
}

/* header */
.header {
  position:sticky; top:0; z-index:1400;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 18px; gap:12px;
  backdrop-filter:blur(8px); background:var(--glass); border-bottom:1px solid var(--glass-border);
}
.brand{display:flex; align-items:center; gap:10px}
.brand img{height:var(--logo-size); border-radius:8px; box-shadow:0 8px 28px rgba(13,110,253,0.06)}
.brand .title{font-weight:800}
.controls{display:flex; gap:8px; align-items:center}

/* main */
.container-main{max-width:1200px; margin:20px auto; padding:16px}

/* hero/report header */
.report-hero{
  padding:18px; border-radius:var(--radius);
  background:linear-gradient(180deg, rgba(13,110,253,0.06), rgba(102,16,242,0.02));
  box-shadow:0 10px 30px rgba(2,6,23,0.04); border:1px solid rgba(13,110,253,0.04);
  margin-bottom:16px;
}
.report-hero h2{margin:0; font-weight:800}
.report-meta{margin-top:8px; color:var(--muted)}

/* cards */
.card-surface{background:var(--card); border-radius:10px; padding:18px; box-shadow:0 12px 30px rgba(2,6,23,0.04); border:1px solid rgba(13,110,253,0.03); margin-bottom:16px}
body[data-theme="dark"] .card-surface{box-shadow:0 10px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03)}

/* headings */
.section-title{display:flex; align-items:center; gap:10px; margin-bottom:12px}

/* table */
.fin-table{width:100%; border-collapse:collapse}
.fin-table th, .fin-table td{padding:8px 10px; border-bottom:1px solid rgba(0,0,0,0.04)}
.fin-table th{background:transparent; text-align:left; font-weight:700}
.fin-amount{font-weight:700; text-align:right}

/* explanation card */
.explain{background:linear-gradient(180deg,#fff,#f8fbff); padding:12px; border-radius:8px; box-shadow:0 8px 20px rgba(2,6,23,0.04)}

/* charts */
.chart-wrap{height:300px}

/* watermark for PDF (hidden visually if needed; present in DOM) */
.watermark{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:0; opacity:0.06}
.watermark img{max-width:520px; filter:grayscale(100%); opacity:0.12}

/* responsive */
@media(max-width:900px){
  .chart-wrap{height:220px}
  .controls{flex-wrap:wrap}
  .report-hero{padding:12px}
}
</style>
</head>
<body data-theme="light">

<!-- watermark (captured in PDF) -->
<div class="watermark" aria-hidden="true"><img src="assets/logo.png" alt="logo"></div>

<!-- header -->
<header class="header" role="banner">
  <div class="brand">
    <img src="assets/logo.png" alt="logo" id="brandLogo">
    <div>
      <div class="title" id="brandText">المحلل المالي</div>
      <div style="font-size:0.85rem; color:var(--muted)" id="brandDesc">تقارير مفصلة وشرح لكل قائمة مالية</div>
    </div>
  </div>

  <div class="controls" role="navigation" aria-label="global controls">
    <a class="btn btn-sm btn-outline-secondary" href="index.html" title="الرئيسية"><i class="bi bi-house"></i></a>
    <a class="btn btn-sm btn-outline-secondary" href="input.html" title="إدخال البيانات"><i class="bi bi-pencil-square"></i></a>
    <a class="btn btn-sm btn-outline-secondary" href="dashboard.html" title="لوحة التحكم"><i class="bi bi-speedometer2"></i></a>
    <a class="btn btn-sm btn-outline-secondary" href="analysis.html" title="التحليلات المالية"><i class="bi bi-bar-chart-line"></i></a>

    <select id="currencySelect" class="form-select form-select-sm" style="min-width:95px" title="اختر العملة"></select>

    <!-- FX rate input -->
    <div style="display:flex; gap:6px; align-items:center;">
      <input id="fxInput" type="number" step="0.0001" class="form-control form-control-sm" style="width:110px" title="سعر الصرف" aria-label="سعر الصرف"/>
      <div style="font-size:0.82rem; color:var(--muted)">سعر الصرف</div>
    </div>

    <select id="languageSelect" class="form-select form-select-sm" style="min-width:110px" title="اللغة"></select>

    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="darkModeToggle" aria-label="الوضع الليلي">
    </div>

    <button id="exportPdfBtn" class="btn btn-outline-primary btn-sm"><i class="bi bi-file-earmark-pdf"></i> تصدير PDF</button>
  </div>
</header>

<!-- main -->
<main class="container-main" id="mainArea" role="main">
  <section class="report-hero">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
      <div>
        <h2 id="pageTitle">تقرير القوائم المالية التفصيلي</h2>
        <div class="report-meta" id="reportMeta">المصدر: بيانات ميزان المراجعة (Trial Balance) — تُستخرج من صفحة الإدخال</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
        <button id="refreshBtn" class="btn btn-glow btn-sm">تحديث البيانات</button>
        <button id="gotoInput" class="btn btn-outline-secondary btn-sm">اذهب لإدخال البيانات</button>
      </div>
    </div>
  </section>

  <!-- Summary KPIs -->
  <section class="card-surface" aria-labelledby="kpisTitle">
    <div class="section-title"><h5 id="kpisTitle">ملخص سريع</h5></div>
    <div id="kpiRow" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px"></div>
  </section>

  <!-- Balance Sheet -->
  <section class="card-surface" id="balanceSection" aria-labelledby="bsTitle">
    <div class="section-title"><h5 id="bsTitle">الميزانية العمومية — Balance Sheet</h5></div>
    <div class="row g-3">
      <div class="col-lg-7">
        <table class="fin-table w-100">
          <thead><tr><th>البند</th><th class="text-end">القيمة (<span id="currencySymbol1">EGP</span>)</th></tr></thead>
          <tbody id="bsTable"></tbody>
          <tfoot><tr><th>الإجمالي</th><th class="text-end" id="bsTotal">-</th></tr></tfoot>
        </table>
      </div>
      <div class="col-lg-5">
        <div class="explain">
          <strong id="bsExplainTitle">ماذا تظهر الميزانية العمومية؟</strong>
          <p id="bsExplain">الميزانية العمومية تعرض الأصول والخصوم وحقوق الملكية في لحظة زمنية محددة. تُظهر قدرة الشركة على تغطية التزاماتها ومدى رأس المال المستثمر.</p>
        </div>
        <div class="chart-wrap mt-3">
          <canvas id="bsChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- Income statement -->
  <section class="card-surface" id="incomeSection" aria-labelledby="isTitle">
    <div class="section-title"><h5 id="isTitle">قائمة الدخل — Income Statement</h5></div>
    <div class="row g-3">
      <div class="col-lg-7">
        <table class="fin-table w-100">
          <thead><tr><th>البند</th><th class="text-end">القيمة (<span id="currencySymbol2">EGP</span>)</th></tr></thead>
          <tbody id="isTable"></tbody>
          <tfoot><tr><th>صافي الربح / الخسارة</th><th class="text-end" id="isNet">-</th></tr></tfoot>
        </table>
      </div>
      <div class="col-lg-5">
        <div class="explain">
          <strong id="isExplainTitle">ماذا تظهر قائمة الدخل؟</strong>
          <p id="isExplain">قائمة الدخل تعرض الإيرادات والمصروفات خلال فترة معينة وتبيّن هل هناك ربح أم خسارة صافية.</p>
        </div>
        <div class="chart-wrap mt-3"><canvas id="isChart"></canvas></div>
      </div>
    </div>
  </section>

  <!-- Cash flow (simplified) -->
  <section class="card-surface" id="cfSection" aria-labelledby="cfTitle">
    <div class="section-title"><h5 id="cfTitle">قائمة التدفقات النقدية — Cash Flow (تقريبية)</h5></div>
    <div class="row g-3">
      <div class="col-lg-7">
        <table class="fin-table w-100">
          <thead><tr><th>البند</th><th class="text-end">القيمة (<span id="currencySymbol3">EGP</span>)</th></tr></thead>
          <tbody id="cfTable"></tbody>
          <tfoot><tr><th>صافي التدفق النقدي</th><th class="text-end" id="cfNet">-</th></tr></tfoot>
        </table>
      </div>
      <div class="col-lg-5">
        <div class="explain">
          <strong id="cfExplainTitle">ماذا تظهر قائمة التدفقات؟</strong>
          <p id="cfExplain">قائمة التدفقات تبين مصادر واستخدامات النقدية — تشغيل، استثمار، وتمويل. هنا نقدم ملخّصًا تقريبيًا من ميزان المراجعة.</p>
        </div>
        <div class="chart-wrap mt-3"><canvas id="cfChart"></canvas></div>
      </div>
    </div>
  </section>

  <!-- Equity statement -->
  <section class="card-surface" id="eqSection" aria-labelledby="eqTitle">
    <div class="section-title"><h5 id="eqTitle">قائمة حقوق الملكية — Statement of Changes in Equity</h5></div>
    <div class="row g-3">
      <div class="col-lg-7">
        <table class="fin-table w-100">
          <thead><tr><th>البند</th><th class="text-end">القيمة (<span id="currencySymbol4">EGP</span>)</th></tr></thead>
          <tbody id="eqTable"></tbody>
          <tfoot><tr><th>إجمالي حقوق الملكية</th><th class="text-end" id="eqTotal">-</th></tr></tfoot>
        </table>
      </div>
      <div class="col-lg-5">
        <div class="explain">
          <strong id="eqExplainTitle">ماذا تظهر قائمة حقوق الملكية؟</strong>
          <p id="eqExplain">توضح التغيرات في حقوق المساهمين — رأس المال، الأرباح المحتجزة، وتغيرات أخرى خلال الفترة.</p>
        </div>
      </div>
    </div>
  </section>

</main>

<script>
/* =========================
   Utilities & i18n
   ========================= */
const $ = id => document.getElementById(id);

const LANGS = [{v:'ar',label:'العربية'},{v:'en',label:'English'}];
const CURRENCIES = [{code:'EGP',symbol:'EGP'},{code:'USD',symbol:'USD'},{code:'EUR',symbol:'EUR'}];

const translations = {
  ar: {
    pageTitle: "تقرير القوائم المالية التفصيلي",
    reportMeta: "المصدر: بيانات ميزان المراجعة (Trial Balance) — تُستخرج من صفحة الإدخال",
    kpisTitle: "ملخص سريع",
    bsTitle: "الميزانية العمومية — Balance Sheet",
    isTitle: "قائمة الدخل — Income Statement",
    cfTitle: "قائمة التدفقات النقدية — Cash Flow (تقريبية)",
    eqTitle: "قائمة حقوق الملكية — Statement of Changes in Equity",
    refresh: "تحديث البيانات",
    gotoInput: "اذهب لإدخال البيانات",
    noData: "لا توجد بيانات ميزان المراجعة لعرض التقرير. اذهب لصفحة إدخال البيانات ورفع ملف أو إضافة صفوف.",
    currencyLabel: "سعر الصرف"
  },
  en: {
    pageTitle: "Detailed Financial Report",
    reportMeta: "Source: Trial Balance data — pulled from the Input page",
    kpisTitle: "Quick Summary",
    bsTitle: "Balance Sheet",
    isTitle: "Income Statement",
    cfTitle: "Cash Flow (approx)",
    eqTitle: "Statement of Changes in Equity",
    refresh: "Refresh Data",
    gotoInput: "Go to Input",
    noData: "No trial balance data available to generate the report. Go to the Input page to upload or add rows.",
    currencyLabel: "FX Rate"
  }
};

function t(key){
  const lang = $('languageSelect')?.value || localStorage.getItem('fa_lang') || 'ar';
  return (translations[lang] && translations[lang][key]) ? translations[lang][key] : key;
}

/* =========================
   Data source (reads same trialData from localStorage)
   ========================= */
let trialData = JSON.parse(localStorage.getItem('trialData') || '[]') || [];

/* FX & currency UI */
function populateControls(){
  const ls = $('languageSelect'); ls.innerHTML = '';
  LANGS.forEach(l => { const o = document.createElement('option'); o.value = l.v; o.textContent = l.label; ls.appendChild(o); });

  const cs = $('currencySelect'); cs.innerHTML = '';
  CURRENCIES.forEach(c => { const o = document.createElement('option'); o.value = c.code; o.textContent = c.code; cs.appendChild(o); });

  // load saved prefs
  const lang = localStorage.getItem('fa_lang') || localStorage.getItem('lang') || 'ar';
  const theme = localStorage.getItem('fa_theme') || localStorage.getItem('theme') || 'light';
  const cur = localStorage.getItem('fa_currency') || localStorage.getItem('currency') || 'EGP';
  const fxStored = localStorage.getItem('fa_fx_manual') || '';

  $('languageSelect').value = lang;
  $('darkModeToggle').checked = theme === 'dark';
  document.body.dataset.theme = theme;
  $('currencySelect').value = cur;
  $('fxInput').value = fxStored;

  // currency symbols in headers
  updateCurrencySymbols();
  applyLanguage();
}

/* language application */
function applyLanguage(){
  const lang = $('languageSelect').value;
  $('pageTitle').textContent = t('pageTitle');
  $('reportMeta').textContent = t('reportMeta');
  $('kpisTitle').textContent = t('kpisTitle');
  $('bsTitle').textContent = t('bsTitle');
  $('isTitle').textContent = t('isTitle');
  $('cfTitle').textContent = t('cfTitle');
  $('eqTitle').textContent = t('eqTitle');
  $('refreshBtn').textContent = t('refresh');
  $('gotoInput').textContent = t('gotoInput');
}

/* currency symbol updates */
function updateCurrencySymbols(){
  const cur = $('currencySelect').value || 'EGP';
  const syms = ['currencySymbol1','currencySymbol2','currencySymbol3','currencySymbol4'];
  syms.forEach(id => { if($(id)) $(id).textContent = cur; });
}

/* FX resolve: user manual fx overrides remote */
function getFxRates(){
  // if currency is EGP, conversion is 1
  const cur = $('currencySelect').value || 'EGP';
  const manual = parseFloat($('fxInput').value);
  if(cur === 'EGP') return {rate:1, symbol:'EGP'};
  if(!isNaN(manual) && manual > 0){
    // user provided rate: interpret as how many EGP per 1 unit of currency? We'll assume input = EGP per cur (e.g. 31 for USD)
    return {rate: manual, symbol: cur};
  }
  // fallback to stored fa_fx if exists
  const stored = JSON.parse(localStorage.getItem('fa_fx') || 'null') || {USD:31,EUR:34};
  const r = stored[cur] || (cur==='USD'?31:34);
  return {rate:r, symbol:cur};
}

/* convert helper */
function convert(num){
  const cur = $('currencySelect').value || 'EGP';
  const fx = getFxRates();
  if(cur === 'EGP') return num;
  // fx.rate is EGP per 1 unit -> to convert EGP number to selected currency divide by rate
  return num / fx.rate;
}

/* =========================
   Financial computations (approximate, derived from trialData)
   - classify rows by Type then account keywords
   - compute aggregates for BS, IS, CF, Equity
   ========================= */

function classifyRow(r){
  // Prefer Type field
  const type = (r.Type || '').toString().toLowerCase();
  const acc = (r.Account || '').toString().toLowerCase();

  // map to categories
  const isAsset = /asset|أصل|cash|bank|current asset|fixed asset|inventory|مخزون|أصول/.test(type) ||
                  /النقد|bank|cash|نقد|مخزون|inventory|أصول/.test(acc);
  const isLiab = /liab|خصوم|payable|loan|قرض|قروض/.test(type) || /دائن|المورد|payable/.test(acc);
  const isEquity = /equity|حقوق|رأس|capital|حقوق الملكية/.test(type) || /رأس|حقوق/.test(acc);
  const isRevenue = /revenue|sales|إيراد|مبيعات/.test(type) || /إيراد|مبيعات|revenue|sales/.test(acc);
  const isExpense = /expense|مصروف|cogs|تكلفة|مصاريف|اهتلاك|depreciation/.test(type) || /مصروف|تكلفة|مصاريف/.test(acc);

  if(isAsset) return 'asset';
  if(isLiab) return 'liability';
  if(isEquity) return 'equity';
  if(isRevenue) return 'revenue';
  if(isExpense) return 'expense';
  return 'other';
}

function computeStatements(){
  // initialize aggregates
  const agg = { assets:0, liabilities:0, equity:0, revenue:0, expense:0, other:0 };

  // also gather detailed buckets
  const bsItems = [];
  const isItems = [];
  const cfItems = []; // simplified
  const eqItems = [];

  trialData.forEach(r => {
    const debit = Number(r.Debit) || 0;
    const credit = Number(r.Credit) || 0;
    const net = debit - credit; // positive => debit balance; negative => credit balance
    const cat = classifyRow(r);

    // For presentation, convert numbers using convert() at display time
    if(cat === 'asset'){ agg.assets += net; bsItems.push({label:r.Account||'أصل', value:net}); }
    else if(cat === 'liability'){ agg.liabilities += (-net); bsItems.push({label:r.Account||'التزامات', value:-net}); }
    else if(cat === 'equity'){ agg.equity += (-net); eqItems.push({label:r.Account||'حقوق الملكية', value:-net}); }
    else if(cat === 'revenue'){ agg.revenue += (-net); isItems.push({label:r.Account||'إيراد', value:-net}); }
    else if(cat === 'expense'){ agg.expense += net; isItems.push({label:r.Account||'مصروف', value:net}); }
    else { agg.other += net; bsItems.push({label:r.Account||'أخرى', value:net}); }
  });

  // Net income = revenue - expense
  const netIncome = agg.revenue - agg.expense;

  // For cash flow (approx): approximate operating cash = net income +/- change in working capital (we don't have time-series)
  // We'll approximate: operating = netIncome, investing = sum of negative 'asset' changes (approx), financing = equity changes
  // Because we only have one point (trial balance), show simplified breakdown.
  const operating = netIncome;
  const investing = 0; // cannot infer without prior period
  const financing = agg.equity; // simplistic

  // compose objects to return
  return {
    agg,
    bsItems,
    isItems,
    eqItems,
    netIncome,
    operating,
    investing,
    financing
  };
}

/* =========================
   Rendering functions
   ========================= */
let bsChart, isChart, cfChart;

function renderAll(){
  // reload trialData
  trialData = JSON.parse(localStorage.getItem('trialData') || '[]') || [];

  if(!trialData.length){
    // show no data message in main sections
    document.getElementById('kpiRow').innerHTML = `<div class="card-surface empty-hint">${t('noData')}</div>`;
    $('bsTable').innerHTML = `<tr><td colspan="2">${t('noData')}</td></tr>`;
    $('isTable').innerHTML = `<tr><td colspan="2">${t('noData')}</td></tr>`;
    $('cfTable').innerHTML = `<tr><td colspan="2">${t('noData')}</td></tr>`;
    $('eqTable').innerHTML = `<tr><td colspan="2">${t('noData')}</td></tr>`;
    // destroy charts if exist
    try{ if(bsChart) bsChart.destroy(); if(isChart) isChart.destroy(); if(cfChart) cfChart.destroy(); }catch(e){}
    return;
  }

  const { agg, bsItems, isItems, eqItems, netIncome, operating, investing, financing } = computeStatements();
  const fx = getFxRates();

  // KPIs
  const kpiRow = $('kpiRow'); kpiRow.innerHTML = '';
  const kpis = [
    {label: t('accounts') || 'Accounts', value: trialData.length},
    {label: t('assets') || 'Assets', value: agg.assets},
    {label: t('liabilities') || 'Liabilities', value: agg.liabilities},
    {label: t('revenue') || 'Revenue', value: agg.revenue},
    {label: t('expense') || 'Expense', value: agg.expense},
    {label: 'Net Income', value: netIncome}
  ];
  kpis.forEach(k => {
    const val = (typeof k.value === 'number') ? formatCurrency(convert(k.value)) : k.value;
    const el = document.createElement('div');
    el.className = 'kpi';
    el.innerHTML = `<div style="font-size:.85rem;color:var(--muted)">${escapeHtml(k.label)}</div><div style="font-size:1.12rem;font-weight:800;margin-top:6px">${val}</div>`;
    kpiRow.appendChild(el);
  });

  // Balance Sheet table
  const bsT = $('bsTable'); bsT.innerHTML = '';
  let bsTotal = 0;
  // group by label sums
  const bsGrouped = {};
  bsItems.forEach(it => { bsGrouped[it.label] = (bsGrouped[it.label] || 0) + it.value; });
  Object.keys(bsGrouped).forEach(lbl => {
    const v = bsGrouped[lbl];
    bsTotal += v;
    const row = document.createElement('tr');
    row.innerHTML = `<td>${escapeHtml(lbl)}</td><td class="fin-amount">${formatCurrency(convert(v))}</td>`;
    bsT.appendChild(row);
  });
  $('bsTotal').textContent = formatCurrency(convert(bsTotal));

  // Income statement table
  const isT = $('isTable'); isT.innerHTML = '';
  let revenueTotal = 0, expenseTotal = 0;
  const isGrouped = {};
  isItems.forEach(it => { isGrouped[it.label] = (isGrouped[it.label] || 0) + it.value; });
  Object.keys(isGrouped).forEach(lbl => {
    const v = isGrouped[lbl];
    if(/إيراد|Revenue|Sales|مبيعات/i.test(lbl)) revenueTotal += v; else expenseTotal += v;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(lbl)}</td><td class="fin-amount">${formatCurrency(convert(v))}</td>`;
    isT.appendChild(tr);
  });
  $('isNet').textContent = formatCurrency(convert(netIncome));

  // Cash Flow table (simplified)
  const cfT = $('cfTable'); cfT.innerHTML = '';
  const operatingV = operating, investingV = investing, financingV = financing;
  cfT.innerHTML = `<tr><td>التدفق من الأنشطة التشغيلية</td><td class="fin-amount">${formatCurrency(convert(operatingV))}</td></tr>
                   <tr><td>التدفق من الأنشطة الاستثمارية (تقريبي)</td><td class="fin-amount">${formatCurrency(convert(investingV))}</td></tr>
                   <tr><td>التدفق من الأنشطة التمويلية (تقريبي)</td><td class="fin-amount">${formatCurrency(convert(financingV))}</td></tr>`;
  $('cfNet').textContent = formatCurrency(convert(operatingV + investingV + financingV));

  // Equity table
  const eqT = $('eqTable'); eqT.innerHTML = '';
  const eqGrouped = {};
  eqItems.forEach(it => { eqGrouped[it.label] = (eqGrouped[it.label] || 0) + it.value; });
  let eqTotal = 0;
  Object.keys(eqGrouped).forEach(lbl => {
    const v = eqGrouped[lbl];
    eqTotal += v;
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(lbl)}</td><td class="fin-amount">${formatCurrency(convert(v))}</td>`; eqT.appendChild(tr);
  });
  $('eqTotal').textContent = formatCurrency(convert(eqTotal));

  // Charts
  // Balance sheet doughnut
  const bsCtx = document.getElementById('bsChart').getContext('2d');
  const bsDataLabels = Object.keys(bsGrouped).slice(0,8);
  const bsDataVals = bsDataLabels.map(k => Math.abs(bsGrouped[k] || 0));
  try{ if(bsChart) bsChart.destroy(); }catch(e){}
  bsChart = new Chart(bsCtx, {
    type:'doughnut',
    data:{labels: bsDataLabels, datasets:[{data: bsDataVals, backgroundColor:['#0d6efd','#6610f2','#198754','#ffc107','#dc3545','#0dcaf0','#6c757d','#fd7e14']}]},
    options:{plugins:{legend:{position:'bottom'}}}
  });

  // Income statement bar
  const isCtx = document.getElementById('isChart').getContext('2d');
  try{ if(isChart) isChart.destroy(); }catch(e){}
  isChart = new Chart(isCtx, {
    type:'bar',
    data:{labels:Object.keys(isGrouped), datasets:[{label:'Amount', data:Object.values(isGrouped).map(Math.abs)}]},
    options:{plugins:{legend:{display:false}}}
  });

  // Cash flow pie/ doughnut
  const cfCtx = document.getElementById('cfChart').getContext('2d');
  try{ if(cfChart) cfChart.destroy(); }catch(e){}
  cfChart = new Chart(cfCtx, {
    type:'pie',
    data:{labels:['Operating','Investing','Financing'], datasets:[{data:[Math.abs(operatingV), Math.abs(investingV), Math.abs(financingV)], backgroundColor:['#0d6efd','#dc3545','#198754']}]},
    options:{plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{label: ctx => `${ctx.label}: ${formatCurrency(ctx.formattedValue||ctx.parsed)}`}}}}
  });
}

/* helper formatting */
function formatCurrency(n){
  if(n===undefined || n===null) return '-';
  const cur = $('currencySelect').value || 'EGP';
  const fx = getFxRates();
  const display = Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  return `${display} ${cur}`;
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

/* =========================
   Events & init
   ========================= */
document.getElementById('refreshBtn').addEventListener('click', ()=> { renderAll(); showToast('تم التحديث', 'success'); });
document.getElementById('gotoInput').addEventListener('click', ()=> { window.location.href = 'input.html'; });

// Language change
$('languageSelect').addEventListener('change', ()=> { localStorage.setItem('fa_lang', $('languageSelect').value); applyLanguage(); renderAll(); });

// Currency change or FX manual change
$('currencySelect').addEventListener('change', ()=> { localStorage.setItem('fa_currency', $('currencySelect').value); updateCurrencySymbols(); renderAll(); });
$('fxInput').addEventListener('input', ()=> { localStorage.setItem('fa_fx_manual', $('fxInput').value); renderAll(); });

// Dark mode toggle
$('darkModeToggle').addEventListener('change', (e)=> {
  const mode = e.target.checked ? 'dark' : 'light';
  document.body.dataset.theme = mode;
  localStorage.setItem('fa_theme', mode);
});

// Export PDF (capture main area; watermark present in DOM)
$('exportPdfBtn').addEventListener('click', ()=>{
  const el = document.getElementById('mainArea');
  // briefly increase watermark visibility for export
  const wm = document.querySelector('.watermark img');
  const old = wm.style.opacity || '';
  wm.style.opacity = '0.18';
  const opt = { margin:0.35, filename:'financial_report.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2, useCORS:true, allowTaint:true}, jsPDF:{unit:'in', format:'a4', orientation:'portrait'} };
  html2pdf().set(opt).from(el).save().finally(()=> { wm.style.opacity = old; });
});

// small toast utility
function showToast(msg, type='info'){
  const area = document.getElementById('toastArea');
  const el = document.createElement('div'); el.className = `toast align-items-center text-bg-${type} border-0 show`; el.style.minWidth='200px'; el.style.marginTop='8px'; el.style.pointerEvents='auto';
  el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.toast').remove()"></button></div>`;
  area.appendChild(el); setTimeout(()=> el.remove(), 3500);
}

/* keyboard accessibility: ctrl+R refresh */
window.addEventListener('keydown', (e)=> { if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='r'){ e.preventDefault(); renderAll(); showToast('Refreshed','info'); } });

/* initialize */
(function init(){
  populateControls();
  applyLanguage();
  renderAll();
})();
</script>
</body>
</html>
