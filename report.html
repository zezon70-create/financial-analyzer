<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>التقرير المالي — Financial Analyzer (Ultra Pro Max)</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<!-- Styles: Modern glass + gradient -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f7fb; --card:#ffffff; --muted:#6c757d; --glass:rgba(255,255,255,0.6);
  --accent-1:#0d6efd; --accent-2:#6610f2;
  --radius:12px;
}
html,body{height:100%;margin:0;font-family:'Cairo',system-ui,sans-serif;background:var(--bg);color:#0b1220}
body[data-theme="dark"]{ --bg:#071018; --card:#07131a; --muted:#9aa6b2; color:#e6eef6; --glass: rgba(6,10,15,0.5); }
.container{max-width:1200px;margin:20px auto;padding:18px}
.site-header{position:sticky;top:10px;z-index:1400;padding:12px;border-radius:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(135deg,rgba(255,255,255,0.35),rgba(255,255,255,0.05));backdrop-filter:blur(8px);border:1px solid rgba(13,110,253,0.06)}
.brand{display:flex;align-items:center;gap:12px}
.brand img{height:42px;border-radius:8px}
.controls{display:flex;align-items:center;gap:8px}

/* Buttons */
.btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:transparent}
.btn-primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#fff;border:none;box-shadow:0 8px 30px rgba(102,16,242,0.08)}
.btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
.icon{margin-inline-start:6px}

/* Header small inputs */
select, input[type="number"]{padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);}

/* Card */
.card{background:var(--card);border-radius:12px;padding:16px;margin-top:14px;box-shadow:0 10px 30px rgba(2,6,23,0.04);border:1px solid rgba(13,110,253,0.03)}
h1,h2{margin:6px 0}
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:12px}
.kpi{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.3));text-align:center}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th, .table td{padding:10px;border:1px solid rgba(0,0,0,0.06);text-align:center}
.table th{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#fff}
.controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* floating add-row button (inline near last row) */
.add-row-inline{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;background:linear-gradient(90deg,#00c6ff,#0072ff);color:#fff;cursor:pointer;border:none}

/* comment */
.comment{margin-top:10px;padding:12px;border-radius:8px;background:linear-gradient(90deg,rgba(13,110,253,0.04),rgba(102,16,242,0.02));color:var(--muted)}

/* responsive */
@media (max-width:900px){ .kpi-row{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))} .controls{flex-wrap:wrap} }
.small{font-size:0.9rem;color:var(--muted)}
</style>
</head>
<body data-theme="light">
<div class="container">

  <!-- Header -->
  <header class="site-header" role="banner" aria-label="site header">
    <div class="brand">
      <img src="assets/logo.png" id="logo" alt="logo">
      <div>
        <div id="brandTitle" style="font-weight:800">المحلل المالي</div>
        <div class="small" id="brandDesc">أداة ذكية لتحليل القوائم المالية — Ultra Pro Max</div>
      </div>
    </div>

    <div class="controls" role="navigation" aria-label="controls">
      <button class="btn btn-ghost" id="btnHome" title="Home" onclick="location.href='index.html'">🏠 <span id="lblHome">الرئيسية</span></button>

      <!-- Upload Data (header) -->
      <button class="btn btn-ghost" id="btnUploadHeader" title="Upload Data"><i class="icon">⬆️</i> <span id="lblUploadHeader">رفع البيانات | Upload Data</span></button>

      <select id="dataSource" title="Source" aria-label="اختيار مصدر البيانات">
        <option value="trialData">من صفحة الإدخال (Input)</option>
        <option value="uploadedData">من صفحة الرفع (Upload)</option>
        <option value="inputData">حفظ مؤقت (inputData)</option>
      </select>

      <select id="langSelect" aria-label="language">
        <option value="ar">العربية</option>
        <option value="en">English</option>
      </select>

      <select id="currencySelect" aria-label="currency">
        <option value="EGP">ج.م (EGP)</option>
        <option value="USD">USD ($)</option>
        <option value="EUR">EUR (€)</option>
      </select>

      <input id="fxInput" type="number" step="any" style="width:120px" title="FX rate" aria-label="سعر الصرف">
      <button class="btn btn-ghost" id="btnTheme" title="Toggle theme">🌓</button>

      <button class="btn btn-primary" id="btnAdvanced" title="Advanced Analytics">📊 <span id="lblAdvanced">التحليلات المتقدمة</span></button>

      <button class="btn btn-ghost" id="btnExportPdf" title="Export PDF">📄 <span id="lblExportPdf">تصدير PDF</span></button>
      <button class="btn btn-ghost" id="btnExportXlsx" title="Export Excel">📈 <span id="lblExportXlsx">تصدير Excel</span></button>
    </div>
  </header>

  <!-- Main -->
  <main>
    <div class="card">
      <h1 id="pageTitle">📑 التقرير المالي</h1>
      <div class="controls-row" style="justify-content:space-between">
        <div class="small-muted small" id="lastUpdate">آخر تحديث: —</div>
        <div class="controls">
          <label class="small" id="lblYear">السنة</label>
          <select id="yearSelect"><option>2023</option><option>2022</option><option>2021</option></select>
          <button class="btn btn-ghost" id="btnRefresh">🔄 <span id="lblRefresh">تحديث</span></button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="kpi-row" id="kpiRow" aria-live="polite"></div>
    </div>

    <!-- Balance Sheet -->
    <section class="card" id="bsCard">
      <h2 id="bsTitle">الميزانية العمومية (Balance Sheet)</h2>
      <div class="small" id="bsComment"></div>
      <div style="overflow:auto">
        <table class="table" id="bsTable" role="table" aria-label="balance sheet table">
          <thead><tr id="bsHead"><th>البند</th><th id="bsY1">2023</th><th id="bsY2">2022</th><th>الانحراف</th><th>إجراء</th></tr></thead>
          <tbody id="bsBody"></tbody>
        </table>
      </div>
      <canvas id="bsChart" height="120"></canvas>
    </section>

    <!-- Income Statement -->
    <section class="card" id="isCard">
      <h2 id="isTitle">قائمة الدخل (Income Statement)</h2>
      <div class="small" id="isComment"></div>
      <div style="overflow:auto">
        <table class="table" id="isTable">
          <thead><tr id="isHead"><th>البند</th><th id="isY1">2023</th><th id="isY2">2022</th><th>الانحراف</th><th>إجراء</th></tr></thead>
          <tbody id="isBody"></tbody>
        </table>
      </div>
      <canvas id="isChart" height="120"></canvas>
    </section>

    <!-- Cash Flow -->
    <section class="card" id="cfCard">
      <h2 id="cfTitle">التدفقات النقدية (Cash Flow)</h2>
      <div class="small" id="cfComment"></div>
      <div style="overflow:auto">
        <table class="table" id="cfTable">
          <thead><tr id="cfHead"><th>البند</th><th id="cfY1">2023</th><th id="cfY2">2022</th><th>الانحراف</th><th>إجراء</th></tr></thead>
          <tbody id="cfBody"></tbody>
        </table>
      </div>
      <canvas id="cfChart" height="120"></canvas>
    </section>

    <!-- Equity -->
    <section class="card" id="eqCard">
      <h2 id="eqTitle">حقوق الملكية (Equity)</h2>
      <div class="small" id="eqComment"></div>
      <div style="overflow:auto">
        <table class="table" id="eqTable">
          <thead><tr id="eqHead"><th>البند</th><th id="eqY1">2023</th><th id="eqY2">2022</th><th>الانحراف</th><th>إجراء</th></tr></thead>
          <tbody id="eqBody"></tbody>
        </table>
      </div>
      <canvas id="eqChart" height="120"></canvas>
    </section>

  </main>

  <footer style="text-align:center;margin-top:16px" class="small-muted small">&copy; 2025 المحلل المالي — Financial Analyzer</footer>
</div>

<script>
/* ==========================
   Translations (ar/en)
   ========================== */
const T = {
  ar: {
    brandTitle: "المحلل المالي",
    brandDesc: "أداة ذكية لتحليل القوائم المالية — Ultra Pro Max",
    home: "الرئيسية", uploadHeader: "رفع البيانات | Upload Data", advanced: "التحليلات المتقدمة",
    exportPdf: "تصدير PDF", exportXlsx:"تصدير Excel", pageTitle:"📑 التقرير المالي",
    year:"السنة", refresh:"تحديث", lastUpdate:"آخر تحديث:",
    bsTitle:"الميزانية العمومية", isTitle:"قائمة الدخل", cfTitle:"التدفقات النقدية", eqTitle:"حقوق الملكية",
    accounts:"عدد البنود", assets:"الأصول", liabilities:"الخصوم", revenue:"الإيرادات", expense:"المصروفات",
    addRow:"إضافة سطر",
    btnAdd:"إضافة",
    edit:"تعديل",
    delete:"حذف",
    noData:"لا توجد بيانات متاحة للمصدر المحدد."
  },
  en: {
    brandTitle: "Financial Analyzer",
    brandDesc: "Smart tool for financial statements analysis — Ultra Pro Max",
    home: "Home", uploadHeader: "Upload Data", advanced: "Advanced Analytics",
    exportPdf: "Export PDF", exportXlsx:"Export Excel", pageTitle:"📑 Financial Report",
    year:"Year", refresh:"Refresh", lastUpdate:"Last update:",
    bsTitle:"Balance Sheet", isTitle:"Income Statement", cfTitle:"Cash Flow", eqTitle:"Equity",
    accounts:"Items", assets:"Assets", liabilities:"Liabilities", revenue:"Revenue", expense:"Expenses",
    addRow:"Add Row", btnAdd:"Add", edit:"Edit", delete:"Delete", noData:"No data available for selected source."
  }
};

/* ==========================
   Utilities & State
   ========================== */
const $ = id => document.getElementById(id);
let lang = localStorage.getItem('fa_lang') || 'ar';
let currency = localStorage.getItem('fa_currency') || 'EGP';
let fxRates = JSON.parse(localStorage.getItem('fa_fx')||'null') || { USD:31.0, EUR:34.0 }; // default EGP per USD/EUR
let theme = localStorage.getItem('fa_theme') || 'light';
let charts = {}; // hold Chart instances
let loadedData = { bs:[], is:[], cf:[], eq:[] }; // balance sheet, income statement, cash flow, equity
let lastUpdated = null;

/* format number according to currency and language */
function toNum(v){ v = v==null?0:v; const n = Number(String(v).toString().replace(/[, ]+/g,'')); return isNaN(n)?0:n; }
function formatCurrency(value){
  const num = Number(value || 0);
  const cur = currency || 'EGP';
  const nf = new Intl.NumberFormat(lang==='ar' ? 'ar-EG' : 'en-US', { maximumFractionDigits:2, minimumFractionDigits:0 });
  const formatted = nf.format(cur==='EGP' ? num : num / (fxRates[cur]||1));
  if(cur==='EGP') return `${formatted} ج.م`;
  if(cur==='USD') return `$${formatted}`;
  if(cur==='EUR') return `€${formatted}`;
  return `${formatted} ${cur}`;
}

/* translate utility */
function tr(key){ return (T[lang] && T[lang][key])? T[lang][key] : key; }

/* set UI language */
function applyLanguage(){
  $('brandTitle').textContent = tr('brandTitle');
  $('brandDesc').textContent = tr('brandDesc');
  $('lblHome').textContent = tr('home');
  $('lblUploadHeader').textContent = tr('uploadHeader');
  $('lblAdvanced').textContent = tr('advanced');
  $('lblExportPdf').textContent = tr('exportPdf');
  $('lblExportXlsx').textContent = tr('exportXlsx');
  $('pageTitle').textContent = tr('pageTitle');
  $('lblYear').textContent = tr('year');
  $('lblRefresh').textContent = tr('refresh');
  $('lastUpdate').textContent = `${tr('lastUpdate')} ${lastUpdated ? new Date(lastUpdated).toLocaleString(lang==='ar'?'ar-EG':'en-US') : '—'}`;

  // section titles
  $('bsTitle').textContent = tr('bsTitle') + ' (' + (lang==='ar' ? 'Balance Sheet' : 'Balance Sheet') + ')';
  $('isTitle').textContent = tr('isTitle') + ' (' + (lang==='ar' ? 'Income Statement' : 'Income Statement') + ')';
  $('cfTitle').textContent = tr('cfTitle') + ' (' + (lang==='ar' ? 'Cash Flow' : 'Cash Flow') + ')';
  $('eqTitle').textContent = tr('eqTitle') + ' (' + (lang==='ar' ? 'Equity' : 'Equity') + ')';

  // table headers & buttons will be refreshed on render
}

/* set theme */
function applyTheme(){
  document.body.dataset.theme = theme;
}

/* save prefs */
function savePrefs(){ localStorage.setItem('fa_lang', lang); localStorage.setItem('fa_currency', currency); localStorage.setItem('fa_fx', JSON.stringify(fxRates)); localStorage.setItem('fa_theme', theme); }

/* ==========================
   Loading data from localStorage (sources)
   Keys checked: trialData, uploadedData, inputData
   Format expected: array of rows with properties: Account, Type, Code, Debit, Credit, Category (optional)
   For report we will synthesize lists by Category keywords; if not, we'll fallback to sample aggregated rows
   ========================== */
function loadFromSourceKey(key){
  const raw = localStorage.getItem(key);
  if(!raw) return null;
  try{
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)) return parsed;
    // if saved as object with sections, accept
    if(parsed && (parsed.bs || parsed.is || parsed.cf || parsed.eq)) return parsed;
    return null;
  }catch(e){ console.error('parse error',e); return null; }
}

/* build aggregated statements from trial balance rows */
function synthesizeStatements(rows){
  // naive mapping based on keywords in Type or Account
  const bs = {}, is = {}, cf = {}, eq = {};
  // helper to add
  function add(target, name, year, val){ target[name] = target[name] || { name, y1:0, y2:0 }; target[name][year] += toNum(val); }
  rows.forEach(r => {
    const acc = (r.Account||'').toString().toLowerCase();
    const type = (r.Type||'').toString().toLowerCase();
    // We treat Debit as positive for asset/expense; Credit as positive for liability/revenue.
    const dr = toNum(r.Debit), cr = toNum(r.Credit);
    const net = dr - cr;

    // Balance sheet candidates
    if(/asset|أصل|cash|bank|inventory|fixed|أصول/.test(type) || /النقد|بنك|أصول|مخزون/.test(acc)){
      add(bs, 'الأصول المتداولة', 'y1', net);
    } else if(/liab|خصوم|payable|قرض|دائن/.test(type) || /موردون|قروض|خصوم/.test(acc)){
      add(bs, 'الخصوم', 'y1', -net);
    } else if(/equity|حقوق|رأس/.test(type) || /رأس/.test(acc)){
      add(eq, 'حقوق الملكية', 'y1', -net);
    } else if(/revenue|sales|إيراد|مبيعات/.test(type) || /مبيعات|إيرادات/.test(acc)){
      add(is, 'الإيرادات', 'y1', -net);
    } else if(/expense|مصروف|تكلفة|مصاريف/.test(type) || /مصروف|مصاريف|تكلفة/.test(acc)){
      add(is, 'المصروفات', 'y1', net);
    } else {
      // fallback: treat as other assets
      add(bs, 'أخرى', 'y1', net);
    }
  });

  // Create sample second year by slightly adjusting numbers if missing
  function toArr(obj){
    return Object.values(obj).map(it => ({ name: it.name, y1: it.y1 || 0, y2: Math.round((it.y1 || 0) * (0.9 + Math.random()*0.3)) }));
  }
  return { bs: toArr(bs), is: toArr(is), cf: [{name:'التشغيل', y1:0,y2:0},{name:'الاستثمار',y1:0,y2:0},{name:'التمويل',y1:0,y2:0}], eq: toArr(eq).length?toArr(eq):[{name:'رأس المال', y1:0,y2:0},{name:'الأرباح المحتجزة',y1:0,y2:0}] };
}

/* If stored data is already structured (bs,is,cf,eq) accept it */
function normalizeLoaded(raw){
  if(!raw) return null;
  // if object with sections
  if(raw.bs || raw.is || raw.cf || raw.eq) return {
    bs: raw.bs || [],
    is: raw.is || [],
    cf: raw.cf || [],
    eq: raw.eq || []
  };
  // if array of rows - synthesize
  if(Array.isArray(raw)) return synthesizeStatements(raw);
  return null;
}

/* Main load pipeline according to selected dataSource */
function loadData(){
  const sourceKey = $('dataSource').value; // user selection
  // Try preferred key first
  let raw = loadFromSourceKey(sourceKey);
  // fallback order
  if(!raw) raw = loadFromSourceKey('trialData') || loadFromSourceKey('uploadedData') || loadFromSourceKey('inputData') || null;
  let normalized = normalizeLoaded(raw);
  if(!normalized){
    // no data: try to look for trialData or uploadedData arrays
    const t = loadFromSourceKey('trialData') || loadFromSourceKey('uploadedData') || loadFromSourceKey('inputData');
    normalized = normalizeLoaded(t);
  }
  if(!normalized){
    // fallback to default example values
    normalized = {
      bs: [
        {name: lang==='ar'?'الأصول المتداولة':'Current Assets', y1:500000, y2:450000},
        {name: lang==='ar'?'الأصول الثابتة':'Fixed Assets', y1:800000, y2:700000},
        {name: lang==='ar'?'الخصوم':'Liabilities', y1:400000, y2:350000},
        {name: lang==='ar'?'حقوق الملكية':'Equity', y1:900000, y2:800000}
      ],
      is: [
        {name: lang==='ar'?'الإيرادات':'Revenue', y1:1200000, y2:1000000},
        {name: lang==='ar'?'المصروفات':'Expenses', y1:700000, y2:600000},
        {name: lang==='ar'?'صافي الربح':'Net Profit', y1:500000, y2:400000}
      ],
      cf: [
        {name: lang==='ar'?'التشغيل':'Operating', y1:300000, y2:250000},
        {name: lang==='ar'?'الاستثمار':'Investing', y1:-100000, y2:-80000},
        {name: lang==='ar'?'التمويل':'Financing', y1:50000, y2:60000}
      ],
      eq: [
        {name: lang==='ar'?'رأس المال':'Capital', y1:500000, y2:500000},
        {name: lang==='ar'?'الأرباح المحتجزة':'Retained Earnings', y1:400000, y2:300000}
      ]
    };
  }

  loadedData = normalized;
  lastUpdated = Date.now();
  renderAll();
}

/* ==========================
   Render functions for each section
   ========================== */
function renderKPIs(){
  const items = [];
  // counts and aggregates
  const totalItems = loadedData.bs.length + loadedData.is.length + loadedData.cf.length + loadedData.eq.length;
  const assetsTotal = loadedData.bs.reduce((s,r)=> s + Math.abs(toNum(r.y1)),0);
  const liabilitiesTotal = loadedData.bs.reduce((s,r)=> s + ( /خصوم|liab|liabilities/i.test((r.name||'')) ? Math.abs(toNum(r.y1)) : 0 ),0) || 0;
  const revenue = loadedData.is.reduce((s,r)=> s + Math.abs(toNum(r.y1)),0);
  const expense = loadedData.is.reduce((s,r)=> s + Math.abs(toNum(r.y1)),0);
  items.push({label: tr('accounts'), value: totalItems, isCurrency:false});
  items.push({label: tr('assets'), value: assetsTotal, isCurrency:true});
  items.push({label: tr('liabilities'), value: liabilitiesTotal, isCurrency:true});
  items.push({label: tr('revenue'), value: revenue, isCurrency:true});
  items.push({label: tr('expense'), value: expense, isCurrency:true});

  const container = $('kpiRow'); container.innerHTML = '';
  items.forEach(it=>{
    const div = document.createElement('div'); div.className='kpi';
    const val = it.isCurrency ? formatCurrency(it.value) : String(it.value);
    div.innerHTML = `<div class="small-muted" style="font-size:0.95rem">${it.label}</div><div style="font-weight:800;margin-top:6px">${val}</div>`;
    container.appendChild(div);
  });
}

function renderTable(section, tableId, chartId, commentId){
  const rows = loadedData[section] || [];
  const body = $(tableId);
  body.innerHTML = '';
  if(!rows.length){
    body.innerHTML = `<tr><td colspan="5" class="small-muted">${tr('noData')}</td></tr>`;
    // clear chart if exists
    if(charts[chartId]) { charts[chartId].destroy(); charts[chartId]=null; }
    $(commentId).textContent = '';
    return;
  }

  rows.forEach((r, idx)=>{
    const trEl = document.createElement('tr');
    const name = r.name || '';
    const y1 = r.y1 || 0;
    const y2 = r.y2 || 0;
    const diff = y2? Math.round(((y1 - y2)/Math.abs(y2||1))*100) : 0;
    trEl.innerHTML = `
      <td>${escapeHtml(name)}</td>
      <td>${formatCurrency(y1)}</td>
      <td>${formatCurrency(y2)}</td>
      <td>${diff>=0? '+'+diff+'%': diff+'%'}</td>
      <td>
        <button class="btn btn-ghost" data-idx="${idx}" data-section="${section}" onclick="editRow(event)">${tr('edit')}</button>
        <button class="btn btn-ghost" data-idx="${idx}" data-section="${section}" onclick="deleteRow(event)">${tr('delete')}</button>
      </td>`;
    body.appendChild(trEl);
  });

  // Add inline Add Row button next to last row action cell
  addInlineAddRow(tableId, section);

  // draw chart
  drawChart(section, chartId);

  // comment: generate smart comment
  const comm = generateComment(section);
  $(commentId).textContent = comm;
}

/* helper escape */
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* Add inline add-row button near last row */
function addInlineAddRow(tableId, section){
  const tbody = $(tableId);
  // find last row's action cell: last child tr last td
  const trs = tbody.querySelectorAll('tr');
  if(trs.length===0) return;
  const lastTr = trs[trs.length-1];
  const actionTd = lastTr.querySelector('td:last-child');
  if(!actionTd) return;

  // create button
  let addBtn = actionTd.querySelector('.add-row-inline');
  if(!addBtn){
    addBtn = document.createElement('button');
    addBtn.className = 'add-row-inline';
    addBtn.innerHTML = '<span>➕</span> <span class="small">'+ tr('addRow') +'</span>';
    addBtn.onclick = ()=> { addRowToSection(section); };
    actionTd.appendChild(addBtn);
  } else {
    // move it to this actionTd if present elsewhere
    actionTd.appendChild(addBtn);
  }
}

/* Add row to data and re-render; row inserted under last */
function addRowToSection(section){
  // prompt user for name & values
  const name = prompt(lang==='ar' ? 'أدخل اسم البند الجديد' : 'Enter new item name');
  if(name === null) return;
  const y1raw = prompt(lang==='ar' ? 'قيمة السنة الحالية (مثال: 120000)' : 'Value for current year (e.g. 120000)', '0');
  if(y1raw === null) return;
  const y2raw = prompt(lang==='ar' ? 'قيمة السنة السابقة' : 'Value for previous year', '0');
  if(y2raw === null) return;
  const y1 = toNum(y1raw), y2 = toNum(y2raw);
  loadedData[section].push({ name, y1, y2 });
  saveAsTemp(); renderAll();
}

/* Edit and delete handlers */
function editRow(e){
  const btn = e.currentTarget;
  const idx = Number(btn.dataset.idx); const section = btn.dataset.section;
  const row = loadedData[section][idx];
  const newName = prompt(lang==='ar' ? 'تعديل اسم البند' : 'Edit item name', row.name);
  if(newName === null) return;
  const newY1 = prompt(lang==='ar' ? 'قيمة السنة الحالية' : 'Value for current year', row.y1);
  if(newY1 === null) return;
  const newY2 = prompt(lang==='ar' ? 'قيمة السنة السابقة' : 'Value for previous year', row.y2);
  if(newY2 === null) return;
  row.name = newName; row.y1 = toNum(newY1); row.y2 = toNum(newY2);
  saveAsTemp(); renderAll();
}
function deleteRow(e){
  if(!confirm(lang==='ar' ? 'هل تريد حذف هذا السطر؟' : 'Delete this row?')) return;
  const btn = e.currentTarget; const idx = Number(btn.dataset.idx); const section = btn.dataset.section;
  loadedData[section].splice(idx,1);
  saveAsTemp(); renderAll();
}

/* draw charts per section */
function drawChart(section, chartId){
  const ctx = $(chartId);
  if(!ctx) return;
  const data = loadedData[section] || [];
  const labels = data.map(r => r.name);
  const y1 = data.map(r => Number(r.y1||0));
  const y2 = data.map(r => Number(r.y2||0));
  // destroy old chart
  if(charts[chartId]) try{ charts[chartId].destroy(); }catch(e){}
  const cfg = {
    type: (section==='is' ? 'line' : (section==='cf' ? 'pie' : 'bar')),
    data: {
      labels,
      datasets: [
        { label: (lang==='ar'?'السنة الحالية':'This Year'), data: y1, backgroundColor:'#0d6efd', borderColor:'#0d6efd', tension:0.3 },
        { label: (lang==='ar'?'السنة السابقة':'Last Year'), data: y2, backgroundColor:'#6610f2', borderColor:'#6610f2', tension:0.3 }
      ]
    },
    options: {
      responsive:true,
      plugins: { legend:{position:'bottom'} },
      scales: { y: { ticks: { callback: val => formatCurrency(val) } } }
    }
  };
  // For pie chart (cf) use single dataset absolute
  if(section==='cf'){
    cfg.type='pie';
    cfg.data = { labels, datasets:[{ data: y1.map(v=>Math.abs(v)), backgroundColor: ['#198754','#ffc107','#dc3545','#6c757d','#0d6efd'] }] };
  }
  charts[chartId] = new Chart(ctx, cfg);
}

/* generate comment (smart) */
function generateComment(section){
  const rows = loadedData[section] || [];
  if(!rows.length) return '';
  // compute totals and simple analysis
  const totalY1 = rows.reduce((s,r)=> s + toNum(r.y1),0);
  const totalY2 = rows.reduce((s,r)=> s + toNum(r.y2),0);
  const diffPerc = totalY2? Math.round(((totalY1 - totalY2)/Math.abs(totalY2))*100) : 0;
  // summary sentence
  if(lang==='ar'){
    if(section==='bs') return `مجموع عناصر ${tr('bsTitle')} للسنة الحالية ${formatCurrency(totalY1)}، مقارنةً بـ ${formatCurrency(totalY2)} للسنة السابقة — تغير ${diffPerc>=0? '+'+diffPerc+'%': diffPerc+'%'}.\n${analysisSentence(section, totalY1, totalY2)}`;
    if(section==='is') return `مجموع ${tr('isTitle')} للسنة الحالية ${formatCurrency(totalY1)} مقابل ${formatCurrency(totalY2)} — تغيير ${diffPerc>=0? '+'+diffPerc+'%': diffPerc+'%'}.\n${analysisSentence(section, totalY1, totalY2)}`;
    if(section==='cf') return `صافي التدفقات للسنة الحالية ${formatCurrency(totalY1)} مقابل ${formatCurrency(totalY2)} — ${diffPerc>=0? 'تحسُن' : 'تراجع'} ${Math.abs(diffPerc)}%.\n${analysisSentence(section, totalY1, totalY2)}`;
    if(section==='eq') return `إجمالي ${tr('eqTitle')} ${formatCurrency(totalY1)} مقابل ${formatCurrency(totalY2)} — ${diffPerc>=0? 'زيادة' : 'انخفاض'} ${Math.abs(diffPerc)}%.\n${analysisSentence(section, totalY1, totalY2)}`;
  } else {
    if(section==='bs') return `Total ${tr('bsTitle')} this year ${formatCurrency(totalY1)} vs ${formatCurrency(totalY2)} last year — change ${diffPerc>=0? '+'+diffPerc+'%': diffPerc+'%'}. ${analysisSentence(section, totalY1, totalY2)}`;
    if(section==='is') return `Total ${tr('isTitle')} this year ${formatCurrency(totalY1)} vs ${formatCurrency(totalY2)} — change ${diffPerc>=0? '+'+diffPerc+'%': diffPerc+'%'}. ${analysisSentence(section, totalY1, totalY2)}`;
    if(section==='cf') return `Net cash flows this year ${formatCurrency(totalY1)} vs ${formatCurrency(totalY2)} — ${diffPerc>=0? 'improved' : 'declined'} ${Math.abs(diffPerc)}%. ${analysisSentence(section, totalY1, totalY2)}`;
    if(section==='eq') return `Total ${tr('eqTitle')} ${formatCurrency(totalY1)} vs ${formatCurrency(totalY2)} — ${diffPerc>=0? 'increase' : 'decrease'} ${Math.abs(diffPerc)}%. ${analysisSentence(section, totalY1, totalY2)}`;
  }
  return '';
}

/* produce a short professional explanation sentence */
function analysisSentence(section, a,b){
  if(section==='bs'){
    // if assets much > liabilities -> healthy
    const assets = loadedData.bs.reduce((s,r)=> s + ( /أصول|asset/i.test(r.name) ? toNum(r.y1) : 0),0);
    const liabilities = loadedData.bs.reduce((s,r)=> s + ( /خصوم|liab|liabilities/i.test(r.name) ? Math.abs(toNum(r.y1)) : 0),0);
    if(assets > liabilities*1.2) return lang==='ar' ? 'الهيكل المالي يبدو قويًا — الأصول تفوق الخصوم بشكل مريح.' : 'Financial structure looks strong — assets comfortably exceed liabilities.';
    if(assets < liabilities) return lang==='ar'? 'تنبيه: الخصوم تتجاوز الأصول — راجع السيولة والالتزامات.' : 'Warning: liabilities exceed assets — review liquidity and obligations.';
    return lang==='ar'? 'التوازن بين الأصول والخصوم مقبول — راجع التفاصيل لكل بند.' : 'Assets-to-liabilities balance is acceptable — review individual items.';
  }
  if(section==='is'){
    // revenue vs expense
    const revenue = loadedData.is.reduce((s,r)=> s + ( /إيراد|revenue|sales/i.test(r.name) ? Math.abs(toNum(r.y1)) : 0),0);
    const expense = loadedData.is.reduce((s,r)=> s + ( /مصروف|expense|cost|cogs/i.test(r.name) ? Math.abs(toNum(r.y1)) : 0),0);
    if(revenue > expense*1.2) return lang==='ar'? 'ربحية جيدة — الإيرادات تفوق المصروفات بشكل صحي.' : 'Good profitability — revenues exceed expenses comfortably.';
    if(revenue <= expense) return lang==='ar'? 'هام: المصروفات مساوية أو تفوق الإيرادات — تحقق من مجالات التكاليف.' : 'Important: expenses are equal to or exceed revenues — check cost areas.';
    return lang==='ar'? 'النتائج مقبولة — تحسينات ممكنة عبر التحكم في التكاليف.' : 'Results are acceptable — improvements possible via cost control.';
  }
  if(section==='cf'){
    // check cash nature
    const operating = (loadedData.cf[0] && loadedData.cf[0].y1) || 0;
    if(operating > 0) return lang==='ar'? 'التدفقات التشغيلية موجبة — إشارة جيدة للسيولة.' : 'Positive operating cash flows — good liquidity sign.';
    return lang==='ar'? 'التدفقات التشغيلية سلبية — قد يؤثر على السيولة قصيرة الأجل.' : 'Negative operating cash flows — may impact short-term liquidity.';
  }
  if(section==='eq'){
    // equity commentary
    return lang==='ar'? 'حقوق الملكية مستقرة أو في تحسن — راجع توزيع الأرباح والاحتياطيات.' : 'Equity is stable or improving — review dividends and reserves.';
  }
  return '';
}

/* render all sections */
function renderAll(){
  applyLanguage();
  applyTheme();
  $('lastUpdate').textContent = `${tr('lastUpdate')} ${new Date(lastUpdated).toLocaleString(lang==='ar'?'ar-EG':'en-US')}`;
  renderKPIs();
  renderTable('bs','bsBody','bsChart','bsComment');
  renderTable('is','isBody','isChart','isComment');
  renderTable('cf','cfBody','cfChart','cfComment');
  renderTable('eq','eqBody','eqChart','eqComment');
}

/* ==========================
   Export functions
   ========================== */
function exportPDF(){
  // Prepare a printable area (clone container)
  const el = document.querySelector('.container').cloneNode(true);
  // remove action buttons (edit/delete/add)
  el.querySelectorAll('.btn-ghost, .add-row-inline, button[onclick]').forEach(n=>n.remove());
  // set direction and styles appropriately
  el.style.maxWidth='1100px';
  const opt = { margin:0.35, filename:`financial_report_${new Date().toISOString().slice(0,10)}.pdf`, image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'a4', orientation:'portrait'} };
  html2pdf().set(opt).from(el).save();
}
function exportXlsx(){
  // Build workbook from loadedData
  const wb = XLSX.utils.book_new();
  function addSheet(name, rows){
    const sheetRows = [[ lang==='ar' ? 'البند' : 'Item', 'This Year', 'Last Year' ]];
    rows.forEach(r=> sheetRows.push([r.name, r.y1, r.y2]));
    const ws = XLSX.utils.aoa_to_sheet(sheetRows);
    XLSX.utils.book_append_sheet(wb, ws, name);
  }
  addSheet('BalanceSheet', loadedData.bs);
  addSheet('IncomeStatement', loadedData.is);
  addSheet('CashFlow', loadedData.cf);
  addSheet('Equity', loadedData.eq);
  XLSX.writeFile(wb, `financial_report_${new Date().toISOString().slice(0,10)}.xlsx`);
}

/* ==========================
   Save a temporary copy of current rendered data to localStorage.inputData
   (used by header Upload Data and persistence)
   ========================== */
function saveAsTemp(){
  const payload = { bs: loadedData.bs, is: loadedData.is, cf: loadedData.cf, eq: loadedData.eq, ts: Date.now() };
  localStorage.setItem('inputData', JSON.stringify(payload));
  lastUpdated = Date.now();
  savePrefs();
}

/* ==========================
   Header button behaviors
   ========================== */
$('btnUploadHeader').addEventListener('click', ()=>{
  // Save current rendered data to inputData
  saveAsTemp();
  showToast(lang==='ar' ? 'تم حفظ البيانات محليًا إلى inputData' : 'Saved data locally to inputData', 'success');
  // navigate to upload page
  window.location.href = 'upload.html';
});
$('btnAdvanced').addEventListener('click', ()=> { window.location.href = 'advanced.html'; });
$('btnExportPdf').addEventListener('click', ()=> exportPDF());
$('btnExportXlsx').addEventListener('click', ()=> exportXlsx());
$('btnRefresh').addEventListener('click', ()=> loadData());
$('btnTheme').addEventListener('click', ()=> { theme = (theme==='light'?'dark':'light'); applyTheme(); savePrefs(); });

$('langSelect').addEventListener('change', (e)=>{ lang = e.target.value; savePrefs(); renderAll(); });
$('currencySelect').addEventListener('change', (e)=>{ currency = e.target.value; savePrefs(); renderAll(); });
$('fxInput').addEventListener('change', (e)=>{ const cur = $('currencySelect').value; const v = toNum(e.target.value); if(v>0){ fxRates[cur]=v; localStorage.setItem('fa_fx', JSON.stringify(fxRates)); showToast(lang==='ar'?'تم تحديث سعر الصرف':'FX updated','success'); renderAll(); }});

/* small toast */
function showToast(msg, type='info'){
  const el = document.createElement('div');
  el.textContent = msg; el.style.position='fixed'; el.style.left='50%'; el.style.transform='translateX(-50%)';
  el.style.top='18px'; el.style.padding='10px 14px'; el.style.borderRadius='8px'; el.style.zIndex=9999;
  el.style.background = type==='success'? 'linear-gradient(90deg,#28a745,#198754)':'#0d6efd'; el.style.color='#fff';
  document.body.appendChild(el); setTimeout(()=> el.remove(),2500);
}

/* ==========================
   Initialization
   ========================== */
(function init(){
  // load preferences
  $('langSelect').value = lang;
  $('currencySelect').value = currency;
  $('fxInput').value = fxRates[currency] || (currency==='EGP'?1: (currency==='USD'?31:34));
  theme = localStorage.getItem('fa_theme') || theme;
  applyTheme();
  // initial load
  loadData();
  // show last updated if available in inputData
  const inputDataRaw = localStorage.getItem('inputData');
  if(inputDataRaw) try{ const p=JSON.parse(inputDataRaw); if(p.ts) lastUpdated = p.ts; }catch(e){}
  applyLanguage();
})();

/* Expose helpers for inline on* attributes */
window.editRow = editRow;
window.deleteRow = deleteRow;
window.addRowToSection = addRowToSection;
window.loadData = loadData;
window.exportPDF = exportPDF;
window.exportXlsx = exportXlsx;

</script>
</body>
</html>
