<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>إدخال ميزان المراجعة — المحلل المالي</title>

<!-- External libs -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
:root{
  --accent-1:#0d6efd; --accent-2:#6610f2;
  --bg:#f6f8fb; --card:#fff; --text:#0b1220; --muted:#6c757d;
  --glass: rgba(255,255,255,0.65);
  --glass-border: rgba(13,110,253,0.06);
  --glass-shadow: 0 12px 30px rgba(2,6,23,0.04);
  --radius:12px;
}
html,body{height:100%}
body{font-family:"Cairo",system-ui,sans-serif;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;transition: background .22s, color .22s;}
body[data-theme="dark"]{
  --bg:#071018; --card:#07131a; --text:#e6eef6; --muted:#9aa6b2; --glass:rgba(6,10,15,0.5);
  --glass-border: rgba(255,255,255,0.04); --glass-shadow: 0 10px 30px rgba(0,0,0,0.6);
  background:var(--bg); color:var(--text);
}

/* layout */
.container-main{max-width:1200px;margin:22px auto;padding:16px}
.site-header{position:sticky;top:0;z-index:1400;padding:10px 18px;backdrop-filter: blur(8px);background:linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.15));border-bottom:1px solid var(--glass-border);display:flex;align-items:center;justify-content:space-between;gap:12px;border-radius:0 0 8px 8px}
.brand{display:flex;align-items:center;gap:.8rem}
.brand img{height:44px;border-radius:8px;box-shadow:0 8px 28px rgba(13,110,253,0.06)}
.brand .title{font-weight:800}
.controls{display:flex;gap:.5rem;align-items:center}

/* hero ribbon */
.ribbon{position:relative;padding:18px;border-radius:var(--radius);background:linear-gradient(180deg,rgba(13,110,253,0.06),rgba(102,16,242,0.02));box-shadow:var(--glass-shadow);border:1px solid rgba(13,110,253,0.04);margin-bottom:16px}
.hero-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.hero-left{flex:1}
.hero-right{width:360px;min-width:260px}

/* card surface */
.card-surface{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--glass-shadow);border:1px solid rgba(13,110,253,0.03);margin-bottom:16px}
body[data-theme="dark"] .card-surface{box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}

/* KPIs */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin:12px 0}
.kpi{background:linear-gradient(180deg,var(--card),#f8fbff);padding:14px;border-radius:10px;text-align:center;box-shadow:0 8px 20px rgba(2,6,23,0.04);transition:transform .12s}
.kpi:hover{transform:translateY(-6px)}
.kpi .num{font-weight:800;font-size:1.12rem;margin-top:6px}
.kpi .label{font-size:.85rem;color:var(--muted)}

/* table */
.table thead th{border-bottom:1px solid rgba(0,0,0,0.06)}
.table tbody tr:hover{background:rgba(13,110,253,0.03)}
.input-sm{height:40px;padding:.45rem .6rem}
.select-type{min-width:160px}

/* watermark */
.watermark{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:0;opacity:0.06}
.watermark img{max-width:520px;filter:grayscale(100%);opacity:0.12}

/* toast */
.toast-area{position:fixed;top:18px;left:50%;transform:translateX(-50%);z-index:2000;pointer-events:none}

/* autocomplete */
.autocomplete-suggestions{position:absolute;background:var(--card);border:1px solid rgba(0,0,0,0.06);border-radius:8px;max-height:180px;overflow:auto;z-index:2500;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
.autocomplete-suggestion{padding:8px 10px;cursor:pointer}
.autocomplete-suggestion:hover{background:linear-gradient(90deg,rgba(13,110,253,0.12),rgba(102,16,242,0.08));color:var(--text)}

/* buttons */
.btn-glow{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));border:none;color:#fff;box-shadow:0 10px 40px rgba(102,16,242,0.12);transition:transform .12s, box-shadow .12s}
.btn-glow:hover{transform:translateY(-3px);box-shadow:0 18px 55px rgba(102,16,242,0.18)}
.btn-small{padding:.35rem .5rem;font-size:.85rem;border-radius:6px}

/* inputs & selects colors to adapt to dark mode */
input, select, textarea, .form-control { color:var(--text); background:transparent; border-radius:8px; }
body[data-theme="dark"] input, body[data-theme="dark"] select, body[data-theme="dark"] .form-control { background:#0b1620; border:1px solid rgba(255,255,255,0.04); color:var(--text); }

/* helper styles */
.small-muted{color:var(--muted);font-size:.95rem}
.badge-note{background:linear-gradient(90deg,#ffc107,#ffb020);padding:6px 10px;border-radius:999px;color:#111;font-weight:800}
.empty-hint{padding:18px;text-align:center;color:var(--muted)}

/* responsive */
@media (max-width:900px){ .hero-right{width:100%} .controls{gap:.4rem} .kpi-row{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))} }
</style>
</head>
<body data-theme="light">

<!-- watermark for PDF -->
<div class="watermark" aria-hidden="true"><img src="assets/logo.png" alt="logo" id="wmLogo"></div>

<!-- toasts -->
<div class="toast-area" id="toastArea" role="status" aria-live="polite"></div>

<!-- header -->
<header class="site-header" role="banner">
  <div class="brand" title="المحلل المالي">
    <img src="assets/logo.png" alt="logo" id="brandLogo">
    <div>
      <div class="title" id="brandText">المحلل المالي</div>
      <div class="small-muted" id="brandDesc">أداة ذكية لتحليل القوائم المالية</div>
    </div>
  </div>

  <div class="controls" role="navigation" aria-label="controls">
    <a class="btn btn-sm btn-outline-secondary" href="index.html" id="backHome" title="الرجوع للرئيسية" aria-label="عودة للرئيسية"><i class="bi bi-house"></i></a>

    <select id="currencySelect" class="form-select form-select-sm" title="اختر العملة" aria-label="اختر العملة" style="min-width:92px"></select>

    <div id="fxWrap" style="display:none;min-width:170px;">
      <div class="input-group input-group-sm">
        <span class="input-group-text" id="fxLabel" style="background:transparent;border-radius:6px;">سعر الصرف</span>
        <input id="fxInput" class="form-control form-control-sm" type="number" step="any" min="0" aria-label="سعر الصرف">
      </div>
    </div>

    <select id="languageSelect" class="form-select form-select-sm" title="اللغة" aria-label="اختر اللغة" style="min-width:110px"></select>
    <div class="form-check form-switch mb-0" title="الوضع الليلي" aria-label="وضع ليلي">
      <input class="form-check-input" id="darkModeToggle" type="checkbox" role="switch" aria-checked="false">
    </div>

    <button id="exportPdfBtnHeader" class="btn btn-outline-primary btn-sm ms-2" title="تصدير PDF" aria-label="تصدير PDF"><i class="bi bi-file-earmark-pdf"></i></button>
    <button id="exportExcelBtn" class="btn btn-outline-success btn-sm ms-1" title="تصدير Excel" aria-label="تصدير Excel"><i class="bi bi-file-earmark-excel"></i></button>

    <!-- NEW: Upload Data button (bilingual, saves inputData then goes to upload.html) -->
    <button id="uploadDataBtn" class="btn btn-outline-info btn-sm ms-2" title="رفع البيانات" aria-label="رفع البيانات"><i class="bi bi-cloud-upload"></i> <span id="uploadBtnText">رفع البيانات</span></button>

    <!-- NEW: Advanced analytics navigation (keeps style) -->
    <button id="goAdvancedBtn" class="btn btn-success btn-sm ms-2" title="التحليلات المتقدمة" aria-label="التحليلات المتقدمة"><i class="bi bi-graph-up"></i> <span id="btnAdvancedText">التحليلات</span></button>
  </div>
</header>

<!-- main content -->
<main class="container-main" role="main" id="mainArea">
  <!-- hero -->
  <section class="ribbon" aria-labelledby="ribbonTitle">
    <div class="hero-row">
      <div class="hero-left">
        <h3 id="ribbonTitle" style="margin:0">مرحبًا بك في <span style="background:linear-gradient(90deg,var(--accent-1),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:900" id="brandGradient">المحلل المالي</span></h3>
        <p class="small-muted" id="ribbonDesc" style="margin-top:6px">ارفع ملف ميزان المراجعة أو أدخلها يدويًا — ستحصل فورًا على مؤشرات ورسوم بيانية وتصدير احترافي مع لوجو وعلامة مائية.</p>

        <div class="mt-3 d-flex gap-2 flex-wrap" role="toolbar" aria-label="actions">
          <button id="addRowBtn" class="btn btn-glow btn-sm" title="إضافة صف" aria-label="إضافة صف"><i class="bi bi-plus-lg"></i> <span id="btnAddText">إضافة صف</span></button>
          <button id="validateBtn" class="btn btn-outline-primary btn-sm" title="تحقق"><i class="bi bi-check-lg"></i> <span id="btnValidateText">تحقق</span></button>
          <button id="saveBtn" class="btn btn-outline-info btn-sm" title="حفظ"><i class="bi bi-save"></i> <span id="btnSaveText">حفظ</span></button>
          <button id="loadBtn" class="btn btn-outline-warning btn-sm" title="استرجاع"><i class="bi bi-folder-symlink"></i> <span id="btnLoadText">استرجاع</span></button>
          <button id="clearBtn" class="btn btn-outline-danger btn-sm" title="مسح الكل"><i class="bi bi-trash"></i> <span id="btnClearText">مسح الكل</span></button>

          <!-- NEW: go to Report -->
          <button id="goReportBtn" class="btn btn-primary btn-sm ms-2" title="عرض التقرير"><i class="bi bi-file-earmark-text"></i> <span id="btnReportText">التقرير</span></button>

          <button id="goDashboardBtn" class="btn btn-success btn-sm ms-2" title="لوحة التحكم"><i class="bi bi-speedometer2"></i> <span id="btnDashText">لوحة التحكم</span></button>
        </div>
      </div>

      <div class="hero-right">
        <label class="form-label fw-bold mb-1" id="uploadLabel">تحميل ملف ميزان المراجعة (CSV / XLSX)</label>
        <input type="file" id="fileInput" class="form-control input-sm" accept=".csv,.xlsx" aria-label="رفع ملف ميزان المراجعة" />
        <div class="small-muted mt-2" id="uploadHint">يدعم CSV و Excel — سيحاول اكتشاف اسم الحساب/النوع/المدين/الدائن.</div>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section id="kpiSection" class="mb-3" aria-live="polite">
    <div class="kpi-row" id="kpiRow"></div>
  </section>

  <!-- table -->
  <section class="card-surface" aria-labelledby="trial-table-title">
    <h6 id="trial-table-title">ميزان المراجعة — البيانات</h6>
    <div class="table-responsive mt-2">
      <table id="trialTable" class="table table-borderless align-middle" role="table" aria-describedby="trial-table-title">
        <thead>
          <tr>
            <th scope="col">الحساب</th>
            <th scope="col">النوع</th>
            <th scope="col">كود</th>
            <th scope="col" class="text-end">مدين</th>
            <th scope="col" class="text-end">دائن</th>
            <th scope="col">إجراء</th>
          </tr>
        </thead>
        <tbody id="tbBody"></tbody>
      </table>
    </div>

    <div class="row-status mt-3">
      <div id="validationResult" class="me-2" aria-live="polite"></div>
      <div id="warningNote" class="small-muted"></div>
    </div>
  </section>

  <!-- charts -->
  <section class="card-surface mt-3">
    <div class="row g-3">
      <div class="col-lg-6">
        <h6 id="catTitle">توزيع الفئات</h6>
        <canvas id="categoryChart" height="220" aria-label="رسم توزيع الفئات"></canvas>
      </div>

      <div class="col-lg-6">
        <h6 id="previewTitle">معاينة القيم (ميزان المراجعة)</h6>
        <div id="tablePreview" class="table-fixed mt-2"></div>
      </div>
    </div>
  </section>

  <footer class="text-center py-3 small">&copy; 2025 المحلل المالي — جميع الحقوق محفوظة</footer>
</main>

<!-- script -->
<script>
/* =========================
   Helpers & Init (Input page) - Enhanced per your requests
   ========================= */
const $ = id => document.getElementById(id);
function showToast(msg, type='info'){
  const area = $('toastArea');
  const el = document.createElement('div');
  el.className = `toast align-items-center text-bg-${type} border-0 show`;
  el.style.minWidth = '220px';
  el.style.marginTop = '6px';
  el.style.pointerEvents = 'auto';
  el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="اغلاق" onclick="this.closest('.toast').remove()"></button></div>`;
  area.appendChild(el);
  setTimeout(()=> el.remove(), 3500);
}
const toNum = v => { const n = Number(String(v).replace(/[, ]+/g,'')); return isNaN(n) ? 0 : n; };
const esc = s => String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));

/* =========================
   Data & defaults (preserve old storage keys too)
   ========================= */
let trialData = JSON.parse(localStorage.getItem('trialData')||'[]');
const FX_DEFAULT = { USD:31.0, EUR:34.0 };
let fxRates = JSON.parse(localStorage.getItem('fa_fx')||'null') || FX_DEFAULT;

/* currency definitions */
const CURRENCY_INFO = { EGP:{sym_ar:'ج.م',sym_en:'EGP',pos:'after'}, USD:{sym_ar:'$',sym_en:'$',pos:'before'}, EUR:{sym_ar:'€',sym_en:'€',pos:'before'} };

/* account types & hints (kept from previous) */
const ACCOUNT_TYPES = [
  "أصل متداول / Current Asset","أصل غير متداول / Non-current Asset","نقد / Cash","بنك / Bank",
  "ذمم مدينة / Accounts Receivable","مخزون / Inventory","مقدمات / Prepayments","أصول ثابتة / Fixed Assets",
  "خصوم متداولة / Current Liabilities","خصوم غير متداولة / Non-current Liabilities","ذمم دائنة / Accounts Payable",
  "قروض قصيرة الأجل / Short-term Loans","قروض طويلة الأجل / Long-term Loans","حقوق الملكية / Equity",
  "الأرباح المحتجزة / Retained Earnings","إيرادات / Revenue","مبيعات / Sales","تكلفة المبيعات / COGS",
  "مصروفات تشغيلية / Operating Expense","مصروفات إدارية / Admin Expense","اهتلاك / Depreciation",
  "مصروفات فوائد / Interest Expense","مصاريف ضريبية / Tax Expense","إيرادات أخرى / Other Income","مصروفات أخرى / Other Expense"
];
const ACCOUNT_LIST = [
  {Account:'النقد', Type:'نقد / Cash', Code:'101'},
  {Account:'البنك', Type:'بنك / Bank', Code:'102'},
  {Account:'الزبائن', Type:'ذمم مدينة / Accounts Receivable', Code:'103'},
  {Account:'الموردون', Type:'ذمم دائنة / Accounts Payable', Code:'201'},
  {Account:'رأس المال', Type:'حقوق الملكية / Equity', Code:'301'},
  {Account:'المبيعات', Type:'إيرادات / Revenue', Code:'401'},
  {Account:'المصروفات', Type:'مصروفات تشغيلية / Operating Expense', Code:'501'}
];

/* Translations - extended */
const translations = {
  ar:{
    brandText:"المحلل المالي", brandDesc:"أداة ذكية لتحليل القوائم المالية",
    uploadLabel:"تحميل ملف ميزان المراجعة (CSV / XLSX)", uploadHint:"يدعم CSV و Excel — سيحاول اكتشاف اسم الحساب/النوع/المدين/الدائن.",
    goDashboard:"لوحة التحكم", addedRow:"تم إضافة صف جديد", fileImported:"تم استيراد الملف بنجاح",
    fileError:"خطأ في قراءة الملف — تأكد من التنسيق", saved:"تم الحفظ محليًا", restored:"تم استرجاع البيانات",
    deletedRow:"تم حذف الصف", cleared:"تم مسح البيانات", validated:"تم التحقق", noDataExport:"لا توجد بيانات للتصدير",
    add:"إضافة صف", validate:"تحقق", save:"حفظ", load:"استرجاع", clear:"مسح الكل", dashboard:"لوحة التحكم",
    accounts:"عدد الحسابات", assets:"الأصول (تقريبي)", liabilities:"الخصوم (تقريبي)", revenue:"الإيرادات", expense:"المصروفات",
    other:"أخرى", noData:"لم تُدخل بيانات بعد.", placeholderAccount:"اكتب اسم الحساب", fxLabel:"سعر الصرف (1 وحدة = ... ج.م)",
    uploadDataBtn:"رفع البيانات", uploadDataBtnTitle:"احفظ البيانات واذهب إلى صفحة الرفع", addHere:"إضافة صف هنا", report:"التقرير",
    advanced:"التحليلات", addRowHereToast:"تمت إضافة صف جديد أسفل هذا السطر"
  },
  en:{
    brandText:"Financial Analyzer", brandDesc:"Smart tool for financial statements analysis",
    uploadLabel:"Upload Trial Balance (CSV / XLSX)", uploadHint:"Supports CSV and Excel — will attempt to detect account/type/debit/credit.",
    goDashboard:"Go to Dashboard", addedRow:"New row added", fileImported:"File imported successfully",
    fileError:"File read error — check format", saved:"Saved locally", restored:"Data restored",
    deletedRow:"Row removed", cleared:"All data cleared", validated:"Validation complete", noDataExport:"No data to export",
    add:"Add Row", validate:"Validate", save:"Save", load:"Load", clear:"Clear All", dashboard:"Dashboard",
    accounts:"Accounts", assets:"Assets (approx)", liabilities:"Liabilities (approx)", revenue:"Revenue", expense:"Expense",
    other:"Other", noData:"No data entered yet.", placeholderAccount:"Type account name", fxLabel:"Exchange rate (1 unit = ... EGP)",
    uploadDataBtn:"Upload Data", uploadDataBtnTitle:"Save data and go to upload page", addHere:"Add row here", report:"Report",
    advanced:"Analytics", addRowHereToast:"New row added beneath this row"
  }
};
function t(key){ const lang = $('languageSelect')?.value || localStorage.getItem('fa_lang') || 'ar'; return (translations[lang] && translations[lang][key])? translations[lang][key] : key; }

/* =========================
   Controls populate + preferences
   ========================= */
const LANGS = [{v:'ar',label:'العربية'},{v:'en',label:'English'}];
const CURRENCIES = ['EGP','USD','EUR'];

function populateControls(){ const ls = $('languageSelect'); ls.innerHTML=''; LANGS.forEach(l => { const o=document.createElement('option'); o.value=l.v; o.textContent=l.label; ls.appendChild(o); }); const cs = $('currencySelect'); cs.innerHTML=''; CURRENCIES.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; cs.appendChild(o); }); }

function loadPreferences(){
  const theme = localStorage.getItem('fa_theme') || localStorage.getItem('theme') || 'light';
  const lang = localStorage.getItem('fa_lang') || localStorage.getItem('lang') || 'ar';
  const currency = localStorage.getItem('fa_currency') || localStorage.getItem('currency') || 'EGP';
  document.body.dataset.theme = theme;
  $('darkModeToggle').checked = (theme === 'dark');
  $('languageSelect').value = lang;
  $('currencySelect').value = currency;
  fxRates = JSON.parse(localStorage.getItem('fa_fx')||'null') || fxRates;
  applyLanguage();
  updateFxUI();
}
function applyLanguage(){
  const lang = $('languageSelect').value || 'ar';
  $('brandText').textContent = translations[lang].brandText;
  $('brandDesc').textContent = translations[lang].brandDesc;
  $('uploadLabel').textContent = translations[lang].uploadLabel;
  $('uploadHint').textContent = translations[lang].uploadHint;
  $('btnAddText').textContent = translations[lang].add;
  $('btnValidateText').textContent = translations[lang].validate;
  $('btnSaveText').textContent = translations[lang].save;
  $('btnLoadText').textContent = translations[lang].load;
  $('btnClearText').textContent = translations[lang].clear;
  $('btnDashText').textContent = translations[lang].dashboard;
  $('btnReportText').textContent = translations[lang].report;
  $('btnAdvancedText').textContent = translations[lang].advanced;
  $('uploadBtnText').textContent = translations[lang].uploadDataBtn;
  $('uploadDataBtn').title = translations[lang].uploadDataBtnTitle;
  $('fxLabel').textContent = translations[lang].fxLabel;
}

/* attach events */
populateControls();
loadPreferences();
$('darkModeToggle').addEventListener('change', e => { document.body.dataset.theme = e.target.checked ? 'dark' : 'light'; localStorage.setItem('fa_theme', document.body.dataset.theme); });
$('languageSelect').addEventListener('change', ()=> { localStorage.setItem('fa_lang', $('languageSelect').value); applyLanguage(); renderTable(); renderSummary(); renderValidation(); });
$('currencySelect').addEventListener('change', ()=> { localStorage.setItem('fa_currency', $('currencySelect').value); updateFxUI(); renderSummary(); });

/* FX input handling */
function updateFxUI(){
  const cur = $('currencySelect').value || 'EGP';
  const fxWrap = $('fxWrap');
  if(cur === 'EGP'){ fxWrap.style.display='none'; } else {
    fxWrap.style.display='inline-block'; const rate = fxRates[cur] || FX_DEFAULT[cur] || 1; $('fxInput').value = rate; $('fxLabel').textContent = t('fxLabel');
  }
}
$('fxInput').addEventListener('change', ()=> {
  const cur = $('currencySelect').value || 'EGP';
  const v = toNum($('fxInput').value);
  if(cur !== 'EGP' && v > 0){ fxRates[cur] = v; localStorage.setItem('fa_fx', JSON.stringify(fxRates)); renderSummary(); showToast(( $('languageSelect').value==='ar' ? 'تم تحديث سعر الصرف' : 'FX updated' ), 'success'); }
});

/* =========================
   Local storage helpers
   ========================= */
function saveLocal(){ localStorage.setItem('trialData', JSON.stringify(trialData)); }
function show(keyOrText, type='info'){ const lang = $('languageSelect')?.value || 'ar'; const text = translations[lang][keyOrText] || keyOrText; showToast(text, type); }

/* =========================
   Table render & edit (Type is SELECT, custom allowed)
   - Added: "Add here" button on last row (moves dynamically)
   ========================= */
function renderTable(){
  const tbody = $('tbBody'); tbody.innerHTML = '';
  trialData.forEach((row, idx) => {
    const tr = document.createElement('tr');
    const typeOptions = ACCOUNT_TYPES.map(opt => `<option value="${esc(opt)}"${(row.Type===opt?' selected':'')}>${esc(opt)}</option>`).join('');
    // If this is last row, include "add-here" button
    const isLast = (idx === (trialData.length - 1));
    tr.innerHTML = `
      <td style="position:relative">
        <input class="form-control form-control-sm input-sm" value="${esc(row.Account||'')}" data-field="Account" data-idx="${idx}" placeholder="${t('placeholderAccount')}">
      </td>
      <td>
        <div class="d-flex gap-1 align-items-center">
          <select class="form-select form-select-sm input-sm select-type" data-field="Type" data-idx="${idx}" aria-label="نوع الحساب">
            <option value="">--</option>
            ${typeOptions}
          </select>
          <button class="btn btn-sm btn-outline-secondary" title="أخرى" data-add-type data-idx="${idx}" aria-label="أضف نوع جديد"><i class="bi bi-pencil-square"></i></button>
        </div>
      </td>
      <td><input class="form-control form-control-sm input-sm" value="${esc(row.Code||'')}" data-field="Code" data-idx="${idx}"></td>
      <td><input type="number" class="form-control form-control-sm input-sm text-end" value="${toNum(row.Debit)}" data-field="Debit" data-idx="${idx}"></td>
      <td><input type="number" class="form-control form-control-sm input-sm text-end" value="${toNum(row.Credit)}" data-field="Credit" data-idx="${idx}"></td>
      <td>
        <div class="d-flex gap-1 align-items-center">
          <button class="btn btn-sm btn-danger btn-delete" data-idx="${idx}" title="${t('deletedRow')}" aria-label="حذف صف"><i class="bi bi-trash"></i></button>
          ${isLast ? `<button class="btn btn-sm btn-glow btn-add-here" data-idx="${idx}" title="${t('addHere')}" aria-label="${t('addHere')}"><i class="bi bi-plus-lg"></i></button>` : ''}
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // attach input handlers
  tbody.querySelectorAll('input, select').forEach(inp => {
    inp.addEventListener('input', e => {
      const i = Number(e.target.dataset.idx); const f = e.target.dataset.field; if(!isFinite(i)) return;
      trialData[i][f] = (f==='Debit' || f==='Credit') ? toNum(e.target.value) : e.target.value;
      saveLocal();
      clearTimeout(inp._deb); inp._deb = setTimeout(()=>{ renderSummary(); renderValidation(); }, 120);
    });
  });

  // add custom type
  tbody.querySelectorAll('button[data-add-type]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const idx = Number(e.currentTarget.dataset.idx);
      const newType = prompt($('languageSelect').value==='ar' ? 'أدخل اسم نوع الحساب الجديد' : 'Enter custom account type');
      if(newType && newType.trim()){
        ACCOUNT_TYPES.unshift(newType.trim()); trialData[idx].Type = newType.trim(); saveLocal(); renderTable(); renderSummary(); show('addedRow','success');
      }
    });
  });

  // delete
  tbody.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', e => {
      const i = Number(e.target.closest('button').dataset.idx);
      trialData.splice(i,1); saveLocal(); renderTable(); renderSummary(); show('deletedRow','danger');
    });
  });

  // add-here (insert after specific row)
  tbody.querySelectorAll('.btn-add-here').forEach(btn => {
    btn.addEventListener('click', e => {
      const idx = Number(e.currentTarget.dataset.idx);
      // insert a new blank row after idx
      trialData.splice(idx+1, 0, {Account:'',Type:'',Code:'',Debit:0,Credit:0});
      saveLocal(); renderTable(); renderSummary();
      show('addRowHereToast','success');
    });
  });

  // autocomplete for account input
  tbody.querySelectorAll('input[data-field="Account"]').forEach(inp => {
    inp.addEventListener('input', e => {
      const val = e.target.value.trim().toLowerCase();
      const tr = e.target.closest('tr');
      let list = tr.querySelector('.autocomplete-suggestions');
      const matches = ACCOUNT_LIST.filter(a => a.Account.toLowerCase().includes(val) && val.length>0).slice(0,8);
      if(!list && matches.length){ list = document.createElement('div'); list.className='autocomplete-suggestions'; tr.children[0].appendChild(list); }
      if(list){
        list.innerHTML = '';
        if(matches.length === 0){ list.remove(); return; }
        matches.forEach(m => {
          const div = document.createElement('div'); div.className='autocomplete-suggestion'; div.textContent = m.Account;
          div.addEventListener('click', ()=> {
            inp.value = m.Account; tr.querySelector('select[data-field="Type"]').value = m.Type || ''; tr.querySelector('input[data-field="Code"]').value = m.Code || ''; list.remove(); inp.dispatchEvent(new Event('input'));
          });
          list.appendChild(div);
        });
      }
    });
    inp.addEventListener('blur', ()=> { setTimeout(()=>{ const l = inp.parentElement.querySelector('.autocomplete-suggestions'); if(l) l.remove(); },120); });
  });

  renderValidation();
}

/* add row (header button) */
$('addRowBtn').addEventListener('click', ()=> { trialData.push({Account:'',Type:'',Code:'',Debit:0,Credit:0}); saveLocal(); renderTable(); renderSummary(); show('addedRow','success'); });

/* clear all */
$('clearBtn').addEventListener('click', ()=> { const confirmMsg = $('languageSelect').value === 'ar' ? 'هل أنت متأكد أنك تريد مسح جميع البيانات؟' : 'Are you sure you want to clear all data?'; if(confirm(confirmMsg)){ trialData = []; saveLocal(); renderTable(); renderSummary(); show('cleared','danger'); } });

/* save/load */
$('saveBtn').addEventListener('click', ()=> { saveLocal(); show('saved','success'); });
$('loadBtn').addEventListener('click', ()=> { trialData = JSON.parse(localStorage.getItem('trialData')||'[]'); renderTable(); renderSummary(); show('restored','info'); });

/* go dashboard */
$('goDashboardBtn').addEventListener('click', ()=> { window.location.href = 'dashboard.html'; });

/* go advanced */
$('goAdvancedBtn').addEventListener('click', ()=> { window.location.href = 'advanced.html'; });

/* NEW: Upload Data button (saves to 'inputData' and navigates to upload.html) */
$('uploadDataBtn').addEventListener('click', ()=> {
  // Save current trialData snapshot to inputData key (for upload page to read)
  localStorage.setItem('inputData', JSON.stringify(trialData || []));
  // Also save preferences used by other pages
  localStorage.setItem('fa_lang', $('languageSelect').value);
  localStorage.setItem('fa_currency', $('currencySelect').value);
  localStorage.setItem('fa_fx', JSON.stringify(fxRates));
  localStorage.setItem('fa_theme', document.body.dataset.theme || 'light');
  show('fileImported','info'); // quick feedback
  // Redirect to upload page
  window.location.href = 'upload.html';
});

/* NEW: go report */
$('goReportBtn').addEventListener('click', ()=> { // Ensure data saved and open report page
  saveLocal();
  localStorage.setItem('fa_lang', $('languageSelect').value);
  localStorage.setItem('fa_currency', $('currencySelect').value);
  localStorage.setItem('fa_fx', JSON.stringify(fxRates));
  localStorage.setItem('fa_theme', document.body.dataset.theme || 'light');
  window.location.href = 'report.html';
});

/* validation */
function renderValidation(){
  const totalDebit = trialData.reduce((s,r)=> s + toNum(r.Debit), 0);
  const totalCredit = trialData.reduce((s,r)=> s + toNum(r.Credit), 0);
  const res = $('validationResult');
  if(trialData.length === 0){ res.innerHTML = `<span class="small-muted">${t('noData')}</span>`; return; }
  if(Math.abs(totalDebit - totalCredit) < 1e-6){
    res.innerHTML = `<span class="text-success">ميزان المراجعة متوازن ✅ — ${formatNumber(totalDebit)}</span>`;
  } else {
    res.innerHTML = `<span class="text-danger">ميزان المراجعة غير متوازن ❌ — مدين: ${formatNumber(totalDebit)} / دائن: ${formatNumber(totalCredit)}</span>`;
  }
}
function formatNumber(v){ return Number(v).toLocaleString(undefined,{maximumFractionDigits:2,minimumFractionDigits:0}); }

/* =========================
   Summary + chart (use convertCurrency for display)
   ========================= */
let categoryChart = null;
function convertCurrency(value){
  const cur = $('currencySelect').value || 'EGP';
  if(cur === 'EGP') return toNum(value);
  const rate = fxRates[cur] || FX_DEFAULT[cur] || 1;
  return toNum(value) / rate;
}
function formatCurrencyValue(value){
  const cur = $('currencySelect').value || 'EGP';
  const info = CURRENCY_INFO[cur] || CURRENCY_INFO.EGP;
  const num = formatNumber(convertCurrency(value));
  if(info.pos === 'before') return `${info.sym_en==='EGP' ? '' : info.sym_en}${num}`;
  return `${num} ${info.sym_ar || info.sym_en}`;
}

/* Smart summary & simple commentary for each section (friendly for accountant & non-accountant) */
function renderSummary(){
  const agg = { assets:0, liabilities:0, equity:0, revenue:0, expense:0, other:0 };
  trialData.forEach(r => {
    const net = toNum(r.Debit) - toNum(r.Credit);
    const s = (r.Type || r.Account || '').toString().toLowerCase();
    if(/asset|أصل|cash|bank|current asset|نقد|bank/i.test(s)) agg.assets += net;
    else if(/liab|خصوم|payable|loan|دائن|قرض/i.test(s)) agg.liabilities += (-net);
    else if(/equity|حقوق|رأس/i.test(s)) agg.equity += (-net);
    else if(/revenue|sales|إيراد|مبيعات/i.test(s)) agg.revenue += (-net);
    else if(/expense|مصروف|cogs|تكلفة|مصاريف/i.test(s)) agg.expense += net;
    else {
      const acc = (r.Account||'').toLowerCase();
      if(/النقد|bank|cash|نقد/.test(acc)) agg.assets += net;
      else if(/المورد|payable|دائن/.test(acc)) agg.liabilities += (-net);
      else if(/رأس|equity/.test(acc)) agg.equity += (-net);
      else if(/إيراد|sales/.test(acc)) agg.revenue += (-net);
      else if(/مصروف|expense|تكلفة/.test(acc)) agg.expense += net;
      else agg.other += net;
    }
  });

  // KPIs
  const kpiRow = $('kpiRow'); kpiRow.innerHTML = '';
  const items = [
    {label: t('accounts'), value: trialData.length, isCurrency:false},
    {label: t('assets'), value: agg.assets, isCurrency:true},
    {label: t('liabilities'), value: agg.liabilities, isCurrency:true},
    {label: t('revenue'), value: agg.revenue, isCurrency:true},
    {label: t('expense'), value: agg.expense, isCurrency:true},
    {label: t('other'), value: agg.other, isCurrency:true},
  ];
  items.forEach(it => {
    const div = document.createElement('div'); div.className='kpi';
    const val = it.isCurrency ? formatCurrencyValue(it.value) : formatNumber(it.value);
    div.innerHTML = `<div class="label">${esc(it.label)}</div><div class="num">${val}</div>`;
    kpiRow.appendChild(div);
  });

  // preview (first 30 rows)
  const preview = $('tablePreview');
  if(trialData.length === 0){ preview.innerHTML = `<div class="empty-hint">${t('noData')}</div>`; }
  else {
    let html = '<table class="table table-sm table-striped"><thead><tr><th>الحساب</th><th class="text-end">مدين</th><th class="text-end">دائن</th></tr></thead><tbody>';
    trialData.slice(0,30).forEach(r => {
      html += `<tr><td>${esc(r.Account)}</td><td class="text-end">${formatCurrencyValue(r.Debit)}</td><td class="text-end">${formatCurrencyValue(r.Credit)}</td></tr>`;
    });
    html += '</tbody></table>';
    preview.innerHTML = html;
  }

  // chart
  const ctx = $('categoryChart').getContext('2d');
  const dataVals = [agg.assets, agg.liabilities, agg.revenue, agg.expense, agg.other].map(v => Math.abs(v));
  const labels = [ $('languageSelect').value === 'ar' ? 'الأصول' : 'Assets', $('languageSelect').value === 'ar' ? 'الخصوم' : 'Liabilities', $('languageSelect').value === 'ar' ? 'الإيرادات' : 'Revenue', $('languageSelect').value === 'ar' ? 'المصروفات' : 'Expenses', $('languageSelect').value === 'ar' ? 'أخرى' : 'Other' ];
  if(categoryChart) try{ categoryChart.destroy(); }catch(e){}
  categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data: dataVals, backgroundColor:['#0d6efd','#dc3545','#198754','#ffc107','#6c757d'], hoverOffset:8 }] },
    options: { responsive:true, plugins:{legend:{position:'bottom'}, tooltip:{callbacks:{label: ctx => `${ctx.label}: ${formatCurrencyValue(ctx.parsed)}`}} } }
  });

  // comments - simple, professional, understandable by accountants & laypeople
  const warning = $('warningNote');
  // Build a short friendly commentary
  const commentary = [];
  commentary.push(`<strong>${$('languageSelect').value==='ar' ? 'ملاحظات سريعة:' : 'Quick notes:'}</strong>`);
  commentary.push($('languageSelect').value==='ar'
    ? `إجمالي الأصول تقريبًا ${formatCurrencyValue(agg.assets)}، وإجمالي الخصوم تقريبًا ${formatCurrencyValue(agg.liabilities)}.`
    : `Total assets approx ${formatCurrencyValue(agg.assets)}, total liabilities approx ${formatCurrencyValue(agg.liabilities)}.`);
  commentary.push($('languageSelect').value==='ar'
    ? `الإيرادات: ${formatCurrencyValue(agg.revenue)} — تشير إلى حجم المبيعات/الإيرادات خلال الفترة.`
    : `Revenue: ${formatCurrencyValue(agg.revenue)} — indicates sales/income size in the period.`);
  commentary.push($('languageSelect').value==='ar'
    ? `المصروفات: ${formatCurrencyValue(agg.expense)} — تشير إلى تكلفة التشغيل أو المصروفات المسجلة.`
    : `Expenses: ${formatCurrencyValue(agg.expense)} — indicates operating costs or recorded expenses.`);
  warning.innerHTML = commentary.map(c => `<div class="small-muted" style="margin-bottom:6px">${c}</div>`).join('');
  renderValidation();
}

/* =========================
   File parsing (CSV/XLSX)
   ========================= */
$('fileInput').addEventListener('change', (e) => {
  const file = e.target.files[0]; if(!file) return;
  const name = file.name.toLowerCase();
  const reader = new FileReader();
  reader.onload = (evt) => {
    try{
      let parsed = [];
      if(name.endsWith('.csv')){ const p = Papa.parse(evt.target.result, { header:true, skipEmptyLines:true, dynamicTyping:false }); parsed = p.data; }
      else { const wb = XLSX.read(evt.target.result, { type:'binary' }); const sheet = wb.SheetNames[0]; parsed = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { defval:'' }); }

      trialData = parsed.map(r => {
        const Account = r.Account || r.account || r['Account Name'] || r['اسم الحساب'] || r['الحساب'] || r['Name'] || '';
        const Type = r.Type || r.type || r['Type'] || r['نوع'] || '';
        const Code = r.Code || r.code || r['Code'] || r['كود'] || '';
        const Debit = r.Debit || r.debit || r['Dr'] || r['مدين'] || r['Debit'] || 0;
        const Credit = r.Credit || r.credit || r['Cr'] || r['دائن'] || r['Credit'] || 0;
        return { Account, Type, Code, Debit: toNum(Debit), Credit: toNum(Credit) };
      });

      saveLocal(); renderTable(); renderSummary(); show('fileImported','success');
    }catch(err){ console.error(err); show('fileError','danger'); }
  };
  if(name.endsWith('.csv')) reader.readAsText(file); else reader.readAsBinaryString(file);
});

/* =========================
   Exports: PDF & Excel
   ========================= */
$('exportPdfBtnHeader').addEventListener('click', ()=> {
  if(!trialData.length){ show('noDataExport','warning'); return; }
  const wm = $('wmLogo'); const oldOpacity = wm.style.opacity; wm.style.opacity = '0.12';
  const el = document.querySelector('main');
  const opt = { margin:0.35, filename:'trialbalance_report.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'in', format:'a4', orientation:'landscape'} };
  html2pdf().set(opt).from(el).save().finally(()=> { wm.style.opacity = oldOpacity; });
});
$('exportExcelBtn').addEventListener('click', ()=> {
  if(!trialData.length){ show('noDataExport','warning'); return; }
  const ws = XLSX.utils.json_to_sheet(trialData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'TrialBalance'); XLSX.writeFile(wb, 'trialbalance.xlsx');
});
$('saveBtn').addEventListener('click', (e)=> { if(e.ctrlKey) $('exportExcelBtn').click(); else { saveLocal(); show('saved','success'); } });

/* =========================
   Currency FX & init
   ========================= */
async function fetchFx(){
  try{ const resp = await fetch('https://api.exchangerate.host/latest?base=EGP&symbols=USD,EUR'); if(!resp.ok) throw new Error('no fx'); const data = await resp.json();
    if(data && data.rates){ if(data.rates.USD) fxRates.USD = 1 / data.rates.USD; if(data.rates.EUR) fxRates.EUR = 1 / data.rates.EUR; localStorage.setItem('fa_fx', JSON.stringify(fxRates)); }
  }catch(e){ console.warn('FX fetch failed; using defaults'); }
}
(function init(){
  renderTable(); renderSummary(); fetchFx();
  if(!trialData.length){ trialData.push({Account:'',Type:'',Code:'',Debit:0,Credit:0}); saveLocal(); renderTable(); }
  window.addEventListener('storage', (e)=> { if(e.key === 'trialData'){ trialData = JSON.parse(e.newValue || '[]'); renderTable(); renderSummary(); show('restored','info'); } });
})();
</script>
  <script src="js/main-fixes.js"></script>
</body>
</html>
