<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>إدخال ميزان المراجعة — المحلل المالي (سوبر)</title>

<!-- Bootstrap RTL & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
:root{
  --accent:#0d6efd; --bg:#f6f8fb; --card:#fff; --text:#0b1220; --muted:#6c757d;
  --success:#16a34a; --danger:#dc3545;
}
body{font-family:"Cairo",system-ui, sans-serif; margin:0; background:var(--bg); color:var(--text); transition: .18s;}
body[data-theme="dark"]{ --bg:#07101a; --card:#08121a; --text:#e6eef6; --muted:#9aa6b2; background:var(--bg); color:var(--text); }

header.site-header{position:sticky;top:0;z-index:1200;background:rgba(255,255,255,0.9);backdrop-filter:blur(6px);border-bottom:1px solid rgba(13,110,253,0.06);padding:10px 18px}
body[data-theme="dark"] header.site-header{background:rgba(7,10,20,0.9);border-color:rgba(255,255,255,0.04)}
.brand{display:flex;gap:.6rem;align-items:center}
.brand img{height:44px;border-radius:8px}
.controls{display:flex;gap:.6rem;align-items:center}

.container-main{max-width:1200px;margin:18px auto;padding:12px}

.card-surface{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.04);border:1px solid rgba(13,110,253,0.03)}
body[data-theme="dark"] .card-surface{box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}

.table thead th{border-bottom:1px solid rgba(0,0,0,0.06)}
body[data-theme="dark"] .table thead th{border-color:rgba(255,255,255,0.04)}

.watermark{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:0;opacity:0.04}
.watermark img{max-width:420px;filter:grayscale(100%);opacity:0.12}

.icon-btn{display:inline-flex;align-items:center;gap:.5rem}
.toast-area{position:fixed;top:18px;left:50%;transform:translateX(-50%);z-index:2000}

.table-fixed{max-height:300px;overflow:auto;display:block;border-radius:8px}
.row-status{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

.badge-need{background:linear-gradient(90deg,#ffc107,#ffb020);padding:5px 8px;border-radius:999px;color:#111;font-weight:700}

.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:12px}
.kpi{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 8px 20px rgba(2,6,23,0.04);text-align:center}

.autocomplete-suggestions{
  position:absolute; background:#fff; border:1px solid #ddd; border-radius:6px;
  max-height:160px; overflow:auto; z-index:2000; width:100%;
}
.autocomplete-suggestion{padding:6px 10px; cursor:pointer;}
.autocomplete-suggestion:hover{background:#0d6efd; color:#fff;}

@media (max-width:768px){ .controls{width:100%;justify-content:center} }
</style>
</head>
<body data-theme="light">

<div class="watermark"><img src="assets/logo.png" alt="logo"/></div>
<div class="toast-area" id="toastArea"></div>

<header class="site-header">
  <div class="container d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
      <a class="brand" href="index.html">
        <img src="assets/logo.png" alt="logo">
        <div style="font-weight:700">المحلل المالي</div>
      </a>
    </div>
    <div class="controls">
      <select id="currencySelect" class="form-select form-select-sm">
        <option value="EGP">جنيه (EGP)</option>
        <option value="USD">دولار (USD)</option>
        <option value="EUR">يورو (EUR)</option>
      </select>
      <select id="langSelect" class="form-select form-select-sm">
        <option value="ar">العربية</option>
        <option value="en">English</option>
      </select>
      <div class="form-check form-switch mb-0">
        <input class="form-check-input" id="darkToggle" type="checkbox">
      </div>
    </div>
  </div>
</header>

<main class="container-main">

<section class="card-surface mb-3">
  <div class="row g-3 align-items-end">
    <div class="col-md-5">
      <label class="form-label fw-bold" id="uploadLabel">تحميل ملف ميزان المراجعة (CSV / XLSX)</label>
      <input type="file" id="fileInput" class="form-control" accept=".csv,.xlsx" />
      <div class="form-text" id="uploadHint">يدعم CSV و Excel — سيحاول اكتشاف اسم الحساب/النوع/المدين/الدائن.</div>
    </div>
    <div class="col-md-7 d-flex gap-2 justify-content-md-end flex-wrap">
      <button id="addRowBtn" class="btn btn-primary"><i class="bi bi-plus-lg"></i> إضافة صف</button>
      <button id="validateBtn" class="btn btn-outline-primary"><i class="bi bi-check-lg"></i> تحقق</button>
      <button id="saveBtn" class="btn btn-outline-info"><i class="bi bi-save"></i> حفظ</button>
      <button id="loadBtn" class="btn btn-outline-warning"><i class="bi bi-folder-symlink"></i> استرجاع</button>
      <button id="clearBtn" class="btn btn-outline-danger"><i class="bi bi-trash"></i> مسح الكل</button>
    </div>
  </div>
</section>

<section id="kpiSection" class="mb-3">
  <div class="kpi-row" id="kpiRow"></div>
</section>

<section class="card-surface">
  <div class="table-responsive">
    <table id="trialTable" class="table table-borderless align-middle">
      <thead>
        <tr>
          <th>الحساب</th>
          <th>النوع</th>
          <th>كود</th>
          <th class="text-end">مدين</th>
          <th class="text-end">دائن</th>
          <th>إجراء</th>
        </tr>
      </thead>
      <tbody id="tbBody"></tbody>
    </table>
  </div>
  <div class="row-status mt-3">
    <div id="validationResult" class="me-2"></div>
  </div>
</section>

<section class="card-surface mt-3">
  <div class="row g-3">
    <div class="col-lg-6">
      <h6>توزيع الفئات</h6>
      <canvas id="categoryChart" height="220"></canvas>
    </div>
    <div class="col-lg-6">
      <h6>معاينة القيم (ميزان المراجعة)</h6>
      <div id="tablePreview" class="table-fixed mt-2"></div>
    </div>
  </div>
</section>

</main>

<footer class="text-center py-3 small">&copy; 2025 المحلل المالي — جميع الحقوق محفوظة</footer>

<script>
const $ = id => document.getElementById(id);
const toNum = v => Number(v)||0;
const esc = s => String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));

let trialData = JSON.parse(localStorage.getItem('trialData')||'[]');
const FX_DEFAULT = {USD:31,EUR:34};
let fxRates = JSON.parse(localStorage.getItem('fa_fx')||'null') || FX_DEFAULT;

const ACCOUNT_LIST = [
  {Account:'النقد', Type:'أصل متداول', Code:'101'},
  {Account:'البنك', Type:'أصل متداول', Code:'102'},
  {Account:'الزبائن', Type:'أصل متداول', Code:'103'},
  {Account:'الموردون', Type:'خصوم متداولة', Code:'201'},
  {Account:'رأس المال', Type:'حقوق الملكية', Code:'301'},
  {Account:'الإيرادات', Type:'إيراد', Code:'401'},
  {Account:'المصروفات', Type:'مصروف', Code:'501'}
];

/* ============================ Helpers ============================ */
function saveLocal(){ localStorage.setItem('trialData', JSON.stringify(trialData)); }
function showToast(msg,type='info'){
  const area = $('toastArea');
  const el = document.createElement('div');
  el.className = `toast align-items-center text-bg-${type} border-0 show`;
  el.style.minWidth='200px'; el.style.marginTop='6px';
  el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.toast').remove()"></button></div>`;
  area.appendChild(el); setTimeout(()=> el.remove(),3000);
}
function formatNumber(v){ return Number(v).toLocaleString(undefined,{maximumFractionDigits:2,minimumFractionDigits:0}); }
function convertCurrency(v){ const cur=$('currencySelect').value||'EGP'; return cur==='EGP'?toNum(v):toNum(v)/ (fxRates[cur]||FX_DEFAULT[cur]); }

/* ============================ Table ============================ */
function renderTable(){
  const tbody = $('tbBody'); tbody.innerHTML='';
  trialData.forEach((row,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="position:relative"><input class="form-control form-control-sm" value="${esc(row.Account||'')}" data-field="Account" data-idx="${idx}"></td>
      <td><input class="form-control form-control-sm" value="${esc(row.Type||'')}" data-field="Type" data-idx="${idx}"></td>
      <td><input class="form-control form-control-sm" value="${esc(row.Code||'')}" data-field="Code" data-idx="${idx}"></td>
      <td><input type="number" class="form-control form-control-sm text-end" value="${toNum(row.Debit)}" data-field="Debit" data-idx="${idx}"></td>
      <td><input type="number" class="form-control form-control-sm text-end" value="${toNum(row.Credit)}" data-field="Credit" data-idx="${idx}"></td>
      <td><button class="btn btn-sm btn-danger btn-delete" data-idx="${idx}"><i class="bi bi-trash"></i></button></td>
    `;
    tbody.appendChild(tr);
  });

  // Input handlers
  tbody.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const i=Number(e.target.dataset.idx);
      const f=e.target.dataset.field;
      trialData[i][f]=(f==='Debit'||f==='Credit')?toNum(e.target.value):e.target.value;
      saveLocal(); setTimeout(()=>{renderTable(); renderSummary();},100);
    });
  });

  // Delete
  tbody.querySelectorAll('.btn-delete').forEach(btn=>{
    btn.addEventListener('click',e=>{
      const i=Number(e.target.closest('button').dataset.idx);
      trialData.splice(i,1); saveLocal(); renderTable(); renderSummary(); showToast('تم حذف الصف','danger');
    });
  });

  // Autocomplete
  tbody.querySelectorAll('input[data-field="Account"]').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const val=e.target.value.toLowerCase();
      const tr=e.target.closest('tr');
      const suggestions = ACCOUNT_LIST.filter(a=>a.Account.toLowerCase().includes(val));
      let list=tr.querySelector('.autocomplete-suggestions');
      if(!list){ list=document.createElement('div'); list.className='autocomplete-suggestions'; tr.children[0].appendChild(list);}
      list.innerHTML='';
      suggestions.forEach(s=>{
        const div=document.createElement('div'); div.className='autocomplete-suggestion'; div.textContent=s.Account;
        div.addEventListener('click', ()=>{ inp.value=s.Account; tr.querySelector('input[data-field="Type"]').value=s.Type; tr.querySelector('input[data-field="Code"]').value=s.Code; list.innerHTML=''; inp.dispatchEvent(new Event('input')); });
        list.appendChild(div);
      });
    });
    inp.addEventListener('blur', ()=>{ setTimeout(()=>{const l=inp.parentElement.querySelector('.autocomplete-suggestions'); if(l) l.innerHTML='';},200); });
  });

  renderValidation();
}

/* ============================ KPIs & Charts ============================ */
let categoryChart=null;
function renderSummary(){
  const agg={assets:0,liabilities:0,equity:0,revenue:0,expense:0,other:0};
  trialData.forEach(r=>{
    const net = toNum(r.Debit)-toNum(r.Credit);
    const acc = r.Account||'';
    if(acc.includes('النقد')||acc.includes('البنك')) agg.assets+=net;
    else if(acc.includes('الموردون')) agg.liabilities+=(-net);
    else if(acc.includes('رأس')) agg.equity+=(-net);
    else if(acc.includes('الإيرادات')) agg.revenue+=(-net);
    else if(acc.includes('المصروفات')) agg.expense+=net;
    else agg.other+=net;
  });

  // KPIs
  const kpiRow=$('kpiRow'); kpiRow.innerHTML='';
  const lang=$('langSelect').value||'ar';
  const items=[
    {label_ar:'عدد الحسابات',label_en:'Accounts',value:trialData.length},
    {label_ar:'الأصول (تقريبي)',label_en:'Assets',value:agg.assets},
    {label_ar:'الخصوم (تقريبي)',label_en:'Liabilities',value:agg.liabilities},
    {label_ar:'الإيرادات',label_en:'Revenue',value:agg.revenue},
    {label_ar:'المصروفات',label_en:'Expense',value:agg.expense},
    {label_ar:'أخرى',label_en:'Other',value:agg.other},
  ];
  items.forEach(it=>{
    const div=document.createElement('div'); div.className='kpi';
    const label=(lang==='ar')?it.label_ar:it.label_en;
    div.innerHTML=`<div class="fw-semibold small text-muted">${esc(label)}</div><div style="font-size:1.15rem;font-weight:800;margin-top:6px">${formatNumber(it.value)}</div>`;
    kpiRow.appendChild(div);
  });

  // Chart
  const ctx=$('categoryChart').getContext('2d');
  const dataVals=[agg.assets,agg.liabilities,agg.revenue,agg.expense,agg.other].map(Math.abs);
  const labels=[lang==='ar'?'الأصول':'Assets',lang==='ar'?'الخصوم':'Liabilities',lang==='ar'?'الإيرادات':'Revenue',lang==='ar'?'المصروفات':'Expenses',lang==='ar'?'أخرى':'Other'];
  if(categoryChart) try{categoryChart.destroy();}catch{}
  categoryChart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:dataVals,backgroundColor:['#0d6efd','#dc3545','#198754','#ffc107','#6c757d']}]}});
}

/* ============================ Validation ============================ */
function renderValidation(){
  const totalDebit=trialData.reduce((s,r)=>s+toNum(r.Debit),0);
  const totalCredit=trialData.reduce((s,r)=>s+toNum(r.Credit),0);
  const res=$('validationResult');
  if(trialData.length===0){res.innerHTML='<span class="text-muted">لم تُدخل بيانات بعد.</span>';return;}
  res.innerHTML=(Math.abs(totalDebit-totalCredit)<1e-6)?`<span class="text-success">ميزان المراجعة متوازن ✅ — ${formatNumber(totalDebit)}</span>`:`<span class="text-danger">ميزان المراجعة غير متوازن ❌ — مدين: ${formatNumber(totalDebit)} / دائن: ${formatNumber(totalCredit)}</span>`;
}

/* ============================ Events ============================ */
$('addRowBtn').addEventListener('click',()=>{trialData.push({Account:'',Type:'',Code:'',Debit:0,Credit:0});saveLocal();renderTable();showToast('تم إضافة صف جديد','success');});
$('clearBtn').addEventListener('click',()=>{if(confirm('هل أنت متأكد؟')){trialData=[];saveLocal();renderTable();showToast('تم مسح البيانات','danger');}});
$('validateBtn').addEventListener('click',()=>{renderValidation();showToast('تم التحقق من الميزان','info');});
$('saveBtn').addEventListener('click',()=>{localStorage.setItem('trialData',JSON.stringify(trialData));showToast('تم الحفظ محلياً','success');});
$('loadBtn').addEventListener('click',()=>{trialData=JSON.parse(localStorage.getItem('trialData')||'[]');renderTable();renderSummary();showToast('تم استرجاع البيانات','info');});

$('darkToggle').addEventListener('change',e=>{document.body.setAttribute('data-theme',e.target.checked?'dark':'light');});
$('langSelect').addEventListener('change',()=>{renderTable();renderSummary();renderValidation();});
$('currencySelect').addEventListener('change',()=>{renderSummary();});

/* ============================ File Input ============================ */
$('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  const ext=file.name.split('.').pop().toLowerCase();
  reader.onload=function(ev){
    try{
      if(ext==='csv'){
        const parsed=Papa.parse(ev.target.result,{header:true,skipEmptyLines:true});
        trialData=parsed.data.map(r=>({Account:r.Account||r['اسم الحساب'],Type:r.Type||r['النوع'],Code:r.Code||r['كود'],Debit:toNum(r.Debit||r['مدين']),Credit:toNum(r.Credit||r['دائن'])}));
      } else {
        const wb=XLSX.read(ev.target.result,{type:'binary'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(ws,{defval:''});
        trialData=json.map(r=>({Account:r.Account||r['اسم الحساب'],Type:r.Type||r['النوع'],Code:r.Code||r['كود'],Debit:toNum(r.Debit||r['مدين']),Credit:toNum(r.Credit||r['دائن'])}));
      }
      saveLocal(); renderTable(); renderSummary(); showToast('تم تحميل الملف بنجاح','success');
    }catch(err){showToast('حدث خطأ أثناء تحميل الملف','danger');console.error(err);}
  };
  if(ext==='csv'){reader.readAsText(file);} else {reader.readAsBinaryString(file);}
});

/* ============================ Init ============================ */
renderTable(); renderSummary(); renderValidation();
</script>

</body>
</html>
