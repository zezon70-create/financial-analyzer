<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مقارنة سنوات — المحلل المالي (Comparison)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- html2pdf for export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --bg-dark: linear-gradient(120deg,#071427 0%, #071a2a 40%, #0b1226 100%);
      --bg-light: linear-gradient(120deg,#f6f8fb 0%, #f2f7ff 60%);
      --card-dark: rgba(255,255,255,0.03);
      --card-light: rgba(255,255,255,0.65);
      --glass-border-dark: rgba(255,255,255,0.04);
      --glass-border-light: rgba(2,6,23,0.06);
      --accent1: #0d6efd;
      --accent2: #6610f2;
      --muted-dark:#9aa6b2;
      --muted-light:#6c757d;
      --text-dark:#e6eef6;
      --text-light:#0b1220;
      --radius:12px;
    }
    html,body{height:100%;margin:0;font-family:"Cairo",system-ui,Arial,Helvetica,sans-serif;-webkit-font-smoothing:antialiased;}
    body{background:var(--bg-dark);color:var(--text-dark);transition:background .18s,color .18s}
    body[data-theme="light"]{background:var(--bg-light);color:var(--text-light)}
    .container{max-width:1200px;margin:20px auto;padding:18px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--glass-border-dark);box-shadow:0 12px 40px rgba(2,6,23,0.35)}
    body[data-theme="light"] .header{border:1px solid var(--glass-border-light);box-shadow:0 10px 30px rgba(2,6,23,0.06)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:44px;border-radius:8px;object-fit:cover}
    .brand .title{font-weight:800;font-size:1.05rem}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .select, .btn, .input {padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    body[data-theme="light"] .select, body[data-theme="light"] .input{border:1px solid rgba(2,6,23,0.06)}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;color:#fff;box-shadow:0 10px 30px rgba(102,16,242,0.12)}
    .panel{margin-top:14px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,23,0.25)}
    body[data-theme="light"] .panel{box-shadow:0 8px 20px rgba(2,6,23,0.04);background:rgba(255,255,255,0.9)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column: span 4;}
    .col-6{grid-column: span 6;}
    .col-12{grid-column: span 12;}
    .kpi{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;flex-direction:column;gap:6px}
    .muted{color:var(--muted-dark);font-size:.92rem}
    body[data-theme="light"] .muted{color:var(--muted-light)}
    table{width:100%;border-collapse:collapse;background:transparent}
    th,td{padding:8px 10px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.03)}
    thead th{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:700}
    .comment{margin-top:8px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
    body[data-theme="light"] .comment{background:rgba(2,6,23,0.02)}
    .small{font-size:.9rem}
    @media (max-width:900px){ .grid{grid-template-columns:repeat(6,1fr)} .col-4{grid-column:span 6} .col-6{grid-column:span 6} }
  </style>
</head>
<body data-theme="dark">
  <div class="container" id="app">
    <!-- Header -->
    <div class="header" role="banner" aria-label="Header">
      <div class="brand" title="المحلل المالي">
        <img src="assets/logo.png" alt="logo" id="logo" onerror="this.style.display='none'">
        <div>
          <div class="title" id="appTitle">المحلل المالي — مقارنة سنوات</div>
          <div class="muted small" id="appDesc">مقارنة ديناميكية بين السنوات مع تعليق تحليلي ذكي</div>
        </div>
      </div>

      <div class="controls" role="navigation" aria-label="Controls">
        <select id="sourceSelect" class="select" title="مصدر البيانات" aria-label="مصدر البيانات"></select>

        <label class="muted small" for="yearASelect" id="lblYearA">السنة A</label>
        <select id="yearASelect" class="select"></select>

        <label class="muted small" for="yearBSelect" id="lblYearB">السنة B</label>
        <select id="yearBSelect" class="select"></select>

        <label class="muted small" for="yearCSelect" id="lblYearC">السنة C</label>
        <select id="yearCSelect" class="select"></select>

        <select id="currencySelect" class="select" title="عملة العرض" aria-label="عملة العرض">
          <option value="EGP">ج.م (EGP)</option>
          <option value="USD">$ USD</option>
          <option value="EUR">€ EUR</option>
        </select>

        <select id="langSelect" class="select" title="اللغة" aria-label="اللغة">
          <option value="ar">العربية</option>
          <option value="en">English</option>
        </select>

        <button id="themeToggle" class="btn" title="وضع ليلي/نهاري">🌙</button>
        <button id="exportBtn" class="btn primary" title="تصدير PDF"><i class="bi bi-file-earmark-pdf"></i>&nbsp;<span id="exportText">تصدير PDF</span></button>
      </div>
    </div>

    <!-- Controls panel -->
    <div class="panel">
      <div class="grid">
        <div class="col-12">
          <div class="muted small" id="instructions">اختر مصدر البيانات (Report أو Advanced أو Input أو Uploaded أو Trial). اختر حتى ثلاث سنوات للمقارنة. كل تغيير يحدث يُحدّث الرسوم والجداول تلقائياً.</div>
        </div>
      </div>
    </div>

    <!-- Comparison area -->
    <div class="grid" style="margin-top:12px">
      <div class="col-4">
        <div class="panel kpi">
          <div class="muted small" id="kpiLabelRevenue">الإيرادات</div>
          <div class="value" id="kpiRevenue">—</div>
          <div class="muted small" id="kpiRevComment">—</div>
        </div>
      </div>

      <div class="col-4">
        <div class="panel kpi">
          <div class="muted small" id="kpiLabelExpense">المصروفات</div>
          <div class="value" id="kpiExpense">—</div>
          <div class="muted small" id="kpiExpComment">—</div>
        </div>
      </div>

      <div class="col-4">
        <div class="panel kpi">
          <div class="muted small" id="kpiLabelNet">صافي الربح</div>
          <div class="value" id="kpiNet">—</div>
          <div class="muted small" id="kpiNetComment">—</div>
        </div>
      </div>

      <div class="col-6">
        <div class="panel">
          <h3 class="small" id="chartTitleMain">مقارنة: الإيرادات / المصروفات / صافي</h3>
          <canvas id="cmpChart" height="220"></canvas>
          <div class="comment small" id="chartComment">—</div>
        </div>
      </div>

      <div class="col-6">
        <div class="panel">
          <h3 class="small" id="ratioTitle">مؤشرات ربحية وسيولة</h3>
          <table id="ratioTable" class="small" aria-live="polite">
            <thead><tr><th id="colMetric">المؤشر</th><th id="colA">سنة A</th><th id="colB">سنة B</th><th id="colC">سنة C</th><th id="colChange">النسبة</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="comment small" id="ratioComment">—</div>
        </div>
      </div>

      <div class="col-12">
        <div class="panel">
          <h3 class="small" id="tableTitle">تفاصيل حسابية (جداول)</h3>
          <div style="overflow:auto">
            <table id="detailTable" class="small" aria-live="polite">
              <thead><tr><th id="dtCol">البند</th><th id="dtA">سنة A</th><th id="dtB">سنة B</th><th id="dtC">سنة C</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="comment small" id="detailComment">—</div>
        </div>
      </div>
    </div>

    <footer style="margin-top:14px;color:var(--muted-dark);font-size:.9rem;text-align:center">
      &copy; 2025 المحلل المالي — Comparison · All rights reserved
    </footer>
  </div>

<script>
/* =============================
   Comparison Page - Ultra Pro
   - Reads data from localStorage keys:
     reportData, advancedData, inputData, uploadedData, trialData
   - Full i18n (ar/en). Currency formatting + dynamic labels.
   - Charts using Chart.js. Export via html2pdf.
   - Smart textual commentary per metric.
   ============================= */

const LO_KEYS = [
  {k:'reportData', label_ar:'بيانات التقرير (report)', label_en:'Report data'},
  {k:'advancedData', label_ar:'البيانات المتقدمة (advanced)', label_en:'Advanced data'},
  {k:'inputData', label_ar:'صفحة الإدخال (input)', label_en:'Input page'},
  {k:'uploadedData', label_ar:'الملف المرفوع (upload)', label_en:'Uploaded file'},
  {k:'trialData', label_ar:'ميزان المراجعة (trial)', label_en:'Trial data'}
];

const i18n = {
  ar: {
    exportPdf: 'تصدير PDF',
    lblYearA: 'سنة A', lblYearB:'سنة B', lblYearC:'سنة C',
    instructions: 'اختر مصدر البيانات (Report أو Advanced أو Input أو Uploaded أو Trial). اختر حتى ثلاث سنوات للمقارنة. كل تغيير يحدث يُحدّث الرسوم والجداول تلقائياً.',
    revenue: 'الإيرادات', expense:'المصروفات', net:'صافي الربح',
    chartTitleMain: 'مقارنة: الإيرادات / المصروفات / صافي',
    ratioTitle: 'مؤشرات ربحية وسيولة',
    tableTitle: 'تفاصيل حسابية (جداول)',
    colMetric: 'المؤشر', colChange:'النسبة', dtCol:'البند',
    noData: 'لا توجد بيانات للسنة/المصدر المحدد.',
    selectSource: 'اختر مصدر البيانات...',
    exportSuccess: 'تم تصدير PDF بنجاح'
  },
  en: {
    exportPdf: 'Export PDF',
    lblYearA: 'Year A', lblYearB:'Year B', lblYearC:'Year C',
    instructions: 'Pick data source (Report/Advanced/Input/Uploaded/Trial). Choose up to 3 years. All changes update charts and tables in real-time.',
    revenue: 'Revenue', expense:'Expenses', net:'Net Profit',
    chartTitleMain: 'Comparison: Revenue / Expense / Net',
    ratioTitle: 'Profitability & Liquidity Ratios',
    tableTitle: 'Calculated details (tables)',
    colMetric: 'Metric', colChange:'Change', dtCol:'Item',
    noData: 'No data for selected year/source.',
    selectSource: 'Select data source...',
    exportSuccess: 'PDF exported successfully'
  }
};

/* helpers */
const $ = id => document.getElementById(id);
function el(q){ return document.querySelector(q); }
function toNum(v){ const n = Number(String(v||'').replace(/[, ]+/g,'')); return isNaN(n)?0:n; }
let state = {
  lang: localStorage.getItem('cmp_lang') || 'ar',
  theme: localStorage.getItem('cmp_theme') || 'dark',
  currency: localStorage.getItem('cmp_currency') || 'EGP',
  sourceKey: localStorage.getItem('cmp_source') || '',
  years: [null,null,null],
  rawByYear: {} // year -> rows[]
};

let cmpChart = null;

/* INIT */
function init(){
  // populate source select
  const s = $('sourceSelect'); s.innerHTML = '';
  const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent = t('selectSource'); s.appendChild(opt0);
  LO_KEYS.forEach(k=>{
    const o = document.createElement('option'); o.value = k.k; o.textContent = (state.lang==='ar'? k.label_ar : k.label_en);
    s.appendChild(o);
  });
  if(state.sourceKey) s.value = state.sourceKey;

  // set language, currency, theme
  $('langSelect').value = state.lang;
  $('currencySelect').value = state.currency;
  applyTheme();

  // wire events
  $('langSelect').addEventListener('change', onLangChange);
  $('currencySelect').addEventListener('change', onCurrencyChange);
  $('themeToggle').addEventListener('click', toggleTheme);
  $('sourceSelect').addEventListener('change', onSourceChange);
  $('yearASelect').addEventListener('change', ()=> onYearChange(0));
  $('yearBSelect').addEventListener('change', ()=> onYearChange(1));
  $('yearCSelect').addEventListener('change', ()=> onYearChange(2));
  $('exportBtn').addEventListener('click', exportPdf);

  applyTranslations();
  refreshYearsList();
  refreshAll();
}

/* translation helper */
function t(key){ return (i18n[state.lang] && i18n[state.lang][key]) ? i18n[state.lang][key] : key; }
function applyTranslations(){
  $('exportText').textContent = t('exportPdf');
  $('lblYearA').textContent = t('lblYearA');
  $('lblYearB').textContent = t('lblYearB');
  $('lblYearC').textContent = t('lblYearC');
  $('instructions').textContent = t('instructions');
  $('kpiLabelRevenue').textContent = t('revenue');
  $('kpiLabelExpense').textContent = t('expense');
  $('kpiLabelNet').textContent = t('net');
  $('chartTitleMain').textContent = t('chartTitleMain');
  $('ratioTitle').textContent = t('ratioTitle');
  $('tableTitle').textContent = t('tableTitle');
  // table headers
  document.getElementById('colMetric').textContent = t('colMetric');
  document.getElementById('colChange').textContent = t('colChange');
  document.getElementById('dtCol').textContent = t('dtCol');
  // source select labels refreshed in init
}

/* theme */
function applyTheme(){
  if(state.theme==='light') document.body.setAttribute('data-theme','light');
  else document.body.setAttribute('data-theme','dark');
  localStorage.setItem('cmp_theme', state.theme);
  $('themeToggle').textContent = state.theme==='light' ? '🌞' : '🌙';
}
function toggleTheme(){ state.theme = state.theme==='light' ? 'dark' : 'light'; applyTheme(); }

/* language change */
function onLangChange(e){ state.lang = e.target.value; localStorage.setItem('cmp_lang',state.lang); // relabel source select
  LO_KEYS.forEach((k,i)=> {
    const opt = $('sourceSelect').options[i+1];
    if(opt) opt.textContent = (state.lang==='ar'? LO_KEYS[i].label_ar : LO_KEYS[i].label_en);
  });
  applyTranslations(); refreshYearsList(); refreshAll();
}

/* currency change */
function onCurrencyChange(e){ state.currency = e.target.value; localStorage.setItem('cmp_currency', state.currency); refreshAll(); }

/* pick source */
function onSourceChange(e){
  state.sourceKey = e.target.value;
  localStorage.setItem('cmp_source', state.sourceKey);
  refreshYearsList();
  refreshAll();
}

/* detect years available in the selected source (or across all LO_KEYS if none) */
function refreshYearsList(){
  const keysToCheck = state.sourceKey ? [state.sourceKey] : LO_KEYS.map(x=>x.k);
  const years = new Set();
  keysToCheck.forEach(k=>{
    try{
      const raw = JSON.parse(localStorage.getItem(k) || 'null');
      if(Array.isArray(raw)){
        raw.forEach(r=>{
          ['Year','year','YYYY','y'].forEach(pk => { if(r && r[pk]) years.add(String(r[pk])); });
        });
      } else if(raw && typeof raw === 'object'){
        Object.values(raw).forEach(v=>{
          if(Array.isArray(v)) v.forEach(r=>{
            ['Year','year','YYYY','y'].forEach(pk => { if(r && r[pk]) years.add(String(r[pk])); });
          });
        });
      }
    }catch(e){}
  });
  // fallback: use current year and prev 2 years
  if(years.size === 0){
    const y = new Date().getFullYear();
    years.add(String(y)); years.add(String(y-1)); years.add(String(y-2));
  }
  const sorted = Array.from(years).sort();
  // populate selects
  ['yearASelect','yearBSelect','yearCSelect'].forEach((id,i)=>{
    const sel = $(id); sel.innerHTML = '';
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent = i18n[state.lang].selectSource === undefined ? '' : (state.lang==='ar' ? '—' : '—'); sel.appendChild(opt0);
    sorted.forEach(y=>{ const o = document.createElement('option'); o.value = y; o.textContent = y; sel.appendChild(o); });
    // preserve previous selection if still available
    if(state.years[i] && sorted.includes(state.years[i])) sel.value = state.years[i];
  });
  // Also store the detected lists in state.rawByYear if possible
  buildRawByYear();
}

/* load and normalize data for selected source(s) into state.rawByYear */
function buildRawByYear(){
  state.rawByYear = {};
  const keysToLoad = state.sourceKey ? [state.sourceKey] : LO_KEYS.map(x=>x.k);
  keysToLoad.forEach(k=>{
    try{
      const raw = JSON.parse(localStorage.getItem(k) || 'null');
      if(!raw) return;
      if(Array.isArray(raw)){
        raw.forEach(r => {
          const Year = r.Year || r.year || r.YYYY || r.y || null;
          const y = Year ? String(Year) : 'unknown';
          state.rawByYear[y] = state.rawByYear[y] || [];
          state.rawByYear[y].push(normalizeRow(r));
        });
      } else if(typeof raw === 'object'){
        // object may contain arrays
        Object.values(raw).forEach(v=>{
          if(Array.isArray(v)){
            v.forEach(r=>{
              const Year = r.Year || r.year || r.YYYY || r.y || null;
              const y = Year ? String(Year) : 'unknown';
              state.rawByYear[y] = state.rawByYear[y] || [];
              state.rawByYear[y].push(normalizeRow(r));
            });
          }
        });
      }
    }catch(e){ console.warn('parse error for key',k); }
  });
}

/* normalize row into {Account,Type,Code,Debit,Credit,CashFlow,Year} */
function normalizeRow(r){
  const Account = r.Account || r.account || r.Name || r.name || '';
  const Type = r.Type || r.type || '';
  const Code = r.Code || r.code || '';
  const Debit = toNum(r.Debit||r.debit||r.Dr||r.dr||0);
  const Credit = toNum(r.Credit||r.credit||r.Cr||r.cr||0);
  const CashFlow = toNum(r.CashFlow || r.cashflow || r.cf || 0);
  const Year = r.Year || r.year || r.YYYY || r.y || null;
  return {Account,Type,Code,Debit,Credit,CashFlow,Year};
}

/* onYearChange: store selection and refresh */
function onYearChange(idx){
  const ids = ['yearASelect','yearBSelect','yearCSelect'];
  state.years[idx] = $(ids[idx]).value || null;
  localStorage.setItem('cmp_years', JSON.stringify(state.years));
  refreshAll();
}

/* Aggregation: compute revenue/expense/net/assets/liabilities for a given year */
function aggregateForYear(year){
  buildRawByYear(); // ensure built
  const rows = state.rawByYear[year] || [];
  let revenue=0, expense=0, assets=0, liabilities=0, cashflow=0;
  rows.forEach(r=>{
    // heuristics: many datasets will have revenue as Credits or specific Type keywords
    // We'll use both: prefer fields if present, otherwise try keyword heuristics.
    // Interpret positive Credit as revenue; positive Debit as expense (common TB layout)
    revenue += toNum(r.Credit);
    expense += toNum(r.Debit);
    cashflow += toNum(r.CashFlow);
    const s = (r.Type || r.Account || '').toString().toLowerCase();
    if(/asset|current asset|fixed asset|cash|bank|نقد|أصل|assets/.test(s)) assets += (toNum(r.Debit)-toNum(r.Credit));
    if(/liab|liability|payable|قرض|دائن|خصوم|liabilities/.test(s)) liabilities += (toNum(r.Credit)-toNum(r.Debit));
  });
  const net = revenue - expense;
  return {revenue,expense,net,assets,liabilities,cashflow,rowsCount:rows.length};
}

/* Build comparison arrays for selected years */
function buildComparison(){
  const years = state.years.filter(Boolean);
  const labels = years.length ? years : [];
  const datasets = [];
  const revs = [], exps = [], nets = [];
  labels.forEach(y=>{
    const ag = aggregateForYear(y);
    revs.push(ag.revenue);
    exps.push(ag.expense);
    nets.push(ag.net);
  });
  return {labels,revs,exps,nets};
}

/* format currency */
function formatCurrency(v){
  // show compact numbers and currency symbol
  const c = state.currency || 'EGP';
  const abs = Math.abs(v);
  const sign = v<0? '-' : '';
  let num;
  if(abs >= 1e9) num = (abs/1e9).toFixed(2) + 'B';
  else if(abs >= 1e6) num = (abs/1e6).toFixed(2) + 'M';
  else if(abs >= 1e3) num = (abs/1e3).toFixed(2) + 'K';
  else num = abs.toFixed(2).replace(/\.00$/,'');
  if(c==='EGP') return `${sign}${num} ج.م`;
  if(c==='USD') return `${sign}$${num}`;
  if(c==='EUR') return `${sign}€${num}`;
  return `${sign}${num} ${c}`;
}

/* render KPI boxes */
function renderKPIs(){
  const ids = state.years;
  const a = ids[0], b = ids[1], c = ids[2];
  const agA = a ? aggregateForYear(a) : null;
  const agB = b ? aggregateForYear(b) : null;
  const agC = c ? aggregateForYear(c) : null;
  // shown as combined summary when only one selected else show A vs B diff in the small text
  const showRev = agA ? agA.revenue : (agB ? agB.revenue : (agC?agC.revenue:0));
  const showExp = agA ? agA.expense : (agB ? agB.expense : (agC?agC.expense:0));
  const showNet = agA ? agA.net : (agB ? agB.net : (agC?agC.net:0));
  $('kpiRevenue').textContent = formatCurrency(showRev);
  $('kpiExpense').textContent = formatCurrency(showExp);
  $('kpiNet').textContent = formatCurrency(showNet);

  $('kpiRevComment').textContent = generateKPIComment('revenue', agA, agB, agC);
  $('kpiExpComment').textContent = generateKPIComment('expense', agA, agB, agC);
  $('kpiNetComment').textContent = generateKPIComment('net', agA, agB, agC);
}

/* smart KPI comment generator */
function generateKPIComment(metric, A, B, C){
  const lang = state.lang;
  // prefer comparing A vs B if both present
  const left = A || B || C;
  const right = B || C || A;
  if(!left || !right) {
    if(!left) return t('noData');
  }
  const v1 = left ? (metric==='revenue'?left.revenue: metric==='expense'?left.expense: left.net) : 0;
  const v2 = right ? (metric==='revenue'?right.revenue: metric==='expense'?right.expense: right.net) : 0;
  const diff = v1 - v2;
  const pct = v2 ? (diff / Math.abs(v2)) : 0;
  const up = pct > 0.05;
  const down = pct < -0.05;
  if(Math.abs(pct) < 0.03) {
    return lang==='ar' ? 'لا تغيير جوهري مقارنة بالعام المرجعي.' : 'No significant change vs reference year.';
  }
  if(up) return lang==='ar' ? `تحسّن بنسبة ${(pct*100).toFixed(1)}% — اتجاه إيجابي.` : `Improved by ${(pct*100).toFixed(1)}% — positive trend.`;
  if(down) return lang==='ar' ? `انخفاض بنسبة ${(Math.abs(pct)*100).toFixed(1)}% — راجع التغييرات.` : `Dropped by ${(Math.abs(pct)*100).toFixed(1)}% — review changes.`;
  return lang==='ar' ? 'تغيّر طفيف.' : 'Minor change.';
}

/* render Chart */
function renderChart(){
  const cmp = buildComparison();
  const labels = cmp.labels.length ? cmp.labels : ['No data'];
  const datasets = [];
  // revenue
  datasets.push({label: t('revenue'), data: cmp.revs, borderColor: '#0d6efd', backgroundColor:'rgba(13,110,253,0.08)', yAxisID:'y'});
  // expense
  datasets.push({label: t('expense'), data: cmp.exps, borderColor: '#dc3545', backgroundColor:'rgba(220,53,69,0.08)', yAxisID:'y'});
  // net
  datasets.push({label: t('net'), data: cmp.nets, borderColor: '#198754', backgroundColor:'rgba(25,135,84,0.06)', yAxisID:'y'});

  const ctx = $('cmpChart').getContext('2d');
  if(cmpChart) try{ cmpChart.destroy(); }catch(e){}
  cmpChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive:true,
      interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'bottom'}},
      scales:{
        y:{beginAtZero:true, ticks:{callback: function(v){ return formatCurrency(v); }}}
      }
    }
  });

  // chart comment
  $('chartComment').textContent = generateChartComment(cmp);
}

/* generate chart-level comment */
function generateChartComment(cmp){
  if(!cmp.labels.length) return t('noData');
  const totalNet = cmp.nets.reduce((s,x)=>s+x,0);
  if(totalNet > 0) return state.lang==='ar' ? 'الاتجاه الإجمالي للـصافي إيجابي — علامة جيدة.' : 'Overall net trend is positive — good sign.';
  if(totalNet < 0) return state.lang==='ar' ? 'الاتجاه الإجمالي للـصافي سلبي — يلزم تحليل.' : 'Overall net trend negative — needs review.';
  return state.lang==='ar' ? 'الاتجاه محايد — لا تغيّرات كبيرة.' : 'Neutral trend — no major changes.';
}

/* ratios & details rendering */
function renderRatiosAndDetails(){
  const years = state.years.filter(Boolean);
  const metrics = [
    {key:'revenue', label_en:'Revenue', label_ar:'الإيرادات'},
    {key:'expense', label_en:'Expenses', label_ar:'المصروفات'},
    {key:'net', label_en:'Net Profit', label_ar:'صافي الربح'},
    {key:'assets', label_en:'Assets', label_ar:'الأصول (تقريبي)'},
    {key:'liabilities', label_en:'Liabilities', label_ar:'الخصوم (تقريبي)'},
    {key:'cashflow', label_en:'Cash Flow', label_ar:'التدفقات النقدية'}
  ];
  // compute per-year values
  const perYearVals = years.map(y => {
    const ag = aggregateForYear(y);
    return ag;
  });

  // populate ratio table
  const tbody = document.querySelector('#ratioTable tbody'); tbody.innerHTML = '';
  metrics.forEach(m=>{
    const tr = document.createElement('tr');
    const td0 = document.createElement('td'); td0.textContent = state.lang==='ar' ? m.label_ar : m.label_en;
    tr.appendChild(td0);
    const vals = perYearVals.map(v=> {
      if(!v) return '-';
      const val = m.key==='revenue'? v.revenue : m.key==='expense'? v.expense : m.key==='net'? v.net : m.key==='assets'? v.assets : m.key==='liabilities'? v.liabilities : v.cashflow;
      return formatCurrency(val);
    });
    vals.forEach(val=>{ const td = document.createElement('td'); td.textContent = val; tr.appendChild(td); });
    // change column: percent difference between first two selected if present
    const tdChange = document.createElement('td');
    if(perYearVals[0] && perYearVals[1]){
      const v1 = m.key==='revenue'? perYearVals[0].revenue : m.key==='expense'? perYearVals[0].expense : m.key==='net'? perYearVals[0].net : m.key==='assets'? perYearVals[0].assets : m.key==='liabilities'? perYearVals[0].liabilities : perYearVals[0].cashflow;
      const v2 = m.key==='revenue'? perYearVals[1].revenue : m.key==='expense'? perYearVals[1].expense : m.key==='net'? perYearVals[1].net : m.key==='assets'? perYearVals[1].assets : m.key==='liabilities'? perYearVals[1].liabilities : perYearVals[1].cashflow;
      const pct = v2 ? ((v1 - v2) / Math.abs(v2) * 100) : 0;
      tdChange.textContent = `${pct>=0?'+':''}${pct.toFixed(1)}%`;
    } else tdChange.textContent = '-';
    tr.appendChild(tdChange);
    tbody.appendChild(tr);
  });

  // details table: show values side-by-side for a set of high-level items
  const dBody = document.querySelector('#detailTable tbody'); dBody.innerHTML = '';
  const detailItems = ['Revenue','Expenses','Net','Assets','Liabilities','CashFlow'];
  detailItems.forEach(it=>{
    const tr = document.createElement('tr');
    const td0 = document.createElement('td'); td0.textContent = mapDetailLabel(it);
    tr.appendChild(td0);
    years.forEach((y,i)=>{
      const ag = perYearVals[i] || {};
      let v = 0;
      if(it==='Revenue') v = ag.revenue || 0;
      if(it==='Expenses') v = ag.expense || 0;
      if(it==='Net') v = ag.net || 0;
      if(it==='Assets') v = ag.assets || 0;
      if(it==='Liabilities') v = ag.liabilities || 0;
      if(it==='CashFlow') v = ag.cashflow || 0;
      const td = document.createElement('td'); td.textContent = formatCurrency(v); tr.appendChild(td);
    });
    // pad empty columns to ensure 3 columns appear
    for(let k=years.length;k<3;k++){ const td = document.createElement('td'); td.textContent = '-'; tr.appendChild(td); }
    dBody.appendChild(tr);
  });

  // small comments
  $('ratioComment').textContent = generateRatioOverview(perYearVals, years);
  $('detailComment').textContent = state.lang==='ar' ? 'ملخص الأرقام أعلاه — راجع التعليقات لكل مؤشر.' : 'Numbers summary above — review comments per metric.';
}

/* map detail label */
function mapDetailLabel(k){
  const map = {
    'Revenue': state.lang==='ar' ? 'الإيرادات' : 'Revenue',
    'Expenses': state.lang==='ar' ? 'المصروفات' : 'Expenses',
    'Net': state.lang==='ar' ? 'صافي الربح' : 'Net Profit',
    'Assets': state.lang==='ar' ? 'الأصول' : 'Assets',
    'Liabilities': state.lang==='ar' ? 'الخصوم' : 'Liabilities',
    'CashFlow': state.lang==='ar' ? 'التدفقات النقدية' : 'Cash Flow'
  };
  return map[k] || k;
}

/* ratio overview comment */
function generateRatioOverview(vals, years){
  if(vals.length === 0) return t('noData');
  // simple checks: profit growth, liquidity proxy
  const a = vals[0] || {}, b = vals[1] || {};
  if(!a || !b) return state.lang==='ar' ? 'غير كافٍ للمقارنة.' : 'Insufficient data for comparison.';
  const netChangePct = b.net ? ((a.net - b.net)/Math.abs(b.net)) : 0;
  if(netChangePct > 0.1) return state.lang==='ar' ? 'تحسّن ربحي ملحوظ — أداء جيد.' : 'Notable profit improvement — solid performance.';
  if(netChangePct < -0.1) return state.lang==='ar' ? 'انخفاض كبير في الربحية — يلزم تحقيق.' : 'Significant profitability drop — investigate.';
  return state.lang==='ar' ? 'تغيرات طفيفة — استقرار نسبي.' : 'Minor changes — relative stability.';
}

/* generate chart comment & KPI comments are above */

function refreshAll(){
  // rebuild rawByYear then render
  buildRawByYear();
  renderKPIs();
  renderChart();
  renderRatiosAndDetails();
}

/* export PDF */
function exportPdf(){
  const el = document.querySelector('.container');
  const oldTheme = document.body.getAttribute('data-theme');
  // switch to light for better PDF readability
  document.body.setAttribute('data-theme','light');
  const opt = {
    margin:0.25, filename: `comparison_${Date.now()}.pdf`,
    image:{type:'jpeg',quality:0.95},
    html2canvas:{scale:2, useCORS:true, allowTaint:true},
    jsPDF:{unit:'in',format:'a4',orientation:'portrait'}
  };
  html2pdf().set(opt).from(el).save().then(()=>{
    showToast(t('exportSuccess'));
  }).finally(()=>{ document.body.setAttribute('data-theme', oldTheme || 'dark'); });
}

/* tiny toast (console + temporary visual) */
function showToast(msg){
  console.info(msg);
  const d = document.createElement('div'); d.textContent = msg;
  d.style.position='fixed'; d.style.left='50%'; d.style.top='18px'; d.style.transform='translateX(-50%)';
  d.style.background='#222'; d.style.color='#fff'; d.style.padding='8px 12px'; d.style.borderRadius='8px'; d.style.zIndex=9999;
  document.body.appendChild(d);
  setTimeout(()=> d.remove(), 2400);
}

/* boot */
(function boot(){
  // restore previously selected years if any
  const savedYears = JSON.parse(localStorage.getItem('cmp_years')||'[null,null,null]');
  state.years = savedYears;
  init();
  // set selects values from state.years if present
  if(state.years[0]) $('yearASelect').value = state.years[0];
  if(state.years[1]) $('yearBSelect').value = state.years[1];
  if(state.years[2]) $('yearCSelect').value = state.years[2];
  // initial load
  refreshAll();
})();
</script>

</body>
</html>
