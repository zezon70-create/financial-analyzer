<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ù…Ù‚Ø§Ø±Ù†Ø§Øª Ù…Ø§Ù„ÙŠØ© â€” Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ (Compare)</title>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.06);
      --accent1: #00b4d8; --accent2:#7209b7;
      --muted:#9aa6b2;
      --card-radius:12px;
    }
    html,body{height:100%;margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#0b1220}
    body{background:linear-gradient(120deg,#0f1724 0%, #071427 40%, #081227 100%); color:#e6eef6; transition:background .22s,color .22s}
    body[data-theme="light"]{ background:linear-gradient(120deg,#f6fbff 0%, #f2f6fb 60%); color:#0b1220 }

    /* header */
    .nav{
      position:sticky;top:10px;margin:12px auto;max-width:1200px;padding:10px 14px;border-radius:14px;display:flex;align-items:center;gap:12px;justify-content:space-between;
      backdrop-filter: blur(8px);
      background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);
      box-shadow:0 10px 30px rgba(2,6,23,0.35);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;border-radius:8px;object-fit:cover}
    .brand .title{font-weight:800}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:.45rem .7rem;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 8px 30px rgba(112,15,170,0.12)}
    .select, .input {padding:.45rem .6rem;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}

    /* page layout */
    .container{max-width:1200px;margin:18px auto;padding:16px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--card-radius);padding:14px;border:1px solid rgba(255,255,255,0.04);margin-bottom:14px}
    .glass {backdrop-filter: blur(6px); background:var(--glass-bg); border-radius:12px; padding:12px;}
    h1, h2, h3{margin:0 0 8px 0}
    .muted{color:var(--muted);font-size:.95rem}

    /* grid */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column:span 4}
    .col-8{grid-column:span 8}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}

    /* tables */
    table{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden}
    thead th{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;padding:10px;text-align:right}
    tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);background:transparent}
    .small-muted{font-size:.9rem;color:var(--muted)}
    .comment{margin-top:10px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:.95rem}

    /* charts area */
    .chart-wrap{height:320px}

    /* responsive */
    @media (max-width:900px){
      .grid{grid-template-columns:repeat(6,1fr)}
      .col-4,.col-6,.col-8{grid-column:span 6}
    }
    /* polish */
    .controls .select, .controls .input {min-width:140px}
    .multi-years{min-height:120px;max-height:160px;overflow:auto;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent}
    .year-item{display:flex;justify-content:space-between;padding:6px 8px;border-radius:6px;margin-bottom:6px;align-items:center}
    .year-item label{cursor:pointer}
    .kpi{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
  </style>
</head>
<body data-theme="dark">
  <!-- Header / Nav -->
  <div class="nav" role="banner" aria-label="Navigation">
    <div class="brand">
      <img src="assets/logo.png" alt="logo" id="logoImg" onerror="this.style.display='none'">
      <div>
        <div class="title" id="brandTitle">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
        <div class="muted small" id="brandSub">Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø³Ù†ÙˆØ§Øª â€” Compare</div>
      </div>
    </div>

    <div class="controls" role="navigation" aria-label="controls">
      <button class="btn" onclick="location.href='index.html'"><i class="bi bi-house"></i> <span id="navHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
      <button class="btn" onclick="location.href='input.html'"><i class="bi bi-pen"></i> <span id="navInput">Input</span></button>
      <button class="btn" onclick="location.href='upload.html'"><i class="bi bi-cloud-arrow-up"></i> <span id="navUpload">Upload</span></button>
      <button class="btn" onclick="location.href='report.html'"><i class="bi bi-file-earmark-text"></i> <span id="navReport">Report</span></button>
      <button class="btn" onclick="location.href='advanced.html'"><i class="bi bi-graph-up"></i> <span id="navAdvanced">Advanced</span></button>
      <button class="btn" onclick="location.href='dashboard.html'"><i class="bi bi-speedometer2"></i> <span id="navDash">Dashboard</span></button>

      <select id="sourceSelect" class="select" title="Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"></select>

      <select id="currencySelect" class="select" title="Ø§Ù„Ø¹Ù…Ù„Ø©">
        <option value="EGP">Ø¬.Ù… - EGP</option>
        <option value="USD">USD - $</option>
        <option value="EUR">EUR - â‚¬</option>
      </select>

      <select id="langSelect" class="select" title="Ø§Ù„Ù„ØºØ©">
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="en">English</option>
      </select>

      <button id="themeToggle" class="btn" title="Theme">ğŸŒ™</button>
      <button id="exportPdfBtn" class="btn primary" title="Export PDF"><i class="bi bi-file-earmark-pdf"></i> <span id="exportPdfLabel">ØªØµØ¯ÙŠØ± PDF</span></button>
      <button id="exportXlsxBtn" class="btn" title="Export Excel"><i class="bi bi-file-earmark-excel"></i> <span id="exportXlsxLabel">ØªØµØ¯ÙŠØ± Excel</span></button>
    </div>
  </div>

  <main class="container" id="app">
    <!-- top controls -->
    <section class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h1 id="pageTitle">Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø³Ù†ÙˆØ§Øª</h1>
          <div class="muted" id="pageDesc">Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Input / Upload / Report / Advanced)ØŒ Ø«Ù… Ø§Ø®ØªÙØ± Ø³Ù†ÙˆØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©. Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ØªØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <label class="muted small" for="compareMode" id="lblCompareMode">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</label>
          <select id="compareMode" class="select" title="Compare Mode">
            <option value="multi">Ù…Ù‚Ø§Ø±Ù†Ø© Ù…ØªØ¹Ø¯Ø¯Ø© (Multi-year)</option>
            <option value="pair">Ù…Ù‚Ø§Ø±Ù†Ø© Ø²ÙˆØ¬ÙŠØ© (Pairwise)</option>
          </select>
        </div>
      </div>
    </section>

    <section class="grid">
      <div class="col-4 panel">
        <h3 id="sourceTitle">Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <p class="small-muted" id="sourceHint">Ù†Ù‚Ø±Ø£ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (localStorage).</p>

        <div style="margin-top:8px;">
          <label class="muted small" id="lblYears">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†ÙˆØ§Øª</label>
          <div id="yearList" class="multi-years" aria-live="polite"></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="btnCompare" class="btn primary">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</button>
          <button id="btnReset" class="btn">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
        </div>

        <div style="margin-top:14px">
          <h4 class="muted small">Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©</h4>
          <ul class="small-muted" id="availableKeys"></ul>
        </div>
      </div>

      <div class="col-8 panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 id="summaryTitle">Ø§Ù„Ù…Ù„Ø®Øµ â€” Key Summary</h3>
          <div class="muted small" id="summaryHint">Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„ÙƒÙ„ Ø³Ù†Ø© Ù…ÙØ®ØªØ§Ø±Ø©.</div>
        </div>

        <div class="grid" style="margin-top:10px">
          <div class="col-4 kpi panel">
            <div class="muted small" id="lblAccounts">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
            <div style="font-weight:800;font-size:1.2rem" id="valAccounts">0</div>
            <div class="small-muted" id="cmtAccounts">â€”</div>
          </div>
          <div class="col-4 kpi panel">
            <div class="muted small" id="lblTotalAssets">Ø§Ù„Ø£ØµÙˆÙ„ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</div>
            <div style="font-weight:800;font-size:1.2rem" id="valAssets">0</div>
            <div class="small-muted" id="cmtAssets">â€”</div>
          </div>
          <div class="col-4 kpi panel">
            <div class="muted small" id="lblTotalLiab">Ø§Ù„Ø®ØµÙˆÙ… (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</div>
            <div style="font-weight:800;font-size:1.2rem" id="valLiab">0</div>
            <div class="small-muted" id="cmtLiab">â€”</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <h4 class="muted small">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</h4>
          <div style="overflow:auto">
            <table id="compareTable" role="table" aria-live="polite">
              <thead>
                <tr id="compareHead"></tr>
              </thead>
              <tbody id="compareBody"></tbody>
            </table>
          </div>
          <div class="comment" id="compareComment">â€”</div>
        </div>
      </div>

      <div class="col-12 panel">
        <h3 id="chartMainTitle">Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</h3>
        <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
        <div class="comment" id="chartComment">â€”</div>
      </div>
    </section>
  </main>

  <script>
  /************************************************************************
   * Compare Page - Ultra Pro (single file)
   * Features:
   * - Reads from localStorage keys: trialData, inputData, uploadedData, reportData, advancedData
   * - Multi-year selection & pairwise modes
   * - Heuristic normalization and aggregation (assets, liabilities, revenue, expense)
   * - Dynamic translation (ar/en) for all UI text
   * - Currency symbol changes dynamically
   * - Export to PDF and Excel
   * - Theme toggle (dark/light)
   * - Detailed comments for each result (smart, dynamic)
   **************************************************************************/

  // Helper shortcuts
  const $ = id => document.getElementById(id);
  const keysToCheck = ['trialData','inputData','uploadedData','reportData','advancedData'];

  // Translations
  const L = {
    ar: {
      pageTitle: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø³Ù†ÙˆØ§Øª',
      pageDesc: 'Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Input / Upload / Report / Advanced)ØŒ Ø«Ù… Ø§Ø®ØªÙØ± Ø³Ù†ÙˆØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©. Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ØªØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.',
      exportPdf: 'ØªØµØ¯ÙŠØ± PDF',
      exportXlsx: 'ØªØµØ¯ÙŠØ± Excel',
      selectSource: 'Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...',
      yearsLabel: 'Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†ÙˆØ§Øª',
      compare: 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©',
      reset: 'Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·',
      noData: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯.',
      accounts: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª',
      assets: 'Ø§Ù„Ø£ØµÙˆÙ„ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)',
      liabilities: 'Ø§Ù„Ø®ØµÙˆÙ… (ØªÙ‚Ø±ÙŠØ¨ÙŠ)',
      comparisonTable: 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©',
      chartCommentPrefix: 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…',
      navHome: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
      navInput: 'Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„',
      navUpload: 'Ø±ÙØ¹',
      navReport: 'Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
      navAdvanced: 'Ø§Ù„Ù…ØªÙ‚Ø¯Ù…',
      navDash: 'Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©',
      compareMode: {multi: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ù…ØªØ¹Ø¯Ø¯Ø©', pair: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø²ÙˆØ¬ÙŠØ©'},
      pairHint: 'ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø²ÙˆØ¬ÙŠ Ø§Ø®ØªØ± Ø³Ù†ØªÙŠÙ† ÙÙ‚Ø· (Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø³Ù†Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø³Ù†Ø©).'
    },
    en: {
      pageTitle: 'Year Comparison',
      pageDesc: 'Pick a data source (Input / Upload / Report / Advanced), then choose multiple years to compare. Results and comments update automatically.',
      exportPdf: 'Export PDF',
      exportXlsx: 'Export Excel',
      selectSource: 'Select data source...',
      yearsLabel: 'Choose years',
      compare: 'Start Compare',
      reset: 'Reset',
      noData: 'No data in the selected source.',
      accounts: 'Accounts',
      assets: 'Assets (approx)',
      liabilities: 'Liabilities (approx)',
      comparisonTable: 'Comparison Table',
      chartCommentPrefix: 'Chart analysis',
      navHome: 'Home',
      navInput: 'Input',
      navUpload: 'Upload',
      navReport: 'Report',
      navAdvanced: 'Advanced',
      navDash: 'Dashboard',
      compareMode: {multi: 'Multi-year', pair: 'Pairwise'},
      pairHint: 'In pairwise mode select exactly two years (compare A vs B).'
    }
  };

  // state
  const state = {
    lang: localStorage.getItem('cmp_lang') || 'ar',
    theme: localStorage.getItem('cmp_theme') || 'dark',
    currency: localStorage.getItem('cmp_currency') || 'EGP',
    sourceKey: localStorage.getItem('cmp_source') || '',
    availableYears: [], // array of years found in data
    selectedYears: [], // chosen years
    rawRows: [], // normalized rows: {Account,Type,Code,Debit,Credit,Year}
    compareMode: 'multi' // 'multi' or 'pair'
  };

  // Setup UI & initial
  function init(){
    // populate source select
    const sel = $('sourceSelect');
    sel.innerHTML = '';
    const placeholder = createOption('', t('selectSource')); sel.appendChild(placeholder);
    keysToCheck.forEach(k => sel.appendChild(createOption(k, k)));
    sel.value = state.sourceKey || '';
    $('langSelect').value = state.lang;
    $('currencySelect').value = state.currency;
    $('compareMode').value = state.compareMode;
    applyTranslations();
    applyTheme();
    detectAvailableKeys();
    attachEvents();
    populateYearsList();
    updateNavText();
    clearResults();
  }

  function createOption(v,t){ const o=document.createElement('option'); o.value=v; o.textContent=t; return o; }

  // Translation helper
  function t(key){
    const dict = L[state.lang] || L['ar'];
    // support nested keys
    if(typeof key === 'string' && key.indexOf('.')>-1){
      const parts = key.split('.');
      let cur = dict;
      for(const p of parts){ cur = cur ? cur[p] : null; }
      return cur || key;
    }
    return dict[key] || key;
  }

  function applyTranslations(){
    $('pageTitle').textContent = t('pageTitle');
    $('pageDesc').textContent = t('pageDesc');
    $('exportPdfLabel').textContent = t('exportPdf');
    $('exportXlsxLabel').textContent = t('exportXlsx');
    $('lblYears').textContent = t('yearsLabel');
    $('btnCompare').textContent = t('compare');
    $('btnReset').textContent = t('reset');
    $('lblCompareMode').textContent = t('compareMode.'+state.compareMode);
    $('navHome').textContent = t('navHome');
    $('navInput').textContent = t('navInput');
    $('navUpload').textContent = t('navUpload');
    $('navReport').textContent = t('navReport');
    $('navAdvanced').textContent = t('navAdvanced');
    $('navDash').textContent = t('navDash');
    // KPI labels
    $('lblAccounts').textContent = t('accounts');
    $('lblTotalAssets').textContent = t('assets');
    $('lblTotalLiab').textContent = t('liabilities');
    // table title
    $('summaryTitle').textContent = t('comparisonTable');
    // compare mode label
    document.querySelectorAll('#compareMode option').forEach(opt=>{
      if(opt.value==='multi') opt.textContent = t('compareMode.multi');
      if(opt.value==='pair') opt.textContent = t('compareMode.pair');
    });
  }

  function applyTheme(){
    if(state.theme === 'light') document.body.setAttribute('data-theme','light');
    else document.body.setAttribute('data-theme','dark');
    $('themeToggle').textContent = state.theme==='light' ? 'ğŸŒ' : 'ğŸŒ™';
  }

  function updateNavText(){
    // nav labels already applied in applyTranslations
  }

  // detect which keys exist in localStorage
  function detectAvailableKeys(){
    const list = $('availableKeys'); list.innerHTML = '';
    keysToCheck.forEach(k=>{
      if(localStorage.getItem(k)){
        const li = document.createElement('li'); li.textContent = `${k} â€” Ù…ÙˆØ¬ÙˆØ¯`; list.appendChild(li);
      } else {
        const li = document.createElement('li'); li.textContent = `${k} â€” ÙØ§Ø±Øº`; li.style.opacity=0.5; list.appendChild(li);
      }
    });
  }

  // Attach events
  function attachEvents(){
    $('langSelect').addEventListener('change', e=>{ state.lang = e.target.value; localStorage.setItem('cmp_lang', state.lang); applyTranslations(); populateYearsList(); });
    $('currencySelect').addEventListener('change', e=>{ state.currency = e.target.value; localStorage.setItem('cmp_currency', state.currency); refreshUI(); });
    $('themeToggle').addEventListener('click', ()=>{ state.theme = state.theme==='light' ? 'dark' : 'light'; localStorage.setItem('cmp_theme', state.theme); applyTheme(); });
    $('sourceSelect').addEventListener('change', e=>{ state.sourceKey = e.target.value; localStorage.setItem('cmp_source', state.sourceKey); loadSource(); });

    $('btnCompare').addEventListener('click', ()=>{ if(state.selectedYears.length < 1){ alert(t('noData')); return; } runComparison(); });
    $('btnReset').addEventListener('click', ()=>{ state.selectedYears = []; populateYearsList(); clearResults(); });

    $('compareMode').addEventListener('change', e=> { state.compareMode = e.target.value; $('lblCompareMode').textContent = t('compareMode.'+state.compareMode); populateYearsList(); });

    $('exportPdfBtn').addEventListener('click', exportPdf);
    $('exportXlsxBtn').addEventListener('click', exportXlsx);
  }

  /* ====== Data loading & normalization ====== */
  function loadSource(){
    const key = state.sourceKey;
    state.rawRows = [];
    state.availableYears = [];
    populateYearsList();
    if(!key){ clearResults(); return; }
    try{
      const raw = JSON.parse(localStorage.getItem(key) || 'null');
      if(!raw){ clearResults(); return; }
      // raw may be: array rows, or object with arrays
      const normalized = [];
      if(Array.isArray(raw)){
        raw.forEach(r => {
          if(typeof r === 'object') normalized.push(normalizeRow(r));
        });
      } else if(typeof raw === 'object'){
        Object.values(raw).forEach(v=>{
          if(Array.isArray(v)) v.forEach(r=> { if(typeof r==='object') normalized.push(normalizeRow(r)); });
        });
      }
      state.rawRows = normalized;
      // detect years
      const years = new Set();
      normalized.forEach(r => { if(r.Year) years.add(String(r.Year)); });
      state.availableYears = Array.from(years).sort();
      populateYearsList();
      refreshUI();
    }catch(e){
      console.error('parse error',e);
      clearResults();
    }
  }

  function normalizeRow(r){
    // Try common key names
    const Account = r.Account || r.account || r['Account Name'] || r['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'] || r.Name || r.name || '';
    const Type = r.Type || r.type || r['Ù†ÙˆØ¹'] || '';
    const Code = r.Code || r.code || r['ÙƒÙˆØ¯'] || '';
    const Debit = toNum(r.Debit || r.debit || r.Dr || r['Ù…Ø¯ÙŠÙ†'] || r.dr || 0);
    const Credit = toNum(r.Credit || r.credit || r.Cr || r['Ø¯Ø§Ø¦Ù†'] || r.cr || 0);
    const Year = r.Year || r.year || r.YYYY || null;
    return { Account:String(Account||''), Type:String(Type||''), Code:String(Code||''), Debit, Credit, Year:Year ? String(Year) : null };
  }

  function toNum(v){ const n = Number(String(v||'').toString().replace(/[, ]+/g,'')); return isNaN(n) ? 0 : n; }

  /* ====== Years UI ====== */
  function populateYearsList(){
    const container = $('yearList'); container.innerHTML = '';
    let years = state.availableYears.length ? state.availableYears.slice() : [];
    // If no explicit years, create synthetic buckets by index/chunk
    if(!years.length && state.rawRows.length){
      // create buckets P1,P2,... group by 10 rows
      const count = Math.max(1, Math.ceil(state.rawRows.length / 10));
      for(let i=1;i<=count;i++) years.push('P'+i);
    }
    // if still empty, show current year as default
    if(!years.length) years = [new Date().getFullYear().toString()];

    years.forEach(y=>{
      const div = document.createElement('div'); div.className='year-item';
      const lbl = document.createElement('label'); lbl.textContent = y;
      const inp = document.createElement('input'); inp.type='checkbox'; inp.value = y;
      inp.checked = state.selectedYears.includes(y);
      inp.addEventListener('change', (e)=>{
        if(state.compareMode === 'pair'){
          // pair mode allow up to 2 (exactly 2 recommended)
          if(e.target.checked){
            state.selectedYears.push(y);
            if(state.selectedYears.length > 2){
              // keep last 2
              state.selectedYears = state.selectedYears.slice(-2);
              // uncheck others
              container.querySelectorAll('input').forEach(i=> { if(!state.selectedYears.includes(i.value)) i.checked = false; });
            }
          } else {
            state.selectedYears = state.selectedYears.filter(s=> s !== y);
          }
        } else {
          if(e.target.checked) state.selectedYears.push(y); else state.selectedYears = state.selectedYears.filter(s=> s !== y);
        }
      });
      div.appendChild(lbl);
      div.appendChild(inp);
      container.appendChild(div);
    });
  }

  /* ====== Aggregation logic ====== */
  // Aggregate metrics for a specific year/bucket
  function aggregateForYear(yearKey){
    // if Year fields exist, filter by equality. Otherwise if bucket Pn, take slice.
    const rows = state.rawRows.slice();
    let filtered = [];
    if(state.availableYears.length){
      filtered = rows.filter(r => String(r.Year) === String(yearKey));
    } else {
      // bucket-based: P1 => first chunk etc.
      if(/^P\d+$/.test(String(yearKey))){
        const idx = Number(yearKey.slice(1)) - 1;
        const chunk = 10;
        filtered = rows.slice(idx*chunk, (idx+1)*chunk);
      } else filtered = rows;
    }

    // compute totals
    let totalDebit = 0, totalCredit = 0;
    let assets=0, liabilities=0, revenue=0, expense=0;
    filtered.forEach(r=>{
      totalDebit += toNum(r.Debit); totalCredit += toNum(r.Credit);
      const net = toNum(r.Debit) - toNum(r.Credit);
      const s = (r.Type || r.Account || '').toString().toLowerCase();
      if(/asset|Ø£ØµÙ„|Ù†Ù‚Ø¯|bank|cash|current asset|fixed asset|Ø£ØµÙˆÙ„/.test(s)) assets += net;
      else if(/liab|Ø®ØµÙˆÙ…|payable|Ø¯Ø§Ø¦Ù†|Ù‚Ø±Ø¶|loan/.test(s)) liabilities += -net;
      else if(/revenue|sale|Ø¥ÙŠØ±Ø§Ø¯|Ù…Ø¨ÙŠØ¹Ø§Øª|income/.test(s)) revenue += -net;
      else if(/expense|Ù…ØµØ±ÙˆÙ|ØªÙƒÙ„ÙØ©|cogs/.test(s)) expense += net;
      else {
        const a = (r.Account||'').toLowerCase();
        if(/Ø§Ù„Ù†Ù‚Ø¯|bank|cash/.test(a)) assets += net;
        else if(/Ù…ÙˆØ±Ø¯|payable|Ø¯Ø§Ø¦Ù†/.test(a)) liabilities += -net;
        else if(/Ù…Ø¨ÙŠØ¹Ø§Øª|revenue|sale/.test(a)) revenue += -net;
        else if(/Ù…ØµØ±ÙˆÙ|expense|ØªÙƒÙ„ÙØ©/.test(a)) expense += net;
        else { /* ambiguous => ignore */ }
      }
    });

    return {
      rowsCount: filtered.length,
      totalDebit, totalCredit,
      assets, liabilities, revenue, expense,
      netProfit: (revenue - expense)
    };
  }

  /* ====== Comparison execution & rendering ====== */
  let mainChart = null;
  function runComparison(){
    // ensure selectedYears
    if(!state.selectedYears.length){ alert(t('noData')); return; }
    // compute per year
    const results = {};
    state.selectedYears.forEach(y => { results[y] = aggregateForYear(y); });

    // render KPIs aggregate (show sums or first selected summary)
    const combined = {accounts:0, assets:0, liabilities:0};
    state.selectedYears.forEach(y=>{ combined.accounts += results[y].rowsCount; combined.assets += results[y].assets; combined.liabilities += results[y].liabilities; });
    $('valAccounts').textContent = formatCurrencyNumber(combined.accounts, false);
    $('valAssets').textContent = formatCurrency(Math.abs(combined.assets));
    $('valLiab').textContent = formatCurrency(Math.abs(combined.liabilities));
    $('cmtAccounts').textContent = state.lang==='ar' ? `Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: ${combined.accounts}` : `Total rows: ${combined.accounts}`;
    $('cmtAssets').textContent = state.lang==='ar' ? `Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø£ØµÙˆÙ„` : `Estimated assets total`;
    $('cmtLiab').textContent = state.lang==='ar' ? `Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø®ØµÙˆÙ…` : `Estimated liabilities total`;

    // build compare table head
    const head = $('compareHead'); head.innerHTML = '';
    const baseTh = document.createElement('th'); baseTh.textContent = state.lang==='ar' ? 'Ø§Ù„Ù…Ù‚ÙŠØ§Ø³' : 'Metric'; head.appendChild(baseTh);
    state.selectedYears.forEach(y=>{
      const th = document.createElement('th'); th.textContent = y; head.appendChild(th);
    });
    if(state.selectedYears.length > 1){
      const thc = document.createElement('th'); thc.textContent = state.lang==='ar' ? 'Ø§Ù„ØªØºÙŠØ± (%)' : 'Change (%)'; head.appendChild(thc);
    }

    // rows to show: Revenue, Expense, Net Profit, Assets, Liabilities
    const metrics = [
      {key:'revenue', label: state.lang==='ar' ? 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' : 'Revenue'},
      {key:'expense', label: state.lang==='ar' ? 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' : 'Expenses'},
      {key:'netProfit', label: state.lang==='ar' ? 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­' : 'Net Profit'},
      {key:'assets', label: state.lang==='ar' ? 'Ø§Ù„Ø£ØµÙˆÙ„ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)' : 'Assets (approx)'},
      {key:'liabilities', label: state.lang==='ar' ? 'Ø§Ù„Ø®ØµÙˆÙ… (ØªÙ‚Ø±ÙŠØ¨ÙŠ)' : 'Liabilities (approx)'}
    ];

    // populate body
    const body = $('compareBody'); body.innerHTML = '';
    metrics.forEach(m=>{
      const tr = document.createElement('tr');
      const tdName = document.createElement('td'); tdName.textContent = m.label; tr.appendChild(tdName);
      const values = state.selectedYears.map(y => results[y][m.key] || 0);
      values.forEach(v => { const td = document.createElement('td'); td.textContent = (m.key==='assets' || m.key==='liabilities' || m.key==='revenue' || m.key==='expense' || m.key==='netProfit') ? formatCurrency(v) : formatCurrencyNumber(v,false); tr.appendChild(td); });
      if(state.selectedYears.length > 1){
        // compute percent change between last and first selected
        const first = values[0] || 0; const last = values[values.length-1] || 0;
        const pct = first === 0 ? (last === 0 ? 0 : 100) : ((last - first) / Math.abs(first) * 100);
        const tdCh = document.createElement('td'); tdCh.textContent = `${pct>=0?'+':''}${pct.toFixed(2)}%`; tdCh.style.color = pct>=0 ? '#18c16e' : '#ff5252'; tr.appendChild(tdCh);
      }
      body.appendChild(tr);
    });

    // comment generation: dynamic multi-line comment
    const cmpComment = generateComparisonComment(results);
    $('compareComment').textContent = cmpComment;

    // chart: show revenue and expense per year
    const labels = state.selectedYears.slice();
    const revenueData = labels.map(y => results[y].revenue || 0);
    const expenseData = labels.map(y => results[y].expense || 0);
    const netData = labels.map(y => results[y].netProfit || 0);

    renderMainChart(labels, revenueData, expenseData, netData);
    $('chartComment').textContent = t('chartCommentPrefix') + ' â€” ' + (state.lang==='ar' ? 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø¹Ø¨Ø± Ø§Ù„Ø³Ù†ÙˆØ§Øª.' : 'Revenue vs Expense vs Net Profit across selected years.');
  }

  function clearResults(){
    $('valAccounts').textContent = '0';
    $('valAssets').textContent = formatCurrency(0);
    $('valLiab').textContent = formatCurrency(0);
    $('compareHead').innerHTML = '';
    $('compareBody').innerHTML = '';
    $('compareComment').textContent = t('noData');
    $('chartComment').textContent = 'â€”';
    if(mainChart) try{ mainChart.destroy(); }catch(e){}
  }

  /* ====== Comments / Analysis generation ====== */
  function generateComparisonComment(resultsObj){
    // resultsObj: {year: {revenue,expense,netProfit,assets,liabilities}}
    // build high-level statements
    const years = Object.keys(resultsObj);
    if(!years.length) return t('noData');
    // find best/worst by netProfit
    const items = years.map(y => ({year:y, net: resultsObj[y].netProfit || 0, rev: resultsObj[y].revenue || 0, exp: resultsObj[y].expense || 0}));
    items.sort((a,b) => b.net - a.net);
    const best = items[0], worst = items[items.length-1];
    const parts = [];
    if(best.net > 0) parts.push(state.lang==='ar' ? `Ø£ÙØ¶Ù„ Ø³Ù†Ø© Ù…Ù† Ø­ÙŠØ« ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${best.year} (ØµØ§ÙÙŠ ${formatCurrency(best.net)})` : `Best net profit year: ${best.year} (net ${formatCurrency(best.net)})`);
    if(worst.net < 0) parts.push(state.lang==='ar' ? `ØªØ­Ø°ÙŠØ±: Ø³Ù†Ø© Ø¨Ø®Ø³Ø§Ø±Ø© ØµØ§ÙÙŠØ©: ${worst.year} (ØµØ§ÙÙŠ ${formatCurrency(worst.net)})` : `Alert: year with net loss: ${worst.year} (net ${formatCurrency(worst.net)})`);
    // revenue vs expense trend
    const totalRev = items.reduce((s,i)=>s+i.rev,0), totalExp = items.reduce((s,i)=>s+i.exp,0);
    if(totalRev > totalExp) parts.push(state.lang==='ar' ? `Ø¹Ù…ÙˆÙ…Ø§Ù‹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª â€” Ù…Ø¤Ø´Ø± Ø¥ÙŠØ¬Ø§Ø¨ÙŠ.` : `Overall revenues exceed expenses â€” positive sign.`);
    else parts.push(state.lang==='ar' ? `Ø¹Ù…ÙˆÙ…Ø§Ù‹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ØªÙÙˆÙ‚ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªÙƒÙ„ÙØ©.` : `Overall expenses exceed revenues â€” review costs.`);
    return parts.join(' â€¢ ');
  }

  /* ====== Charting ====== */
  function renderMainChart(labels, revenueData, expenseData, netData){
    const ctx = $('mainChart').getContext('2d');
    if(mainChart) try{ mainChart.destroy(); }catch(e){}
    mainChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { type:'bar', label: state.lang==='ar' ? 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' : 'Revenue', data: revenueData, backgroundColor: 'rgba(14,165,233,0.7)' },
          { type:'bar', label: state.lang==='ar' ? 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' : 'Expenses', data: expenseData, backgroundColor: 'rgba(255,193,7,0.75)' },
          { type:'line', label: state.lang==='ar' ? 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­' : 'Net Profit', data: netData, borderColor: 'rgba(112,15,170,0.95)', tension:0.3, yAxisID:'y' }
        ]
      },
      options: {
        responsive:true,
        interaction: { mode:'index', intersect:false },
        scales: { y: { beginAtZero:true } },
        plugins:{ legend:{ position: 'bottom' } }
      }
    });
  }

  /* ====== Exports ====== */
  function exportPdf(){
    const el = document.querySelector('main');
    const oldTheme = document.body.getAttribute('data-theme');
    // temporarily set light for better print
    document.body.setAttribute('data-theme','light');
    const opt = {
      margin:0.35, filename: 'comparison_report.pdf',
      image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'}
    };
    html2pdf().set(opt).from(el).save().finally(()=> { document.body.setAttribute('data-theme', oldTheme || 'dark'); });
  }

  function exportXlsx(){
    // Build sheet with table data
    const wb = XLSX.utils.book_new();
    const wsData = [];
    // header
    const headerRow = ['Metric'].concat(state.selectedYears);
    if(state.selectedYears.length > 1) headerRow.push('Change (%)');
    wsData.push(headerRow);
    // extract table rows
    const rows = document.querySelectorAll('#compareBody tr');
    rows.forEach(tr=>{
      const row = Array.from(tr.querySelectorAll('td')).map(td => td.textContent);
      wsData.push(row);
    });
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, 'Comparison');
    XLSX.writeFile(wb, 'comparison.xlsx');
  }

  /* ====== Utils for formatting ====== */
  function formatCurrency(v){
    const c = state.currency || 'EGP';
    if(typeof v !== 'number') v = Number(v) || 0;
    const num = Number(Math.round((v + Number.EPSILON) * 100)/100).toLocaleString();
    if(c === 'EGP') return `${num} Ø¬.Ù…`;
    if(c === 'USD') return `$ ${num}`;
    if(c === 'EUR') return `â‚¬ ${num}`;
    return `${num} ${c}`;
  }
  function formatCurrencyNumber(v, withSymbol=true){
    if(typeof v !== 'number') v = Number(v) || 0;
    if(!withSymbol) return v.toLocaleString();
    return formatCurrency(v);
  }

  /* ====== UI refresh ====== */
  function refreshUI(){
    // reload source (if chosen)
    if(state.sourceKey) loadSource();
    else { populateYearsList(); clearResults(); }
  }

  // INITIALIZE on load
  (function(){
    // apply saved states if any
    state.lang = localStorage.getItem('cmp_lang') || state.lang;
    state.theme = localStorage.getItem('cmp_theme') || state.theme;
    state.currency = localStorage.getItem('cmp_currency') || state.currency;
    state.sourceKey = localStorage.getItem('cmp_source') || state.sourceKey;
    init();
    if(state.sourceKey) loadSource();
  })();

  </script>
</body>
</html>
