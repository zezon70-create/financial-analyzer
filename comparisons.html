<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>ğŸ“Š Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h1>
    <nav>
      <a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="input.html">Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</a>
      <a href="reports.html">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
      <a href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
      <a href="advanced.html">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</a>
      <a href="comparisons.html" class="active">Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª</a>
      <a href="settings.html">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    </nav>
  </header>

  <main>
    <section class="upload-section">
      <h2>Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</h2>
      <div class="file-inputs">
        <label>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„:
          <input type="file" id="fileInput1" accept=".csv" />
        </label>
        <label>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø«Ø§Ù†ÙŠ:
          <input type="file" id="fileInput2" accept=".csv" />
        </label>
      </div>
      <button id="compareBtn">Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</button>
    </section>

    <section id="comparisonResults" class="results-section">
      <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</h2>
      <div id="comparisonTables">
        <!-- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù‡ØªØªÙˆÙ„Ø¯ Ù‡Ù†Ø§ -->
      </div>
      <canvas id="comparisonChart" width="600" height="300"></canvas>
    </section>

    <section class="export-section">
      <button id="exportComparisonPdf">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
      <button id="exportComparisonExcel">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
    </section>
  </main>

  <footer>
    <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025</p>
  </footer>

  <script>
    let trial1 = [];
    let trial2 = [];
    let comparisonData = {};

    document.getElementById("compareBtn").addEventListener("click", () => {
      const file1 = document.getElementById("fileInput1").files[0];
      const file2 = document.getElementById("fileInput2").files[0];
      if (!file1 || !file2) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„ÙÙŠÙ† Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©");
        return;
      }

      Papa.parse(file1, {
        header: true,
        complete: function (results1) {
          trial1 = results1.data;
          Papa.parse(file2, {
            header: true,
            complete: function (results2) {
              trial2 = results2.data;
              generateComparison();
            },
          });
        },
      });
    });

    function generateComparison() {
      // Ù†Ø­Ø³Ø¨ Ù†ÙØ³ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù„ÙƒÙ„Ø§ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† main.js
      const income1 = generateIncomeStatement(trial1);
      const income2 = generateIncomeStatement(trial2);
      const balance1 = generateBalanceSheet(trial1);
      const balance2 = generateBalanceSheet(trial2);

      comparisonData = { income1, income2, balance1, balance2 };
      renderComparison(comparisonData);
    }

    function sumAccounts(data, keywords) {
      return data
        .filter((row) => keywords.some((kw) => row["Ø§Ù„Ø­Ø³Ø§Ø¨"]?.includes(kw)))
        .reduce((sum, row) => sum + parseFloat(row["Ø§Ù„Ù‚ÙŠÙ…Ø©"] || 0), 0);
    }

    function generateIncomeStatement(data) {
      let sales = sumAccounts(data, ["Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", "Ù…Ø¨ÙŠØ¹Ø§Øª"]);
      let cogs = sumAccounts(data, ["ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª"]);
      let operatingExp = sumAccounts(data, ["Ù…ØµØ§Ø±ÙŠÙ Ø¹Ù…ÙˆÙ…ÙŠØ©", "Ù…ØµØ§Ø±ÙŠÙ ØªØ´ØºÙŠÙ„ÙŠØ©"]);
      let otherRev = sumAccounts(data, ["Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰"]);
      let otherExp = sumAccounts(data, ["Ù…ØµØ§Ø±ÙŠÙ Ø£Ø®Ø±Ù‰"]);
      let tax = sumAccounts(data, ["Ø¶Ø±ÙŠØ¨Ø©"]);

      let grossProfit = sales - cogs;
      let operatingProfit = grossProfit - operatingExp;
      let netBeforeTax = operatingProfit + otherRev - otherExp;
      let netAfterTax = netBeforeTax - tax;

      return {
        sales,
        cogs,
        grossProfit,
        operatingExp,
        operatingProfit,
        otherRev,
        otherExp,
        netBeforeTax,
        tax,
        netAfterTax,
      };
    }

    function generateBalanceSheet(data) {
      let currentAssets = sumAccounts(data, ["Ù†Ù‚Ø¯ÙŠØ©", "Ø¨Ù†Ùƒ", "Ù…Ø¯ÙŠÙ†ÙˆÙ†", "Ù…Ø®Ø²ÙˆÙ†"]);
      let nonCurrentAssets = sumAccounts(data, ["Ø£ØµÙˆÙ„ Ø«Ø§Ø¨ØªØ©", "Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª"]);
      let currentLiabilities = sumAccounts(data, ["Ø¯Ø§Ø¦Ù†ÙˆÙ†", "Ù…ÙˆØ±Ø¯ÙˆÙ†", "Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù‚ØµÙŠØ±Ø©"]);
      let nonCurrentLiabilities = sumAccounts(data, ["Ù‚Ø±ÙˆØ¶ Ø·ÙˆÙŠÙ„Ø©"]);
      let equity = sumAccounts(data, ["Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„", "Ø£Ø±Ø¨Ø§Ø­ Ù…Ø­ØªØ¬Ø²Ø©"]);

      let totalAssets = currentAssets + nonCurrentAssets;
      let totalLiabilities = currentLiabilities + nonCurrentLiabilities;
      let totalEquity = equity;

      return {
        currentAssets,
        nonCurrentAssets,
        totalAssets,
        currentLiabilities,
        nonCurrentLiabilities,
        totalLiabilities,
        equity: totalEquity,
      };
    }

    function renderComparison(data) {
      const container = document.getElementById("comparisonTables");
      container.innerHTML = `
        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</h3>
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø¨Ù†Ø¯</th>
              <th>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„</th>
              <th>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
              <th>Ø§Ù„ÙØ±Ù‚</th>
            </tr>
          </thead>
          <tbody>
            ${Object.keys(data.income1).map(key => `
              <tr>
                <td>${key}</td>
                <td>${data.income1[key]}</td>
                <td>${data.income2[key]}</td>
                <td>${data.income2[key] - data.income1[key]}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>

        <h3>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</h3>
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø¨Ù†Ø¯</th>
              <th>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„</th>
              <th>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
              <th>Ø§Ù„ÙØ±Ù‚</th>
            </tr>
          </thead>
          <tbody>
            ${Object.keys(data.balance1).map(key => `
              <tr>
                <td>${key}</td>
                <td>${data.balance1[key]}</td>
                <td>${data.balance2[key]}</td>
                <td>${data.balance2[key] - data.balance1[key]}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      const ctx = document.getElementById("comparisonChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", "Ù…Ø¬Ù…Ù„ Ø§Ù„Ø±Ø¨Ø­", "ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"],
          datasets: [
            {
              label: "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„",
              data: [
                data.income1.sales,
                data.income1.grossProfit,
                data.income1.netAfterTax
              ],
              backgroundColor: "rgba(54, 162, 235, 0.6)"
            },
            {
              label: "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø«Ø§Ù†ÙŠ",
              data: [
                data.income2.sales,
                data.income2.grossProfit,
                data.income2.netAfterTax
              ],
              backgroundColor: "rgba(255, 99, 132, 0.6)"
            }
          ]
        }
      });
    }

    document.getElementById("exportComparisonPdf").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©", 10, 10);
      Object.entries(comparisonData.income1).forEach(([k, v], i) => {
        doc.text(`${k}: ${v} vs ${comparisonData.income2[k]}`, 10, 20 + i * 10);
      });
      doc.save("comparison.pdf");
    });

    document.getElementById("exportComparisonExcel").addEventListener("click", () => {
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(
        wb,
        XLSX.utils.json_to_sheet([comparisonData.income1, comparisonData.income2]),
        "Income Comparison"
      );
      XLSX.utils.book_append_sheet(
        wb,
        XLSX.utils.json_to_sheet([comparisonData.balance1, comparisonData.balance2]),
        "Balance Comparison"
      );
      XLSX.writeFile(wb, "comparison.xlsx");
    });
  </script>
  <script src="js/main-fixes.js"></script>
</body>
</html>
