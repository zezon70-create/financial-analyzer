<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advanced Analytics â€” Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ (Ultra Pro Max)</title>

  <!-- Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --g1: #0d6efd; --g2:#7b61ff; --glass: rgba(255,255,255,0.55);
      --bg: #f4f7fb; --card: #ffffff; --text:#07101a; --muted:#6c757d;
      --radius:14px;
    }
    body{font-family:"Cairo",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto, "Helvetica Neue",Arial; margin:0; background:linear-gradient(180deg,#f6f9ff,#eef4ff); color:var(--text); -webkit-font-smoothing:antialiased;}
    body[data-theme="dark"]{ --bg:#071018; --card:#08131a; --text:#e7f1f9; --muted:#9aa6b2; background:linear-gradient(180deg,#04101a,#071620); }

    .container-main{max-width:1200px;margin:22px auto;padding:18px}
    .site-header{position:sticky;top:0;z-index:1200;padding:10px 18px;background:linear-gradient(90deg,var(--g1),var(--g2));color:#fff;border-radius:10px;box-shadow:0 8px 40px rgba(11,20,40,0.08);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{height:44px;border-radius:8px;background:rgba(255,255,255,0.08);padding:6px}
    .controls{display:flex;gap:.5rem;align-items:center}

    .card-surface{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 12px 30px rgba(2,6,23,0.04);border:1px solid rgba(255,255,255,0.06);margin-bottom:14px}
    body[data-theme="dark"] .card-surface{background:linear-gradient(180deg,#07131a,#061220); box-shadow:0 10px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03)}

    .kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin:12px 0}
    .kpi{padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(13,110,253,0.06), rgba(123,97,255,0.04));text-align:center}
    .kpi .num{font-weight:800;font-size:1.05rem}
    .kpi .label{font-size:.85rem;color:var(--muted)}

    /* table */
    .table thead th{background:transparent;border-bottom:1px solid rgba(0,0,0,0.06)}
    .analysis-grid{display:grid;grid-template-columns:1fr 420px;gap:14px;align-items:start}
    @media (max-width:1000px){ .analysis-grid{grid-template-columns:1fr} .controls{flex-wrap:wrap} .site-header{flex-direction:column;align-items:flex-start} }

    /* small helpers */
    .muted{color:var(--muted)} .btn-glow{background:linear-gradient(90deg,var(--g1),var(--g2));border:none;color:#fff}
    .toast-area{position:fixed;top:22px;left:50%;transform:translateX(-50%);z-index:2000;pointer-events:none}
    .analysis-comment{padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(13,110,253,0.03),rgba(123,97,255,0.02));min-height:72px}
    /* responsive chart container */
    .chart-wrap{height:240px}
  </style>
</head>
<body data-theme="light">
  <div class="toast-area" id="toastArea" aria-live="polite"></div>

  <header class="site-header">
    <div class="brand" title="Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ">
      <img src="assets/logo.png" alt="logo" id="brandLogo" onerror="this.style.display='none'">
      <div>
        <div style="font-weight:800;font-size:16px" id="brandTitle">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ â€” Advanced</div>
        <div style="font-size:12px;opacity:.9" id="brandSub">Ultra Pro Max â€” ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</div>
      </div>
    </div>

    <div class="controls" role="navigation" aria-label="controls">
      <a class="btn btn-sm btn-outline-light" href="index.html" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"><i class="bi bi-house"></i></a>

      <select id="langSelect" class="form-select form-select-sm" title="Ø§Ù„Ù„ØºØ©" style="min-width:110px"></select>
      <select id="currencySelect" class="form-select form-select-sm" title="Ø§Ù„Ø¹Ù…Ù„Ø©" style="min-width:110px"></select>
      <div class="form-check form-switch mb-0" title="Ø§Ù„ÙˆØ¶Ø¹" style="margin-left:6px">
        <input class="form-check-input" id="darkModeToggle" type="checkbox" role="switch">
      </div>

      <button id="btnReport" class="btn btn-sm btn-outline-light ms-2" title="Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØªÙ‚Ø±ÙŠØ±"><i class="bi bi-file-earmark-text"></i> <span id="txtReport">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span></button>
      <button id="btnUpload" class="btn btn-sm btn-outline-light ms-1" title="ÙØªØ­ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"><i class="bi bi-cloud-upload"></i> <span id="txtUpload">Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span></button>

      <button id="exportPdf" class="btn btn-sm btn-glow ms-2" title="ØªØµØ¯ÙŠØ± PDF"><i class="bi bi-file-earmark-pdf"></i> <span id="txtExport">ØªØµØ¯ÙŠØ± PDF</span></button>
    </div>
  </header>

  <main class="container-main" id="mainArea">
    <!-- header controls -->
    <section class="card-surface">
      <div class="d-flex gap-3 align-items-center justify-content-between" style="flex-wrap:wrap">
        <div>
          <h4 id="pageTitle" style="margin:0">ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© â€” Advanced Analytics</h4>
          <div class="muted" id="pageDesc">Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø¹Ù…Ù„Ø© â€” Ø³ØªØ±Ù‰ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±ÙŠØ© Ù„ÙƒÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª.</div>
        </div>

        <div class="d-flex gap-2 align-items-center">
          <label class="small-muted mb-0 me-2" id="labelSource">Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
          <select id="dataSource" class="form-select form-select-sm" aria-label="Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" style="min-width:220px">
            <option value="auto">Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠ â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ØªÙˆÙØ± (trialData / inputData / uploadData)</option>
            <option value="trialData">Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (trialData)</option>
            <option value="inputData">Ù…Ù† input (inputData)</option>
            <option value="uploadData">Ù…Ù† upload (uploadData)</option>
          </select>
        </div>
      </div>
    </section>

    <!-- KPI row -->
    <section id="kpiSection" class="mt-3" aria-live="polite">
      <div class="kpi-row" id="kpiRow"></div>
    </section>

    <!-- Main analysis grid -->
    <section class="analysis-grid">
      <div>
        <!-- Financial ratios -->
        <div class="card-surface mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 id="ratiosTitle">Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h6>
            <div class="muted" id="ratiosHint">ØªØ­Ø³Ø¨ Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¯Ø§Ø®Ù„ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
          </div>

          <div id="ratiosTableWrap" class="table-responsive">
            <table class="table table-sm table-striped">
              <thead><tr><th id="colRatio">Ø§Ù„Ù†Ø³Ø¨Ø©</th><th id="colValue">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th id="colComment">ØªØ­Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹</th></tr></thead>
              <tbody id="ratiosBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Trend & Forecast -->
        <div class="card-surface mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 id="trendTitle">Ø§ØªØ¬Ø§Ù‡Ø§Øª ÙˆØªÙˆÙ‚Ø¹Ø§Øª</h6>
            <div class="muted" id="trendHint">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆÙ‚Ø¹ (Ù†Ù…Ùˆ Ù…ØªÙˆØ³Ø· / Ø§Ù†Ø­Ø¯Ø§Ø± Ø®Ø·ÙŠ)</div>
          </div>

          <div class="row g-2">
            <div class="col-md-8">
              <div class="chart-wrap card-surface" id="trendChartWrap">
                <canvas id="trendChart"></canvas>
              </div>
            </div>
            <div class="col-md-4">
              <label class="small-muted">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ†Ø¨Ø¤</label>
              <select id="forecastMethod" class="form-select form-select-sm mb-2">
                <option value="avg">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ù…Ùˆ (%)</option>
                <option value="linear">Ø§Ù†Ø­Ø¯Ø§Ø± Ø®Ø·ÙŠ Ø¨Ø³ÙŠØ·</option>
              </select>
              <label class="small-muted">Ø³Ù†ÙˆØ§Øª Ù„Ù„ØªÙ†Ø¨Ø¤</label>
              <input id="forecastYears" class="form-control form-control-sm mb-2" type="number" min="1" value="3" />
              <div class="analysis-comment" id="forecastComment"></div>
            </div>
          </div>
        </div>

        <!-- Advanced indicators -->
        <div class="card-surface mb-3">
          <h6 id="advTitle">Ù…Ø¤Ø´Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© â€” Ø¹Ø§Ø¦Ø¯ ÙˆÙ…Ø®Ø§Ø·Ø±Ø©</h6>
          <div class="small-muted mb-2" id="advHint">Ø­Ø³Ø§Ø¨ Sharpe, Debt ratios, ÙˆÙ…Ù„Ø®Øµ Ù…Ø®Ø§Ø·Ø± Ø£Ø³Ø§Ø³ÙŠ</div>
          <div id="advBody"></div>
        </div>

        <!-- Raw data viewer -->
        <div class="card-surface mb-3">
          <div class="d-flex justify-content-between">
            <h6 id="dataTitle">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Raw)</h6>
            <div class="muted" id="dataHint">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù…ØµØ¯Ø± Ø¢Ø®Ø±</div>
          </div>
          <div class="table-responsive" style="max-height:260px;overflow:auto">
            <table class="table table-sm">
              <thead><tr><th id="hdrAccount">Ø§Ù„Ø­Ø³Ø§Ø¨</th><th id="hdrType">Ø§Ù„Ù†ÙˆØ¹</th><th id="hdrCode">ÙƒÙˆØ¯</th><th id="hdrDebit">Ù…Ø¯ÙŠÙ†</th><th id="hdrCredit">Ø¯Ø§Ø¦Ù†</th></tr></thead>
              <tbody id="rawBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- right column: comments + charts -->
      <aside>
        <div class="card-surface mb-3">
          <h6 id="summaryTitle">Ù…ÙÙ„Ø®Øµ Ø°ÙƒÙŠ</h6>
          <div id="smartSummary" class="analysis-comment">â€”</div>
        </div>

        <div class="card-surface mb-3">
          <h6 id="chartTitle">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</h6>
          <div class="chart-wrap"><canvas id="categoryChart"></canvas></div>
        </div>

        <div class="card-surface mb-3">
          <h6 id="alertsTitle">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª</h6>
          <div id="alertsArea" class="small-muted"></div>
        </div>

        <div class="card-surface mb-3">
          <h6 id="actionsTitle">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h6>
          <div class="d-grid gap-2">
            <button id="btnAddRowLocal" class="btn btn-glow btn-sm">â• Ø¥Ø¶Ø§ÙØ© ØµÙ Ù…Ø­Ù„ÙŠ</button>
            <button id="btnSaveLocal" class="btn btn-outline-primary btn-sm">ğŸ’¾ Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ</button>
            <button id="btnReload" class="btn btn-outline-secondary btn-sm">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±</button>
            <button id="btnAdvancedPage" class="btn btn-outline-success btn-sm">ğŸ”¬ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Advanced)</button>
          </div>
        </div>
      </aside>
    </section>

    <footer class="text-center small muted mt-3">&copy; 2025 Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ â€” Ultra Pro Max</footer>
  </main>

<script>
/* =========================
   TRANSLATIONS (full)
   ========================= */
const TRANSLATIONS = {
  ar: {
    brandTitle: "Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ â€” Advanced",
    brandSub: "Ultra Pro Max â€” ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©",
    pageTitle: "ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© â€” Advanced Analytics",
    pageDesc: "Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø¹Ù…Ù„Ø© â€” Ø³ØªØ±Ù‰ ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±ÙŠØ© Ù„ÙƒÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª.",
    labelSource: "Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
    txtReport: "Ø§Ù„ØªÙ‚Ø±ÙŠØ±",
    txtUpload: "Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
    txtExport: "ØªØµØ¯ÙŠØ± PDF",
    ratiosTitle: "Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©",
    ratiosHint: "ØªØ­Ø³Ø¨ Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¯Ø§Ø®Ù„ Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
    trendTitle: "Ø§ØªØ¬Ø§Ù‡Ø§Øª ÙˆØªÙˆÙ‚Ø¹Ø§Øª",
    trendHint: "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆÙ‚Ø¹ (Ù†Ù…Ùˆ Ù…ØªÙˆØ³Ø· / Ø§Ù†Ø­Ø¯Ø§Ø± Ø®Ø·ÙŠ)",
    advTitle: "Ù…Ø¤Ø´Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© â€” Ø¹Ø§Ø¦Ø¯ ÙˆÙ…Ø®Ø§Ø·Ø±Ø©",
    advHint: "Ø­Ø³Ø§Ø¨ Sharpe, Debt ratios, ÙˆÙ…Ù„Ø®Øµ Ù…Ø®Ø§Ø·Ø± Ø£Ø³Ø§Ø³ÙŠ",
    dataTitle: "Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Raw)",
    dataHint: "ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù…ØµØ¯Ø± Ø¢Ø®Ø±",
    hdrAccount: "Ø§Ù„Ø­Ø³Ø§Ø¨", hdrType: "Ø§Ù„Ù†ÙˆØ¹", hdrCode: "ÙƒÙˆØ¯", hdrDebit: "Ù…Ø¯ÙŠÙ†", hdrCredit: "Ø¯Ø§Ø¦Ù†",
    summaryTitle: "Ù…ÙÙ„Ø®Øµ Ø°ÙƒÙŠ",
    chartTitle: "ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª",
    alertsTitle: "ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª",
    actionsTitle: "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©",
    btnAddRow: "â• Ø¥Ø¶Ø§ÙØ© ØµÙ Ù…Ø­Ù„ÙŠ",
    btnSaveLocal: "ğŸ’¾ Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ",
    btnReload: "ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„",
    noData: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯.",
    exportSuccess: "ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ PDF.",
    savedLocal: "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§.",
    rowAdded: "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ (Ù…Ø­Ù„ÙŠ)."
  },
  en: {
    brandTitle: "Financial Analyzer â€” Advanced",
    brandSub: "Ultra Pro Max â€” Advanced Analytics",
    pageTitle: "Advanced Analytics",
    pageDesc: "Choose data source, language & currency â€” all analyses update live.",
    labelSource: "Data Source",
    txtReport: "Report",
    txtUpload: "Upload Data",
    txtExport: "Export PDF",
    ratiosTitle: "Key Financial Ratios",
    ratiosHint: "Calculated from trial balance categories",
    trendTitle: "Trends & Forecasts",
    trendHint: "Pick forecast method (avg growth / linear)",
    advTitle: "Advanced Indicators â€” Return & Risk",
    advHint: "Calculates Sharpe, Debt ratios and basic risk summary",
    dataTitle: "Raw Data Preview",
    dataHint: "Edit values locally or reload from another source",
    hdrAccount: "Account", hdrType: "Type", hdrCode: "Code", hdrDebit: "Debit", hdrCredit: "Credit",
    summaryTitle: "Smart Summary",
    chartTitle: "Category Distribution",
    alertsTitle: "Alerts & Notes",
    actionsTitle: "Quick Actions",
    btnAddRow: "â• Add Local Row",
    btnSaveLocal: "ğŸ’¾ Save Locally",
    btnReload: "ğŸ”„ Reload",
    noData: "No data available from selected source.",
    exportSuccess: "Exported report as PDF.",
    savedLocal: "Saved locally.",
    rowAdded: "New row added (local)."
  }
};

let LANG = localStorage.getItem('fa_lang') || 'ar';
const LANGS = [{v:'ar',name:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'},{v:'en',name:'English'}];
const CURRENCIES = ['EGP','USD','EUR'];
let currency = localStorage.getItem('fa_currency') || 'EGP';

/* =========================
   Helpers
   ========================= */
const $ = id => document.getElementById(id);
function t(key){ return (TRANSLATIONS[LANG] && TRANSLATIONS[LANG][key]) ? TRANSLATIONS[LANG][key] : key; }
function showToast(msg, type='info'){ const area = $('toastArea'); const el = document.createElement('div'); el.className = `toast align-items-center text-bg-${type} border-0 show`; el.style.minWidth='220px'; el.style.marginTop='6px'; el.style.pointerEvents='auto'; el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Ø§ØºÙ„Ø§Ù‚" onclick="this.closest('.toast').remove()"></button></div>`; area.appendChild(el); setTimeout(()=> el.remove(), 3800); }

/* safe numeric */
const toNum = v => { const n = Number(String(v||'').toString().replace(/[^\d.-]+/g,'')); return isNaN(n) ? 0 : n; };

/* =========================
   UI Init
   ========================= */
function populateControls(){
  const sel = $('langSelect'); sel.innerHTML=''; LANGS.forEach(l=>{ const o=document.createElement('option'); o.value=l.v; o.textContent=l.name; sel.appendChild(o); });
  $('langSelect').value = LANG;
  const cs = $('currencySelect'); cs.innerHTML=''; CURRENCIES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; cs.appendChild(o); }); $('currencySelect').value = currency;
  applyTranslations();
}
function applyTranslations(){
  // header
  $('brandTitle').textContent = t('brandTitle');
  $('brandSub').textContent = t('brandSub');
  $('pageTitle').textContent = t('pageTitle');
  $('pageDesc').textContent = t('pageDesc');
  $('labelSource').textContent = t('labelSource');
  $('txtReport').textContent = t('txtReport');
  $('txtUpload').textContent = t('txtUpload');
  $('txtExport').textContent = t('txtExport');

  // sections
  $('ratiosTitle').textContent = t('ratiosTitle');
  $('ratiosHint').textContent = t('ratiosHint');
  $('trendTitle').textContent = t('trendTitle');
  $('trendHint').textContent = t('trendHint');
  $('advTitle').textContent = t('advTitle');
  $('advHint').textContent = t('advHint');
  $('dataTitle').textContent = t('dataTitle');
  $('dataHint').textContent = t('dataHint');
  $('hdrAccount').textContent = t('hdrAccount');
  $('hdrType').textContent = t('hdrType');
  $('hdrCode').textContent = t('hdrCode');
  $('hdrDebit').textContent = t('hdrDebit');
  $('hdrCredit').textContent = t('hdrCredit');
  $('summaryTitle').textContent = t('summaryTitle');
  $('chartTitle').textContent = t('chartTitle');
  $('alertsTitle').textContent = t('alertsTitle');
  $('actionsTitle').textContent = t('actionsTitle');

  $('btnAddRowLocal').textContent = t('btnAddRow');
  $('btnSaveLocal').textContent = t('btnSaveLocal');
  $('btnReload').textContent = t('btnReload');
}
populateControls();

/* dark mode */
$('darkModeToggle').addEventListener('change', e => {
  document.body.dataset.theme = e.target.checked ? 'dark' : 'light';
  localStorage.setItem('fa_theme', document.body.dataset.theme);
});

/* language change */
$('langSelect').addEventListener('change', (e)=>{ LANG = e.target.value; localStorage.setItem('fa_lang', LANG); applyTranslations(); renderAll(); });

/* currency change */
$('currencySelect').addEventListener('change', e => { currency = e.target.value; localStorage.setItem('fa_currency', currency); renderAll(); });

/* go to report / upload */
$('btnReport').addEventListener('click', ()=> { window.location.href = 'report.html'; });
$('btnUpload').addEventListener('click', ()=> { window.location.href = 'upload.html'; });

/* export pdf */
$('exportPdf').addEventListener('click', ()=> {
  const opt = { margin:0.4, filename:'advanced_report.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'in', format:'a4', orientation:'portrait'} };
  const el = document.querySelector('main');
  html2pdf().set(opt).from(el).save().then(()=> showToast(t('exportSuccess'),'success'));
});

/* quick actions */
$('btnAddRowLocal').addEventListener('click', ()=> {
  // add an empty row to trialData local copy and save to localStorage trialData
  trialData.push({Account:'',Type:'',Code:'',Debit:0,Credit:0});
  localStorage.setItem('trialData', JSON.stringify(trialData));
  renderAll();
  showToast(t('rowAdded'),'success');
});
$('btnSaveLocal').addEventListener('click', ()=> {
  localStorage.setItem('trialData', JSON.stringify(trialData));
  showToast(t('savedLocal'),'success');
});
$('btnReload').addEventListener('click', ()=> { loadData(); renderAll(); showToast(t('savedLocal'),'info'); });

/* =========================
   Data loading (from localStorage keys)
   ========================= */
let trialData = []; // array of rows {Account,Type,Code,Debit,Credit}

function loadData(){
  const mode = $('dataSource').value || 'auto';
  const keysTry = (mode === 'trialData') ? ['trialData'] : (mode === 'inputData') ? ['inputData'] : (mode === 'uploadData') ? ['uploadData'] : ['trialData','inputData','uploadData'];
  let loaded = null;
  for(const k of keysTry){
    try{
      const raw = localStorage.getItem(k);
      if(raw){
        const arr = JSON.parse(raw);
        if(Array.isArray(arr) && arr.length){
          loaded = arr;
          break;
        }
      }
    }catch(e){ console.warn('parse fail',k); }
  }
  if(!loaded) {
    trialData = JSON.parse(localStorage.getItem('trialData')||'[]') || [];
  } else trialData = loaded.map(r => ({ Account: r.Account||r.account||'', Type: r.Type||r.type||'', Code: r.Code||r.code||'', Debit: toNum(r.Debit), Credit: toNum(r.Credit) }));
}
$('dataSource').addEventListener('change', ()=> { loadData(); renderAll(); });

/* =========================
   Aggregation helpers: compute category sums (assets, liabilities, equity, revenue, expense, other)
   Uses heuristics based on Account/Type strings
   ========================= */
function aggregateByCategory(data){
  const agg = { assets:0, liabilities:0, equity:0, revenue:0, expense:0, other:0 };
  data.forEach(r=>{
    const net = toNum(r.Debit) - toNum(r.Credit);
    const s = (r.Type || r.Account || '').toString().toLowerCase();
    if(/asset|Ø£ØµÙ„|cash|bank|current asset|Ù†Ù‚Ø¯|bank/i.test(s)) agg.assets += net;
    else if(/liab|Ø®ØµÙˆÙ…|payable|loan|Ø¯Ø§Ø¦Ù†|Ù‚Ø±Ø¶/i.test(s)) agg.liabilities += (-net);
    else if(/equity|Ø­Ù‚ÙˆÙ‚|Ø±Ø£Ø³/i.test(s)) agg.equity += (-net);
    else if(/revenue|sales|Ø¥ÙŠØ±Ø§Ø¯|Ù…Ø¨ÙŠØ¹Ø§Øª/i.test(s)) agg.revenue += (-net);
    else if(/expense|Ù…ØµØ±ÙˆÙ|cogs|ØªÙƒÙ„ÙØ©|Ù…ØµØ§Ø±ÙŠÙ/i.test(s)) agg.expense += net;
    else {
      const acc = (r.Account||'').toLowerCase();
      if(/Ø§Ù„Ù†Ù‚Ø¯|bank|cash|Ù†Ù‚Ø¯/.test(acc)) agg.assets += net;
      else if(/Ø§Ù„Ù…ÙˆØ±Ø¯|payable|Ø¯Ø§Ø¦Ù†/.test(acc)) agg.liabilities += (-net);
      else if(/Ø±Ø£Ø³|equity/.test(acc)) agg.equity += (-net);
      else if(/Ø¥ÙŠØ±Ø§Ø¯|sales/.test(acc)) agg.revenue += (-net);
      else if(/Ù…ØµØ±ÙˆÙ|expense|ØªÙƒÙ„ÙØ©/.test(acc)) agg.expense += net;
      else agg.other += net;
    }
  });
  return agg;
}

/* =========================
   Ratios & analysed comments
   ========================= */
function computeRatios(agg){
  // Basic sanity: avoid division by zero
  const curRatio = (agg.assets && agg.liabilities) ? (agg.assets / (agg.liabilities || 1)) : null;
  const debtToEquity = (agg.liabilities && agg.equity) ? (agg.liabilities / (agg.equity || 1)) : null;
  const netProfit = agg.revenue - agg.expense;
  const grossMargin = (agg.revenue) ? ((agg.revenue - agg.expense) / (agg.revenue || 1)) : null; // approximate
  const roa = (agg.assets) ? (netProfit / (agg.assets || 1)) : null;
  const roe = (agg.equity) ? (netProfit / (agg.equity || 1)) : null;
  const assetTurnover = (agg.assets) ? (agg.revenue / (agg.assets || 1)) : null;

  // interest coverage (approx): not available if no interest expense, skip
  // Return object
  return {
    currentRatio: curRatio,
    debtToEquity,
    netProfit,
    grossMargin,
    roa, roe, assetTurnover
  };
}

/* generate human-friendly comments depending on value */
function commentForRatio(key, val){
  const en = (LANG === 'en');
  function c(a,b){ return en ? a : b; }
  if(val === null || val === undefined || isNaN(val)) return c('Insufficient data to compute.','Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ø­Ø³Ø§Ø¨.');
  switch(key){
    case 'currentRatio':
      if(val >= 2) return c('Very healthy short-term liquidity â€” company can comfortably meet obligations.','Ø³ÙŠÙˆÙ„Ø© Ù‚ØµÙŠØ±Ø© Ø§Ù„Ø£Ù…Ø¯ Ù‚ÙˆÙŠØ© â€” Ø§Ù„Ø´Ø±ÙƒØ© Ù‚Ø§Ø¯Ø±Ø© Ø¹Ù„Ù‰ ØªØºØ·ÙŠØ© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©.');
      if(val >= 1.2) return c('Adequate liquidity; monitor working capital closely.','Ø³ÙŠÙˆÙ„Ø© ÙƒØ§ÙÙŠØ©Ø› Ø±Ø§Ù‚Ø¨ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø¹Ø§Ù…Ù„.');
      return c('Low current ratio â€” possible liquidity concerns, consider cash planning.','Ù†Ø³Ø¨Ø© Ø³ÙŠÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø© â€” Ù‚Ø¯ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§ÙˆÙ Ø³ÙŠÙˆÙ„Ø©Ø› Ø®Ø·Ø· Ù„Ù„Ù†Ù‚Ø¯.');
    case 'debtToEquity':
      if(val < 0.5) return c('Low leverage â€” conservative capital structure.', 'Ø±ÙØ¹ Ù…Ø§Ù„ÙŠ Ù…Ù†Ø®ÙØ¶ â€” Ù‡ÙŠÙƒÙ„ ØªÙ…ÙˆÙŠÙ„ Ù…Ø­Ø§ÙØ¸.');
      if(val < 2) return c('Moderate leverage â€” typical for many firms.', 'Ø±ÙØ¹ Ù…Ø§Ù„ÙŠ Ù…Ø¹ØªØ¯Ù„ â€” Ø£Ù…Ø± Ø´Ø§Ø¦Ø¹.');
      return c('High leverage â€” financial risk elevated; review debt costs.', 'Ø±ÙØ¹ Ù…Ø§Ù„ÙŠ Ù…Ø±ØªÙØ¹ â€” Ù…Ø®Ø§Ø·Ø± Ù…Ø§Ù„ÙŠØ©Ø› Ø±Ø§Ø¬Ø¹ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¯ÙŠÙˆÙ†.');
    case 'grossMargin':
      if(val >= 0.4) return c('Strong gross margin â€” good pricing or low cost of sales.', 'Ù‡Ø§Ù…Ø´ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¬ÙŠØ¯ â€” ØªØ³Ø¹ÙŠØ± Ù‚ÙˆÙŠ Ø£Ùˆ ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù†Ø®ÙØ¶Ø©.');
      if(val >= 0.2) return c('Acceptable gross margin; efficiency can be improved.', 'Ù‡Ø§Ù…Ø´ Ù…Ù‚Ø¨ÙˆÙ„Ø› ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒÙØ§Ø¡Ø©.');
      return c('Thin gross margin â€” pricing or costs need review.', 'Ù‡Ø§Ù…Ø´ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¶Ø¹ÙŠÙ â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø£Ùˆ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ.');
    case 'roa':
      if(val >= 0.1) return c('ROA healthy â€” assets generate good returns.', 'Ø¹Ø§Ø¦Ø¯ Ù…Ù…ØªÙ„ÙƒØ§Øª Ø¬ÙŠØ¯ â€” Ø§Ù„Ø£ØµÙˆÙ„ ØªÙ†ØªØ¬ Ø¹ÙˆØ§Ø¦Ø¯ Ø¬ÙŠØ¯Ø©.');
      if(val >= 0.03) return c('ROA moderate â€” room for operational improvement.', 'Ø¹Ø§Ø¦Ø¯ Ù…Ù…ØªÙ„ÙƒØ§Øª Ù…ØªÙˆØ³Ø· â€” Ù…Ø¬Ø§Ù„ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.');
      return c('Low ROA â€” assets underutilized or profitability weak.', 'Ø¹Ø§Ø¦Ø¯ Ù…Ù…ØªÙ„ÙƒØ§Øª Ù…Ù†Ø®ÙØ¶ â€” Ø§Ø³ØªØºÙ„Ø§Ù„ Ø§Ù„Ø£ØµÙˆÙ„ Ø¶Ø¹ÙŠÙ Ø£Ùˆ Ø§Ù„Ø±Ø¨Ø­ÙŠØ© Ø¶Ø¹ÙŠÙØ©.');
    case 'roe':
      if(val >= 0.15) return c('Strong ROE â€” shareholders seeing good returns.', 'Ø¹Ø§Ø¦Ø¯ Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ© Ù‚ÙˆÙŠ â€” Ø¹ÙˆØ§Ø¦Ø¯ Ø¬ÙŠØ¯Ø© Ù„Ù„Ù…Ø³Ø§Ù‡Ù…ÙŠÙ†.');
      if(val >= 0.07) return c('Acceptable ROE; target improvement via margin/turnover.', 'Ø¹Ø§Ø¦Ø¯ Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ© Ù…Ù‚Ø¨ÙˆÙ„Ø› Ø­Ø³Ù‘Ù† Ø§Ù„Ù‡Ø§Ù…Ø´/Ø§Ù„Ø¯ÙˆØ±Ø§Ù†.');
      return c('Low ROE â€” equity returns need improvement.', 'Ø¹Ø§Ø¦Ø¯ Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ© Ù…Ù†Ø®ÙØ¶ â€” ÙŠÙ„Ø²Ù… ØªØ­Ø³ÙŠÙ† Ø¹ÙˆØ§Ø¦Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù….');
    case 'assetTurnover':
      if(val >= 1) return c('High asset turnover â€” efficient asset use.', 'Ø¯ÙˆØ±Ø§Ù† Ø£ØµÙˆÙ„ Ø¹Ø§Ù„ÙŠ â€” Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙØ¹Ø§Ù„ Ù„Ù„Ø£ØµÙˆÙ„.');
      if(val >= 0.4) return c('Moderate turnover â€” potential to increase sales or streamline assets.', 'Ø¯ÙˆØ±Ø§Ù† Ù…Ø¹ØªØ¯Ù„ â€” Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø£Ùˆ ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø£ØµÙˆÙ„.');
      return c('Low turnover â€” assets may be idle or sales low.', 'Ø¯ÙˆØ±Ø§Ù† Ø£ØµÙˆÙ„ Ù…Ù†Ø®ÙØ¶ â€” Ø£ØµÙˆÙ„ Ø®Ø§Ù…Ù„Ø© Ø£Ùˆ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù†Ø®ÙØ¶Ø©.');
    default:
      return '';
  }
}

/* =========================
   Renderers: KPIs / tables / charts / comments
   ========================= */
let categoryChart = null, trendChart = null;

function formatCur(v){
  const n = Number(v || 0);
  const opts = { maximumFractionDigits:2, minimumFractionDigits:0 };
  if(currency === 'EGP') return n.toLocaleString(undefined,opts) + ' Ø¬.Ù…';
  if(currency === 'USD') return '$' + n.toLocaleString(undefined,opts);
  if(currency === 'EUR') return 'â‚¬' + n.toLocaleString(undefined,opts);
  return n.toLocaleString(undefined,opts);
}

function renderKPIs(agg){
  const k = $('kpiRow'); k.innerHTML='';
  const items = [
    {label: t('ratiosTitle'), value: Object.values(agg).reduce((s,v)=>s+Math.abs(v||0),0), isCur:true},
    {label: t('hdrAccount'), value: trialData.length, isCur:false},
    {label: t('advTitle'), value: formatCur(Math.abs(agg.revenue||0)), isCur:false},
  ];
  items.forEach(it=>{
    const d = document.createElement('div'); d.className='kpi';
    const val = it.isCur ? formatCur(it.value) : (typeof it.value === 'number' ? (it.value.toLocaleString()) : it.value);
    d.innerHTML = `<div class="label">${it.label}</div><div class="num">${val}</div>`;
    k.appendChild(d);
  });
}

function renderRawTable(){
  const body = $('rawBody'); body.innerHTML='';
  if(!trialData || !trialData.length){ body.innerHTML = `<tr><td colspan="5" class="muted">${t('noData')}</td></tr>`; return; }
  trialData.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input class="form-control form-control-sm" data-idx="${idx}" data-field="Account" value="${escapeHtml(r.Account)}"></td>
                    <td><input class="form-control form-control-sm" data-idx="${idx}" data-field="Type" value="${escapeHtml(r.Type)}"></td>
                    <td><input class="form-control form-control-sm" data-idx="${idx}" data-field="Code" value="${escapeHtml(r.Code)}"></td>
                    <td><input class="form-control form-control-sm text-end" data-idx="${idx}" data-field="Debit" value="${r.Debit}"></td>
                    <td><input class="form-control form-control-sm text-end" data-idx="${idx}" data-field="Credit" value="${r.Credit}"></td>`;
    body.appendChild(tr);
  });
  // attach handlers to inputs to update trialData
  body.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const idx = Number(e.target.dataset.idx); const field = e.target.dataset.field;
      if(!isFinite(idx)) return;
      let val = e.target.value;
      if(field==='Debit' || field==='Credit') { val = toNum(val); }
      trialData[idx][field] = val;
      localStorage.setItem('trialData', JSON.stringify(trialData));
      // re-render derived parts
      renderAll(false);
    });
  });
}

/* Chart render for category distribution */
function renderCategoryChart(agg){
  const ctx = $('categoryChart').getContext('2d');
  const labels = [ LANG==='ar' ? 'Ø§Ù„Ø£ØµÙˆÙ„' : 'Assets', LANG==='ar' ? 'Ø§Ù„Ø®ØµÙˆÙ…' : 'Liabilities', LANG==='ar' ? 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' : 'Revenue', LANG==='ar' ? 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' : 'Expenses', LANG==='ar' ? 'Ø£Ø®Ø±Ù‰' : 'Other' ];
  const data = [Math.abs(agg.assets||0), Math.abs(agg.liabilities||0), Math.abs(agg.revenue||0), Math.abs(agg.expense||0), Math.abs(agg.other||0)];
  if(categoryChart) try{ categoryChart.destroy(); }catch(e){}
  categoryChart = new Chart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data, backgroundColor:['#0d6efd','#dc3545','#198754','#ffc107','#6c757d'] }] }, options:{plugins:{legend:{position:'bottom'}} } });
}

/* Trend/forecast chart: we create synthetic time-series from categories if no yearly series available */
function renderTrendChart(agg){
  const ctx = $('trendChart').getContext('2d');
  // create synthetic 3-year series based on simple assumptions: use assets/revenue/expense over "past 3 years" with small random/noise growth if not provided time series
  const years = [new Date().getFullYear()-2, new Date().getFullYear()-1, new Date().getFullYear()];
  // try to read from localStorage time-series keys (optional datasets: tb_timeseries)
  const tsRaw = JSON.parse(localStorage.getItem('tb_timeseries')||'null') || null;
  let labels = years.map(String), dsRevenue=[], dsExpense=[];
  if(tsRaw && Array.isArray(tsRaw) && tsRaw.length>=3){
    labels = tsRaw.map(o=>o.year);
    dsRevenue = tsRaw.map(o=>toNum(o.revenue));
    dsExpense = tsRaw.map(o=>toNum(o.expense));
  } else {
    // synthetic: split current revenue into 3 parts decreasing back by small growth
    const rev = Math.max(1, Math.abs(agg.revenue||0));
    const exp = Math.max(1, Math.abs(agg.expense||0));
    const g = 0.07; // assume modest growth
    dsRevenue = [rev/(1+g)/(1+g), rev/(1+g), rev];
    dsExpense = [exp/(1+g)/(1+g), exp/(1+g), exp];
  }

  // forecast
  const method = $('forecastMethod').value;
  const fYears = Math.max(1, parseInt($('forecastYears').value||3));
  let forecast = [];
  if(method === 'avg'){
    // compute avg growth rate of revenue
    const growths = [];
    for(let i=1;i<dsRevenue.length;i++){ const g = (dsRevenue[i]-dsRevenue[i-1])/(Math.abs(dsRevenue[i-1])||1); growths.push(g); }
    const avgG = growths.length ? (growths.reduce((s,x)=>s+x,0)/growths.length) : 0.05;
    let last = dsRevenue[dsRevenue.length-1];
    for(let y=1;y<=fYears;y++){ last = last*(1+avgG); forecast.push(Math.max(0,last)); }
  } else {
    // linear: fit slope between last and first
    const n = dsRevenue.length;
    const slope = (dsRevenue[n-1]-dsRevenue[0])/(n-1||1);
    let last = dsRevenue[n-1];
    for(let y=1;y<=fYears;y++){ last = last + slope; forecast.push(Math.max(0,last)); }
  }
  const allLabels = labels.concat(Array.from({length:fYears},(_,i)=> String((new Date().getFullYear())+i+1)));
  const allRevenue = dsRevenue.concat(forecast);
  if(trendChart) try{ trendChart.destroy(); }catch(e){}
  trendChart = new Chart(ctx, {
    type:'line',
    data:{ labels: allLabels, datasets:[ { label: LANG==='ar' ? 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' : 'Revenue', data: allRevenue, borderColor:'#0d6efd', fill:true, tension:0.3 } ] },
    options:{ plugins:{ legend:{display:false} } }
  });

  // forecast comment
  const avgGrowth = (dsRevenue.length>1) ? ((dsRevenue[dsRevenue.length-1]/(dsRevenue[0]||1))**(1/(dsRevenue.length-1))-1) : 0;
  const commentEl = $('forecastComment');
  const summary = LANG==='ar'
      ? `ØªÙˆÙ‚Ø¹Ø§Øª Ù„Ù…Ø¯Ø© ${fYears} Ø³Ù†Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ${method==='avg' ? 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ù…Ùˆ' : 'Ø§Ù†Ø­Ø¯Ø§Ø± Ø®Ø·ÙŠ'}. Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${(avgGrowth*100).toFixed(2)}%.`
      : `Forecast for ${fYears} years using ${method==='avg' ? 'average growth' : 'linear regression'}. Approx historical growth: ${(avgGrowth*100).toFixed(2)}%.`;
  commentEl.textContent = summary;
}

/* Advanced indicators area (Sharpe approximate etc.) */
function renderAdvanced(agg){
  const area = $('advBody'); area.innerHTML='';
  const netProfit = agg.revenue - agg.expense;
  const items = [];
  items.push({title: LANG==='ar' ? 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­' : 'Net Profit', value: formatCur(netProfit), comment: (netProfit>=0) ? (LANG==='ar' ? 'Ø±Ø¨Ø­ÙŠØ© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©.' : 'Positive profitability.') : (LANG==='ar' ? 'Ø®Ø³Ø§Ø±Ø© ØµØ§ÙÙŠØ©.' : 'Net loss.') });
  const debtToEquity = (agg.equity!==0) ? (agg.liabilities / (agg.equity || 1)) : null;
  items.push({title: LANG==='ar' ? 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©' : 'Debt to Equity', value: debtToEquity===null ? '-' : debtToEquity.toFixed(2), comment: commentForRatio('debtToEquity', debtToEquity) });
  // Sharpe approximation: require returns & risk info â€” we'll provide simplistic view if user provided series (tb_returns)
  const returnsSeries = JSON.parse(localStorage.getItem('tb_returns')||'null');
  let sharpeComment = LANG==='ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹ÙˆØ§Ø¦Ø¯ ÙƒØ§ÙÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Sharpe.' : 'No returns data for Sharpe ratio.';
  if(Array.isArray(returnsSeries) && returnsSeries.length>1){
    const rets = returnsSeries.map(v=>toNum(v));
    const avg = rets.reduce((s,x)=>s+x,0)/rets.length;
    const sd = Math.sqrt(rets.map(r=>(r-avg)*(r-avg)).reduce((s,x)=>s+x,0)/Math.max(1,rets.length-1));
    const rf = 0.02; // assumed risk-free
    const sharpe = (sd>0) ? ((avg - rf)/sd) : null;
    sharpeComment = sharpe ? `${LANG==='ar'? 'Sharpe ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§: ' : 'Sharpe approx: '}${sharpe.toFixed(2)} â€” ${sharpe>1 ? (LANG==='ar'?'Ø¬ÙŠØ¯':'Good') : (LANG==='ar'?'Ù…Ø¹ØªØ¯Ù„':'Moderate')}` : sharpeComment;
  }
  items.push({title: LANG==='ar' ? 'Sharpe (ØªÙ‚Ø±ÙŠØ¨ÙŠ)' : 'Sharpe (approx)', value: '-', comment: sharpeComment});
  // interest coverage: require interest expense and EBIT (approx netProfit + interest + tax) -> we approximate
  const interestCoverage = null;
  items.push({title: LANG==='ar' ? 'ØªØºØ·ÙŠØ© Ø§Ù„ÙÙˆØ§Ø¦Ø¯ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)' : 'Interest Coverage (approx)', value: interestCoverage===null ? '-' : interestCoverage.toFixed(2), comment: LANG==='ar' ? 'ÙŠÙØ­Ø³Ø¨ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙˆØ§Ø¦Ø¯' : 'Requires interest expense data.'});

  items.forEach(it=>{
    const el = document.createElement('div');
    el.className = 'mb-2';
    el.innerHTML = `<div style="font-weight:700">${escapeHtml(it.title)} â€” <span style="float:left">${escapeHtml(it.value)}</span></div><div class="small-muted">${escapeHtml(it.comment)}</div>`;
    area.appendChild(el);
  });
}

/* Smart summary generation */
function generateSmartSummary(agg, ratios){
  // Compose multi-line summary based on computed metrics
  const lines = [];
  const net = agg.revenue - agg.expense;
  lines.push( LANG==='ar' ? `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${formatCur(agg.revenue)} â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${formatCur(agg.expense)}.` : `Total Revenue: ${formatCur(agg.revenue)} â€” Total Expense: ${formatCur(agg.expense)}.` );
  lines.push( LANG==='ar' ? `ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${formatCur(net)}.` : `Net Profit: ${formatCur(net)}.` );
  // liquidity line
  if(ratios.currentRatio !== null) lines.push((LANG==='ar' ? 'Ø§Ù„Ø³ÙŠÙˆÙ„Ø© (Current Ratio): ' : 'Current Ratio: ') + (ratios.currentRatio.toFixed(2)) + ' â€” ' + commentForRatio('currentRatio', ratios.currentRatio));
  // leverage
  if(ratios.debtToEquity !== null) lines.push((LANG==='ar' ? 'Ø±ÙØ¹ Ù…Ø§Ù„ÙŠ (Debt/Equity): ' : 'Debt/Equity: ') + (ratios.debtToEquity.toFixed(2)) + ' â€” ' + commentForRatio('debtToEquity', ratios.debtToEquity));
  // ROA / ROE
  if(ratios.roa !== null) lines.push((LANG==='ar' ? 'Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙˆÙ„ (ROA): ' : 'ROA: ') + ( (ratios.roa*100).toFixed(2) + '%' ) + ' â€” ' + commentForRatio('roa', ratios.roa));
  if(ratios.roe !== null) lines.push((LANG==='ar' ? 'Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (ROE): ' : 'ROE: ') + ( (ratios.roe*100).toFixed(2) + '%' ) + ' â€” ' + commentForRatio('roe', ratios.roe));
  return lines.join(' ');
}

/* Utility escape */
function escapeHtml(s){ return (s===null||s===undefined) ? '' : String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

/* Render ratios table body */
function renderRatiosTable(ratios){
  const body = $('ratiosBody'); body.innerHTML='';
  const rows = [
    {k:'currentRatio', label: LANG==='ar' ? 'Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Current Ratio)' : 'Current Ratio', value: ratios.currentRatio},
    {k:'debtToEquity', label: LANG==='ar' ? 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙŠÙ†/Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©' : 'Debt to Equity', value: ratios.debtToEquity},
    {k:'grossMargin', label: LANG==='ar' ? 'Ù‡Ø§Ù…Ø´ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ' : 'Gross Margin (approx)', value: ratios.grossMargin},
    {k:'netProfit', label: LANG==='ar' ? 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­' : 'Net Profit', value: ratios.netProfit},
    {k:'roa', label: LANG==='ar' ? 'Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙˆÙ„ (ROA)' : 'ROA', value: ratios.roa},
    {k:'roe', label: LANG==='ar' ? 'Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (ROE)' : 'ROE', value: ratios.roe},
    {k:'assetTurnover', label: LANG==='ar' ? 'Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø£ØµÙˆÙ„' : 'Asset Turnover', value: ratios.assetTurnover}
  ];
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const valStr = (r.value === null || r.value === undefined) ? '-' : ( (Math.abs(r.value) >= 1 && (r.k === 'netProfit')) ? formatCur(r.value) : ( (r.k==='grossMargin' || r.k==='roa' || r.k==='roe') ? ((r.value*100).toFixed(2) + '%') : (typeof r.value === 'number' ? (r.value.toFixed(2)) : r.value) ) );
    const comm = commentForRatio(r.k, r.value);
    tr.innerHTML = `<td>${escapeHtml(r.label)}</td><td>${escapeHtml(valStr)}</td><td class="small-muted">${escapeHtml(comm)}</td>`;
    body.appendChild(tr);
  });
}

/* Alerts area */
function renderAlerts(agg,ratios){
  const area = $('alertsArea'); area.innerHTML='';
  const list = [];
  if(trialData.length === 0) list.push(t('noData'));
  if(ratios.currentRatio !== null && ratios.currentRatio < 1) list.push(LANG==='ar' ? 'ØªØ­Ø°ÙŠØ±: Ù†Ø³Ø¨Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø£Ù‚Ù„ Ù…Ù† 1 â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù†Ù‚Ø¯.' : 'Warning: Current ratio < 1 â€” review cash.');
  if(ratios.debtToEquity !== null && ratios.debtToEquity > 2) list.push(LANG==='ar' ? 'ØªØ­Ø°ÙŠØ±: Ø±ÙØ¹ Ù…Ø§Ù„ÙŠ Ù…Ø±ØªÙØ¹.' : 'Warning: High leverage.');
  list.forEach(it=>{ const d = document.createElement('div'); d.textContent = it; area.appendChild(d); });
}

/* Master render */
function renderAll(scroll=true){
  loadData();
  const agg = aggregateByCategory(trialData);
  renderKPIs(agg);
  renderRawTable();
  renderCategoryChart(agg);
  const ratios = computeRatios(agg);
  renderRatiosTable(ratios);
  renderAdvanced(agg);
  renderTrendChart(agg);
  const smart = generateSmartSummary(agg, ratios);
  $('smartSummary').textContent = smart;
  renderAlerts(agg, ratios);
  if(scroll) window.scrollTo({top:0,behavior:'smooth'});
}

/* initial load */
(function init(){
  // apply theme from storage
  const theme = localStorage.getItem('fa_theme') || 'light';
  document.body.dataset.theme = theme;
  $('darkModeToggle').checked = (theme === 'dark');

  // set language + currency controls & load data
  populateControls();
  loadData();
  renderAll(false);
})();

</script>

</body>
</html>
