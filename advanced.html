<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© â€” Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ</title>

  <!-- CSS fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --text:#111; --muted:#6c757d;
      --accent1:#0d6efd; --accent2:#6610f2; --radius:12px;
    }
    html,body{height:100%;margin:0;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;transition:background .18s,color .18s}
    body.dark{ --bg:#071018; --card:#0b1116; --text:#e6eef6; --muted:#9aa6b2 }
    header{position:sticky;top:0;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;padding:12px 18px;z-index:1200}
    header .brand{display:flex;align-items:center;gap:12px}
    header .brand img{height:44px;border-radius:8px;box-shadow:0 8px 26px rgba(0,0,0,0.15)}
    header h1{margin:0;font-size:1.15rem}
    .controls-bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:14px}
    .controls-bar select,.controls-bar input{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)}
    .btn-main{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .container{max-width:1200px;margin:18px auto;padding:0 14px}
    .row-surface{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.04);margin-bottom:16px;border:1px solid rgba(13,110,253,0.04)}
    body.dark .row-surface{box-shadow:0 10px 30px rgba(0,0,0,0.6);border-color:rgba(255,255,255,0.03)}
    h2.section-title{margin:0 0 10px 0;font-size:1.05rem}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .kpi{background:linear-gradient(180deg,var(--card),#f8fbff);padding:12px;border-radius:10px;text-align:center;box-shadow:0 8px 20px rgba(2,6,23,0.04)}
    .kpi .value{font-weight:800;font-size:1.05rem;margin-top:6px}
    .flex-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .col-split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){ .col-split{grid-template-columns:1fr} .controls-bar{justify-content:center} }
    .table-fixed{max-height:300px;overflow:auto}
    /* watermark for PDF/print */
    .watermark{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:0;opacity:0.06}
    .watermark img{max-width:520px;filter:grayscale(100%);opacity:0.12}
    .explain{font-size:0.95rem;color:var(--muted)}
    .small-muted{color:var(--muted);font-size:0.93rem}
    .controls-compact{display:flex;gap:8px;align-items:center}
    .compare-table th, .compare-table td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06)}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-weight:700}
    .export-actions{display:flex;gap:8px;flex-wrap:wrap}
    .export-actions button{padding:8px 10px;border-radius:8px;border:none;background:#0b5ed7;color:#fff;cursor:pointer}
    /* ensure readable text in dark mode */
    body.dark h2, body.dark .explain, body.dark .small-muted, body.dark table, body.dark p { color: var(--text); }
    table{width:100%;border-collapse:collapse}
  </style>
</head>
<body>
  <!-- Watermark (captured when exporting) -->
  <div class="watermark" aria-hidden="true"><img src="assets/logo.png" alt="logo"/></div>

  <header>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div class="brand">
        <img src="assets/logo.png" alt="logo">
        <div>
          <h1 id="pageTitle">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h1>
          <div class="small-muted" id="pageDesc">Ù…Ø±Ø¬Ø¹ Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŒ Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŒ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn-main" id="goReport">ğŸ“‘ ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn-main" id="goInput">ğŸ“ Ø¥Ø¯Ø®Ø§Ù„</button>
        <button class="btn-main" id="goHome">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Controls -->
    <div class="controls-bar row-surface" role="region" aria-label="controls">
      <div class="controls-compact">
        <label for="languageSelect" class="small-muted" style="margin-inline-end:6px">Ø§Ù„Ù„ØºØ©</label>
        <select id="languageSelect" aria-label="Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©">
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="en">English</option>
        </select>

        <label for="currencySelect" class="small-muted" style="margin-inline-start:12px;margin-inline-end:6px">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
        <select id="currencySelect" aria-label="Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©">
          <option value="EGP">EGP</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>

        <label for="fxInput" class="small-muted" style="margin-inline-start:12px;margin-inline-end:6px">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</label>
        <input id="fxInput" type="number" step="0.0001" style="width:110px" placeholder="1" aria-label="Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù">

        <button id="toggleTheme" class="btn-main" style="margin-inline-start:12px">ğŸŒ™/â˜€</button>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="export-actions" role="group" aria-label="ØªØµØ¯ÙŠØ±">
          <button id="exportPdf">ØªØµØ¯ÙŠØ± PDF</button>
          <button id="exportExcel">ØªØµØ¯ÙŠØ± Excel</button>
          <button id="exportWord">ØªØµØ¯ÙŠØ± Word</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <section class="row-surface" id="kpisSection" aria-labelledby="kpisTitle">
      <h2 class="section-title" id="kpisTitle">Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h2>
      <div class="kpi-grid" id="kpiGrid"></div>
    </section>

    <!-- Ratios & Explanations -->
    <section class="row-surface" id="ratiosSection" aria-labelledby="ratiosTitle">
      <h2 class="section-title" id="ratiosTitle">Ø§Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
      <div class="col-split">
        <div>
          <canvas id="ratiosChart" height="220"></canvas>
        </div>
        <div>
          <h3 style="margin:0.2rem 0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø¨</h3>
          <div id="ratiosTable" class="table-fixed"></div>
        </div>
      </div>
      <p class="explain" id="ratiosExplain"></p>
    </section>

    <!-- Value Added & Risk -->
    <section class="row-surface" id="valueRiskSection">
      <div class="col-split">
        <div>
          <h2 class="section-title">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</h2>
          <canvas id="valueChart" height="220"></canvas>
          <div id="valueTable"></div>
          <p class="explain" id="valueExplain"></p>
        </div>
        <div>
          <h2 class="section-title">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h2>
          <canvas id="riskChart" height="220"></canvas>
          <div id="riskTable"></div>
          <p class="explain" id="riskExplain"></p>
        </div>
      </div>
    </section>

    <!-- Forecast -->
    <section class="row-surface" id="forecastSection">
      <h2 class="section-title">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª (ØªÙ‚Ø¯ÙŠØ±ÙŠØ©)</h2>
      <div class="flex-row" style="align-items:flex-start">
        <div style="flex:1">
          <canvas id="forecastChart" height="220"></canvas>
        </div>
        <div style="width:360px">
          <h4>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ†Ø¨Ø¤ (Ø³Ø±ÙŠØ¹Ø©)</h4>
          <p class="small-muted" id="forecastExplain">Ù†Ø³ØªØ®Ø¯Ù… Ù…ØªÙˆØ³Ø· Ù†Ù…Ùˆ Ø³Ù†ÙˆÙŠ Ø¨Ø³ÙŠØ· Ù„Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ø³Ù†Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©. Ù‡Ø°Ø§ ØªØ¨Ø³ÙŠØ· Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ·ÙˆÙŠØ± Ù„Ù†Ù…Ø§Ø°Ø¬ Ø£ÙƒØ«Ø± ØªÙ‚Ø¯Ù…Ù‹Ø§.</p>
          <div id="forecastTable"></div>
        </div>
      </div>
    </section>

    <!-- Comparison -->
    <section class="row-surface" id="compareSection">
      <h2 class="section-title">Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† ÙØªØ±ØªÙŠÙ† (Snapshots)</h2>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <select id="snapA"><option value="">--</option></select>
        <select id="snapB"><option value="">--</option></select>
        <button id="compareBtn" class="btn-main">Ù‚Ø§Ø±Ù†</button>
        <button id="clearCompare" class="btn-main" style="background:#6c757d">Ù…Ø³Ø­</button>
      </div>
      <div id="compareResult" style="margin-top:12px"></div>
      <canvas id="compareChart" height="240" style="margin-top:12px"></canvas>
    </section>

    <footer class="row-surface small-muted" style="text-align:center">Â© 2025 Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</footer>
  </div>

  <script>
  /**************************************************************************
   * Advanced Analytics Page - Single-file
   * - Reads trialData from localStorage (same key used in Input/Report pages)
   * - Computes many ratios, shows charts, explanations (AR/EN switching)
   * - Currency conversion via FX input
   * - Snapshot comparison, simple forecasting (avg growth)
   * - Export PDF/Excel/Word with logo + watermark (uses html2pdf + XLSX + FileSaver)
   **************************************************************************/

  // ---------- helpers ----------
  const $ = id=>document.getElementById(id);
  const langTexts = {
    ar: {
      title: "Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©",
      desc: "Ù…Ø±Ø¬Ø¹ Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŒ Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŒ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©",
      kpi_accounts: "Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª",
      kpi_assets: "Ø§Ù„Ø£ØµÙˆÙ„ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)",
      kpi_liab: "Ø§Ù„Ø®ØµÙˆÙ… (ØªÙ‚Ø±ÙŠØ¨ÙŠ)",
      kpi_revenue: "Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",
      kpi_expense: "Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª",
      ratio_explain: "Ø§Ù„Ø´Ø±Ø­: Ù‡Ù†Ø§ ØªÙˆØ¶ÙŠØ­ Ù…Ø§Ø°Ø§ ØªØ¹Ù†ÙŠ Ø§Ù„Ù†Ø³Ø¨ØŒ ÙˆÙƒÙŠÙ ØªÙØ³ØªØ®Ø¯Ù… Ù„Ù‚ÙŠØ§Ø³ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ©. ØªØºÙŠØ± Ø§Ù„Ù„ØºØ© ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ù†ØµÙˆØµ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.",
      value_explain: "Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© ØªÙØ­Ø³Ø¨ Ø¨ØµÙˆØ±Ø© ØªÙ‚Ù„ÙŠØ¯ÙŠØ© (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø§ØªØ¬ - Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ù† Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª). Ù‡Ø°Ø§ ØªØ¨Ø³ÙŠØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙƒØ±Ø©.",
      risk_explain: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙŠØ¹Ø±Ø¶ Ù…Ø¤Ø´Ø±Ø§Øª Ø£ÙˆÙ„ÙˆÙŠØ© (Ø³ÙŠÙˆÙ„Ø©ØŒ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©ØŒ ØªØºØ·ÙŠØ© ÙÙˆØ§Ø¦Ø¯) ÙˆØªØ­Ø°ÙŠØ±Ø§Øª Ù…Ø¨ÙƒØ±Ø©.",
      forecast_explain: "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ†Ø¨Ø¤: Ù…ØªÙˆØ³Ø· Ù†Ù…Ùˆ Ø¨Ø³ÙŠØ· Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©. Ù‡Ø°Ø§ ØªÙ‚Ø¯ÙŠØ± Ø³Ø±ÙŠØ¹ ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ù„ØªØ·ÙˆÙŠØ±.",
      choose_snapshots: "Ø§Ø®ØªØ± Ù„Ù‚Ø·ØªÙŠÙ† Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©",
      none_data: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§."
    },
    en: {
      title: "Advanced Financial Analytics",
      desc: "Global reference for ratios, indicators, risk and value added",
      kpi_accounts: "Accounts",
      kpi_assets: "Assets (approx)",
      kpi_liab: "Liabilities (approx)",
      kpi_revenue: "Revenue",
      kpi_expense: "Expense",
      ratio_explain: "Explanation: Ratios measure liquidity, solvency, profitability and efficiency. Change language to switch texts.",
      value_explain: "Value Added: (Total output - purchased inputs). Simplified view for demonstration.",
      risk_explain: "Risk analysis shows priority indicators (liquidity, leverage, interest coverage) and early warnings.",
      forecast_explain: "Forecasting: simple avg growth forecasting. Useful quick estimate; can be upgraded to ML models.",
      choose_snapshots: "Choose two snapshots to compare",
      none_data: "No data to display."
    }
  };
  function t(key){ const l = $('languageSelect').value || 'ar'; return (langTexts[l] && langTexts[l][key]) ? langTexts[l][key] : key; }

  function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
  function toNum(v){ const n = Number(String(v||'').toString().replace(/[, ]+/g,'')); return isNaN(n)?0:n; }
  function fmt(v){ return Number(v).toLocaleString(undefined,{maximumFractionDigits:2,minimumFractionDigits:0}); }

  // ---------- data sources ----------
  let trialData = JSON.parse(localStorage.getItem('trialData')||'[]'); // expected: [{Account,Type,Code,Debit,Credit},...]
  let snapshots = JSON.parse(localStorage.getItem('trialData_snapshots')||'{}'); // { label: [...] }
  let fxRates = JSON.parse(localStorage.getItem('fa_fx')||'null') || { USD:31, EUR:34 };
  // user custom FX
  function getCustomFX(){ const v = Number($('fxInput').value); return v>0 ? v : null; }

  // ---------- UI init ----------
  function initUI(){
    // navigation
    $('goReport').addEventListener('click', ()=> location.href='report.html');
    $('goInput').addEventListener('click', ()=> location.href='input.html');
    $('goHome').addEventListener('click', ()=> location.href='index.html');

    // load selects
    const langSelect = $('languageSelect'); langSelect.value = localStorage.getItem('fa_lang') || localStorage.getItem('lang') || 'ar';
    const cur = localStorage.getItem('fa_currency') || localStorage.getItem('currency') || 'EGP';
    $('currencySelect').value = cur;
    $('fxInput').value = localStorage.getItem('fa_fx_custom') || '';

    // events
    $('languageSelect').addEventListener('change', ()=>{ localStorage.setItem('fa_lang',$('languageSelect').value); renderAll(); });
    $('currencySelect').addEventListener('change', ()=>{ localStorage.setItem('fa_currency',$('currencySelect').value); renderAll(); });
    $('fxInput').addEventListener('change', ()=>{ localStorage.setItem('fa_fx_custom',$('fxInput').value); renderAll(); });
    $('toggleTheme').addEventListener('click', ()=>{ document.body.classList.toggle('dark'); localStorage.setItem('fa_theme', document.body.classList.contains('dark')?'dark':'light'); });

    // export handlers
    $('exportPdf').addEventListener('click', exportPDF);
    $('exportExcel').addEventListener('click', exportXLSX);
    $('exportWord').addEventListener('click', exportWord);

    // snapshots
    $('compareBtn').addEventListener('click', doCompare);
    $('clearCompare').addEventListener('click', ()=>{ $('compareResult').innerHTML=''; if(window.compareChart) try{ window.compareChart.destroy(); }catch{} });

    // storage listener
    window.addEventListener('storage',(e)=>{ if(e.key==='trialData'){ trialData = JSON.parse(e.newValue||'[]'); renderAll(); } if(e.key==='trialData_snapshots'){ snapshots = JSON.parse(e.newValue||'{}'); renderSnapshotOptions(); } });

    renderSnapshotOptions();
  }

  // ---------- utilities ----------
  function getCurrencySymbol(){
    const cur = $('currencySelect').value || 'EGP';
    if(cur==='EGP') return 'Ø¬.Ù…';
    if(cur==='USD') return '$';
    if(cur==='EUR') return 'â‚¬';
    return cur;
  }
  function convert(value){
    const cur = $('currencySelect').value || 'EGP';
    if(cur==='EGP') return toNum(value);
    const custom = getCustomFX();
    if(custom) return toNum(value)/custom;
    const rate = fxRates[cur] || 1;
    return toNum(value)/rate;
  }

  // ---------- aggregation & ratios ----------
  function aggregate(data){
    const agg = { assets:0, liabilities:0, equity:0, revenue:0, expense:0, other:0 };
    data.forEach(r=>{
      const net = toNum(r.Debit) - toNum(r.Credit);
      const s = String((r.Type||r.Account||'')).toLowerCase();
      if(/asset|Ø£ØµÙ„|cash|bank|Ù†Ù‚Ø¯|fixed asset|Ø£ØµÙˆÙ„|inventory/.test(s)) agg.assets += net;
      else if(/liab|Ø®ØµÙˆÙ…|payable|Ø¯Ø§Ø¦Ù†|loan|Ù‚Ø±Ø¶|Ù‚Ø±ÙˆØ¶/.test(s)) agg.liabilities += -net;
      else if(/equity|Ø­Ù‚ÙˆÙ‚|Ø±Ø£Ø³|capital/.test(s)) agg.equity += -net;
      else if(/revenue|sales|Ø¥ÙŠØ±Ø§Ø¯|Ù…Ø¨ÙŠØ¹Ø§Øª/.test(s)) agg.revenue += -net;
      else if(/expense|Ù…ØµØ±ÙˆÙ|cogs|ØªÙƒÙ„ÙØ©|Ù…ØµØ§Ø±ÙŠÙ/.test(s)) agg.expense += net;
      else agg.other += net;
    });
    return agg;
  }

  // compute many ratios
  function computeRatios(data){
    const agg = aggregate(data);
    const totalAssets = agg.assets;
    const totalLiabilities = agg.liabilities;
    const totalEquity = agg.equity;
    const revenue = agg.revenue;
    const expense = agg.expense;
    const grossProfit = revenue - expense; // simplistic
    // Basic ratios (defensive with zero checks)
    const currentRatio = safeDiv(totalAssets, totalLiabilities); // approximated
    const debtToEquity = safeDiv(totalLiabilities, totalEquity);
    const debtRatio = safeDiv(totalLiabilities, totalAssets);
    const roe = safeDiv(grossProfit, totalEquity) * 100;
    const roa = safeDiv(grossProfit, totalAssets) * 100;
    const profitMargin = safeDiv(grossProfit, revenue) * 100;
    const expenseRatio = safeDiv(expense, revenue) * 100;
    // coverage proxy (EBITDA unknown => use grossProfit)
    const interestCoverage = safeDiv(grossProfit, Math.max(1, Math.abs(expense*0.05))) ; // proxy guess for demonstration

    // efficiency proxies
    const assetTurnover = safeDiv(revenue, totalAssets);

    // EVA rough (NOPAT - WACC*Capital) - we can't compute NOPAT/WACC exactly; provide simple proxy
    const eva = (revenue - expense) - (0.08 * Math.abs(totalEquity + totalLiabilities)); // assuming WACC ~8%

    return {
      totalAssets, totalLiabilities, totalEquity, revenue, expense, grossProfit,
      currentRatio, debtToEquity, debtRatio, roe, roa, profitMargin, expenseRatio,
      interestCoverage, assetTurnover, eva
    };
  }

  function safeDiv(a,b){ if(!isFinite(a)) a=0; if(!isFinite(b) || b===0) return 0; return a/b; }

  // ---------- renderers ----------
  let ratiosChart=null, valueChart=null, riskChart=null, forecastChart=null, compareChart=null;

  function renderKPIs(data){
    const kpiGrid = $('kpiGrid'); kpiGrid.innerHTML='';
    const agg = aggregate(data);
    const items = [
      {label: t('kpi_accounts') || langTexts[$('languageSelect').value].kpi_accounts, value: data.length},
      {label: t('kpi_assets') || langTexts[$('languageSelect').value].kpi_assets, value: agg.assets},
      {label: t('kpi_liab') || langTexts[$('languageSelect').value].kpi_liab, value: agg.liabilities},
      {label: t('kpi_revenue') || langTexts[$('languageSelect').value].kpi_revenue, value: agg.revenue},
      {label: t('kpi_expense') || langTexts[$('languageSelect').value].kpi_expense, value: agg.expense},
      {label: ( $('languageSelect').value==='ar' ? 'Ø£Ø®Ø±Ù‰' : 'Other'), value: agg.other}
    ];
    items.forEach(it=>{
      const div = document.createElement('div'); div.className='kpi';
      const val = (typeof it.value === 'number') ? fmt(convert(it.value)) + ' ' + getCurrencySymbol() : esc(it.value);
      div.innerHTML = `<div class="small-muted">${esc(it.label)}</div><div class="value">${val}</div>`;
      kpiGrid.appendChild(div);
    });
  }

  function renderRatios(data){
    const res = computeRatios(data);
    // Table
    const table = document.createElement('table'); table.className='table';
    const tbody = document.createElement('tbody');
    const addRow = (label, val, desc) => {
      const tr = document.createElement('tr');
      const th = document.createElement('td'); th.style.width='55%'; th.innerText = label;
      const td = document.createElement('td'); td.style.textAlign='right'; td.innerText = val;
      tbody.appendChild(tr); tr.appendChild(th); tr.appendChild(td);
      if(desc){
        const tr2 = document.createElement('tr'); const td2=document.createElement('td'); td2.colSpan=2; td2.className='small-muted'; td2.innerText=desc;
        tbody.appendChild(tr2); tr2.appendChild(td2);
      }
    };
    addRow( $('languageSelect').value==='ar' ? 'Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)' : 'Current Ratio (approx)', fmt(res.currentRatio) );
    addRow( $('languageSelect').value==='ar' ? 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©' : 'Debt to Equity', fmt(res.debtToEquity) );
    addRow( $('languageSelect').value==='ar' ? 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ø£ØµÙˆÙ„' : 'Debt Ratio', fmt(res.debtRatio) );
    addRow( $('languageSelect').value==='ar' ? 'Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (Ùª)' : 'ROE (%)', fmt(res.roe) + '%' );
    addRow( $('languageSelect').value==='ar' ? 'Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙˆÙ„ (Ùª)' : 'ROA (%)', fmt(res.roa) + '%' );
    addRow( $('languageSelect').value==='ar' ? 'Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­' : 'Profit Margin', fmt(res.profitMargin) + '%' );
    addRow( $('languageSelect').value==='ar' ? 'ØªØºØ·ÙŠØ© Ø§Ù„ÙÙˆØ§Ø¦Ø¯ (Ù…Ø¤Ø´Ø± ØªÙ‚Ø±ÙŠØ¨ÙŠ)' : 'Interest Coverage (proxy)', fmt(res.interestCoverage) );
    addRow( $('languageSelect').value==='ar' ? 'Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø£ØµÙˆÙ„' : 'Asset Turnover', fmt(res.assetTurnover) );
    addRow( $('languageSelect').value==='ar' ? 'EVA (ØªÙ‚Ø¯ÙŠØ±ÙŠ)' : 'EVA (est.)', fmt(res.eva) + ' ' + getCurrencySymbol() );
    table.appendChild(tbody);
    $('ratiosTable').innerHTML=''; $('ratiosTable').appendChild(table);

    // Chart: show selected ratios
    const labels = [ $('languageSelect').value==='ar' ? 'ROE%' : 'ROE%', $('languageSelect').value==='ar' ? 'ROA%' : 'ROA%', 'Profit Margin%','Debt Ratio' ];
    const dataVals = [res.roe, res.roa, res.profitMargin, res.debtRatio*100];
    if(ratiosChart) try{ ratiosChart.destroy(); }catch(e){}
    const ctx = $('ratiosChart').getContext('2d');
    ratiosChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets:[{label: $('languageSelect').value==='ar'?'Ù…Ø¹Ø¯Ù„Ø§Øª':'Ratios', data: dataVals, backgroundColor:['#0d6efd','#6610f2','#198754','#ffc107']}]},
      options: { responsive:true, plugins:{legend:{display:false}} }
    });

    $('ratiosExplain').innerText = t('ratio_explain') || langTexts[$('languageSelect').value].ratio_explain;
  }

  function renderValueAndRisk(data){
    // value added simplistic: revenue - intermediate consumption (we don't have inputs, use expense as proxy)
    const agg = aggregate(data);
    const valueAdded = agg.revenue - agg.expense;
    $('valueTable').innerHTML = `<table class="table"><tbody>
      <tr><td>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (ØªÙ‚Ø±ÙŠØ¨ÙŠ)</td><td class="text-end">${fmt(convert(valueAdded))} ${getCurrencySymbol()}</td></tr>
      <tr><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¥ÙŠØ±Ø§Ø¯Ø§Øª)</td><td class="text-end">${fmt(convert(agg.revenue))} ${getCurrencySymbol()}</td></tr>
      <tr><td>ØªÙƒÙ„ÙØ© / Ù…ØµØ±ÙˆÙØ§Øª</td><td class="text-end">${fmt(convert(agg.expense))} ${getCurrencySymbol()}</td></tr>
    </tbody></table>`;
    $('valueExplain').innerText = t('value_explain') || langTexts[$('languageSelect').value].value_explain;

    // risk: simple scoring based on ratios
    const r = computeRatios(data);
    const riskScore = Math.max(0, Math.min(100, ( (r.debtRatio*100)/2 + (100 - Math.min(100,r.currentRatio*50)) + (r.profitMargin<0?30:0) )));
    $('riskTable').innerHTML = `<table class="table"><tbody>
      <tr><td>Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© (0-100)</td><td class="text-end">${fmt(riskScore)}</td></tr>
      <tr><td>Ù†Ø³Ø¨Ø© ØªØºØ·ÙŠØ© Ø§Ù„ÙÙˆØ§Ø¦Ø¯ (ØªÙ‚Ø±ÙŠØ¨)</td><td class="text-end">${fmt(r.interestCoverage)}</td></tr>
    </tbody></table>`;
    $('riskExplain').innerText = t('risk_explain') || langTexts[$('languageSelect').value].risk_explain;

    // risk chart (gauge-like bar)
    if(riskChart) try{ riskChart.destroy(); }catch(e){}
    const ctx = $('riskChart').getContext('2d');
    riskChart = new Chart(ctx, {
      type:'doughnut',
      data:{ labels:['Risk','Safe'], datasets:[{data:[riskScore,100-riskScore], backgroundColor:['#dc3545','#198754']}] },
      options:{ plugins:{legend:{display:false}} }
    });
  }

  function renderForecast(data){
    // simple forecasting using average growth of revenue across snapshots if available, else linear from current data
    const labels = []; const values = [];
    // try snapshots: if there are labeled snapshots with numeric label like years, use them
    const snaps = Object.keys(snapshots || {});
    if(snaps.length>=2){
      // sort keys if numeric-like
      const years = snaps.slice().sort();
      years.forEach(k=>{
        const d = snapshots[k];
        const agg = aggregate(d);
        labels.push(k);
        values.push(convert(agg.revenue));
      });
    } else {
      // fallback: use current single point and generate small trend from past (none) => no forecast data
      labels.push('Now'); values.push(convert(aggregate(data).revenue));
    }
    // compute simple growth rate and forecast next
    const growths = [];
    for(let i=1;i<values.length;i++){
      const prev = values[i-1]||1;
      const g = prev ? (values[i]-prev)/prev : 0;
      growths.push(g);
    }
    const avgGrowth = growths.length? (growths.reduce((s,x)=>s+x,0)/growths.length) : 0.05; // default 5%
    const lastVal = values[values.length-1]||0;
    const forecastVal = lastVal*(1+avgGrowth);
    // prepare chart
    const chartLabels = labels.concat(['Forecast']);
    const chartVals = values.concat([forecastVal]);
    if(forecastChart) try{ forecastChart.destroy(); }catch(e){}
    const ctx = $('forecastChart').getContext('2d');
    forecastChart = new Chart(ctx,{ type:'line', data:{ labels:chartLabels, datasets:[{label: $('languageSelect').value==='ar'?'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª':'Revenue', data:chartVals, borderColor:'#0d6efd', tension:0.3, fill:true}]}, options:{ responsive:true }});
    $('forecastTable').innerHTML = `<table class="table"><tbody>
      <tr><td>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</td><td class="text-end">${fmt(lastVal)} ${getCurrencySymbol()}</td></tr>
      <tr><td>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</td><td class="text-end">${(avgGrowth*100).toFixed(2)}%</td></tr>
      <tr><td>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø§Ù„Ø³Ù†Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©)</td><td class="text-end">${fmt(forecastVal)} ${getCurrencySymbol()}</td></tr>
    </tbody></table>`;
    $('forecastExplain').innerText = t('forecast_explain') || langTexts[$('languageSelect').value].forecast_explain;
  }

  // ---------- snapshot management ----------
  function renderSnapshotOptions(){
    const sa = $('snapA'); const sb = $('snapB');
    sa.innerHTML = '<option value="">--</option>'; sb.innerHTML = '<option value="">--</option>';
    const keys = Object.keys(snapshots || {}).sort().reverse();
    if(!keys.length){
      sa.innerHTML = `<option value="">${t('none_data')}</option>`; sb.innerHTML = `<option value="">${t('none_data')}</option>`;
      return;
    }
    keys.forEach(k=>{ const o1 = document.createElement('option'); o1.value=k; o1.textContent=k; sa.appendChild(o1); const o2 = document.createElement('option'); o2.value=k; o2.textContent=k; sb.appendChild(o2); });
  }

  function doCompare(){
    const a = $('snapA').value; const b = $('snapB').value;
    if(!a || !b){ alert(t('choose_snapshots')); return; }
    const dataA = snapshots[a] || []; const dataB = snapshots[b] || [];
    const aggA = aggregate(dataA); const aggB = aggregate(dataB);
    const labels = [ $('languageSelect').value==='ar' ? 'Ø§Ù„Ø£ØµÙˆÙ„' : 'Assets', $('languageSelect').value==='ar' ? 'Ø§Ù„Ø®ØµÙˆÙ…' : 'Liabilities', $('languageSelect').value==='ar' ? 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' : 'Revenue', $('languageSelect').value==='ar' ? 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' : 'Expenses' ];
    const valsA = [convert(aggA.assets), convert(aggA.liabilities), convert(aggA.revenue), convert(aggA.expense)];
    const valsB = [convert(aggB.assets), convert(aggB.liabilities), convert(aggB.revenue), convert(aggB.expense)];
    // table
    let html = '<table class="table compare-table"><thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th class="text-end">A</th><th class="text-end">B</th><th class="text-end">Ø§Ù„ÙØ±Ù‚</th><th class="text-end">Ùª Ø§Ù„ØªØºÙŠØ±</th></tr></thead><tbody>';
    for(let i=0;i<labels.length;i++){
      const diff = valsB[i] - valsA[i];
      const pct = valsA[i] ? (diff/valsA[i])*100 : 0;
      html += `<tr><td>${esc(labels[i])}</td><td class="text-end">${fmt(valsA[i])} ${getCurrencySymbol()}</td><td class="text-end">${fmt(valsB[i])} ${getCurrencySymbol()}</td><td class="text-end">${fmt(diff)} ${getCurrencySymbol()}</td><td class="text-end">${fmt(pct)}%</td></tr>`;
    }
    html += '</tbody></table>';
    $('compareResult').innerHTML = `<h4>Ù…Ù‚Ø§Ø±Ù†Ø© ${esc(a)} â†” ${esc(b)}</h4>` + html;
    // chart
    if(compareChart) try{ compareChart.destroy(); }catch(e){}
    const ctx = $('compareChart').getContext('2d');
    compareChart = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[ {label: a, data: valsA, backgroundColor:'rgba(13,110,253,0.8)'}, {label: b, data: valsB, backgroundColor:'rgba(102,16,242,0.8)'} ] },
      options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
    });
  }

  // ---------- exports ----------
  async function exportPDF(){
    // ensure watermark/logo visible
    const wm = document.querySelector('.watermark img'); const prevOp = wm.style.opacity; wm.style.opacity = '0.12';
    const element = document.querySelector('main') || document.body;
    const opt = { margin:0.4, filename:'advanced_financial_report.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2,useCORS:true,allowTaint:true}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'} };
    try{
      await html2pdf().set(opt).from(document.querySelector('.container')).save();
    }catch(e){ console.error(e); alert('PDF export failed'); }
    wm.style.opacity = prevOp || '';
  }

  function exportXLSX(){
    if(!trialData || !trialData.length){ alert(t('none_data')); return; }
    const ws = XLSX.utils.json_to_sheet(trialData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'TrialBalance');
    XLSX.writeFile(wb, 'trialbalance.xlsx');
  }

  function exportWord(){
    // simple text-based .doc export
    let html = `<h1>${esc($('pageTitle').innerText)}</h1><p>${esc($('pageDesc').innerText)}</p>`;
    html += document.querySelector('#kpisSection').innerHTML;
    const blob = new Blob([html], { type:'application/msword' });
    saveAs(blob, 'advanced_report.doc');
  }

  // ---------- main render ----------
  function renderAll(){
    // refresh local data
    trialData = JSON.parse(localStorage.getItem('trialData')||'[]');
    snapshots = JSON.parse(localStorage.getItem('trialData_snapshots')||'{}');
    fxRates = JSON.parse(localStorage.getItem('fa_fx')||'null') || fxRates;
    // apply language titles
    const L = $('languageSelect').value || 'ar';
    $('pageTitle').innerText = L==='ar' ? 'Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' : 'Advanced Financial Analytics';
    $('pageDesc').innerText = L==='ar' ? 'Ù…Ø±Ø¬Ø¹ Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŒ Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŒ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©' : 'Global reference for ratios, indicators, risk and value added';
    // KPIs
    renderKPIs(trialData || []);
    // ratios
    renderRatios(trialData || []);
    // value & risk
    renderValueAndRisk(trialData || []);
    // forecast
    renderForecast(trialData || []);
    // snapshot selects
    renderSnapshotOptions();
  }

  // ---------- Init ----------
  initUI();
  renderAll();

  // initial UX: if no trialData, show hint
  if(!trialData || !trialData.length){
    const note = document.createElement('div'); note.className='row-surface small-muted'; note.style.marginTop='8px'; note.innerText = t('none_data');
    document.querySelector('.container').prepend(note);
  }
  </script>
</body>
</html>
