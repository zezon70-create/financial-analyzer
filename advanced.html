<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>التحليلات المتقدمة — المحلل المالي</title>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <!-- Styles: modern gradient + glass -->
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff;
      --glass: rgba(255,255,255,0.6);
      --accent1:#0d6efd; --accent2:#6610f2;
      --text:#0b1220; --muted:#6c757d;
      --glass-border: rgba(13,110,253,0.06);
      --radius:12px;
    }
    [data-theme="dark"]{
      --bg:#071018; --card:#07131a; --glass: rgba(6,10,15,0.65);
      --text:#e6eef6; --muted:#9aa6b2;
    }
    html,body{height:100%;margin:0;font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,var(--bg),#eaf0ff); color:var(--text); -webkit-font-smoothing:antialiased;}
    .container{max-width:1200px;margin:20px auto;padding:18px}
    .site-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,var(--glass), rgba(255,255,255,0.2));backdrop-filter: blur(8px);border:1px solid var(--glass-border)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;border-radius:8px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:transparent}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 8px 30px rgba(102,16,242,0.08)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(2,6,23,0.04);border:1px solid rgba(13,110,253,0.03);margin-top:14px}
    h2{margin:0 0 10px 0}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} .controls{flex-wrap:wrap} }
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:center}
    th{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none}
    .muted{color:var(--muted)}
    .analysis-comment{background:linear-gradient(90deg, rgba(13,110,253,0.04), rgba(102,16,242,0.02));padding:10px;border-radius:8px;margin-top:10px}
    .chart-wrap{height:240px}
    .control-inline{display:flex;gap:8px;align-items:center}
    .stat{font-weight:800;font-size:1.05rem}
    .small{font-size:.9rem;color:var(--muted)}
    .kpi-row{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{flex:1;min-width:160px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#f3f7ff);box-shadow:0 6px 20px rgba(2,6,23,0.03);text-align:center}
    /* responsive */
  </style>
</head>
<body data-theme="light">
  <div class="container" id="pageRoot">
    <header class="site-header" role="banner" aria-label="header">
      <div class="brand">
        <img id="brandLogo" src="assets/logo.png" alt="logo" onerror="this.style.display='none'">
        <div>
          <div id="brandTitle" style="font-weight:900">المحلل المالي — Advanced</div>
          <div id="brandSub" class="small muted">تحليلات مالية متقدمة</div>
        </div>
      </div>

      <div class="controls" role="navigation" aria-label="controls">
        <div class="control-inline">
          <select id="sourceSelect" class="btn" title="مصدر البيانات" aria-label="مصدر البيانات">
            <option value="auto">اختر مصدر البيانات — تلقائي</option>
            <option value="financialData">من صفحة التقرير (recommend)</option>
            <option value="trialData">من صفحة الإدخال</option>
            <option value="sample">عرض تجريبي</option>
          </select>
          <select id="langSelect" class="btn" aria-label="اللغة">
            <option value="ar">العربية</option>
            <option value="en">English</option>
          </select>
          <select id="currencySelect" class="btn" aria-label="العملة">
            <option value="EGP">ج.م (EGP)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (€)</option>
          </select>
          <button id="darkToggle" class="btn" title="وضع ليلي">🌙</button>
        </div>

        <div style="width:12px"></div>

        <div class="toolbar">
          <button id="backToReport" class="btn" title="العودة للتقرير">⤺ الرجوع للتقرير</button>
          <button id="goReport" class="btn primary" title="عرض التقرير">عرض التقرير</button>
          <button id="exportPdf" class="btn" title="تصدير PDF">📄 تصدير PDF</button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main>
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <h2 id="titleMain">التحليلات المتقدمة</h2>
            <div id="subtitle" class="small muted">نظرة مُعمّقة على الأداء المالي والتنبؤات والمخاطر</div>
          </div>
          <div style="text-align:right">
            <div class="small muted" id="dataStatus">جلب البيانات...</div>
            <div class="small muted" id="lastUpdated"></div>
          </div>
        </div>

        <!-- KPIs -->
        <div class="kpi-row" id="kpiRow" style="margin-top:12px"></div>

        <!-- Summary + Charts -->
        <div class="grid" style="margin-top:12px">
          <div class="card">
            <h3 id="bsTitleSmall">ملخص الأداء</h3>
            <div id="summaryTableHolder"></div>
            <div class="analysis-comment" id="summaryComment"></div>
          </div>

          <div class="card">
            <h3 id="chartTitle">مخططات</h3>
            <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
            <div class="small muted" id="chartHint">التحديث آليًا مع كل تغيير.</div>
          </div>
        </div>
      </section>

      <!-- Ratios and Comments -->
      <section class="card" id="ratiosSection">
        <h2 id="ratiosTitle">النسب والمؤشرات</h2>
        <div id="ratiosTableHolder"></div>
        <div class="analysis-comment" id="ratiosComment"></div>
      </section>

      <!-- Forecast & Risk -->
      <section class="card" id="forecastSection">
        <h2 id="forecastTitle">التنبؤ والمخاطرة</h2>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div style="flex:1">
            <label class="small muted" id="forecastHorizonLabel">أفق التنبؤ (سنة):</label>
            <input id="forecastHorizon" class="btn" type="number" min="1" max="10" value="3" style="width:80px">
          </div>
          <div>
            <button id="runForecast" class="btn primary">تشغيل التنبؤ</button>
          </div>
        </div>

        <div style="margin-top:12px" id="forecastResultHolder"></div>
        <div class="analysis-comment" id="forecastComment"></div>
      </section>

      <!-- Detailed tables -->
      <section class="card" id="detailsSection">
        <h2 id="detailsTitle">تفاصيل البيانات (قابلة للتبديل)</h2>
        <div id="detailsTables"></div>
      </section>
    </main>

    <footer style="margin-top:14px;text-align:center" class="small muted">© 2025 المحلل المالي — Advanced Analytics</footer>
  </div>

  <!-- Script: logic -->
  <script>
  /**********************
   * Translations object
   **********************/
  const translations = {
    ar: {
      titleMain: "التحليلات المتقدمة",
      subtitle: "نظرة مُعمّقة على الأداء المالي والتنبؤات والمخاطر",
      dataStatusFetching: "يحاول جلب البيانات من LocalStorage...",
      dataStatusLoaded: "تم جلب البيانات من: ",
      dataStatusSample: "عرض تجريبي",
      bsTitleSmall: "ملخص الأداء",
      chartTitle: "مخططات",
      ratiosTitle: "النسب والمؤشرات",
      forecastTitle: "التنبؤ والمخاطرة",
      forecastHorizonLabel: "أفق التنبؤ (سنة):",
      runForecast: "تشغيل التنبؤ",
      detailsTitle: "تفاصيل البيانات (قابلة للتبديل)",
      backToReport: "الرجوع للتقرير",
      goReport: "عرض التقرير",
      exportPdf: "تصدير PDF",
      noData: "لا توجد بيانات متاحة — استخدم صفحة الإدخال/الرفع أو اختر 'عرض تجريبي'.",
      kpi_accounts: "حسابات",
      kpi_assets: "أصول (صافي)",
      kpi_liab: "خصوم",
      kpi_rev: "إيرادات",
      kpi_exp: "مصروفات",
      comment_assets_good: "الأصول تبدو قوية بالنسبة للحجم الكلي — سيولة متاحة لتغطية العمليات.",
      comment_assets_warning: "الأصول مرتفعة لكن قد تحتاج تحليل جودة الأصول (مخزون/ذمم).",
      comment_liab_good: "مستوى الخصوم مقبول بالنسبة لهيكل رأس المال.",
      comment_liab_warning: "الخصوم مرتفعة — راجع التزامات قصيرة الأجل وتمويل التشغيل.",
      forecastResultTitle: "نتائج التنبؤ (تقديري)",
      forecastCommentGood: "النمو المتوقع إيجابي ومستقر ضمن سيناريو محافظ.",
      forecastCommentWarn: "النمو المتوقّع متقلب — ضع سيناريوهات بديلة وراجع افتراضات الإيرادات.",
      ratios_expl: "الشرح: التعليقات أدناه تشرح كل مؤشر بطريقة مبسطة للمحاسبين وغير المتخصصين."
    },
    en: {
      titleMain: "Advanced Analytics",
      subtitle: "Deep view of financial performance, forecasts and risks",
      dataStatusFetching: "Attempting to fetch data from LocalStorage...",
      dataStatusLoaded: "Data loaded from: ",
      dataStatusSample: "Sample data",
      bsTitleSmall: "Performance Summary",
      chartTitle: "Charts",
      ratiosTitle: "Ratios & Metrics",
      forecastTitle: "Forecast & Risk",
      forecastHorizonLabel: "Forecast horizon (yrs):",
      runForecast: "Run Forecast",
      detailsTitle: "Data Details (toggleable)",
      backToReport: "Back to Report",
      goReport: "Open Report",
      exportPdf: "Export PDF",
      noData: "No data available — use input/upload page or select 'sample'.",
      kpi_accounts: "Accounts",
      kpi_assets: "Assets (net)",
      kpi_liab: "Liabilities",
      kpi_rev: "Revenue",
      kpi_exp: "Expense",
      comment_assets_good: "Assets look healthy relative to size — liquidity available to run operations.",
      comment_assets_warning: "Assets are high; inspect asset quality (inventory/receivables).",
      comment_liab_good: "Liabilities level acceptable for capital structure.",
      comment_liab_warning: "Liabilities are high — review short-term obligations and financing.",
      forecastResultTitle: "Forecast Results (est.)",
      forecastCommentGood: "Expected growth is positive and stable under a conservative scenario.",
      forecastCommentWarn: "Forecast is volatile — run alternative scenarios and check revenue assumptions.",
      ratios_expl: "Notes: Comments explain each metric simply for accountants and non-specialists."
    }
  };

  // Current UI state
  let STATE = {
    lang: localStorage.getItem('fa_lang') || 'ar',
    theme: localStorage.getItem('fa_theme') || 'light',
    currency: localStorage.getItem('fa_currency') || 'EGP',
    source: 'auto',
    data: null
  };

  // Utility: translations getter
  function tr(key){ return translations[STATE.lang][key] || key; }

  // DOM refs
  const langSelect = document.getElementById('langSelect');
  const currencySelect = document.getElementById('currencySelect');
  const dataStatus = document.getElementById('dataStatus');
  const lastUpdated = document.getElementById('lastUpdated');
  const sourceSelect = document.getElementById('sourceSelect');
  const darkToggle = document.getElementById('darkToggle');
  const kpiRow = document.getElementById('kpiRow');
  const summaryTableHolder = document.getElementById('summaryTableHolder');
  const summaryComment = document.getElementById('summaryComment');
  const ratiosTableHolder = document.getElementById('ratiosTableHolder');
  const ratiosComment = document.getElementById('ratiosComment');
  const forecastResultHolder = document.getElementById('forecastResultHolder');
  const forecastComment = document.getElementById('forecastComment');
  const detailsTables = document.getElementById('detailsTables');
  const brandTitle = document.getElementById('brandTitle');
  const brandSub = document.getElementById('brandSub');
  const titleMain = document.getElementById('titleMain');
  const subtitle = document.getElementById('subtitle');
  const bsTitleSmall = document.getElementById('bsTitleSmall');
  const chartTitle = document.getElementById('chartTitle');
  const ratiosTitle = document.getElementById('ratiosTitle');
  const forecastTitle = document.getElementById('forecastTitle');
  const forecastHorizonInput = document.getElementById('forecastHorizon');
  const runForecastBtn = document.getElementById('runForecast');
  const backToReport = document.getElementById('backToReport');
  const goReport = document.getElementById('goReport');
  const exportPdfBtn = document.getElementById('exportPdf');

  // chart instance
  let mainChart = null;

  /**********************
   * Initialization
   **********************/
  function initUI(){
    // load prefs
    STATE.lang = localStorage.getItem('fa_lang') || STATE.lang;
    STATE.theme = localStorage.getItem('fa_theme') || STATE.theme;
    STATE.currency = localStorage.getItem('fa_currency') || STATE.currency;

    langSelect.value = STATE.lang;
    currencySelect.value = STATE.currency;
    document.body.setAttribute('data-theme', STATE.theme);
    darkToggle.textContent = (STATE.theme === 'dark') ? '☀️' : '🌙';

    // set labels
    applyTranslations();

    // events
    langSelect.addEventListener('change', ()=>{ STATE.lang = langSelect.value; localStorage.setItem('fa_lang', STATE.lang); applyTranslations(); renderAll(); });
    currencySelect.addEventListener('change', ()=>{ STATE.currency = currencySelect.value; localStorage.setItem('fa_currency', STATE.currency); renderAll(); });
    sourceSelect.addEventListener('change', ()=>{ STATE.source = sourceSelect.value; loadDataAndRender(); });
    darkToggle.addEventListener('click', ()=>{ STATE.theme = (STATE.theme === 'dark') ? 'light' : 'dark'; localStorage.setItem('fa_theme', STATE.theme); document.body.setAttribute('data-theme', STATE.theme); darkToggle.textContent = (STATE.theme === 'dark') ? '☀️' : '🌙'; });

    runForecastBtn.addEventListener('click', runForecast);
    backToReport.addEventListener('click', ()=> window.location.href = 'report.html');
    goReport.addEventListener('click', ()=> window.location.href = 'report.html');
    exportPdfBtn.addEventListener('click', exportPDF);

    // initial load
    loadDataAndRender();
  }

  function applyTranslations(){
    titleMain.textContent = tr('titleMain');
    subtitle.textContent = tr('subtitle');
    document.getElementById('dataStatus').textContent = tr('dataStatusFetching');
    bsTitleSmall.textContent = tr('bsTitleSmall');
    chartTitle.textContent = tr('chartTitle');
    ratiosTitle.textContent = tr('ratiosTitle');
    forecastTitle.textContent = tr('forecastTitle');
    document.getElementById('forecastHorizonLabel').textContent = tr('forecastHorizonLabel');
    runForecastBtn.textContent = tr('runForecast');
    document.getElementById('detailsTitle').textContent = tr('detailsTitle');
    backToReport.textContent = tr('backToReport');
    goReport.textContent = tr('goReport');
    exportPdfBtn.textContent = tr('exportPdf');
  }

  /**********************
   * Data loading
   **********************/
  function loadDataAndRender(){
    // priority logic: sourceSelect or auto:
    let chosen = STATE.source || sourceSelect.value || 'auto';
    if(chosen === 'auto' || chosen === 'financialData'){
      // try financialData first
      const fd = localStorage.getItem('financialData');
      if(fd){
        STATE.data = safeParse(fd);
        dataLoaded('financialData');
        return;
      }
      // fallback to trialData
      const td = localStorage.getItem('trialData');
      if(td){
        STATE.data = safeParse(td);
        dataLoaded('trialData');
        return;
      }
    }
    if(chosen === 'trialData'){
      const td = localStorage.getItem('trialData');
      if(td){ STATE.data = safeParse(td); dataLoaded('trialData'); return; }
    }
    if(chosen === 'sample' || chosen === 'auto'){
      // load sample demo data embedded
      STATE.data = sampleData();
      dataLoaded('sample');
      return;
    }

    // nothing found
    STATE.data = null;
    dataStatus.textContent = tr('noData');
    lastUpdated.textContent = '';
    renderEmpty();
  }

  function safeParse(str){ try{ return JSON.parse(str); }catch(e){ return null; } }
  function dataLoaded(key){
    dataStatus.textContent = tr('dataStatusLoaded') + (key === 'sample' ? tr('dataStatusSample') : key);
    lastUpdated.textContent = (new Date()).toLocaleString();
    renderAll();
  }

  /**********************
   * Sample demo data
   **********************/
  function sampleData(){
    // structure: array of rows {Account,Type,Code,Debit,Credit} OR a financial summary object
    // We'll prepare both possibilities for better compatibility.
    return {
      meta:{ company:'Demo Co.', period:'FY 2024' },
      trialData:[
        {Account:'النقد',Type:'نقد / Cash',Code:'101',Debit:200000,Credit:0},
        {Account:'البنك',Type:'بنك / Bank',Code:'102',Debit:150000,Credit:0},
        {Account:'الزبائن',Type:'ذمم مدينة / Accounts Receivable',Code:'103',Debit:250000,Credit:0},
        {Account:'المخزون',Type:'مخزون / Inventory',Code:'104',Debit:180000,Credit:0},
        {Account:'المبيعات',Type:'إيرادات / Revenue',Code:'401',Debit:0,Credit:1200000},
        {Account:'تكلفة المبيعات',Type:'تكلفة المبيعات / COGS',Code:'501',Debit:500000,Credit:0},
        {Account:'المصروفات',Type:'مصروفات تشغيلية / Operating Expense',Code:'502',Debit:300000,Credit:0},
        {Account:'الموردون',Type:'ذمم دائنة / Accounts Payable',Code:'201',Debit:0,Credit:400000},
        {Account:'القروض',Type:'قروض قصيرة الأجل / Short-term Loans',Code:'202',Debit:0,Credit:150000},
        {Account:'رأس المال',Type:'حقوق الملكية / Equity',Code:'301',Debit:0,Credit:400000},
      ],
      // time series for revenue (years) for forecasting/demo
      timeseries:{
        years:[2020,2021,2022,2023],
        revenue:[700000,900000,1050000,1200000],
        expenses:[450000,520000,600000,800000]
      }
    };
  }

  /**********************
   * Rendering: main
   **********************/
  function renderAll(){
    if(!STATE.data){ renderEmpty(); return; }
    // normalize: if it's array assume trialData
    let dataObj = STATE.data;
    if(Array.isArray(STATE.data)) dataObj = { trialData: STATE.data };

    // derive aggregates
    const agg = aggregateData(dataObj.trialData || []);
    renderKPIs(agg);
    renderSummary(agg);
    renderChart(dataObj.timeseries || agg.timeseries);
    renderRatios(agg);
    renderDetails(dataObj);
    // reset forecast area
    forecastResultHolder.innerHTML = '';
    forecastComment.innerHTML = '';
  }

  function renderEmpty(){
    kpiRow.innerHTML = '';
    summaryTableHolder.innerHTML = '<div class="muted">'+tr('noData')+'</div>';
    ratiosTableHolder.innerHTML = '';
    detailsTables.innerHTML = '';
    if(mainChart){ mainChart.destroy(); mainChart = null; }
  }

  /**********************
   * Aggregation helpers
   **********************/
  function aggregateData(rows){
    // returns sums and tries to find revenue/expense totals
    const res = { totalDebit:0, totalCredit:0, accounts: rows.length, assets:0, liabilities:0, revenue:0, expense:0, timeseries: null };

    rows.forEach(r=>{
      const dr = Number(r.Debit || 0);
      const cr = Number(r.Credit || 0);
      res.totalDebit += dr; res.totalCredit += cr;

      const name = (r.Type || r.Account || '').toString().toLowerCase();
      const acc = (r.Account||'').toString().toLowerCase();
      // simple classification heuristics
      if(/asset|أصل|cash|bank|نقد|bank|inventory|مخزون|fixed asset|أصول/.test(name) || /النقد|البنك|مخزون|أصول/.test(acc)){
        res.assets += (dr - cr);
      } else if(/liab|خصوم|payable|loan|ذمم دائنة|قرض/.test(name) || /الموردون|قروض|قرض/.test(acc)){
        res.liabilities += (cr - dr);
      } else if(/revenue|sales|إيراد|مبيعات/.test(name) || /مبيعات|إيرادات/.test(acc)){
        res.revenue += (cr - dr);
      } else if(/expense|مصروف|cogs|تكلفة|مصاريف|مصروفات/.test(name) || /تكلفة|مصروفات|مصاريف/.test(acc)){
        res.expense += (dr - cr);
      } else {
        // unknown: add to assets as neutral default if debit>credit
        if(dr - cr > 0) res.assets += (dr - cr); else res.liabilities += (cr - dr);
      }
    });

    // If data contains timeseries attach it
    if(STATE.data && STATE.data.timeseries){
      res.timeseries = STATE.data.timeseries;
    }

    return res;
  }

  /**********************
   * KPIs
   **********************/
  function renderKPIs(agg){
    kpiRow.innerHTML = '';
    const items = [
      {label: tr('kpi_accounts'), value: agg.accounts},
      {label: tr('kpi_assets'), value: formatMoney(agg.assets)},
      {label: tr('kpi_liab'), value: formatMoney(agg.liabilities)},
      {label: tr('kpi_rev'), value: formatMoney(agg.revenue)},
      {label: tr('kpi_exp'), value: formatMoney(agg.expense)}
    ];
    items.forEach(it=>{
      const div = document.createElement('div'); div.className='kpi';
      div.innerHTML = `<div class="small muted">${it.label}</div><div class="stat">${it.value}</div>`;
      kpiRow.appendChild(div);
    });
  }

  /**********************
   * Summary
   **********************/
  function renderSummary(agg){
    // quick table
    const html = `
      <table>
        <thead><tr><th>${STATE.lang==='ar'?'البند':'Item'}</th><th>${STATE.lang==='ar'?'القيمة':'Value'}</th></tr></thead>
        <tbody>
          <tr><td>${STATE.lang==='ar'?'إجمالي الأصول':'Total Assets'}</td><td>${formatMoney(agg.assets)}</td></tr>
          <tr><td>${STATE.lang==='ar'?'إجمالي الخصوم':'Total Liabilities'}</td><td>${formatMoney(agg.liabilities)}</td></tr>
          <tr><td>${STATE.lang==='ar'?'الإيرادات':'Revenue'}</td><td>${formatMoney(agg.revenue)}</td></tr>
          <tr><td>${STATE.lang==='ar'?'المصروفات':'Expense'}</td><td>${formatMoney(agg.expense)}</td></tr>
        </tbody>
      </table>
    `;
    summaryTableHolder.innerHTML = html;

    // comment: simple rules
    let comments = [];
    if(agg.assets > agg.liabilities) comments.push(tr('comment_assets_good')); else comments.push(tr('comment_assets_warning'));
    if(agg.liabilities < agg.assets*0.6) comments.push(tr('comment_liab_good')); else comments.push(tr('comment_liab_warning'));
    summaryComment.innerHTML = comments.map(c => `<div>${c}</div>`).join('');
  }

  /**********************
   * Chart
   **********************/
  function renderChart(timeseries){
    const ctx = document.getElementById('mainChart').getContext('2d');
    if(mainChart) try{ mainChart.destroy(); }catch(e){}
    if(!timeseries){
      // fallback: chart assets vs liabilities vs revenue
      mainChart = new Chart(ctx, {
        type: 'doughnut',
        data:{
          labels: [STATE.lang==='ar'?'أصول':'Assets', STATE.lang==='ar'?'خصوم':'Liabilities', STATE.lang==='ar'?'إيرادات':'Revenue'],
          datasets:[{data:[1,1,1], backgroundColor:['#0d6efd','#dc3545','#198754']}]
        },
        options:{responsive:true}
      });
      return;
    }

    // prepare datasets
    const labels = timeseries.years.map(String);
    const datasets = [];
    if(timeseries.revenue) datasets.push({ label: STATE.lang==='ar'?'الإيرادات':'Revenue', data: timeseries.revenue, borderColor:'#0d6efd', tension:0.2, fill:false });
    if(timeseries.expenses) datasets.push({ label: STATE.lang==='ar'?'المصروفات':'Expenses', data: timeseries.expenses, borderColor:'#dc3545', tension:0.2, fill:false });
    mainChart = new Chart(ctx, { type:'line', data:{ labels, datasets }, options:{ responsive:true, plugins:{legend:{position:'bottom'} } } });
  }

  /**********************
   * Ratios & comments
   **********************/
  function renderRatios(agg){
    // compute common ratios (guard against zero)
    const currentRatio = safeDiv(agg.assets, agg.liabilities);
    const debtToEquity = safeDiv(agg.liabilities, (agg.assets - agg.liabilities));
    const profit = agg.revenue - agg.expense;
    const netMargin = safeDiv(profit, agg.revenue);
    const roe = safeDiv(profit, (agg.assets - agg.liabilities));
    const roa = safeDiv(profit, agg.assets);

    const rows = [
      {name: STATE.lang==='ar'?'نسبة التداول (Current Ratio)':'Current Ratio', value: formatPct(currentRatio)},
      {name: STATE.lang==='ar'?'نسبة الدين إلى حقوق الملكية':'Debt to Equity', value: formatNum(debtToEquity)},
      {name: STATE.lang==='ar'?'هامش صافي الربح':'Net Margin', value: formatPct(netMargin)},
      {name: STATE.lang==='ar'?'العائد على حقوق الملكية':'ROE', value: formatPct(roe)},
      {name: STATE.lang==='ar'?'العائد على إجمالي الأصول':'ROA', value: formatPct(roa)},
    ];

    let html = `<table><thead><tr><th>${STATE.lang==='ar'?'المؤشر':'Metric'}</th><th>${STATE.lang==='ar'?'القيمة':'Value'}</th><th>${STATE.lang==='ar'?'التفسير':'Interpretation'}</th></tr></thead><tbody>`;
    rows.forEach(r=>{
      html += `<tr><td>${r.name}</td><td>${r.value}</td><td>${interpretRatio(r.name, r.value)}</td></tr>`;
    });
    html += `</tbody></table><div class="small muted" style="margin-top:8px">${tr('ratios_expl')}</div>`;
    ratiosTableHolder.innerHTML = html;

    // summary comment
    ratiosComment.innerHTML = `<div>${STATE.lang==='ar'?'نظرة عامة':'Overview'}: ${formatMoney(agg.assets)} / ${formatMoney(agg.liabilities)}</div>`;
  }

  function interpretRatio(name, rawValue){
    // simple multilingual commentary based on thresholds
    const v = parseFloat(String(rawValue).replace('%','')) || 0;
    if(name.includes('Current') || name.includes('نسبة التداول')){
      if(v >= 200) return STATE.lang==='ar'?'قوي — سيولة جيدة':'Healthy — good liquidity';
      if(v >= 100) return STATE.lang==='ar'?'مقبول — تحتاج متابعة':'Acceptable — monitor';
      return STATE.lang==='ar'?'ضعيف — قد تواجه صعوبات سيولة':'Weak — potential liquidity issues';
    }
    if(name.includes('Debt') || name.includes('الديون')){
      if(v <= 1) return STATE.lang==='ar'?'آمن — هيكل تمويل محافظ':'Conservative financing structure';
      if(v <= 2) return STATE.lang==='ar'?'مقبول — مراقبة':'Moderate — monitor';
      return STATE.lang==='ar'?'مرتفع — تحقق من التزامات التمويل':'High — review financing obligations';
    }
    if(name.includes('Net Margin') || name.includes('هامش صافي')){
      if(v >= 20) return STATE.lang==='ar'?'ممتاز — ربحية عالية':'Excellent — high profitability';
      if(v >= 5) return STATE.lang==='ar'?'جيد — ربحية معقولة':'Good — reasonable profitability';
      return STATE.lang==='ar'?'ضعيف — ضع خطة لتحسين الهامش':'Low — consider margin improvement';
    }
    if(name.includes('ROE')||name.includes('العائد على حقوق')){
      if(v >= 15) return STATE.lang==='ar'?'قوي — عائد مناسب للمستثمرين':'Strong — attractive to equity holders';
      if(v >= 5) return STATE.lang==='ar'?'مقبول':'Acceptable';
      return STATE.lang==='ar'?'ضعيف — راجع كفاءة رأس المال':'Weak — review capital efficiency';
    }
    if(name.includes('ROA')||name.includes('العائد على إجمالي')){
      if(v >= 8) return STATE.lang==='ar'?'جيد':'Good';
      if(v >= 2) return STATE.lang==='ar'?'مقبول':'Acceptable';
      return STATE.lang==='ar'?'ضعيف':'Weak';
    }
    return '';
  }

  /**********************
   * Forecast & Risk
   **********************/
  function runForecast(){
    if(!STATE.data || (!STATE.data.timeseries && !STATE.data.trialData)){
      forecastResultHolder.innerHTML = `<div class="muted">${tr('noData')}</div>`;
      return;
    }

    // use available timeseries.revenue for forecast; otherwise try to approximate from trialData
    let series = STATE.data.timeseries;
    if(!series){
      // try to construct a tiny series from trialData: not ideal — use demo fallback
      series = { years:[2020,2021,2022,2023], revenue:[700000,900000,1050000,1200000] };
    }
    const horizon = Math.max(1, Math.min(10, Number(forecastHorizonInput.value) || 3));
    const revenue = series.revenue.slice();
    const years = series.years.slice();

    // simple linear regression on revenue vs years
    const model = linearRegression(years, revenue);
    const lastYear = years[years.length-1];
    const projections = [];
    for(let i=1;i<=horizon;i++){
      const y = lastYear + i;
      const pred = model.predict(y);
      projections.push({year:y, value: Math.max(0, Math.round(pred))});
    }

    // output
    let html = `<h3>${tr('forecastResultTitle')}</h3>`;
    html += `<table><thead><tr><th>${STATE.lang==='ar'?'السنة':'Year'}</th><th>${STATE.lang==='ar'?'الإيراد المتوقع':'Projected Revenue'}</th></tr></thead><tbody>`;
    projections.forEach(p => html += `<tr><td>${p.year}</td><td>${formatMoney(p.value)}</td></tr>`);
    html += `</tbody></table>`;
    forecastResultHolder.innerHTML = html;

    // comment: volatility measure = std dev / mean
    const volatility = stddev(revenue) / (mean(revenue) || 1);
    if(volatility < 0.15){
      forecastComment.innerHTML = `<div>${tr('forecastCommentGood')}</div>`;
    } else {
      forecastComment.innerHTML = `<div>${tr('forecastCommentWarn')}</div>`;
    }
    // also plot projection appended to chart if timeseries exists
    const chartYears = years.concat(projections.map(p=>p.year));
    const chartRev = revenue.concat(projections.map(p=>p.value));
    updateMainChartWithProjection(chartYears.map(String), chartRev);
  }

  function updateMainChartWithProjection(labels, data){
    const ctx = document.getElementById('mainChart').getContext('2d');
    if(mainChart) try{ mainChart.destroy(); }catch(e){}
    mainChart = new Chart(ctx, {
      type:'line',
      data:{
        labels,
        datasets:[
          { label: STATE.lang==='ar'?'الإيرادات':'Revenue', data, borderColor:'#0d6efd', tension:0.2, fill:false }
        ]
      },
      options:{ responsive:true }
    });
  }

  /**********************
   * Details tables
   **********************/
  function renderDetails(dataObj){
    // Clear
    detailsTables.innerHTML = '';
    // trialData table
    const rows = dataObj.trialData || [];
    if(rows && rows.length){
      let html = `<h4>${STATE.lang==='ar'?'ميزان المراجعة (تفاصيل)':'Trial Balance (details)'}</h4>`;
      html += `<table><thead><tr><th>${STATE.lang==='ar'?'الحساب':'Account'}</th><th>${STATE.lang==='ar'?'النوع':'Type'}</th><th>Code</th><th>${STATE.lang==='ar'?'مدين':'Debit'}</th><th>${STATE.lang==='ar'?'دائن':'Credit'}</th></tr></thead><tbody>`;
      rows.forEach(r => html += `<tr><td>${escapeHtml(r.Account||'')}</td><td>${escapeHtml(r.Type||'')}</td><td>${escapeHtml(r.Code||'')}</td><td>${formatMoney(Number(r.Debit||0))}</td><td>${formatMoney(Number(r.Credit||0))}</td></tr>`);
      html += `</tbody></table>`;
      detailsTables.innerHTML += html;
    }

    // timeseries table
    if(dataObj.timeseries){
      let t = dataObj.timeseries;
      let html = `<h4>${STATE.lang==='ar'?'السلاسل الزمنية':'Time Series'}</h4>`;
      html += `<table><thead><tr><th>${STATE.lang==='ar'?'السنة':'Year'}</th>`;
      if(t.revenue) html += `<th>${STATE.lang==='ar'?'الإيرادات':'Revenue'}</th>`;
      if(t.expenses) html += `<th>${STATE.lang==='ar'?'المصروفات':'Expenses'}</th>`;
      html += `</tr></thead><tbody>`;
      for(let i=0;i<t.years.length;i++){
        html += `<tr><td>${t.years[i]}</td>`;
        if(t.revenue) html += `<td>${formatMoney(t.revenue[i])}</td>`;
        if(t.expenses) html += `<td>${formatMoney((t.expenses||[])[i]||0)}</td>`;
        html += `</tr>`;
      }
      html += `</tbody></table>`;
      detailsTables.innerHTML += html;
    }
  }

  /**********************
   * Helpers: formatting
   **********************/
  function formatMoney(v){
    v = Number(v||0);
    const cur = STATE.currency || 'EGP';
    const locales = { EGP:'ar-EG', USD:'en-US', EUR:'de-DE' };
    const symbol = cur === 'EGP' ? 'ج.م' : (cur === 'USD' ? '$' : '€');
    return v.toLocaleString(locales[cur]||undefined, { maximumFractionDigits:2 }) + ' ' + symbol;
  }

  function formatPct(v){
    if(isNaN(v)) return '-';
    return (v*100).toFixed(1) + '%';
  }
  function formatNum(v){ return (isFinite(v) ? Number(v).toFixed(2) : '-'); }

  function safeDiv(a,b){ if(!isFinite(a)||!isFinite(b)||b===0) return NaN; return a/b; }

  function mean(arr){ if(!arr||!arr.length) return 0; return arr.reduce((s,x)=>s+x,0)/arr.length; }
  function stddev(arr){ if(!arr||!arr.length) return 0; const m = mean(arr); return Math.sqrt(arr.reduce((s,x)=>s+Math.pow(x-m,2),0)/arr.length); }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  /**********************
   * Simple linear regression model
   **********************/
  function linearRegression(xs, ys){
    // xs, ys arrays of numbers
    const n = xs.length;
    if(n === 0) return { predict: ()=>0 };

    const mx = mean(xs), my = mean(ys);
    let num = 0, den = 0;
    for(let i=0;i<n;i++){ num += (xs[i]-mx)*(ys[i]-my); den += (xs[i]-mx)*(xs[i]-mx); }
    const slope = den === 0 ? 0 : num/den;
    const intercept = my - slope*mx;
    return {
      slope, intercept,
      predict: x => intercept + slope*x
    };
  }

  /**********************
   * Export PDF
   **********************/
  function exportPDF(){
    // use html2pdf to export container
    const opt = { margin:0.35, filename:'advanced_report.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'} };
    const el = document.getElementById('pageRoot');
    // show watermark subtle change
    html2pdf().set(opt).from(el).save();
  }

  /**********************
   * Utilities
   **********************/
  function renderNow(){ loadDataAndRender(); }
  function parseNum(v){ return Number(String(v).replace(/[^0-9.-]+/g,'')) || 0; }

  /**********************
   * Chart projection helper (called by forecast)
   **********************/
  function updateMainChartWithProjection(labels, data){ /* implemented above in runForecast */ }

  /**********************
   * Init call
   **********************/
  initUI();
  </script>
</body>
</html>
