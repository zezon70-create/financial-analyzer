<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© â€” Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ</title>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <!-- Styles: modern gradient + glass -->
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff;
      --glass: rgba(255,255,255,0.6);
      --accent1:#0d6efd; --accent2:#6610f2;
      --text:#0b1220; --muted:#6c757d;
      --glass-border: rgba(13,110,253,0.06);
      --radius:12px;
    }
    [data-theme="dark"]{
      --bg:#071018; --card:#07131a; --glass: rgba(6,10,15,0.65);
      --text:#e6eef6; --muted:#9aa6b2;
    }
    html,body{height:100%;margin:0;font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,var(--bg),#eaf0ff); color:var(--text); -webkit-font-smoothing:antialiased;}
    .container{max-width:1200px;margin:20px auto;padding:18px}
    .site-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,var(--glass), rgba(255,255,255,0.2));backdrop-filter: blur(8px);border:1px solid var(--glass-border)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:44px;border-radius:8px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:transparent}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 8px 30px rgba(102,16,242,0.08)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(2,6,23,0.04);border:1px solid rgba(13,110,253,0.03);margin-top:14px}
    h2{margin:0 0 10px 0}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} .controls{flex-wrap:wrap} }
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:center}
    th{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none}
    .muted{color:var(--muted)}
    .analysis-comment{background:linear-gradient(90deg, rgba(13,110,253,0.04), rgba(102,16,242,0.02));padding:10px;border-radius:8px;margin-top:10px}
    .chart-wrap{height:240px}
    .control-inline{display:flex;gap:8px;align-items:center}
    .stat{font-weight:800;font-size:1.05rem}
    .small{font-size:.9rem;color:var(--muted)}
    .kpi-row{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{flex:1;min-width:160px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#f3f7ff);box-shadow:0 6px 20px rgba(2,6,23,0.03);text-align:center}
    /* responsive */
  </style>
</head>
<body data-theme="light">
  <div class="container" id="pageRoot">
    <header class="site-header" role="banner" aria-label="header">
      <div class="brand">
        <img id="brandLogo" src="assets/logo.png" alt="logo" onerror="this.style.display='none'">
        <div>
          <div id="brandTitle" style="font-weight:900">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ â€” Advanced</div>
          <div id="brandSub" class="small muted">ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…Ø§Ù„ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©</div>
        </div>
      </div>

      <div class="controls" role="navigation" aria-label="controls">
        <div class="control-inline">
          <select id="sourceSelect" class="btn" title="Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" aria-label="Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
            <option value="auto">Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â€” ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
            <option value="financialData">Ù…Ù† ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (recommend)</option>
            <option value="trialData">Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</option>
            <option value="sample">Ø¹Ø±Ø¶ ØªØ¬Ø±ÙŠØ¨ÙŠ</option>
          </select>
          <select id="langSelect" class="btn" aria-label="Ø§Ù„Ù„ØºØ©">
            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
            <option value="en">English</option>
          </select>
          <select id="currencySelect" class="btn" aria-label="Ø§Ù„Ø¹Ù…Ù„Ø©">
            <option value="EGP">Ø¬.Ù… (EGP)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (â‚¬)</option>
          </select>
          <button id="darkToggle" class="btn" title="ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
        </div>

        <div style="width:12px"></div>

        <div class="toolbar">
          <button id="backToReport" class="btn" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªÙ‚Ø±ÙŠØ±">â¤º Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØªÙ‚Ø±ÙŠØ±</button>
          <button id="goReport" class="btn primary" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          <button id="exportPdf" class="btn" title="ØªØµØ¯ÙŠØ± PDF">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main>
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <h2 id="titleMain">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
            <div id="subtitle" class="small muted">Ù†Ø¸Ø±Ø© Ù…ÙØ¹Ù…Ù‘Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„ØªÙ†Ø¨Ø¤Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø±</div>
          </div>
          <div style="text-align:right">
            <div class="small muted" id="dataStatus">Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            <div class="small muted" id="lastUpdated"></div>
          </div>
        </div>

        <!-- KPIs -->
        <div class="kpi-row" id="kpiRow" style="margin-top:12px"></div>

        <!-- Summary + Charts -->
        <div class="grid" style="margin-top:12px">
          <div class="card">
            <h3 id="bsTitleSmall">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
            <div id="summaryTableHolder"></div>
            <div class="analysis-comment" id="summaryComment"></div>
          </div>

          <div class="card">
            <h3 id="chartTitle">Ù…Ø®Ø·Ø·Ø§Øª</h3>
            <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
            <div class="small muted" id="chartHint">Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¢Ù„ÙŠÙ‹Ø§ Ù…Ø¹ ÙƒÙ„ ØªØºÙŠÙŠØ±.</div>
          </div>
        </div>
      </section>

      <!-- Ratios and Comments -->
      <section class="card" id="ratiosSection">
        <h2 id="ratiosTitle">Ø§Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</h2>
        <div id="ratiosTableHolder"></div>
        <div class="analysis-comment" id="ratiosComment"></div>
      </section>

      <!-- Forecast & Risk -->
      <section class="card" id="forecastSection">
        <h2 id="forecastTitle">Ø§Ù„ØªÙ†Ø¨Ø¤ ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø±Ø©</h2>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div style="flex:1">
            <label class="small muted" id="forecastHorizonLabel">Ø£ÙÙ‚ Ø§Ù„ØªÙ†Ø¨Ø¤ (Ø³Ù†Ø©):</label>
            <input id="forecastHorizon" class="btn" type="number" min="1" max="10" value="3" style="width:80px">
          </div>
          <div>
            <button id="runForecast" class="btn primary">ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ†Ø¨Ø¤</button>
          </div>
        </div>

        <div style="margin-top:12px" id="forecastResultHolder"></div>
        <div class="analysis-comment" id="forecastComment"></div>
      </section>

      <!-- Detailed tables -->
      <section class="card" id="detailsSection">
        <h2 id="detailsTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„)</h2>
        <div id="detailsTables"></div>
      </section>
    </main>

    <footer style="margin-top:14px;text-align:center" class="small muted">Â© 2025 Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ â€” Advanced Analytics</footer>
  </div>

  <!-- Script: logic -->
  <script>
  /**********************
   * Translations object
   **********************/
  const translations = {
    ar: {
      titleMain: "Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©",
      subtitle: "Ù†Ø¸Ø±Ø© Ù…ÙØ¹Ù…Ù‘Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„ØªÙ†Ø¨Ø¤Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø±",
      dataStatusFetching: "ÙŠØ­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage...",
      dataStatusLoaded: "ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†: ",
      dataStatusSample: "Ø¹Ø±Ø¶ ØªØ¬Ø±ÙŠØ¨ÙŠ",
      bsTitleSmall: "Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡",
      chartTitle: "Ù…Ø®Ø·Ø·Ø§Øª",
      ratiosTitle: "Ø§Ù„Ù†Ø³Ø¨ ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª",
      forecastTitle: "Ø§Ù„ØªÙ†Ø¨Ø¤ ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø±Ø©",
      forecastHorizonLabel: "Ø£ÙÙ‚ Ø§Ù„ØªÙ†Ø¨Ø¤ (Ø³Ù†Ø©):",
      runForecast: "ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ†Ø¨Ø¤",
      detailsTitle: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„)",
      backToReport: "Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØªÙ‚Ø±ÙŠØ±",
      goReport: "Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±",
      exportPdf: "ØªØµØ¯ÙŠØ± PDF",
      noData: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© â€” Ø§Ø³ØªØ®Ø¯Ù… ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„/Ø§Ù„Ø±ÙØ¹ Ø£Ùˆ Ø§Ø®ØªØ± 'Ø¹Ø±Ø¶ ØªØ¬Ø±ÙŠØ¨ÙŠ'.",
      kpi_accounts: "Ø­Ø³Ø§Ø¨Ø§Øª",
      kpi_assets: "Ø£ØµÙˆÙ„ (ØµØ§ÙÙŠ)",
      kpi_liab: "Ø®ØµÙˆÙ…",
      kpi_rev: "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",
      kpi_exp: "Ù…ØµØ±ÙˆÙØ§Øª",
      comment_assets_good: "Ø§Ù„Ø£ØµÙˆÙ„ ØªØ¨Ø¯Ùˆ Ù‚ÙˆÙŠØ© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒÙ„ÙŠ â€” Ø³ÙŠÙˆÙ„Ø© Ù…ØªØ§Ø­Ø© Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.",
      comment_assets_warning: "Ø§Ù„Ø£ØµÙˆÙ„ Ù…Ø±ØªÙØ¹Ø© Ù„ÙƒÙ† Ù‚Ø¯ ØªØ­ØªØ§Ø¬ ØªØ­Ù„ÙŠÙ„ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£ØµÙˆÙ„ (Ù…Ø®Ø²ÙˆÙ†/Ø°Ù…Ù…).",
      comment_liab_good: "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®ØµÙˆÙ… Ù…Ù‚Ø¨ÙˆÙ„ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù‡ÙŠÙƒÙ„ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„.",
      comment_liab_warning: "Ø§Ù„Ø®ØµÙˆÙ… Ù…Ø±ØªÙØ¹Ø© â€” Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù‚ØµÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù„ ÙˆØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„.",
      forecastResultTitle: "Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙ†Ø¨Ø¤ (ØªÙ‚Ø¯ÙŠØ±ÙŠ)",
      forecastCommentGood: "Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ ÙˆÙ…Ø³ØªÙ‚Ø± Ø¶Ù…Ù† Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù…Ø­Ø§ÙØ¸.",
      forecastCommentWarn: "Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ù…ØªÙˆÙ‚Ù‘Ø¹ Ù…ØªÙ‚Ù„Ø¨ â€” Ø¶Ø¹ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø¨Ø¯ÙŠÙ„Ø© ÙˆØ±Ø§Ø¬Ø¹ Ø§ÙØªØ±Ø§Ø¶Ø§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª.",
      ratios_expl: "Ø§Ù„Ø´Ø±Ø­: Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø£Ø¯Ù†Ø§Ù‡ ØªØ´Ø±Ø­ ÙƒÙ„ Ù…Ø¤Ø´Ø± Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø¨Ø³Ø·Ø© Ù„Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠÙ† ÙˆØºÙŠØ± Ø§Ù„Ù…ØªØ®ØµØµÙŠÙ†."
    },
    en: {
      titleMain: "Advanced Analytics",
      subtitle: "Deep view of financial performance, forecasts and risks",
      dataStatusFetching: "Attempting to fetch data from LocalStorage...",
      dataStatusLoaded: "Data loaded from: ",
      dataStatusSample: "Sample data",
      bsTitleSmall: "Performance Summary",
      chartTitle: "Charts",
      ratiosTitle: "Ratios & Metrics",
      forecastTitle: "Forecast & Risk",
      forecastHorizonLabel: "Forecast horizon (yrs):",
      runForecast: "Run Forecast",
      detailsTitle: "Data Details (toggleable)",
      backToReport: "Back to Report",
      goReport: "Open Report",
      exportPdf: "Export PDF",
      noData: "No data available â€” use input/upload page or select 'sample'.",
      kpi_accounts: "Accounts",
      kpi_assets: "Assets (net)",
      kpi_liab: "Liabilities",
      kpi_rev: "Revenue",
      kpi_exp: "Expense",
      comment_assets_good: "Assets look healthy relative to size â€” liquidity available to run operations.",
      comment_assets_warning: "Assets are high; inspect asset quality (inventory/receivables).",
      comment_liab_good: "Liabilities level acceptable for capital structure.",
      comment_liab_warning: "Liabilities are high â€” review short-term obligations and financing.",
      forecastResultTitle: "Forecast Results (est.)",
      forecastCommentGood: "Expected growth is positive and stable under a conservative scenario.",
      forecastCommentWarn: "Forecast is volatile â€” run alternative scenarios and check revenue assumptions.",
      ratios_expl: "Notes: Comments explain each metric simply for accountants and non-specialists."
    }
  };

  // Current UI state
  let STATE = {
    lang: localStorage.getItem('fa_lang') || 'ar',
    theme: localStorage.getItem('fa_theme') || 'light',
    currency: localStorage.getItem('fa_currency') || 'EGP',
    source: 'auto',
    data: null
  };

  // Utility: translations getter
  function tr(key){ return translations[STATE.lang][key] || key; }

  // DOM refs
  const langSelect = document.getElementById('langSelect');
  const currencySelect = document.getElementById('currencySelect');
  const dataStatus = document.getElementById('dataStatus');
  const lastUpdated = document.getElementById('lastUpdated');
  const sourceSelect = document.getElementById('sourceSelect');
  const darkToggle = document.getElementById('darkToggle');
  const kpiRow = document.getElementById('kpiRow');
  const summaryTableHolder = document.getElementById('summaryTableHolder');
  const summaryComment = document.getElementById('summaryComment');
  const ratiosTableHolder = document.getElementById('ratiosTableHolder');
  const ratiosComment = document.getElementById('ratiosComment');
  const forecastResultHolder = document.getElementById('forecastResultHolder');
  const forecastComment = document.getElementById('forecastComment');
  const detailsTables = document.getElementById('detailsTables');
  const brandTitle = document.getElementById('brandTitle');
  const brandSub = document.getElementById('brandSub');
  const titleMain = document.getElementById('titleMain');
  const subtitle = document.getElementById('subtitle');
  const bsTitleSmall = document.getElementById('bsTitleSmall');
  const chartTitle = document.getElementById('chartTitle');
  const ratiosTitle = document.getElementById('ratiosTitle');
  const forecastTitle = document.getElementById('forecastTitle');
  const forecastHorizonInput = document.getElementById('forecastHorizon');
  const runForecastBtn = document.getElementById('runForecast');
  const backToReport = document.getElementById('backToReport');
  const goReport = document.getElementById('goReport');
  const exportPdfBtn = document.getElementById('exportPdf');

  // chart instance
  let mainChart = null;

  /**********************
   * Initialization
   **********************/
  function initUI(){
    // load prefs
    STATE.lang = localStorage.getItem('fa_lang') || STATE.lang;
    STATE.theme = localStorage.getItem('fa_theme') || STATE.theme;
    STATE.currency = localStorage.getItem('fa_currency') || STATE.currency;

    langSelect.value = STATE.lang;
    currencySelect.value = STATE.currency;
    document.body.setAttribute('data-theme', STATE.theme);
    darkToggle.textContent = (STATE.theme === 'dark') ? 'â˜€ï¸' : 'ğŸŒ™';

    // set labels
    applyTranslations();

    // events
    langSelect.addEventListener('change', ()=>{ STATE.lang = langSelect.value; localStorage.setItem('fa_lang', STATE.lang); applyTranslations(); renderAll(); });
    currencySelect.addEventListener('change', ()=>{ STATE.currency = currencySelect.value; localStorage.setItem('fa_currency', STATE.currency); renderAll(); });
    sourceSelect.addEventListener('change', ()=>{ STATE.source = sourceSelect.value; loadDataAndRender(); });
    darkToggle.addEventListener('click', ()=>{ STATE.theme = (STATE.theme === 'dark') ? 'light' : 'dark'; localStorage.setItem('fa_theme', STATE.theme); document.body.setAttribute('data-theme', STATE.theme); darkToggle.textContent = (STATE.theme === 'dark') ? 'â˜€ï¸' : 'ğŸŒ™'; });

    runForecastBtn.addEventListener('click', runForecast);
    backToReport.addEventListener('click', ()=> window.location.href = 'report.html');
    goReport.addEventListener('click', ()=> window.location.href = 'report.html');
    exportPdfBtn.addEventListener('click', exportPDF);

    // initial load
    loadDataAndRender();
  }

  function applyTranslations(){
    titleMain.textContent = tr('titleMain');
    subtitle.textContent = tr('subtitle');
    document.getElementById('dataStatus').textContent = tr('dataStatusFetching');
    bsTitleSmall.textContent = tr('bsTitleSmall');
    chartTitle.textContent = tr('chartTitle');
    ratiosTitle.textContent = tr('ratiosTitle');
    forecastTitle.textContent = tr('forecastTitle');
    document.getElementById('forecastHorizonLabel').textContent = tr('forecastHorizonLabel');
    runForecastBtn.textContent = tr('runForecast');
    document.getElementById('detailsTitle').textContent = tr('detailsTitle');
    backToReport.textContent = tr('backToReport');
    goReport.textContent = tr('goReport');
    exportPdfBtn.textContent = tr('exportPdf');
  }

  /**********************
   * Data loading
   **********************/
  function loadDataAndRender(){
    // priority logic: sourceSelect or auto:
    let chosen = STATE.source || sourceSelect.value || 'auto';
    if(chosen === 'auto' || chosen === 'financialData'){
      // try financialData first
      const fd = localStorage.getItem('financialData');
      if(fd){
        STATE.data = safeParse(fd);
        dataLoaded('financialData');
        return;
      }
      // fallback to trialData
      const td = localStorage.getItem('trialData');
      if(td){
        STATE.data = safeParse(td);
        dataLoaded('trialData');
        return;
      }
    }
    if(chosen === 'trialData'){
      const td = localStorage.getItem('trialData');
      if(td){ STATE.data = safeParse(td); dataLoaded('trialData'); return; }
    }
    if(chosen === 'sample' || chosen === 'auto'){
      // load sample demo data embedded
      STATE.data = sampleData();
      dataLoaded('sample');
      return;
    }

    // nothing found
    STATE.data = null;
    dataStatus.textContent = tr('noData');
    lastUpdated.textContent = '';
    renderEmpty();
  }

  function safeParse(str){ try{ return JSON.parse(str); }catch(e){ return null; } }
  function dataLoaded(key){
    dataStatus.textContent = tr('dataStatusLoaded') + (key === 'sample' ? tr('dataStatusSample') : key);
    lastUpdated.textContent = (new Date()).toLocaleString();
    renderAll();
  }

  /**********************
   * Sample demo data
   **********************/
  function sampleData(){
    // structure: array of rows {Account,Type,Code,Debit,Credit} OR a financial summary object
    // We'll prepare both possibilities for better compatibility.
    return {
      meta:{ company:'Demo Co.', period:'FY 2024' },
      trialData:[
        {Account:'Ø§Ù„Ù†Ù‚Ø¯',Type:'Ù†Ù‚Ø¯ / Cash',Code:'101',Debit:200000,Credit:0},
        {Account:'Ø§Ù„Ø¨Ù†Ùƒ',Type:'Ø¨Ù†Ùƒ / Bank',Code:'102',Debit:150000,Credit:0},
        {Account:'Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†',Type:'Ø°Ù…Ù… Ù…Ø¯ÙŠÙ†Ø© / Accounts Receivable',Code:'103',Debit:250000,Credit:0},
        {Account:'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',Type:'Ù…Ø®Ø²ÙˆÙ† / Inventory',Code:'104',Debit:180000,Credit:0},
        {Account:'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',Type:'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª / Revenue',Code:'401',Debit:0,Credit:1200000},
        {Account:'ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',Type:'ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª / COGS',Code:'501',Debit:500000,Credit:0},
        {Account:'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',Type:'Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ÙŠØ© / Operating Expense',Code:'502',Debit:300000,Credit:0},
        {Account:'Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†',Type:'Ø°Ù…Ù… Ø¯Ø§Ø¦Ù†Ø© / Accounts Payable',Code:'201',Debit:0,Credit:400000},
        {Account:'Ø§Ù„Ù‚Ø±ÙˆØ¶',Type:'Ù‚Ø±ÙˆØ¶ Ù‚ØµÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù„ / Short-term Loans',Code:'202',Debit:0,Credit:150000},
        {Account:'Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„',Type:'Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© / Equity',Code:'301',Debit:0,Credit:400000},
      ],
      // time series for revenue (years) for forecasting/demo
      timeseries:{
        years:[2020,2021,2022,2023],
        revenue:[700000,900000,1050000,1200000],
        expenses:[450000,520000,600000,800000]
      }
    };
  }

  /**********************
   * Rendering: main
   **********************/
  function renderAll(){
    if(!STATE.data){ renderEmpty(); return; }
    // normalize: if it's array assume trialData
    let dataObj = STATE.data;
    if(Array.isArray(STATE.data)) dataObj = { trialData: STATE.data };

    // derive aggregates
    const agg = aggregateData(dataObj.trialData || []);
    renderKPIs(agg);
    renderSummary(agg);
    renderChart(dataObj.timeseries || agg.timeseries);
    renderRatios(agg);
    renderDetails(dataObj);
    // reset forecast area
    forecastResultHolder.innerHTML = '';
    forecastComment.innerHTML = '';
  }

  function renderEmpty(){
    kpiRow.innerHTML = '';
    summaryTableHolder.innerHTML = '<div class="muted">'+tr('noData')+'</div>';
    ratiosTableHolder.innerHTML = '';
    detailsTables.innerHTML = '';
    if(mainChart){ mainChart.destroy(); mainChart = null; }
  }

  /**********************
   * Aggregation helpers
   **********************/
  function aggregateData(rows){
    // returns sums and tries to find revenue/expense totals
    const res = { totalDebit:0, totalCredit:0, accounts: rows.length, assets:0, liabilities:0, revenue:0, expense:0, timeseries: null };

    rows.forEach(r=>{
      const dr = Number(r.Debit || 0);
      const cr = Number(r.Credit || 0);
      res.totalDebit += dr; res.totalCredit += cr;

      const name = (r.Type || r.Account || '').toString().toLowerCase();
      const acc = (r.Account||'').toString().toLowerCase();
      // simple classification heuristics
      if(/asset|Ø£ØµÙ„|cash|bank|Ù†Ù‚Ø¯|bank|inventory|Ù…Ø®Ø²ÙˆÙ†|fixed asset|Ø£ØµÙˆÙ„/.test(name) || /Ø§Ù„Ù†Ù‚Ø¯|Ø§Ù„Ø¨Ù†Ùƒ|Ù…Ø®Ø²ÙˆÙ†|Ø£ØµÙˆÙ„/.test(acc)){
        res.assets += (dr - cr);
      } else if(/liab|Ø®ØµÙˆÙ…|payable|loan|Ø°Ù…Ù… Ø¯Ø§Ø¦Ù†Ø©|Ù‚Ø±Ø¶/.test(name) || /Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†|Ù‚Ø±ÙˆØ¶|Ù‚Ø±Ø¶/.test(acc)){
        res.liabilities += (cr - dr);
      } else if(/revenue|sales|Ø¥ÙŠØ±Ø§Ø¯|Ù…Ø¨ÙŠØ¹Ø§Øª/.test(name) || /Ù…Ø¨ÙŠØ¹Ø§Øª|Ø¥ÙŠØ±Ø§Ø¯Ø§Øª/.test(acc)){
        res.revenue += (cr - dr);
      } else if(/expense|Ù…ØµØ±ÙˆÙ|cogs|ØªÙƒÙ„ÙØ©|Ù…ØµØ§Ø±ÙŠÙ|Ù…ØµØ±ÙˆÙØ§Øª/.test(name) || /ØªÙƒÙ„ÙØ©|Ù…ØµØ±ÙˆÙØ§Øª|Ù…ØµØ§Ø±ÙŠÙ/.test(acc)){
        res.expense += (dr - cr);
      } else {
        // unknown: add to assets as neutral default if debit>credit
        if(dr - cr > 0) res.assets += (dr - cr); else res.liabilities += (cr - dr);
      }
    });

    // If data contains timeseries attach it
    if(STATE.data && STATE.data.timeseries){
      res.timeseries = STATE.data.timeseries;
    }

    return res;
  }

  /**********************
   * KPIs
   **********************/
  function renderKPIs(agg){
    kpiRow.innerHTML = '';
    const items = [
      {label: tr('kpi_accounts'), value: agg.accounts},
      {label: tr('kpi_assets'), value: formatMoney(agg.assets)},
      {label: tr('kpi_liab'), value: formatMoney(agg.liabilities)},
      {label: tr('kpi_rev'), value: formatMoney(agg.revenue)},
      {label: tr('kpi_exp'), value: formatMoney(agg.expense)}
    ];
    items.forEach(it=>{
      const div = document.createElement('div'); div.className='kpi';
      div.innerHTML = `<div class="small muted">${it.label}</div><div class="stat">${it.value}</div>`;
      kpiRow.appendChild(div);
    });
  }

  /**********************
   * Summary
   **********************/
  function renderSummary(agg){
    // quick table
    const html = `
      <table>
        <thead><tr><th>${STATE.lang==='ar'?'Ø§Ù„Ø¨Ù†Ø¯':'Item'}</th><th>${STATE.lang==='ar'?'Ø§Ù„Ù‚ÙŠÙ…Ø©':'Value'}</th></tr></thead>
        <tbody>
          <tr><td>${STATE.lang==='ar'?'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„':'Total Assets'}</td><td>${formatMoney(agg.assets)}</td></tr>
          <tr><td>${STATE.lang==='ar'?'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…':'Total Liabilities'}</td><td>${formatMoney(agg.liabilities)}</td></tr>
          <tr><td>${STATE.lang==='ar'?'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª':'Revenue'}</td><td>${formatMoney(agg.revenue)}</td></tr>
          <tr><td>${STATE.lang==='ar'?'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª':'Expense'}</td><td>${formatMoney(agg.expense)}</td></tr>
        </tbody>
      </table>
    `;
    summaryTableHolder.innerHTML = html;

    // comment: simple rules
    let comments = [];
    if(agg.assets > agg.liabilities) comments.push(tr('comment_assets_good')); else comments.push(tr('comment_assets_warning'));
    if(agg.liabilities < agg.assets*0.6) comments.push(tr('comment_liab_good')); else comments.push(tr('comment_liab_warning'));
    summaryComment.innerHTML = comments.map(c => `<div>${c}</div>`).join('');
  }

  /**********************
   * Chart
   **********************/
  function renderChart(timeseries){
    const ctx = document.getElementById('mainChart').getContext('2d');
    if(mainChart) try{ mainChart.destroy(); }catch(e){}
    if(!timeseries){
      // fallback: chart assets vs liabilities vs revenue
      mainChart = new Chart(ctx, {
        type: 'doughnut',
        data:{
          labels: [STATE.lang==='ar'?'Ø£ØµÙˆÙ„':'Assets', STATE.lang==='ar'?'Ø®ØµÙˆÙ…':'Liabilities', STATE.lang==='ar'?'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª':'Revenue'],
          datasets:[{data:[1,1,1], backgroundColor:['#0d6efd','#dc3545','#198754']}]
        },
        options:{responsive:true}
      });
      return;
    }

    // prepare datasets
    const labels = timeseries.years.map(String);
    const datasets = [];
    if(timeseries.revenue) datasets.push({ label: STATE.lang==='ar'?'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª':'Revenue', data: timeseries.revenue, borderColor:'#0d6efd', tension:0.2, fill:false });
    if(timeseries.expenses) datasets.push({ label: STATE.lang==='ar'?'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª':'Expenses', data: timeseries.expenses, borderColor:'#dc3545', tension:0.2, fill:false });
    mainChart = new Chart(ctx, { type:'line', data:{ labels, datasets }, options:{ responsive:true, plugins:{legend:{position:'bottom'} } } });
  }

  /**********************
   * Ratios & comments
   **********************/
  function renderRatios(agg){
    // compute common ratios (guard against zero)
    const currentRatio = safeDiv(agg.assets, agg.liabilities);
    const debtToEquity = safeDiv(agg.liabilities, (agg.assets - agg.liabilities));
    const profit = agg.revenue - agg.expense;
    const netMargin = safeDiv(profit, agg.revenue);
    const roe = safeDiv(profit, (agg.assets - agg.liabilities));
    const roa = safeDiv(profit, agg.assets);

    const rows = [
      {name: STATE.lang==='ar'?'Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ (Current Ratio)':'Current Ratio', value: formatPct(currentRatio)},
      {name: STATE.lang==='ar'?'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙŠÙ† Ø¥Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©':'Debt to Equity', value: formatNum(debtToEquity)},
      {name: STATE.lang==='ar'?'Ù‡Ø§Ù…Ø´ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­':'Net Margin', value: formatPct(netMargin)},
      {name: STATE.lang==='ar'?'Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©':'ROE', value: formatPct(roe)},
      {name: STATE.lang==='ar'?'Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„':'ROA', value: formatPct(roa)},
    ];

    let html = `<table><thead><tr><th>${STATE.lang==='ar'?'Ø§Ù„Ù…Ø¤Ø´Ø±':'Metric'}</th><th>${STATE.lang==='ar'?'Ø§Ù„Ù‚ÙŠÙ…Ø©':'Value'}</th><th>${STATE.lang==='ar'?'Ø§Ù„ØªÙØ³ÙŠØ±':'Interpretation'}</th></tr></thead><tbody>`;
    rows.forEach(r=>{
      html += `<tr><td>${r.name}</td><td>${r.value}</td><td>${interpretRatio(r.name, r.value)}</td></tr>`;
    });
    html += `</tbody></table><div class="small muted" style="margin-top:8px">${tr('ratios_expl')}</div>`;
    ratiosTableHolder.innerHTML = html;

    // summary comment
    ratiosComment.innerHTML = `<div>${STATE.lang==='ar'?'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©':'Overview'}: ${formatMoney(agg.assets)} / ${formatMoney(agg.liabilities)}</div>`;
  }

  function interpretRatio(name, rawValue){
    // simple multilingual commentary based on thresholds
    const v = parseFloat(String(rawValue).replace('%','')) || 0;
    if(name.includes('Current') || name.includes('Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„')){
      if(v >= 200) return STATE.lang==='ar'?'Ù‚ÙˆÙŠ â€” Ø³ÙŠÙˆÙ„Ø© Ø¬ÙŠØ¯Ø©':'Healthy â€” good liquidity';
      if(v >= 100) return STATE.lang==='ar'?'Ù…Ù‚Ø¨ÙˆÙ„ â€” ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©':'Acceptable â€” monitor';
      return STATE.lang==='ar'?'Ø¶Ø¹ÙŠÙ â€” Ù‚Ø¯ ØªÙˆØ§Ø¬Ù‡ ØµØ¹ÙˆØ¨Ø§Øª Ø³ÙŠÙˆÙ„Ø©':'Weak â€” potential liquidity issues';
    }
    if(name.includes('Debt') || name.includes('Ø§Ù„Ø¯ÙŠÙˆÙ†')){
      if(v <= 1) return STATE.lang==='ar'?'Ø¢Ù…Ù† â€” Ù‡ÙŠÙƒÙ„ ØªÙ…ÙˆÙŠÙ„ Ù…Ø­Ø§ÙØ¸':'Conservative financing structure';
      if(v <= 2) return STATE.lang==='ar'?'Ù…Ù‚Ø¨ÙˆÙ„ â€” Ù…Ø±Ø§Ù‚Ø¨Ø©':'Moderate â€” monitor';
      return STATE.lang==='ar'?'Ù…Ø±ØªÙØ¹ â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„':'High â€” review financing obligations';
    }
    if(name.includes('Net Margin') || name.includes('Ù‡Ø§Ù…Ø´ ØµØ§ÙÙŠ')){
      if(v >= 20) return STATE.lang==='ar'?'Ù…Ù…ØªØ§Ø² â€” Ø±Ø¨Ø­ÙŠØ© Ø¹Ø§Ù„ÙŠØ©':'Excellent â€” high profitability';
      if(v >= 5) return STATE.lang==='ar'?'Ø¬ÙŠØ¯ â€” Ø±Ø¨Ø­ÙŠØ© Ù…Ø¹Ù‚ÙˆÙ„Ø©':'Good â€” reasonable profitability';
      return STATE.lang==='ar'?'Ø¶Ø¹ÙŠÙ â€” Ø¶Ø¹ Ø®Ø·Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù‡Ø§Ù…Ø´':'Low â€” consider margin improvement';
    }
    if(name.includes('ROE')||name.includes('Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ‚')){
      if(v >= 15) return STATE.lang==='ar'?'Ù‚ÙˆÙŠ â€” Ø¹Ø§Ø¦Ø¯ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ†':'Strong â€” attractive to equity holders';
      if(v >= 5) return STATE.lang==='ar'?'Ù…Ù‚Ø¨ÙˆÙ„':'Acceptable';
      return STATE.lang==='ar'?'Ø¶Ø¹ÙŠÙ â€” Ø±Ø§Ø¬Ø¹ ÙƒÙØ§Ø¡Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„':'Weak â€” review capital efficiency';
    }
    if(name.includes('ROA')||name.includes('Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ')){
      if(v >= 8) return STATE.lang==='ar'?'Ø¬ÙŠØ¯':'Good';
      if(v >= 2) return STATE.lang==='ar'?'Ù…Ù‚Ø¨ÙˆÙ„':'Acceptable';
      return STATE.lang==='ar'?'Ø¶Ø¹ÙŠÙ':'Weak';
    }
    return '';
  }

  /**********************
   * Forecast & Risk
   **********************/
  function runForecast(){
    if(!STATE.data || (!STATE.data.timeseries && !STATE.data.trialData)){
      forecastResultHolder.innerHTML = `<div class="muted">${tr('noData')}</div>`;
      return;
    }

    // use available timeseries.revenue for forecast; otherwise try to approximate from trialData
    let series = STATE.data.timeseries;
    if(!series){
      // try to construct a tiny series from trialData: not ideal â€” use demo fallback
      series = { years:[2020,2021,2022,2023], revenue:[700000,900000,1050000,1200000] };
    }
    const horizon = Math.max(1, Math.min(10, Number(forecastHorizonInput.value) || 3));
    const revenue = series.revenue.slice();
    const years = series.years.slice();

    // simple linear regression on revenue vs years
    const model = linearRegression(years, revenue);
    const lastYear = years[years.length-1];
    const projections = [];
    for(let i=1;i<=horizon;i++){
      const y = lastYear + i;
      const pred = model.predict(y);
      projections.push({year:y, value: Math.max(0, Math.round(pred))});
    }

    // output
    let html = `<h3>${tr('forecastResultTitle')}</h3>`;
    html += `<table><thead><tr><th>${STATE.lang==='ar'?'Ø§Ù„Ø³Ù†Ø©':'Year'}</th><th>${STATE.lang==='ar'?'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹':'Projected Revenue'}</th></tr></thead><tbody>`;
    projections.forEach(p => html += `<tr><td>${p.year}</td><td>${formatMoney(p.value)}</td></tr>`);
    html += `</tbody></table>`;
    forecastResultHolder.innerHTML = html;

    // comment: volatility measure = std dev / mean
    const volatility = stddev(revenue) / (mean(revenue) || 1);
    if(volatility < 0.15){
      forecastComment.innerHTML = `<div>${tr('forecastCommentGood')}</div>`;
    } else {
      forecastComment.innerHTML = `<div>${tr('forecastCommentWarn')}</div>`;
    }
    // also plot projection appended to chart if timeseries exists
    const chartYears = years.concat(projections.map(p=>p.year));
    const chartRev = revenue.concat(projections.map(p=>p.value));
    updateMainChartWithProjection(chartYears.map(String), chartRev);
  }

  function updateMainChartWithProjection(labels, data){
    const ctx = document.getElementById('mainChart').getContext('2d');
    if(mainChart) try{ mainChart.destroy(); }catch(e){}
    mainChart = new Chart(ctx, {
      type:'line',
      data:{
        labels,
        datasets:[
          { label: STATE.lang==='ar'?'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª':'Revenue', data, borderColor:'#0d6efd', tension:0.2, fill:false }
        ]
      },
      options:{ responsive:true }
    });
  }

  /**********************
   * Details tables
   **********************/
  function renderDetails(dataObj){
    // Clear
    detailsTables.innerHTML = '';
    // trialData table
    const rows = dataObj.trialData || [];
    if(rows && rows.length){
      let html = `<h4>${STATE.lang==='ar'?'Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (ØªÙØ§ØµÙŠÙ„)':'Trial Balance (details)'}</h4>`;
      html += `<table><thead><tr><th>${STATE.lang==='ar'?'Ø§Ù„Ø­Ø³Ø§Ø¨':'Account'}</th><th>${STATE.lang==='ar'?'Ø§Ù„Ù†ÙˆØ¹':'Type'}</th><th>Code</th><th>${STATE.lang==='ar'?'Ù…Ø¯ÙŠÙ†':'Debit'}</th><th>${STATE.lang==='ar'?'Ø¯Ø§Ø¦Ù†':'Credit'}</th></tr></thead><tbody>`;
      rows.forEach(r => html += `<tr><td>${escapeHtml(r.Account||'')}</td><td>${escapeHtml(r.Type||'')}</td><td>${escapeHtml(r.Code||'')}</td><td>${formatMoney(Number(r.Debit||0))}</td><td>${formatMoney(Number(r.Credit||0))}</td></tr>`);
      html += `</tbody></table>`;
      detailsTables.innerHTML += html;
    }

    // timeseries table
    if(dataObj.timeseries){
      let t = dataObj.timeseries;
      let html = `<h4>${STATE.lang==='ar'?'Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ø²Ù…Ù†ÙŠØ©':'Time Series'}</h4>`;
      html += `<table><thead><tr><th>${STATE.lang==='ar'?'Ø§Ù„Ø³Ù†Ø©':'Year'}</th>`;
      if(t.revenue) html += `<th>${STATE.lang==='ar'?'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª':'Revenue'}</th>`;
      if(t.expenses) html += `<th>${STATE.lang==='ar'?'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª':'Expenses'}</th>`;
      html += `</tr></thead><tbody>`;
      for(let i=0;i<t.years.length;i++){
        html += `<tr><td>${t.years[i]}</td>`;
        if(t.revenue) html += `<td>${formatMoney(t.revenue[i])}</td>`;
        if(t.expenses) html += `<td>${formatMoney((t.expenses||[])[i]||0)}</td>`;
        html += `</tr>`;
      }
      html += `</tbody></table>`;
      detailsTables.innerHTML += html;
    }
  }

  /**********************
   * Helpers: formatting
   **********************/
  function formatMoney(v){
    v = Number(v||0);
    const cur = STATE.currency || 'EGP';
    const locales = { EGP:'ar-EG', USD:'en-US', EUR:'de-DE' };
    const symbol = cur === 'EGP' ? 'Ø¬.Ù…' : (cur === 'USD' ? '$' : 'â‚¬');
    return v.toLocaleString(locales[cur]||undefined, { maximumFractionDigits:2 }) + ' ' + symbol;
  }

  function formatPct(v){
    if(isNaN(v)) return '-';
    return (v*100).toFixed(1) + '%';
  }
  function formatNum(v){ return (isFinite(v) ? Number(v).toFixed(2) : '-'); }

  function safeDiv(a,b){ if(!isFinite(a)||!isFinite(b)||b===0) return NaN; return a/b; }

  function mean(arr){ if(!arr||!arr.length) return 0; return arr.reduce((s,x)=>s+x,0)/arr.length; }
  function stddev(arr){ if(!arr||!arr.length) return 0; const m = mean(arr); return Math.sqrt(arr.reduce((s,x)=>s+Math.pow(x-m,2),0)/arr.length); }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  /**********************
   * Simple linear regression model
   **********************/
  function linearRegression(xs, ys){
    // xs, ys arrays of numbers
    const n = xs.length;
    if(n === 0) return { predict: ()=>0 };

    const mx = mean(xs), my = mean(ys);
    let num = 0, den = 0;
    for(let i=0;i<n;i++){ num += (xs[i]-mx)*(ys[i]-my); den += (xs[i]-mx)*(xs[i]-mx); }
    const slope = den === 0 ? 0 : num/den;
    const intercept = my - slope*mx;
    return {
      slope, intercept,
      predict: x => intercept + slope*x
    };
  }

  /**********************
   * Export PDF
   **********************/
  function exportPDF(){
    // use html2pdf to export container
    const opt = { margin:0.35, filename:'advanced_report.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'} };
    const el = document.getElementById('pageRoot');
    // show watermark subtle change
    html2pdf().set(opt).from(el).save();
  }

  /**********************
   * Utilities
   **********************/
  function renderNow(){ loadDataAndRender(); }
  function parseNum(v){ return Number(String(v).replace(/[^0-9.-]+/g,'')) || 0; }

  /**********************
   * Chart projection helper (called by forecast)
   **********************/
  function updateMainChartWithProjection(labels, data){ /* implemented above in runForecast */ }

  /**********************
   * Init call
   **********************/
  initUI();
  </script>
</body>
</html>
