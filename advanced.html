<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Advanced Analytics — المحلل المالي (Ultra Pro Max)</title>

  <!-- Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --g1: #0d6efd; --g2:#7b61ff; --glass: rgba(255,255,255,0.55);
      --bg: #f4f7fb; --card: #ffffff; --text:#07101a; --muted:#6c757d;
      --radius:14px;
    }
    body{font-family:"Cairo",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto, "Helvetica Neue",Arial; margin:0; background:linear-gradient(180deg,#f6f9ff,#eef4ff); color:var(--text); -webkit-font-smoothing:antialiased;}
    body[data-theme="dark"]{ --bg:#071018; --card:#08131a; --text:#e7f1f9; --muted:#9aa6b2; background:linear-gradient(180deg,#04101a,#071620); }

    .container-main{max-width:1200px;margin:22px auto;padding:18px}
    .site-header{position:sticky;top:0;z-index:1200;padding:10px 18px;background:linear-gradient(90deg,var(--g1),var(--g2));color:#fff;border-radius:10px;box-shadow:0 8px 40px rgba(11,20,40,0.08);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{height:44px;border-radius:8px;background:rgba(255,255,255,0.08);padding:6px}
    .controls{display:flex;gap:.5rem;align-items:center}

    .card-surface{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 12px 30px rgba(2,6,23,0.04);border:1px solid rgba(255,255,255,0.06);margin-bottom:14px}
    body[data-theme="dark"] .card-surface{background:linear-gradient(180deg,#07131a,#061220); box-shadow:0 10px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03)}

    .kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin:12px 0}
    .kpi{padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(13,110,253,0.06), rgba(123,97,255,0.04));text-align:center}
    .kpi .num{font-weight:800;font-size:1.05rem}
    .kpi .label{font-size:.85rem;color:var(--muted)}

    /* table */
    .table thead th{background:transparent;border-bottom:1px solid rgba(0,0,0,0.06)}
    .analysis-grid{display:grid;grid-template-columns:1fr 420px;gap:14px;align-items:start}
    @media (max-width:1000px){ .analysis-grid{grid-template-columns:1fr} .controls{flex-wrap:wrap} .site-header{flex-direction:column;align-items:flex-start} }

    /* small helpers */
    .muted{color:var(--muted)} .btn-glow{background:linear-gradient(90deg,var(--g1),var(--g2));border:none;color:#fff}
    .toast-area{position:fixed;top:22px;left:50%;transform:translateX(-50%);z-index:2000;pointer-events:none}
    .analysis-comment{padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(13,110,253,0.03),rgba(123,97,255,0.02));min-height:72px}
    /* responsive chart container */
    .chart-wrap{height:240px}
  </style>
</head>
<body data-theme="light">
  <div class="toast-area" id="toastArea" aria-live="polite"></div>

  <header class="site-header">
    <div class="brand" title="المحلل المالي">
      <img src="assets/logo.png" alt="logo" id="brandLogo" onerror="this.style.display='none'">
      <div>
        <div style="font-weight:800;font-size:16px" id="brandTitle">المحلل المالي — Advanced</div>
        <div style="font-size:12px;opacity:.9" id="brandSub">Ultra Pro Max — تحليلات متقدمة</div>
      </div>
    </div>

    <div class="controls" role="navigation" aria-label="controls">
      <a class="btn btn-sm btn-outline-light" href="index.html" title="الصفحة الرئيسية"><i class="bi bi-house"></i></a>

      <select id="langSelect" class="form-select form-select-sm" title="اللغة" style="min-width:110px"></select>
      <select id="currencySelect" class="form-select form-select-sm" title="العملة" style="min-width:110px"></select>
      <div class="form-check form-switch mb-0" title="الوضع" style="margin-left:6px">
        <input class="form-check-input" id="darkModeToggle" type="checkbox" role="switch">
      </div>

      <button id="btnReport" class="btn btn-sm btn-outline-light ms-2" title="الرجوع للتقرير"><i class="bi bi-file-earmark-text"></i> <span id="txtReport">التقرير</span></button>
      <button id="btnUpload" class="btn btn-sm btn-outline-light ms-1" title="فتح رفع البيانات"><i class="bi bi-cloud-upload"></i> <span id="txtUpload">رفع البيانات</span></button>

      <button id="exportPdf" class="btn btn-sm btn-glow ms-2" title="تصدير PDF"><i class="bi bi-file-earmark-pdf"></i> <span id="txtExport">تصدير PDF</span></button>
    </div>
  </header>

  <main class="container-main" id="mainArea">
    <!-- header controls -->
    <section class="card-surface">
      <div class="d-flex gap-3 align-items-center justify-content-between" style="flex-wrap:wrap">
        <div>
          <h4 id="pageTitle" style="margin:0">تحليلات متقدمة — Advanced Analytics</h4>
          <div class="muted" id="pageDesc">اختر مصدر البيانات واللغة والعملة — سترى تحديثات فورية لكل التحليلات.</div>
        </div>

        <div class="d-flex gap-2 align-items-center">
          <label class="small-muted mb-0 me-2" id="labelSource">مصدر البيانات</label>
          <select id="dataSource" class="form-select form-select-sm" aria-label="مصدر البيانات" style="min-width:220px">
            <option value="auto">أوتوماتيكي — اختر المتوفر (trialData / inputData / uploadData)</option>
            <option value="trialData">من صفحة الإدخال (trialData)</option>
            <option value="inputData">من input (inputData)</option>
            <option value="uploadData">من upload (uploadData)</option>
          </select>
        </div>
      </div>
    </section>

    <!-- KPI row -->
    <section id="kpiSection" class="mt-3" aria-live="polite">
      <div class="kpi-row" id="kpiRow"></div>
    </section>

    <!-- Main analysis grid -->
    <section class="analysis-grid">
      <div>
        <!-- Financial ratios -->
        <div class="card-surface mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 id="ratiosTitle">النسب المالية الأساسية</h6>
            <div class="muted" id="ratiosHint">تحسب من مجموعات الأصناف داخل ميزان المراجعة</div>
          </div>

          <div id="ratiosTableWrap" class="table-responsive">
            <table class="table table-sm table-striped">
              <thead><tr><th id="colRatio">النسبة</th><th id="colValue">القيمة</th><th id="colComment">تحليل سريع</th></tr></thead>
              <tbody id="ratiosBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Trend & Forecast -->
        <div class="card-surface mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 id="trendTitle">اتجاهات وتوقعات</h6>
            <div class="muted" id="trendHint">يمكنك اختيار طريقة التوقع (نمو متوسط / انحدار خطي)</div>
          </div>

          <div class="row g-2">
            <div class="col-md-8">
              <div class="chart-wrap card-surface" id="trendChartWrap">
                <canvas id="trendChart"></canvas>
              </div>
            </div>
            <div class="col-md-4">
              <label class="small-muted">طريقة التنبؤ</label>
              <select id="forecastMethod" class="form-select form-select-sm mb-2">
                <option value="avg">متوسط النمو (%)</option>
                <option value="linear">انحدار خطي بسيط</option>
              </select>
              <label class="small-muted">سنوات للتنبؤ</label>
              <input id="forecastYears" class="form-control form-control-sm mb-2" type="number" min="1" value="3" />
              <div class="analysis-comment" id="forecastComment"></div>
            </div>
          </div>
        </div>

        <!-- Advanced indicators -->
        <div class="card-surface mb-3">
          <h6 id="advTitle">مؤشرات متقدمة — عائد ومخاطرة</h6>
          <div class="small-muted mb-2" id="advHint">حساب Sharpe, Debt ratios, وملخص مخاطر أساسي</div>
          <div id="advBody"></div>
        </div>

        <!-- Raw data viewer -->
        <div class="card-surface mb-3">
          <div class="d-flex justify-content-between">
            <h6 id="dataTitle">معاينة البيانات (Raw)</h6>
            <div class="muted" id="dataHint">يمكنك تعديل القيم محليًا أو إعادة التحميل من مصدر آخر</div>
          </div>
          <div class="table-responsive" style="max-height:260px;overflow:auto">
            <table class="table table-sm">
              <thead><tr><th id="hdrAccount">الحساب</th><th id="hdrType">النوع</th><th id="hdrCode">كود</th><th id="hdrDebit">مدين</th><th id="hdrCredit">دائن</th></tr></thead>
              <tbody id="rawBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- right column: comments + charts -->
      <aside>
        <div class="card-surface mb-3">
          <h6 id="summaryTitle">مُلخص ذكي</h6>
          <div id="smartSummary" class="analysis-comment">—</div>
        </div>

        <div class="card-surface mb-3">
          <h6 id="chartTitle">توزيع الفئات</h6>
          <div class="chart-wrap"><canvas id="categoryChart"></canvas></div>
        </div>

        <div class="card-surface mb-3">
          <h6 id="alertsTitle">تنبيهات وملاحظات</h6>
          <div id="alertsArea" class="small-muted"></div>
        </div>

        <div class="card-surface mb-3">
          <h6 id="actionsTitle">إجراءات سريعة</h6>
          <div class="d-grid gap-2">
            <button id="btnAddRowLocal" class="btn btn-glow btn-sm">➕ إضافة صف محلي</button>
            <button id="btnSaveLocal" class="btn btn-outline-primary btn-sm">💾 حفظ محلي</button>
            <button id="btnReload" class="btn btn-outline-secondary btn-sm">🔄 إعادة تحميل من المصدر</button>
            <button id="btnAdvancedPage" class="btn btn-outline-success btn-sm">🔬 إلى صفحة التحليلات المتقدمة (Advanced)</button>
          </div>
        </div>
      </aside>
    </section>

    <footer class="text-center small muted mt-3">&copy; 2025 المحلل المالي — Ultra Pro Max</footer>
  </main>

<script>
/* =========================
   TRANSLATIONS (full)
   ========================= */
const TRANSLATIONS = {
  ar: {
    brandTitle: "المحلل المالي — Advanced",
    brandSub: "Ultra Pro Max — تحليلات متقدمة",
    pageTitle: "تحليلات متقدمة — Advanced Analytics",
    pageDesc: "اختر مصدر البيانات واللغة والعملة — سترى تحديثات فورية لكل التحليلات.",
    labelSource: "مصدر البيانات",
    txtReport: "التقرير",
    txtUpload: "رفع البيانات",
    txtExport: "تصدير PDF",
    ratiosTitle: "النسب المالية الأساسية",
    ratiosHint: "تحسب من مجموعات الأصناف داخل ميزان المراجعة",
    trendTitle: "اتجاهات وتوقعات",
    trendHint: "يمكنك اختيار طريقة التوقع (نمو متوسط / انحدار خطي)",
    advTitle: "مؤشرات متقدمة — عائد ومخاطرة",
    advHint: "حساب Sharpe, Debt ratios, وملخص مخاطر أساسي",
    dataTitle: "معاينة البيانات (Raw)",
    dataHint: "يمكنك تعديل القيم محليًا أو إعادة التحميل من مصدر آخر",
    hdrAccount: "الحساب", hdrType: "النوع", hdrCode: "كود", hdrDebit: "مدين", hdrCredit: "دائن",
    summaryTitle: "مُلخص ذكي",
    chartTitle: "توزيع الفئات",
    alertsTitle: "تنبيهات وملاحظات",
    actionsTitle: "إجراءات سريعة",
    btnAddRow: "➕ إضافة صف محلي",
    btnSaveLocal: "💾 حفظ محلي",
    btnReload: "🔄 إعادة تحميل",
    noData: "لا توجد بيانات متاحة من المصدر المحدد.",
    exportSuccess: "تم تصدير التقرير كـ PDF.",
    savedLocal: "تم الحفظ محليًا.",
    rowAdded: "تمت إضافة صف جديد (محلي)."
  },
  en: {
    brandTitle: "Financial Analyzer — Advanced",
    brandSub: "Ultra Pro Max — Advanced Analytics",
    pageTitle: "Advanced Analytics",
    pageDesc: "Choose data source, language & currency — all analyses update live.",
    labelSource: "Data Source",
    txtReport: "Report",
    txtUpload: "Upload Data",
    txtExport: "Export PDF",
    ratiosTitle: "Key Financial Ratios",
    ratiosHint: "Calculated from trial balance categories",
    trendTitle: "Trends & Forecasts",
    trendHint: "Pick forecast method (avg growth / linear)",
    advTitle: "Advanced Indicators — Return & Risk",
    advHint: "Calculates Sharpe, Debt ratios and basic risk summary",
    dataTitle: "Raw Data Preview",
    dataHint: "Edit values locally or reload from another source",
    hdrAccount: "Account", hdrType: "Type", hdrCode: "Code", hdrDebit: "Debit", hdrCredit: "Credit",
    summaryTitle: "Smart Summary",
    chartTitle: "Category Distribution",
    alertsTitle: "Alerts & Notes",
    actionsTitle: "Quick Actions",
    btnAddRow: "➕ Add Local Row",
    btnSaveLocal: "💾 Save Locally",
    btnReload: "🔄 Reload",
    noData: "No data available from selected source.",
    exportSuccess: "Exported report as PDF.",
    savedLocal: "Saved locally.",
    rowAdded: "New row added (local)."
  }
};

let LANG = localStorage.getItem('fa_lang') || 'ar';
const LANGS = [{v:'ar',name:'العربية'},{v:'en',name:'English'}];
const CURRENCIES = ['EGP','USD','EUR'];
let currency = localStorage.getItem('fa_currency') || 'EGP';

/* =========================
   Helpers
   ========================= */
const $ = id => document.getElementById(id);
function t(key){ return (TRANSLATIONS[LANG] && TRANSLATIONS[LANG][key]) ? TRANSLATIONS[LANG][key] : key; }
function showToast(msg, type='info'){ const area = $('toastArea'); const el = document.createElement('div'); el.className = `toast align-items-center text-bg-${type} border-0 show`; el.style.minWidth='220px'; el.style.marginTop='6px'; el.style.pointerEvents='auto'; el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="اغلاق" onclick="this.closest('.toast').remove()"></button></div>`; area.appendChild(el); setTimeout(()=> el.remove(), 3800); }

/* safe numeric */
const toNum = v => { const n = Number(String(v||'').toString().replace(/[^\d.-]+/g,'')); return isNaN(n) ? 0 : n; };

/* =========================
   UI Init
   ========================= */
function populateControls(){
  const sel = $('langSelect'); sel.innerHTML=''; LANGS.forEach(l=>{ const o=document.createElement('option'); o.value=l.v; o.textContent=l.name; sel.appendChild(o); });
  $('langSelect').value = LANG;
  const cs = $('currencySelect'); cs.innerHTML=''; CURRENCIES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; cs.appendChild(o); }); $('currencySelect').value = currency;
  applyTranslations();
}
function applyTranslations(){
  // header
  $('brandTitle').textContent = t('brandTitle');
  $('brandSub').textContent = t('brandSub');
  $('pageTitle').textContent = t('pageTitle');
  $('pageDesc').textContent = t('pageDesc');
  $('labelSource').textContent = t('labelSource');
  $('txtReport').textContent = t('txtReport');
  $('txtUpload').textContent = t('txtUpload');
  $('txtExport').textContent = t('txtExport');

  // sections
  $('ratiosTitle').textContent = t('ratiosTitle');
  $('ratiosHint').textContent = t('ratiosHint');
  $('trendTitle').textContent = t('trendTitle');
  $('trendHint').textContent = t('trendHint');
  $('advTitle').textContent = t('advTitle');
  $('advHint').textContent = t('advHint');
  $('dataTitle').textContent = t('dataTitle');
  $('dataHint').textContent = t('dataHint');
  $('hdrAccount').textContent = t('hdrAccount');
  $('hdrType').textContent = t('hdrType');
  $('hdrCode').textContent = t('hdrCode');
  $('hdrDebit').textContent = t('hdrDebit');
  $('hdrCredit').textContent = t('hdrCredit');
  $('summaryTitle').textContent = t('summaryTitle');
  $('chartTitle').textContent = t('chartTitle');
  $('alertsTitle').textContent = t('alertsTitle');
  $('actionsTitle').textContent = t('actionsTitle');

  $('btnAddRowLocal').textContent = t('btnAddRow');
  $('btnSaveLocal').textContent = t('btnSaveLocal');
  $('btnReload').textContent = t('btnReload');
}
populateControls();

/* dark mode */
$('darkModeToggle').addEventListener('change', e => {
  document.body.dataset.theme = e.target.checked ? 'dark' : 'light';
  localStorage.setItem('fa_theme', document.body.dataset.theme);
});

/* language change */
$('langSelect').addEventListener('change', (e)=>{ LANG = e.target.value; localStorage.setItem('fa_lang', LANG); applyTranslations(); renderAll(); });

/* currency change */
$('currencySelect').addEventListener('change', e => { currency = e.target.value; localStorage.setItem('fa_currency', currency); renderAll(); });

/* go to report / upload */
$('btnReport').addEventListener('click', ()=> { window.location.href = 'report.html'; });
$('btnUpload').addEventListener('click', ()=> { window.location.href = 'upload.html'; });

/* export pdf */
$('exportPdf').addEventListener('click', ()=> {
  const opt = { margin:0.4, filename:'advanced_report.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'in', format:'a4', orientation:'portrait'} };
  const el = document.querySelector('main');
  html2pdf().set(opt).from(el).save().then(()=> showToast(t('exportSuccess'),'success'));
});

/* quick actions */
$('btnAddRowLocal').addEventListener('click', ()=> {
  // add an empty row to trialData local copy and save to localStorage trialData
  trialData.push({Account:'',Type:'',Code:'',Debit:0,Credit:0});
  localStorage.setItem('trialData', JSON.stringify(trialData));
  renderAll();
  showToast(t('rowAdded'),'success');
});
$('btnSaveLocal').addEventListener('click', ()=> {
  localStorage.setItem('trialData', JSON.stringify(trialData));
  showToast(t('savedLocal'),'success');
});
$('btnReload').addEventListener('click', ()=> { loadData(); renderAll(); showToast(t('savedLocal'),'info'); });

/* =========================
   Data loading (from localStorage keys)
   ========================= */
let trialData = []; // array of rows {Account,Type,Code,Debit,Credit}

function loadData(){
  const mode = $('dataSource').value || 'auto';
  const keysTry = (mode === 'trialData') ? ['trialData'] : (mode === 'inputData') ? ['inputData'] : (mode === 'uploadData') ? ['uploadData'] : ['trialData','inputData','uploadData'];
  let loaded = null;
  for(const k of keysTry){
    try{
      const raw = localStorage.getItem(k);
      if(raw){
        const arr = JSON.parse(raw);
        if(Array.isArray(arr) && arr.length){
          loaded = arr;
          break;
        }
      }
    }catch(e){ console.warn('parse fail',k); }
  }
  if(!loaded) {
    trialData = JSON.parse(localStorage.getItem('trialData')||'[]') || [];
  } else trialData = loaded.map(r => ({ Account: r.Account||r.account||'', Type: r.Type||r.type||'', Code: r.Code||r.code||'', Debit: toNum(r.Debit), Credit: toNum(r.Credit) }));
}
$('dataSource').addEventListener('change', ()=> { loadData(); renderAll(); });

/* =========================
   Aggregation helpers: compute category sums (assets, liabilities, equity, revenue, expense, other)
   Uses heuristics based on Account/Type strings
   ========================= */
function aggregateByCategory(data){
  const agg = { assets:0, liabilities:0, equity:0, revenue:0, expense:0, other:0 };
  data.forEach(r=>{
    const net = toNum(r.Debit) - toNum(r.Credit);
    const s = (r.Type || r.Account || '').toString().toLowerCase();
    if(/asset|أصل|cash|bank|current asset|نقد|bank/i.test(s)) agg.assets += net;
    else if(/liab|خصوم|payable|loan|دائن|قرض/i.test(s)) agg.liabilities += (-net);
    else if(/equity|حقوق|رأس/i.test(s)) agg.equity += (-net);
    else if(/revenue|sales|إيراد|مبيعات/i.test(s)) agg.revenue += (-net);
    else if(/expense|مصروف|cogs|تكلفة|مصاريف/i.test(s)) agg.expense += net;
    else {
      const acc = (r.Account||'').toLowerCase();
      if(/النقد|bank|cash|نقد/.test(acc)) agg.assets += net;
      else if(/المورد|payable|دائن/.test(acc)) agg.liabilities += (-net);
      else if(/رأس|equity/.test(acc)) agg.equity += (-net);
      else if(/إيراد|sales/.test(acc)) agg.revenue += (-net);
      else if(/مصروف|expense|تكلفة/.test(acc)) agg.expense += net;
      else agg.other += net;
    }
  });
  return agg;
}

/* =========================
   Ratios & analysed comments
   ========================= */
function computeRatios(agg){
  // Basic sanity: avoid division by zero
  const curRatio = (agg.assets && agg.liabilities) ? (agg.assets / (agg.liabilities || 1)) : null;
  const debtToEquity = (agg.liabilities && agg.equity) ? (agg.liabilities / (agg.equity || 1)) : null;
  const netProfit = agg.revenue - agg.expense;
  const grossMargin = (agg.revenue) ? ((agg.revenue - agg.expense) / (agg.revenue || 1)) : null; // approximate
  const roa = (agg.assets) ? (netProfit / (agg.assets || 1)) : null;
  const roe = (agg.equity) ? (netProfit / (agg.equity || 1)) : null;
  const assetTurnover = (agg.assets) ? (agg.revenue / (agg.assets || 1)) : null;

  // interest coverage (approx): not available if no interest expense, skip
  // Return object
  return {
    currentRatio: curRatio,
    debtToEquity,
    netProfit,
    grossMargin,
    roa, roe, assetTurnover
  };
}

/* generate human-friendly comments depending on value */
function commentForRatio(key, val){
  const en = (LANG === 'en');
  function c(a,b){ return en ? a : b; }
  if(val === null || val === undefined || isNaN(val)) return c('Insufficient data to compute.','لا توجد بيانات كافية للحساب.');
  switch(key){
    case 'currentRatio':
      if(val >= 2) return c('Very healthy short-term liquidity — company can comfortably meet obligations.','سيولة قصيرة الأمد قوية — الشركة قادرة على تغطية الالتزامات بسهولة.');
      if(val >= 1.2) return c('Adequate liquidity; monitor working capital closely.','سيولة كافية؛ راقب رأس المال العامل.');
      return c('Low current ratio — possible liquidity concerns, consider cash planning.','نسبة سيولة منخفضة — قد توجد مخاوف سيولة؛ خطط للنقد.');
    case 'debtToEquity':
      if(val < 0.5) return c('Low leverage — conservative capital structure.', 'رفع مالي منخفض — هيكل تمويل محافظ.');
      if(val < 2) return c('Moderate leverage — typical for many firms.', 'رفع مالي معتدل — أمر شائع.');
      return c('High leverage — financial risk elevated; review debt costs.', 'رفع مالي مرتفع — مخاطر مالية؛ راجع تكلفة الديون.');
    case 'grossMargin':
      if(val >= 0.4) return c('Strong gross margin — good pricing or low cost of sales.', 'هامش إجمالي جيد — تسعير قوي أو تكلفة مبيعات منخفضة.');
      if(val >= 0.2) return c('Acceptable gross margin; efficiency can be improved.', 'هامش مقبول؛ يمكن تحسين الكفاءة.');
      return c('Thin gross margin — pricing or costs need review.', 'هامش إجمالي ضعيف — راجع التسعير أو التكاليف.');
    case 'roa':
      if(val >= 0.1) return c('ROA healthy — assets generate good returns.', 'عائد ممتلكات جيد — الأصول تنتج عوائد جيدة.');
      if(val >= 0.03) return c('ROA moderate — room for operational improvement.', 'عائد ممتلكات متوسط — مجال لتحسين العمليات.');
      return c('Low ROA — assets underutilized or profitability weak.', 'عائد ممتلكات منخفض — استغلال الأصول ضعيف أو الربحية ضعيفة.');
    case 'roe':
      if(val >= 0.15) return c('Strong ROE — shareholders seeing good returns.', 'عائد حقوق ملكية قوي — عوائد جيدة للمساهمين.');
      if(val >= 0.07) return c('Acceptable ROE; target improvement via margin/turnover.', 'عائد حقوق ملكية مقبول؛ حسّن الهامش/الدوران.');
      return c('Low ROE — equity returns need improvement.', 'عائد حقوق ملكية منخفض — يلزم تحسين عوائد الأسهم.');
    case 'assetTurnover':
      if(val >= 1) return c('High asset turnover — efficient asset use.', 'دوران أصول عالي — استخدام فعال للأصول.');
      if(val >= 0.4) return c('Moderate turnover — potential to increase sales or streamline assets.', 'دوران معتدل — إمكانية زيادة المبيعات أو تبسيط الأصول.');
      return c('Low turnover — assets may be idle or sales low.', 'دوران أصول منخفض — أصول خاملة أو مبيعات منخفضة.');
    default:
      return '';
  }
}

/* =========================
   Renderers: KPIs / tables / charts / comments
   ========================= */
let categoryChart = null, trendChart = null;

function formatCur(v){
  const n = Number(v || 0);
  const opts = { maximumFractionDigits:2, minimumFractionDigits:0 };
  if(currency === 'EGP') return n.toLocaleString(undefined,opts) + ' ج.م';
  if(currency === 'USD') return '$' + n.toLocaleString(undefined,opts);
  if(currency === 'EUR') return '€' + n.toLocaleString(undefined,opts);
  return n.toLocaleString(undefined,opts);
}

function renderKPIs(agg){
  const k = $('kpiRow'); k.innerHTML='';
  const items = [
    {label: t('ratiosTitle'), value: Object.values(agg).reduce((s,v)=>s+Math.abs(v||0),0), isCur:true},
    {label: t('hdrAccount'), value: trialData.length, isCur:false},
    {label: t('advTitle'), value: formatCur(Math.abs(agg.revenue||0)), isCur:false},
  ];
  items.forEach(it=>{
    const d = document.createElement('div'); d.className='kpi';
    const val = it.isCur ? formatCur(it.value) : (typeof it.value === 'number' ? (it.value.toLocaleString()) : it.value);
    d.innerHTML = `<div class="label">${it.label}</div><div class="num">${val}</div>`;
    k.appendChild(d);
  });
}

function renderRawTable(){
  const body = $('rawBody'); body.innerHTML='';
  if(!trialData || !trialData.length){ body.innerHTML = `<tr><td colspan="5" class="muted">${t('noData')}</td></tr>`; return; }
  trialData.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input class="form-control form-control-sm" data-idx="${idx}" data-field="Account" value="${escapeHtml(r.Account)}"></td>
                    <td><input class="form-control form-control-sm" data-idx="${idx}" data-field="Type" value="${escapeHtml(r.Type)}"></td>
                    <td><input class="form-control form-control-sm" data-idx="${idx}" data-field="Code" value="${escapeHtml(r.Code)}"></td>
                    <td><input class="form-control form-control-sm text-end" data-idx="${idx}" data-field="Debit" value="${r.Debit}"></td>
                    <td><input class="form-control form-control-sm text-end" data-idx="${idx}" data-field="Credit" value="${r.Credit}"></td>`;
    body.appendChild(tr);
  });
  // attach handlers to inputs to update trialData
  body.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const idx = Number(e.target.dataset.idx); const field = e.target.dataset.field;
      if(!isFinite(idx)) return;
      let val = e.target.value;
      if(field==='Debit' || field==='Credit') { val = toNum(val); }
      trialData[idx][field] = val;
      localStorage.setItem('trialData', JSON.stringify(trialData));
      // re-render derived parts
      renderAll(false);
    });
  });
}

/* Chart render for category distribution */
function renderCategoryChart(agg){
  const ctx = $('categoryChart').getContext('2d');
  const labels = [ LANG==='ar' ? 'الأصول' : 'Assets', LANG==='ar' ? 'الخصوم' : 'Liabilities', LANG==='ar' ? 'الإيرادات' : 'Revenue', LANG==='ar' ? 'المصروفات' : 'Expenses', LANG==='ar' ? 'أخرى' : 'Other' ];
  const data = [Math.abs(agg.assets||0), Math.abs(agg.liabilities||0), Math.abs(agg.revenue||0), Math.abs(agg.expense||0), Math.abs(agg.other||0)];
  if(categoryChart) try{ categoryChart.destroy(); }catch(e){}
  categoryChart = new Chart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data, backgroundColor:['#0d6efd','#dc3545','#198754','#ffc107','#6c757d'] }] }, options:{plugins:{legend:{position:'bottom'}} } });
}

/* Trend/forecast chart: we create synthetic time-series from categories if no yearly series available */
function renderTrendChart(agg){
  const ctx = $('trendChart').getContext('2d');
  // create synthetic 3-year series based on simple assumptions: use assets/revenue/expense over "past 3 years" with small random/noise growth if not provided time series
  const years = [new Date().getFullYear()-2, new Date().getFullYear()-1, new Date().getFullYear()];
  // try to read from localStorage time-series keys (optional datasets: tb_timeseries)
  const tsRaw = JSON.parse(localStorage.getItem('tb_timeseries')||'null') || null;
  let labels = years.map(String), dsRevenue=[], dsExpense=[];
  if(tsRaw && Array.isArray(tsRaw) && tsRaw.length>=3){
    labels = tsRaw.map(o=>o.year);
    dsRevenue = tsRaw.map(o=>toNum(o.revenue));
    dsExpense = tsRaw.map(o=>toNum(o.expense));
  } else {
    // synthetic: split current revenue into 3 parts decreasing back by small growth
    const rev = Math.max(1, Math.abs(agg.revenue||0));
    const exp = Math.max(1, Math.abs(agg.expense||0));
    const g = 0.07; // assume modest growth
    dsRevenue = [rev/(1+g)/(1+g), rev/(1+g), rev];
    dsExpense = [exp/(1+g)/(1+g), exp/(1+g), exp];
  }

  // forecast
  const method = $('forecastMethod').value;
  const fYears = Math.max(1, parseInt($('forecastYears').value||3));
  let forecast = [];
  if(method === 'avg'){
    // compute avg growth rate of revenue
    const growths = [];
    for(let i=1;i<dsRevenue.length;i++){ const g = (dsRevenue[i]-dsRevenue[i-1])/(Math.abs(dsRevenue[i-1])||1); growths.push(g); }
    const avgG = growths.length ? (growths.reduce((s,x)=>s+x,0)/growths.length) : 0.05;
    let last = dsRevenue[dsRevenue.length-1];
    for(let y=1;y<=fYears;y++){ last = last*(1+avgG); forecast.push(Math.max(0,last)); }
  } else {
    // linear: fit slope between last and first
    const n = dsRevenue.length;
    const slope = (dsRevenue[n-1]-dsRevenue[0])/(n-1||1);
    let last = dsRevenue[n-1];
    for(let y=1;y<=fYears;y++){ last = last + slope; forecast.push(Math.max(0,last)); }
  }
  const allLabels = labels.concat(Array.from({length:fYears},(_,i)=> String((new Date().getFullYear())+i+1)));
  const allRevenue = dsRevenue.concat(forecast);
  if(trendChart) try{ trendChart.destroy(); }catch(e){}
  trendChart = new Chart(ctx, {
    type:'line',
    data:{ labels: allLabels, datasets:[ { label: LANG==='ar' ? 'الإيرادات' : 'Revenue', data: allRevenue, borderColor:'#0d6efd', fill:true, tension:0.3 } ] },
    options:{ plugins:{ legend:{display:false} } }
  });

  // forecast comment
  const avgGrowth = (dsRevenue.length>1) ? ((dsRevenue[dsRevenue.length-1]/(dsRevenue[0]||1))**(1/(dsRevenue.length-1))-1) : 0;
  const commentEl = $('forecastComment');
  const summary = LANG==='ar'
      ? `توقعات لمدة ${fYears} سنة باستخدام ${method==='avg' ? 'متوسط النمو' : 'انحدار خطي'}. معدل النمو التاريخي التقريبي: ${(avgGrowth*100).toFixed(2)}%.`
      : `Forecast for ${fYears} years using ${method==='avg' ? 'average growth' : 'linear regression'}. Approx historical growth: ${(avgGrowth*100).toFixed(2)}%.`;
  commentEl.textContent = summary;
}

/* Advanced indicators area (Sharpe approximate etc.) */
function renderAdvanced(agg){
  const area = $('advBody'); area.innerHTML='';
  const netProfit = agg.revenue - agg.expense;
  const items = [];
  items.push({title: LANG==='ar' ? 'صافي الربح' : 'Net Profit', value: formatCur(netProfit), comment: (netProfit>=0) ? (LANG==='ar' ? 'ربحية إيجابية.' : 'Positive profitability.') : (LANG==='ar' ? 'خسارة صافية.' : 'Net loss.') });
  const debtToEquity = (agg.equity!==0) ? (agg.liabilities / (agg.equity || 1)) : null;
  items.push({title: LANG==='ar' ? 'نسبة الدين إلى حقوق الملكية' : 'Debt to Equity', value: debtToEquity===null ? '-' : debtToEquity.toFixed(2), comment: commentForRatio('debtToEquity', debtToEquity) });
  // Sharpe approximation: require returns & risk info — we'll provide simplistic view if user provided series (tb_returns)
  const returnsSeries = JSON.parse(localStorage.getItem('tb_returns')||'null');
  let sharpeComment = LANG==='ar' ? 'لا توجد بيانات عوائد كافية لحساب Sharpe.' : 'No returns data for Sharpe ratio.';
  if(Array.isArray(returnsSeries) && returnsSeries.length>1){
    const rets = returnsSeries.map(v=>toNum(v));
    const avg = rets.reduce((s,x)=>s+x,0)/rets.length;
    const sd = Math.sqrt(rets.map(r=>(r-avg)*(r-avg)).reduce((s,x)=>s+x,0)/Math.max(1,rets.length-1));
    const rf = 0.02; // assumed risk-free
    const sharpe = (sd>0) ? ((avg - rf)/sd) : null;
    sharpeComment = sharpe ? `${LANG==='ar'? 'Sharpe تقريبًا: ' : 'Sharpe approx: '}${sharpe.toFixed(2)} — ${sharpe>1 ? (LANG==='ar'?'جيد':'Good') : (LANG==='ar'?'معتدل':'Moderate')}` : sharpeComment;
  }
  items.push({title: LANG==='ar' ? 'Sharpe (تقريبي)' : 'Sharpe (approx)', value: '-', comment: sharpeComment});
  // interest coverage: require interest expense and EBIT (approx netProfit + interest + tax) -> we approximate
  const interestCoverage = null;
  items.push({title: LANG==='ar' ? 'تغطية الفوائد (تقريبي)' : 'Interest Coverage (approx)', value: interestCoverage===null ? '-' : interestCoverage.toFixed(2), comment: LANG==='ar' ? 'يُحسب عند توفر بيانات الفوائد' : 'Requires interest expense data.'});

  items.forEach(it=>{
    const el = document.createElement('div');
    el.className = 'mb-2';
    el.innerHTML = `<div style="font-weight:700">${escapeHtml(it.title)} — <span style="float:left">${escapeHtml(it.value)}</span></div><div class="small-muted">${escapeHtml(it.comment)}</div>`;
    area.appendChild(el);
  });
}

/* Smart summary generation */
function generateSmartSummary(agg, ratios){
  // Compose multi-line summary based on computed metrics
  const lines = [];
  const net = agg.revenue - agg.expense;
  lines.push( LANG==='ar' ? `إجمالي الإيرادات: ${formatCur(agg.revenue)} — إجمالي المصروفات: ${formatCur(agg.expense)}.` : `Total Revenue: ${formatCur(agg.revenue)} — Total Expense: ${formatCur(agg.expense)}.` );
  lines.push( LANG==='ar' ? `صافي الربح: ${formatCur(net)}.` : `Net Profit: ${formatCur(net)}.` );
  // liquidity line
  if(ratios.currentRatio !== null) lines.push((LANG==='ar' ? 'السيولة (Current Ratio): ' : 'Current Ratio: ') + (ratios.currentRatio.toFixed(2)) + ' — ' + commentForRatio('currentRatio', ratios.currentRatio));
  // leverage
  if(ratios.debtToEquity !== null) lines.push((LANG==='ar' ? 'رفع مالي (Debt/Equity): ' : 'Debt/Equity: ') + (ratios.debtToEquity.toFixed(2)) + ' — ' + commentForRatio('debtToEquity', ratios.debtToEquity));
  // ROA / ROE
  if(ratios.roa !== null) lines.push((LANG==='ar' ? 'العائد على الأصول (ROA): ' : 'ROA: ') + ( (ratios.roa*100).toFixed(2) + '%' ) + ' — ' + commentForRatio('roa', ratios.roa));
  if(ratios.roe !== null) lines.push((LANG==='ar' ? 'العائد على حقوق الملكية (ROE): ' : 'ROE: ') + ( (ratios.roe*100).toFixed(2) + '%' ) + ' — ' + commentForRatio('roe', ratios.roe));
  return lines.join(' ');
}

/* Utility escape */
function escapeHtml(s){ return (s===null||s===undefined) ? '' : String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

/* Render ratios table body */
function renderRatiosTable(ratios){
  const body = $('ratiosBody'); body.innerHTML='';
  const rows = [
    {k:'currentRatio', label: LANG==='ar' ? 'النسبة الحالية (Current Ratio)' : 'Current Ratio', value: ratios.currentRatio},
    {k:'debtToEquity', label: LANG==='ar' ? 'نسبة الدين/حقوق الملكية' : 'Debt to Equity', value: ratios.debtToEquity},
    {k:'grossMargin', label: LANG==='ar' ? 'هامش إجمالي تقريبي' : 'Gross Margin (approx)', value: ratios.grossMargin},
    {k:'netProfit', label: LANG==='ar' ? 'صافي الربح' : 'Net Profit', value: ratios.netProfit},
    {k:'roa', label: LANG==='ar' ? 'العائد على الأصول (ROA)' : 'ROA', value: ratios.roa},
    {k:'roe', label: LANG==='ar' ? 'العائد على حقوق الملكية (ROE)' : 'ROE', value: ratios.roe},
    {k:'assetTurnover', label: LANG==='ar' ? 'دوران الأصول' : 'Asset Turnover', value: ratios.assetTurnover}
  ];
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const valStr = (r.value === null || r.value === undefined) ? '-' : ( (Math.abs(r.value) >= 1 && (r.k === 'netProfit')) ? formatCur(r.value) : ( (r.k==='grossMargin' || r.k==='roa' || r.k==='roe') ? ((r.value*100).toFixed(2) + '%') : (typeof r.value === 'number' ? (r.value.toFixed(2)) : r.value) ) );
    const comm = commentForRatio(r.k, r.value);
    tr.innerHTML = `<td>${escapeHtml(r.label)}</td><td>${escapeHtml(valStr)}</td><td class="small-muted">${escapeHtml(comm)}</td>`;
    body.appendChild(tr);
  });
}

/* Alerts area */
function renderAlerts(agg,ratios){
  const area = $('alertsArea'); area.innerHTML='';
  const list = [];
  if(trialData.length === 0) list.push(t('noData'));
  if(ratios.currentRatio !== null && ratios.currentRatio < 1) list.push(LANG==='ar' ? 'تحذير: نسبة السيولة أقل من 1 — راجع النقد.' : 'Warning: Current ratio < 1 — review cash.');
  if(ratios.debtToEquity !== null && ratios.debtToEquity > 2) list.push(LANG==='ar' ? 'تحذير: رفع مالي مرتفع.' : 'Warning: High leverage.');
  list.forEach(it=>{ const d = document.createElement('div'); d.textContent = it; area.appendChild(d); });
}

/* Master render */
function renderAll(scroll=true){
  loadData();
  const agg = aggregateByCategory(trialData);
  renderKPIs(agg);
  renderRawTable();
  renderCategoryChart(agg);
  const ratios = computeRatios(agg);
  renderRatiosTable(ratios);
  renderAdvanced(agg);
  renderTrendChart(agg);
  const smart = generateSmartSummary(agg, ratios);
  $('smartSummary').textContent = smart;
  renderAlerts(agg, ratios);
  if(scroll) window.scrollTo({top:0,behavior:'smooth'});
}

/* initial load */
(function init(){
  // apply theme from storage
  const theme = localStorage.getItem('fa_theme') || 'light';
  document.body.dataset.theme = theme;
  $('darkModeToggle').checked = (theme === 'dark');

  // set language + currency controls & load data
  populateControls();
  loadData();
  renderAll(false);
})();

</script>

</body>
</html>
