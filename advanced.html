<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>التحليلات المتقدمة — المحلل المالي</title>

<!-- CDN libraries -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@8.2.2/build/index.umd.js"></script>

<style>
:root{
  --bg:#f6f8fb; --card:#fff; --text:#0b1220; --muted:#6c757d;
  --accent1:#0d6efd; --accent2:#6610f2;
}
html,body{height:100%}
body{font-family:"Cairo",system-ui, sans-serif;margin:0;background:var(--bg);color:var(--text);transition:background .2s,color .2s;}
body[data-theme="dark"]{ --bg:#061018; --card:#07131a; --text:#e6eef6; --muted:#9aa6b2; background:var(--bg); color:var(--text); }

.site-header{position:sticky;top:0;z-index:1200;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
.brand{display:flex;gap:.6rem;align-items:center}
.brand img{height:44px;border-radius:8px}
.controls{display:flex;gap:.5rem;align-items:center}

.container-main{max-width:1200px;margin:18px auto;padding:12px}
.card-surface{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.04);margin-bottom:16px;border:1px solid rgba(13,110,253,0.04)}
body[data-theme="dark"] .card-surface{box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}

.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.kpi{padding:12px;border-radius:10px;background:linear-gradient(180deg,var(--card),#f8fbff);text-align:center}
.kpi .num{font-weight:800;font-size:1.05rem}

.table{margin-top:8px}

.watermark{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:0;opacity:0.06}
.watermark img{max-width:420px;filter:grayscale(100%);opacity:0.12}

.dark-text{color:var(--text)}
.small-muted{color:var(--muted)}

.controls select,input,button{min-height:38px}
.btn-glow{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;color:#fff}

@media (max-width:900px){
  .controls{flex-wrap:wrap}
  .kpi-row{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
}
@media print{
  body{background:white;color:black}
  .no-print{display:none!important}
  .watermark{display:block;opacity:0.08}
}
</style>
</head>
<body data-theme="light">

<!-- watermark image used for export -->
<div class="watermark" aria-hidden="true"><img id="wmLogo" src="assets/logo.png" alt="logo"></div>

<header class="site-header no-print" role="banner">
  <div class="brand">
    <img src="assets/logo.png" alt="logo" id="brandLogo">
    <div style="font-weight:700">المحلل المالي — التحليلات المتقدمة</div>
  </div>

  <div class="controls" role="navigation" aria-label="controls">
    <a class="btn btn-sm btn-outline-light" href="index.html" title="الرئيسية"><i class="bi bi-house"></i></a>
    <a class="btn btn-sm btn-outline-light" href="input.html" title="إدخال البيانات">إدخال</a>
    <a class="btn btn-sm btn-outline-light" href="report.html" title="التقارير">تقارير</a>
    <select id="languageSelect" class="form-select form-select-sm" title="اللغة" style="min-width:110px">
      <option value="ar">العربية</option><option value="en">English</option>
    </select>
    <select id="currencySelect" class="form-select form-select-sm" title="العملة" style="min-width:90px">
      <option value="EGP">EGP</option><option value="USD">USD</option><option value="EUR">EUR</option>
    </select>
    <input id="fxRateInput" class="form-control form-control-sm" style="width:110px" placeholder="FX" title="سعر الصرف (1 currency = ? EGP)"/>
    <div class="form-check form-switch">
      <input class="form-check-input" id="darkModeToggle" type="checkbox" title="الوضع الليلي">
    </div>
    <button id="exportPdfBtn" class="btn btn-sm btn-outline-light" title="تصدير PDF"><i class="bi bi-file-earmark-pdf"></i></button>
    <button id="exportDocxBtn" class="btn btn-sm btn-outline-light" title="تصدير DOCX"><i class="bi bi-file-earmark-word"></i></button>
  </div>
</header>

<main class="container-main" id="mainArea" role="main">

  <!-- top summary -->
  <section class="card-surface" aria-labelledby="topSummaryTitle">
    <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
      <div>
        <h4 id="topSummaryTitle">لوحة تحكم التحليلات المتقدمة</h4>
        <div id="summaryDesc" class="small-muted">استخرج نسب الأداء، المقارنة الزمنية، العائد، المخاطر، حساب EVA، ونظام تنبؤات قابل للربط.</div>
      </div>
      <div class="d-flex gap-2 align-items-center no-print">
        <button id="saveSnapshot" class="btn btn-glow btn-sm"><i class="bi bi-save"></i> حفظ لقطة</button>
        <select id="snapshotA" class="form-select form-select-sm" style="min-width:160px"><option value="">-- A --</option></select>
        <select id="snapshotB" class="form-select form-select-sm" style="min-width:160px"><option value="">-- B --</option></select>
        <button id="compareBtn" class="btn btn-outline-primary btn-sm">قارن</button>
        <button id="clearCompareBtn" class="btn btn-outline-secondary btn-sm">مسح مقارنة</button>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="card-surface" id="kpiSection">
    <h6>مؤشرات سريعة</h6>
    <div class="kpi-row" id="kpiRow" aria-live="polite"></div>
  </section>

  <!-- Detailed ratios -->
  <section class="card-surface" id="ratiosSection">
    <h6>النسب المالية — شاملة ومفصلة</h6>
    <div class="small-muted">تتضمن نسب السيولة، الربحية، نشاط، مديونية، وكفاءة رأس المال.</div>

    <table class="table table-sm table-striped mt-2" id="ratiosTable" role="table" aria-label="ratios">
      <thead><tr><th>النسبة</th><th class="text-end">القيمة</th><th class="text-end">تفسير/رأي فني</th></tr></thead>
      <tbody></tbody>
    </table>

    <canvas id="ratiosChart" height="120" aria-label="ratios chart"></canvas>
  </section>

  <!-- EVA and value metrics -->
  <section class="card-surface" id="valueSection">
    <h6>القيمة المضافة (EVA) ومؤشرات القيمة</h6>
    <div class="small-muted">EVA = NOPAT - (WACC × Capital Employed). يتم إظهار الافتراضات وعلى المستخدم مراجعتها.</div>

    <table class="table table-sm table-striped mt-2" id="evaTable">
      <thead><tr><th>المؤشر</th><th class="text-end">القيمة</th><th class="text-end">رأي فني</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Risk & Return -->
  <section class="card-surface" id="riskSection">
    <h6>العائد والمخاطر</h6>
    <div class="small-muted">Sharpe, Treynor, Beta (مقترح)، VaR — بعض المؤشرات تحتاج بيانات سوقية (سعر السهم/سوق) لزيادة الدقة.</div>

    <table class="table table-sm table-striped mt-2" id="riskTable">
      <thead><tr><th>المؤشر</th><th class="text-end">القيمة</th><th class="text-end">رأي فني</th></tr></thead>
      <tbody></tbody>
    </table>

    <canvas id="riskChart" height="120"></canvas>
  </section>

  <!-- Forecast -->
  <section class="card-surface" id="forecastSection">
    <h6>التنبؤات</h6>
    <div class="small-muted mb-2">يمكن ربط هذا القسم بباك-إند (Python) لتشغيل نماذج ARIMA أو Prophet أو LSTM. حالياً يوجد محاكي لتجربة العرض.</div>
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">نموذج التنبؤ (Placeholder)</label>
        <select id="forecastModel" class="form-select form-select-sm">
          <option value="arima">ARIMA (server)</option>
          <option value="prophet">Prophet (server)</option>
          <option value="simple">محاكاة بسيطة (Frontend)</option>
        </select>
      </div>
      <div class="col-md-8 d-flex align-items-end gap-2">
        <button id="runForecastBtn" class="btn btn-glow btn-sm">تشغيل التنبؤ</button>
        <div class="small-muted">مخرجات التوقعات قابلة للتصدير في التقرير.</div>
      </div>
    </div>

    <canvas id="forecastChart" height="140" class="mt-3"></canvas>
  </section>

  <footer class="text-center small no-print mt-3">&copy; 2025 المحلل المالي — جميع الحقوق محفوظة</footer>
</main>

<!-- Script: main logic -->
<script>
// ---------------------- Helpers ----------------------
const $ = id => document.getElementById(id);
const el = (s) => document.querySelector(s);
function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function toNum(v){ const n = Number(String(v||'').toString().replace(/[,\s]+/g,'')); return isNaN(n)?0:n; }
function formatNumber(v){ return Number(v).toLocaleString(undefined,{maximumFractionDigits:2}); }
function showToast(msg, type='info'){ console.info(msg); /* minimal toast */ alert(msg); }

// ---------------------- State & Data sources ----------------------
let trialData = JSON.parse(localStorage.getItem('trialData')||'[]'); // from input/report pages
let snapshots = JSON.parse(localStorage.getItem('trialData_snapshots')||'{}');
const FX_DEFAULTS = { USD:31, EUR:34 };
let fxRates = JSON.parse(localStorage.getItem('fa_fx')||'null') || FX_DEFAULTS;

// translations for UI text (ensuring strings change with language)
const UI = {
  ar: {
    title: "التحليلات المتقدمة",
    saveSnapshotPrompt: "ادخل تسمية/سنة للحفظ (مثال: 2024)",
    snapshotSaved: "تم حفظ اللقطة محليًا",
    chooseSnapshots: "اختر لقطتين للمقارنة",
    noData: "لا توجد بيانات لعرضها.",
    fxPlaceholder: "سعر الصرف (1 عملة = ؟ EGP)"
  },
  en: {
    title: "Advanced Analysis",
    saveSnapshotPrompt: "Enter label/year to save snapshot (e.g. 2024)",
    snapshotSaved: "Snapshot saved locally",
    chooseSnapshots: "Choose two snapshots to compare",
    noData: "No data to display.",
    fxPlaceholder: "FX rate (1 currency = ? EGP)"
  }
};

// ---------------------- UI Init ----------------------
function populateControls(){
  // load language and currency preferences
  const lang = localStorage.getItem('fa_lang') || 'ar';
  const cur = localStorage.getItem('fa_currency') || 'EGP';
  $('languageSelect').value = lang;
  $('currencySelect').value = cur;
  $('fxRateInput').value = localStorage.getItem('fa_fx_custom') || '';
  $('fxRateInput').placeholder = UI[lang].fxPlaceholder;
}
populateControls();

// dark mode control
$('darkModeToggle').addEventListener('change', (e)=>{
  const theme = e.target.checked ? 'dark' : 'light';
  document.body.dataset.theme = theme;
  localStorage.setItem('fa_theme', theme);
});
(function loadTheme(){
  const t = localStorage.getItem('fa_theme') || 'light';
  document.body.dataset.theme = t;
  $('darkModeToggle').checked = (t === 'dark');
})();

// language switch - update texts
$('languageSelect').addEventListener('change', ()=>{
  const lang = $('languageSelect').value;
  localStorage.setItem('fa_lang', lang);
  $('fxRateInput').placeholder = UI[lang].fxPlaceholder;
  renderAll();
});

// currency change
$('currencySelect').addEventListener('change', ()=>{
  localStorage.setItem('fa_currency', $('currencySelect').value);
  renderAll();
});

// fx manual
$('fxRateInput').addEventListener('change', ()=>{
  const v = toNum($('fxRateInput').value);
  if(v>0){
    localStorage.setItem('fa_fx_custom', v);
    fxRates['CUSTOM'] = v;
    localStorage.setItem('fa_fx', JSON.stringify(fxRates));
    showToast('سعر الصرف محفوظ','info');
    renderAll();
  }
});

// fetch FX (non-blocking)
async function fetchFx(){
  try{
    const resp = await fetch('https://api.exchangerate.host/latest?base=EGP&symbols=USD,EUR');
    if(resp.ok){
      const data = await resp.json();
      if(data.rates){
        fxRates.USD = 1 / (data.rates.USD || FX_DEFAULTS.USD);
        fxRates.EUR = 1 / (data.rates.EUR || FX_DEFAULTS.EUR);
        localStorage.setItem('fa_fx', JSON.stringify(fxRates));
      }
    }
  }catch(e){ console.warn('FX fetch failed -> using defaults'); }
}
fetchFx();

// ---------------------- Utilities: currency display ----------------------
function getCurrencySymbol(){
  const cur = $('currencySelect').value || 'EGP';
  if(cur === 'EGP') return 'ج.م';
  if(cur === 'USD') return '$';
  if(cur === 'EUR') return '€';
  return cur;
}
function convertCurrencyLocal(value){
  const cur = $('currencySelect').value || 'EGP';
  const custom = Number(localStorage.getItem('fa_fx_custom')||'0');
  if(cur === 'EGP') return toNum(value);
  if(custom>0) return toNum(value) / custom;
  const rate = fxRates[cur] || FX_DEFAULTS[cur] || 1;
  return toNum(value) / rate;
}

// ---------------------- Aggregation & Ratios ----------------------
function aggregateData(data){
  const agg = { assets:0, liabilities:0, equity:0, revenue:0, expense:0, other:0 };
  data.forEach(r=>{
    const debit = toNum(r.Debit), credit = toNum(r.Credit);
    const net = debit - credit;
    const type = String(r.Type||r.Account||'').toLowerCase();
    if(/asset|أصل|cash|bank|current asset|نقد|fixed asset|أصول/.test(type)) agg.assets += net;
    else if(/liab|خصوم|payable|loan|دائن|قرض/.test(type)) agg.liabilities += -net;
    else if(/equity|حقوق|رأس|capital/.test(type)) agg.equity += -net;
    else if(/revenue|sales|إيراد|مبيعات/.test(type)) agg.revenue += -net;
    else if(/expense|مصروف|cogs|تكلفة|مصاريف/.test(type)) agg.expense += net;
    else {
      const acc = (r.Account||'').toLowerCase();
      if(/النقد|bank|cash|نقد/.test(acc)) agg.assets += net;
      else if(/المورد|payable|دائن/.test(acc)) agg.liabilities += -net;
      else if(/رأس|equity/.test(acc)) agg.equity += -net;
      else if(/إيراد|sales/.test(acc)) agg.revenue += -net;
      else if(/مصروف|expense|تكلفة/.test(acc)) agg.expense += net;
      else agg.other += net;
    }
  });
  return agg;
}

// ratio computations and expert-opinions
function computeRatios(data){
  const agg = aggregateData(data);
  const totals = {
    currentRatio: safeDiv(agg.assets, agg.liabilities),
    debtEquity: safeDiv(agg.liabilities, agg.equity),
    returnOnEquity: safeDiv((agg.revenue - agg.expense), agg.equity) * 100,
    profitMargin: safeDiv((agg.revenue - agg.expense), agg.revenue) * 100,
    assetTurnover: safeDiv(agg.revenue, agg.assets)
  };
  // expert opinions (simple rules)
  const opinions = {
    currentRatio: totals.currentRatio >= 1.5 ? "سيولة صحية" : (totals.currentRatio >=1 ? "مقبول" : "ضعيف — راجع التزامات قصيرة الأجل"),
    debtEquity: totals.debtEquity <=1 ? "دين تحت السيطرة" : "ديون مرتفعة — راجع تكلفة الاقتراض",
    returnOnEquity: totals.returnOnEquity > 15 ? "عالي — أداء مميز" : (totals.returnOnEquity>5 ? "متوسط" : "منخفض"),
    profitMargin: totals.profitMargin > 10 ? "هامش ربحي جيد" : "هامش ضيق — راجع التكاليف",
    assetTurnover: totals.assetTurnover>1 ? "إستخدام جيد للأصول" : "قد تكون الأصول غير مستغلة بكفاءة"
  };
  return { totals, opinions };
}

function safeDiv(a,b){ if(!b) return 0; return a/b; }

// ---------------------- EVA & Value metrics ----------------------
function computeEVA(data){
  // EVA = NOPAT - WACC * CapitalEmployed
  // NOPAT approximated as EBIT * (1 - taxRate)
  // We try to extract EBIT and CapitalEmployed from trialData if present (fallback to aggregated proxies)
  let NOPAT=0, EBIT=0, taxRate=0.25, capitalEmployed=0;
  // attempt to find common accounts by keywords
  trialData.forEach(r=>{
    const acc = (r.Account||'').toLowerCase();
    if(/ebit|operating profit|ربح تشغيل/i.test(acc) || acc.includes('ebit')) EBIT += toNum(r.Debit) - toNum(r.Credit);
    if(/capital employed|capital|رأس المال/i.test(acc)) capitalEmployed += toNum(r.Debit) - toNum(r.Credit);
  });
  if(!EBIT){ // fallback: approximate EBIT = revenue - expense
    const agg = aggregateData(trialData);
    EBIT = agg.revenue - agg.expense;
  }
  NOPAT = EBIT * (1 - taxRate);
  // WACC: if user set costOfCapital in localStorage use it, else assume 12%
  const wacc = Number(localStorage.getItem('fa_wacc')||localStorage.getItem('costOfCapital')||0.12);
  if(!capitalEmployed){ // fallback: total assets - current liabilities approx
    const agg = aggregateData(trialData);
    capitalEmployed = Math.abs(agg.assets); // crude fallback
  }
  const EVA = NOPAT - (wacc * capitalEmployed);
  return {EBIT,NOPAT,wacc,capitalEmployed,EVA};
}

// ---------------------- Risk & Return (placeholders + simple calculations) ----------------------
function computeRiskReturn(data){
  // Placeholder: Without time-series of returns we can't compute Beta or VaR precisely.
  // We'll compute simple Sharpe using sample assumptions.
  // For real accuracy, link to time-series of returns (market & asset).
  const assumedReturn = Number(localStorage.getItem('fa_assumed_return')||0.12); // 12% default
  const riskFree = Number(localStorage.getItem('fa_riskfree')||0.03);
  const volatility = Number(localStorage.getItem('fa_vol')||0.18); // assumed SD
  const sharpe = safeDiv(assumedReturn - riskFree, volatility);
  const treynor = safeDiv(assumedReturn - riskFree, 1.0); // requires beta -- placeholder
  const beta = Number(localStorage.getItem('fa_beta')||1.0);
  const var95 = (assumedReturn - 1.65 * volatility);
  return {sharpe,treynor,beta,var95};
}

// ---------------------- Rendering ----------------------
let ratiosChart=null, riskChart=null, forecastChart=null;

function renderKPIs(data){
  const kpiRow = document.getElementById('kpiRow');
  kpiRow.innerHTML = '';
  const agg = aggregateData(data);
  const items = [
    {label: 'عدد الحسابات', value: data.length},
    {label: 'الأصول (تقريبي)', value: agg.assets},
    {label: 'الخصوم (تقريبي)', value: agg.liabilities},
    {label: 'الإيرادات', value: agg.revenue},
    {label: 'المصروفات', value: agg.expense}
  ];
  items.forEach(it=>{
    const div = document.createElement('div'); div.className='kpi';
    div.innerHTML = `<div class="small-muted">${esc(it.label)}</div><div class="num">${formatNumber(convertCurrencyLocal(it.value))} <small>${getCurrencySymbol()}</small></div>`;
    kpiRow.appendChild(div);
  });
}

function renderRatios(data){
  const tb = document.querySelector('#ratiosTable tbody');
  tb.innerHTML = '';
  const {totals, opinions} = computeRatios(data);
  const rows = [
    {name: $('languageSelect').value==='ar' ? 'النسبة الجارية (Current Ratio)' : 'Current Ratio', val: totals.currentRatio},
    {name: $('languageSelect').value==='ar' ? 'نسبة الدين إلى حقوق الملكية (Debt/Equity)' : 'Debt/Equity', val: totals.debtEquity},
    {name: $('languageSelect').value==='ar' ? 'العائد على حقوق الملكية ROE (%)' : 'ROE (%)', val: totals.returnOnEquity},
    {name: $('languageSelect').value==='ar' ? 'هامش صافي الربح (%)' : 'Net Profit Margin (%)', val: totals.profitMargin},
    {name: $('languageSelect').value==='ar' ? 'دوران الأصول (Asset Turnover)' : 'Asset Turnover', val: totals.assetTurnover}
  ];
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${esc(r.name)}</td><td class="text-end">${formatNumber(r.val)} ${r.name.includes('%')? '%':''}</td><td class="text-end small-muted">${esc(opinionFor(r.name, opinions))}</td>`;
    tb.appendChild(tr);
  });

  // chart
  const ctx = document.getElementById('ratiosChart').getContext('2d');
  if(ratiosChart) try{ ratiosChart.destroy(); }catch(e){}
  ratiosChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: rows.map(r=>r.name), datasets: [{ label: 'Ratios', data: rows.map(r=>Number(r.val) || 0), backgroundColor: 'rgba(13,110,253,0.85)' }] },
    options: { responsive:true, scales:{y:{beginAtZero:true}} }
  });
}

function opinionFor(name, opinions){
  if(name.includes('Current')) return opinions.currentRatio;
  if(name.includes('Debt')) return opinions.debtEquity;
  if(name.includes('ROE')) return opinions.returnOnEquity;
  if(name.includes('Net Profit')||name.includes('هامش')) return opinions.profitMargin;
  return opinions.assetTurnover;
}

function renderEVA(data){
  const t = computeEVA(data);
  const tb = document.querySelector('#evaTable tbody'); tb.innerHTML = '';
  const rows = [
    {n:'EBIT (تقريبي)', v:t.EBIT},
    {n:'NOPAT (EBIT بعد الضرائب)', v:t.NOPAT},
    {n:'رأس المال المستخدم (Capital Employed)', v:t.capitalEmployed},
    {n:'WACC (تكلفة رأس المال)', v:t.wacc},
    {n:'EVA', v:t.EVA}
  ];
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${esc(r.n)}</td><td class="text-end">${formatNumber(convertCurrencyLocal(r.v))} ${getCurrencySymbol()}</td><td class="text-end small-muted">${evaOpinion(r)}</td>`;
    tb.appendChild(tr);
  });
}

function evaOpinion(row){
  if(row.n === 'EVA'){
    if(row.v > 0) return 'موجب — الشركة تولد قيمة للمساهمين';
    if(row.v === 0) return 'محايد';
    return 'سالب — راجع تكلفة رأس المال والسياسات التشغيلية';
  }
  return 'قيمة مستخرجة من البيانات';
}

function renderRisk(data){
  const tb = document.querySelector('#riskTable tbody'); tb.innerHTML = '';
  const rr = computeRiskReturn(data);
  const rows = [
    {n: $('languageSelect').value==='ar' ? 'Sharpe Ratio' : 'Sharpe Ratio', v:rr.sharpe, opin: (rr.sharpe>1? 'جيد' : 'متوسط')},
    {n: $('languageSelect').value==='ar' ? 'Treynor' : 'Treynor', v:rr.treynor, opin: 'مؤشر تقريبي'},
    {n: $('languageSelect').value==='ar' ? 'Beta' : 'Beta', v:rr.beta, opin: (rr.beta>1? 'مخاطرة أعلى من السوق' : 'أقل من السوق')},
    {n: $('languageSelect').value==='ar' ? 'VaR (95%)' : 'VaR (95%)', v:rr.var95, opin: 'قيمة تقريبية على أساس SD مفترض'}
  ];
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${esc(r.n)}</td><td class="text-end">${formatNumber(r.v)}</td><td class="text-end small-muted">${esc(r.opin)}</td>`;
    tb.appendChild(tr);
  });

  // risk chart
  const ctx = document.getElementById('riskChart').getContext('2d');
  if(riskChart) try{ riskChart.destroy(); }catch(e){}
  riskChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: rows.map(x=>x.n), datasets: [{ data: rows.map(x=>Math.abs(Number(x.v))||1), backgroundColor: ['#0d6efd','#6610f2','#198754','#ffc107'] }]},
    options:{responsive:true}
  });
}

// ---------------------- Snapshot management & comparison ----------------------
function loadSnapshots(){
  snapshots = JSON.parse(localStorage.getItem('trialData_snapshots')||'{}');
  const sa = $('snapshotA'); const sb = $('snapshotB');
  sa.innerHTML = '<option value="">-- A --</option>'; sb.innerHTML = '<option value="">-- B --</option>';
  const keys = Object.keys(snapshots).sort().reverse();
  if(keys.length === 0){
    sa.innerHTML += `<option value="">${UI[$('languageSelect').value].noData}</option>`;
    sb.innerHTML += `<option value="">${UI[$('languageSelect').value].noData}</option>`;
    return;
  }
  keys.forEach(k=>{ sa.innerHTML += `<option value="${esc(k)}">${esc(k)}</option>`; sb.innerHTML += `<option value="${esc(k)}">${esc(k)}</option>`; });
}

$('saveSnapshot').addEventListener('click', ()=>{
  const lang = $('languageSelect').value;
  const label = prompt(UI[lang].saveSnapshotPrompt, new Date().getFullYear());
  if(label && label.trim()){
    snapshots = JSON.parse(localStorage.getItem('trialData_snapshots')||'{}');
    snapshots[label.trim()] = JSON.parse(JSON.stringify(trialData || []));
    localStorage.setItem('trialData_snapshots', JSON.stringify(snapshots));
    loadSnapshots(); alert(UI[lang].snapshotSaved);
  }
});

$('compareBtn').addEventListener('click', ()=>{
  const a = $('snapshotA').value, b = $('snapshotB').value;
  if(!a || !b){ alert(UI[$('languageSelect').value].chooseSnapshots); return; }
  const A = snapshots[a]||[]; const B = snapshots[b]||[];
  compareSnapshots(a,b,A,B);
});

$('clearCompareBtn').addEventListener('click', ()=>{
  renderAll();
  if(compareChart) try{ compareChart.destroy(); }catch(e){}
  showToast('تم مسح المقارنة','info');
});

let compareChart = null;
function compareSnapshots(labelA,labelB,dataA,dataB){
  const aggA = aggregateData(dataA);
  const aggB = aggregateData(dataB);
  const labels = [ $('languageSelect').value==='ar'?'الأصول':'Assets', $('languageSelect').value==='ar'?'الخصوم':'Liabilities', $('languageSelect').value==='ar'?'الإيرادات':'Revenue', $('languageSelect').value==='ar'?'المصروفات':'Expenses', $('languageSelect').value==='ar'?'أخرى':'Other' ];
  const valsA = [Math.abs(aggA.assets), Math.abs(aggA.liabilities), Math.abs(aggA.revenue), Math.abs(aggA.expense), Math.abs(aggA.other)].map(convertCurrencyLocal);
  const valsB = [Math.abs(aggB.assets), Math.abs(aggB.liabilities), Math.abs(aggB.revenue), Math.abs(aggB.expense), Math.abs(aggB.other)].map(convertCurrencyLocal);
  const diffs = valsB.map((v,i)=>v - (valsA[i]||0));
  const pct = valsA.map((v,i)=> v ? (diffs[i]/v)*100 : 0);

  // summary area: inject into a modal? for brevity use alert or console and draw chart
  const ctx = document.getElementById('ratiosChart').getContext('2d');
  if(compareChart) try{ compareChart.destroy(); }catch(e){}
  compareChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: labelA, data: valsA, backgroundColor: 'rgba(13,110,253,0.8)' },
        { label: labelB, data: valsB, backgroundColor: 'rgba(102,16,242,0.8)' }
      ]
    },
    options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
  });

  // show a quick table in console and a tiny popup
  console.table({labels,valsA,valsB,diffs,pct});
  alert(`تمت المقارنة: ${labelA} ↔ ${labelB}\nاطلع على الرسوم البيانية والكونسول للمزيد.`);
}

// ---------------------- Forecasting (placeholder) ----------------------
$('runForecastBtn').addEventListener('click', ()=> {
  const model = $('forecastModel').value;
  if(model === 'simple') { simulateForecast(); return; }
  // For ARIMA/Prophet models: send POST to your Python API and render response.
  // Example (server must implement /api/forecast endpoint):
  // fetch('/api/forecast', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({model, data: trialData})})
  //  .then(r=>r.json()).then(renderForecastFromServer)
  //  .catch(e=>alert('Forecast server error: '+e));
  alert('الخيار المختار يتطلب باك-إند (Python) لتشغيل ARIMA/Prophet. الكود frontend جاهز لإرسال الطلب.');
});

function simulateForecast(){
  // fake series: use revenue over time from snapshots if exist, else simulate
  const keys = Object.keys(snapshots).sort();
  let series = [];
  if(keys.length>=3){
    keys.forEach(k=>{
      const a = aggregateData(snapshots[k]);
      series.push({label:k,value:Math.abs(a.revenue)});
    });
  } else {
    // simulate
    for(let i=0;i<6;i++) series.push({label: `T${i+1}`, value: 100000 + Math.random()*50000});
  }
  const labels = series.map(s=>s.label);
  const values = series.map(s=>s.value);
  // naive forecast (next = last * (1 + avg growth))
  let growths = [];
  for(let i=1;i<values.length;i++) growths.push((values[i]-values[i-1])/values[i-1]);
  const avgG = growths.length ? (growths.reduce((a,b)=>a+b,0)/growths.length) : 0.05;
  const forecast = [];
  let last = values[values.length-1];
  for(let h=1;h<=6;h++){
    last = last*(1+avgG);
    forecast.push(last);
  }

  // render chart
  const ctx = document.getElementById('forecastChart').getContext('2d');
  if(forecastChart) try{ forecastChart.destroy(); }catch(e){}
  forecastChart = new Chart(ctx, {
    type:'line',
    data: {
      labels: [...labels, ...Array.from({length:forecast.length},(_,i)=>`F+${i+1}`)],
      datasets: [
        { label: 'Historical', data: values, borderColor:'#0d6efd', tension:0.2 },
        { label: 'Forecast', data: [...Array(values.length).fill(null), ...forecast], borderColor:'#6610f2', borderDash:[6,4], tension:0.2 }
      ]
    },
    options:{responsive:true}
  });
}

// ---------------------- Export: PDF & DOCX ----------------------
$('exportPdfBtn').addEventListener('click', ()=> exportPDF());
$('exportDocxBtn').addEventListener('click', ()=> exportDOCX());

async function exportPDF(){
  if(!(trialData && trialData.length)) { alert(UI[$('languageSelect').value].noData); return; }
  // Use html2pdf (bundled via html2pdf.bundle) triggered on main area
  const main = document.getElementById('mainArea');
  // briefly ensure watermark opacity visible
  const wm = document.getElementById('wmLogo');
  const prev = wm.style.opacity;
  wm.style.opacity = '0.12';
  const opt = { margin:0.4, filename:'advanced_report.pdf', image:{type:'jpeg',quality:0.95}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'in', format:'a4', orientation:'portrait'} };
  html2pdf().set(opt).from(main).save().finally(()=>{ wm.style.opacity = prev || ''; });
}

async function exportDOCX(){
  if(!(trialData && trialData.length)) { alert(UI[$('languageSelect').value].noData); return; }
  // Use docx.js (UMD loaded) to create a simple doc with header logo and key tables.
  const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType } = window.docx;
  const doc = new Document();
  // Header
  doc.addSection({
    children: [
      new Paragraph({ children: [ new TextRun({text:'التقرير التحليلي المتقدم', bold:true, size:28}) ] }),
      new Paragraph(''),
      new Paragraph({ children: [ new TextRun('مُلخّص النسب والمؤشرات (قيمة بالأرقام حسب العملة المحددة)'), ] }),
    ]
  });

  // Note: docx generation of large tables is possible; for brevity we add summary paragraphs.
  const blob = await Packer.toBlob(doc);
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'advanced_report.docx';
  link.click();
}

// ---------------------- Orchestration: load local data & render ----------------------
function renderAll(){
  trialData = JSON.parse(localStorage.getItem('trialData')||'[]');
  loadSnapshots();
  renderKPIs(trialData || []);
  renderRatios(trialData || []);
  renderEVA(trialData || []);
  renderRisk(trialData || []);
}

// initial load
(function init(){
  // ensure there is at least an empty array
  trialData = JSON.parse(localStorage.getItem('trialData')||'[]');
  if(!Array.isArray(trialData)) trialData = [];
  loadSnapshots();
  populateControls();
  renderAll();
})();

// storage event sync across tabs
window.addEventListener('storage', (e)=>{
  if(e.key === 'trialData'){ trialData = JSON.parse(e.newValue || '[]'); renderAll(); }
  if(e.key === 'trialData_snapshots'){ loadSnapshots(); }
});
</script>

</body>
</html>
