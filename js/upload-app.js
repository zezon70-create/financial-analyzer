window.pageTranslations = {
    ar: {
        pageTitle: "ÿ±ŸÅÿπ Ÿàÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ‚Äî ÿßŸÑŸÖÿ≠ŸÑŸÑ ÿßŸÑŸÖÿßŸÑŸä",
        pageHeader: "ÿ±ŸÅÿπ Ÿàÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑŸÖÿßŸÑŸäÿ©",
        pageSubheader: "Ÿáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ© ŸÖÿÆÿµÿµÿ© ŸÑÿ∫Ÿäÿ± ÿßŸÑŸÖÿ™ÿÆÿµÿµŸäŸÜ ŸÑÿ±ŸÅÿπ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑŸÖÿßŸÑŸäÿ© ÿßŸÑÿ¨ÿßŸáÿ≤ÿ© ÿ£Ÿà ÿ•ÿØÿÆÿßŸÑŸáÿß ÿ®ÿ≥ŸáŸàŸÑÿ©.",
        actionsTitle: "ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÉŸÖ",
        save: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ŸÅÿ∏",
        clear: "ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ",
        saveForComparison: "ÿ≠ŸÅÿ∏ ŸÜÿ≥ÿÆÿ© ŸÑŸÑŸÖŸÇÿßÿ±ŸÜÿßÿ™",
        saveAsPlaceholder: "ŸÖÿ´ÿßŸÑ: ÿ®ŸäÿßŸÜÿßÿ™ 2025",
        saveAs: "ÿ≠ŸÅÿ∏ ÿ®ÿßÿ≥ŸÖ",
        uploadTitle: "ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿ¨ÿßŸáÿ≤",
        uploadLabel: "ŸäŸÖŸÉŸÜŸÉ ÿ±ŸÅÿπ ŸÖŸÑŸÅ Excel ÿ£Ÿà CSV Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£Ÿä ŸÖŸÜ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑŸÖÿßŸÑŸäÿ©.",
        entryTitle: "ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸäÿØŸàŸä",
        tabBS: "ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ© ÿßŸÑÿπŸÖŸàŸÖŸäÿ©",
        tabIS: "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿØÿÆŸÑ",
        addBS: "ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸÜÿØ ŸÑŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ©",
        addIS: "ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸÜÿØ ŸÑŸÑÿØÿÆŸÑ",
        confirmClear: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÉŸÑ ÿßŸÑÿ¨ÿØÿßŸàŸÑÿü",
        savedSuccess: "ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ŸÅÿ∏! (ŸÖŸÑÿßÿ≠ÿ∏ÿ©: Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ŸÉŸÑ ÿ™ÿ∫ŸäŸäÿ±)",
        noDataToSave: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ≠ŸÅÿ∏Ÿáÿß.",
        saveAsSuccess: "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠ ÿ®ÿßÿ≥ŸÖ",
        saveAsError: "ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ŸÑÿ≠ŸÅÿ∏ ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.",
        savePrevious: "ÿ≠ŸÅÿ∏ ŸÉŸÅÿ™ÿ±ÿ© ÿ≥ÿßÿ®ŸÇÿ©",
        savedPreviousSuccess: "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ÿ®ŸÜÿ¨ÿßÿ≠!",
        thClassification: "ÿßŸÑÿ™ÿµŸÜŸäŸÅ (ŸÖŸáŸÖ ÿ¨ÿØÿßŸã)",
        uploadFileSubtitle: "ÿ≥ŸäŸÇŸàŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ®ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ÿπŸÖÿØÿ©. ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ®ŸÜŸàÿØ ŸäÿØŸàŸäÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ±ŸÅÿπ.",
        fileProcessingSuccess: "ÿ™ŸÖÿ™ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠! Ÿäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ Ÿàÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ®ŸÜŸàÿØ ŸÅŸä ÿ¨ÿØŸàŸÑ ÿßŸÑÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸäÿØŸàŸä.",
        manualEntryTab: "ÿ•ÿØÿÆÿßŸÑ ŸäÿØŸàŸä",
        uploadFileTab: "ÿ±ŸÅÿπ ŸÖŸÑŸÅ",
        uploadFileTitle: "ÿ±ŸÅÿπ ŸÖŸÑŸÅ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑŸÖÿßŸÑŸäÿ© (Excel ÿ£Ÿà CSV)",
        uploadDragDrop: "ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™ ŸÖŸÑŸÅŸÉ ŸáŸÜÿßÿå ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±",
        uploadSupportedFiles: "ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿØÿπŸàŸÖÿ©: .xlsx, .xls, .csv",
        uploadBrowseButton: "ÿ™ÿµŸÅÿ≠ ÿßŸÑŸÖŸÑŸÅÿßÿ™",
        uploadFileReady: "ÿßŸÑŸÖŸÑŸÅ ÿ¨ÿßŸáÿ≤ ŸÑŸÑŸÖÿπÿßŸÑÿ¨ÿ©",
        loadingPreview: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿπÿßŸäŸÜÿ©...",
        dataPreview: "ŸÖÿπÿßŸäŸÜÿ© ÿ£ŸàŸÑ 5 ÿµŸÅŸàŸÅ:",
        columnMappingTitle: "ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿßŸÑÿ£ÿπŸÖÿØÿ©",
        columnMappingSubtitle: "ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿßŸÑÿ£ÿπŸÖÿØÿ© ŸÖŸÜ ŸÖŸÑŸÅŸÉ ŸÖÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©.",
        processFileButton: "ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ ŸàŸÖŸÑÿ° ÿßŸÑÿ¨ÿØÿßŸàŸÑ",
        confirmClearUpload: "ÿ≥ŸäŸÇŸàŸÖ Ÿáÿ∞ÿß ÿ®ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ∞Ÿä ÿ≥ÿ™ÿÆÿ™ÿßÿ±Ÿá. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü",
        fileReadError: "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜŸá ŸÖŸÑŸÅ Excel ÿ£Ÿà CSV ÿµÿßŸÑÿ≠.",
        fieldAccount: "ÿßŸÑÿ≠ÿ≥ÿßÿ®/ÿßŸÑÿ®ŸÜÿØ",
        fieldValue: "ÿßŸÑŸÇŸäŸÖÿ©",
        fieldClassification: "ÿßŸÑÿ™ÿµŸÜŸäŸÅ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
        mapToStatement: "Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿÆÿµ ÿ£Ÿä ŸÇÿßÿ¶ŸÖÿ©ÿü",
        "group_currentAssets": "ÿßŸÑÿ£ÿµŸàŸÑ ÿßŸÑŸÖÿ™ÿØÿßŸàŸÑÿ©",
        "group_nonCurrentAssets": "ÿßŸÑÿ£ÿµŸàŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ™ÿØÿßŸàŸÑÿ©",
        "group_currentLiabilities": "ÿßŸÑÿÆÿµŸàŸÖ ÿßŸÑŸÖÿ™ÿØÿßŸàŸÑÿ©",
        "group_nonCurrentLiabilities": "ÿßŸÑÿÆÿµŸàŸÖ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ™ÿØÿßŸàŸÑÿ©",
        "group_equity": "ÿ≠ŸÇŸàŸÇ ÿßŸÑŸÖŸÑŸÉŸäÿ©",
        "group_revenues": "ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™ ŸàÿßŸÑŸÖŸÉÿßÿ≥ÿ®",
        "group_expenses": "ÿßŸÑÿ™ŸÉÿßŸÑŸäŸÅ ŸàÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™",
        opt_select: "-- ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ --",
        opt_cash: "ÿßŸÑŸÜŸÇÿØŸäÿ© ŸàŸÖÿß ŸÅŸä ÿ≠ŸÉŸÖŸáÿß",
        opt_receivables: "ÿßŸÑÿπŸÖŸÑÿßÿ° ŸàÿßŸÑŸÖÿØŸäŸÜŸàŸÜ",
        opt_inventory: "ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ",
        opt_otherCurrentAssets: "ÿ£ÿµŸàŸÑ ŸÖÿ™ÿØÿßŸàŸÑÿ© ÿ£ÿÆÿ±Ÿâ",
        opt_fixedAssets: "ÿ£ÿµŸàŸÑ ÿ´ÿßÿ®ÿ™ÿ© (ÿµÿßŸÅŸä)",
        opt_otherNonCurrentAssets: "ÿ£ÿµŸàŸÑ ÿ∫Ÿäÿ± ŸÖÿ™ÿØÿßŸàŸÑÿ© ÿ£ÿÆÿ±Ÿâ",
        opt_payables: "ÿßŸÑŸÖŸàÿ±ÿØŸàŸÜ ŸàÿßŸÑÿØÿßÿ¶ŸÜŸàŸÜ",
        opt_shortTermDebt: "ŸÇÿ±Ÿàÿ∂ ŸÇÿµŸäÿ±ÿ© ÿßŸÑÿ£ÿ¨ŸÑ",
        opt_otherCurrentLiabilities: "ÿÆÿµŸàŸÖ ŸÖÿ™ÿØÿßŸàŸÑÿ© ÿ£ÿÆÿ±Ÿâ",
        opt_longTermDebt: "ŸÇÿ±Ÿàÿ∂ ÿ∑ŸàŸäŸÑÿ© ÿßŸÑÿ£ÿ¨ŸÑ",
        opt_otherNonCurrentLiabilities: "ÿÆÿµŸàŸÖ ÿ∫Ÿäÿ± ŸÖÿ™ÿØÿßŸàŸÑÿ© ÿ£ÿÆÿ±Ÿâ",
        opt_equity: "ÿ≠ŸÇŸàŸÇ ÿßŸÑŸÖŸÑŸÉŸäÿ©",
        opt_revenue: "ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™",
        opt_cogs: "ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ®ÿ∂ÿßÿπÿ© ÿßŸÑŸÖÿ®ÿßÿπÿ© (COGS)",
        opt_operatingExpense: "ŸÖÿµÿ±ŸàŸÅÿßÿ™ ÿ™ÿ¥ÿ∫ŸäŸÑŸäÿ© (ÿπŸÖŸàŸÖŸäÿ© Ÿàÿ•ÿØÿßÿ±Ÿäÿ© Ÿàÿ®Ÿäÿπ)",
        opt_depreciation: "ŸÖÿµÿ±ŸàŸÅ ÿßŸÑÿ•ŸáŸÑÿßŸÉ (Ÿäÿ∂ÿßŸÅ ŸáŸÜÿß ŸÑŸà ŸÖŸÜŸÅÿµŸÑ)",
        opt_interestExpense: "ŸÖÿµÿ±ŸàŸÅÿßÿ™ ŸÅÿßÿ¶ÿØÿ©",
        opt_taxExpense: "ŸÖÿµÿ±ŸàŸÅÿßÿ™ ÿ∂ÿ±Ÿäÿ®Ÿäÿ©",
        opt_otherRevenue: "ÿ•Ÿäÿ±ÿßÿØÿßÿ™ ÿ£ÿÆÿ±Ÿâ",
        opt_otherExpense: "ŸÖÿµÿ±ŸàŸÅÿßÿ™ ÿ£ÿÆÿ±Ÿâ"
    },
    en: {
        pageTitle: "Upload & Enter Statements ‚Äî Financial Analyzer",
        pageHeader: "Upload & Enter Financial Statements",
        pageSubheader: "This page is for non-specialists to easily upload ready-made financial statements or enter them manually.",
        actionsTitle: "Controls",
        save: "Confirm Save",
        clear: "Clear All",
        saveForComparison: "Save a copy for comparisons",
        saveAsPlaceholder: "e.g., Data 2025",
        saveAs: "Save As",
        uploadTitle: "Upload a File",
        uploadLabel: "You can upload an Excel or CSV file containing any of the financial statements.",
        entryTitle: "Manual Data Entry",
        tabBS: "Balance Sheet",
        tabIS: "Income Statement",
        addBS: "Add Balance Sheet Item",
        addIS: "Add Income Item",
        confirmClear: "Are you sure you want to clear all data in all tables?",
        savedSuccess: "Save Confirmed! (Note: Your data auto-saves on every change)",
        noDataToSave: "No data to save.",
        saveAsSuccess: "Data saved successfully as",
        saveAsError: "Please enter a name to save the dataset.",
        savePrevious: "Save as Previous Period",
        savedPreviousSuccess: "Previous period data saved successfully!",
        thClassification: "Classification (Very Important)",
        uploadFileSubtitle: "The system will analyze columns. You will need to manually classify items after uploading.",
        fileProcessingSuccess: "File processed successfully! Please review the data and classify the items in the manual entry table.",
        manualEntryTab: "Manual Entry",
        uploadFileTab: "Upload File",
        uploadFileTitle: "Upload Financial Statements (Excel or CSV)",
        uploadDragDrop: "Drag & drop your file here, or click to browse",
        uploadSupportedFiles: "Supported files: .xlsx, .xls, .csv",
        uploadBrowseButton: "Browse Files",
        uploadFileReady: "File is ready to be processed",
        loadingPreview: "Loading preview...",
        dataPreview: "Preview of first 5 rows:",
        columnMappingTitle: "Column Mapping",
        columnMappingSubtitle: "Please match the columns from your file to the required fields.",
        processFileButton: "Process File and Populate Tables",
        confirmClearUpload: "This will clear the data in the selected table. Do you want to continue?",
        fileReadError: "An error occurred reading the file. Please ensure it's a valid Excel or CSV file.",
        fileProcessingSuccess: "File processed successfully! The selected table has been populated.",
        fieldAccount: "Account/Item",
        fieldValue: "Value",
        fieldClassification: "Classification (Optional)",
        mapToStatement: "Which statement does this data belong to?",
        "group_currentAssets": "Current Assets",
        "group_nonCurrentAssets": "Non-Current Assets",
        "group_currentLiabilities": "Current Liabilities",
        "group_nonCurrentLiabilities": "Non-Current Liabilities",
        "group_equity": "Equity",
        "group_revenues": "Revenues & Gains",
        "group_expenses": "Costs & Expenses",
        opt_select: "-- Select Classification --",
        opt_cash: "Cash and Equivalents",
        opt_receivables: "Accounts Receivable",
        opt_inventory: "Inventory",
        opt_otherCurrentAssets: "Other Current Assets",
        opt_fixedAssets: "Fixed Assets (Net)",
        opt_otherNonCurrentAssets: "Other Non-Current Assets",
        opt_payables: "Accounts Payable",
        opt_shortTermDebt: "Short-term Debt",
        opt_otherCurrentLiabilities: "Other Current Liabilities",
        opt_longTermDebt: "Long-term Debt",
        opt_otherNonCurrentLiabilities: "Other Non-Current Liabilities",
        opt_equity: "Equity",
        opt_revenue: "Revenue",
        opt_cogs: "Cost of Goods Sold (COGS)",
        opt_operatingExpense: "Operating Expenses (SG&A)",
        opt_depreciation: "Depreciation Expense (if separate)",
        opt_interestExpense: "Interest Expense",
        opt_taxExpense: "Tax Expense",
        opt_otherRevenue: "Other Revenue",
        opt_otherExpense: "Other Expense"
    }
};

document.addEventListener("DOMContentLoaded", (() => {

    const classificationStructure = {
        bs: {
            "group_currentAssets": ["opt_cash", "opt_receivables", "opt_inventory", "opt_otherCurrentAssets"],
            "group_nonCurrentAssets": ["opt_fixedAssets", "opt_otherNonCurrentAssets"],
            "group_currentLiabilities": ["opt_payables", "opt_shortTermDebt", "opt_otherCurrentLiabilities"],
            "group_nonCurrentLiabilities": ["opt_longTermDebt", "opt_otherNonCurrentLiabilities"],
            "group_equity": ["opt_equity"]
        },
        is: {
            "group_revenues": ["opt_revenue", "opt_otherRevenue"],
            "group_expenses": ["opt_cogs", "opt_operatingExpense", "opt_depreciation", "opt_interestExpense", "opt_taxExpense", "opt_otherExpense"]
        }
    };

    const e = classificationStructure;

    const t = {
            data: {
                bs: [],
                is: []
            },
            fileData: [],
            fileHeaders: []
        },
        a = localStorage.getItem("lang") || "ar",
        o = e => window.pageTranslations[a] ? .[e] || e,
        s = e => window.pageTranslations[a] ? .[`field${e}`] || e,
        n = e => window.pageTranslations[a] ? .[e] || e,
        l = {
            saveAsNameInput: document.getElementById("saveAsName"),
            saveAsBtn: document.getElementById("saveAsBtn"),
            saveBtn: document.getElementById("saveBtn"),
            clearBtn: document.getElementById("clearBtn"),
            savePreviousBtn: document.getElementById("savePreviousBtn"),
            tabContent: document.querySelector(".tab-content"),
            fileDropArea: document.getElementById("fileDropArea"),
            fileUploader: document.getElementById("fileUploader"),
            browseButton: document.getElementById("browseButton"),
            fileNameDisplay: document.getElementById("fileNameDisplay"),
            filePreviewArea: document.getElementById("filePreviewArea"),
            previewSpinner: document.getElementById("previewSpinner"),
            filePreviewTable: document.getElementById("filePreviewTable"),
            columnMapper: document.getElementById("columnMapper"),
            processFileBtn: document.getElementById("processFileBtn"),
            manualTab: document.getElementById("manual-tab")
        },

        r = {
            tables: {
                bs: {
                    headers: {
                        ar: ["ÿßŸÑÿ≠ÿ≥ÿßÿ®", "ÿßŸÑŸÇŸäŸÖÿ©", "ÿßŸÑÿ™ÿµŸÜŸäŸÅ (ŸÖŸáŸÖ ÿ¨ÿØÿßŸã)", "ÿ•ÿ¨ÿ±ÿßÿ°"],
                        en: ["Account", "Value", "Classification (Important)", "Action"]
                    },
                    fields: ["Account", "Value", "Classification"]
                },
                is: {
                    headers: {
                        ar: ["ÿßŸÑÿ®ŸÜÿØ", "ÿßŸÑŸÇŸäŸÖÿ©", "ÿßŸÑÿ™ÿµŸÜŸäŸÅ (ŸÖŸáŸÖ ÿ¨ÿØÿßŸã)", "ÿ•ÿ¨ÿ±ÿßÿ°"],
                        en: ["Item", "Value", "Classification (Important)", "Action"]
                    },
                    fields: ["Account", "Value", "Classification"]
                }
            },
            requiredFields: ["Account", "Value", "Classification"]
        },

        i = e => parseFloat(String(e || "").replace(/,/g, "")) || 0,
        d = () => {
            localStorage.setItem("uploadedFinancialData", JSON.stringify(t.data)), console.log("Auto-save successful!")
        },
        c = () => {
            const e = JSON.parse(localStorage.getItem("uploadedFinancialData") || "{}");
            for (const o in r.tables) t.data[o] = e[o] ? .length > 0 ? e[o] : [(a = r.tables[o].fields, a.reduce(((e, t) => ({ ...e,
                [t]: "Value" === t ? 0 : ""
            })), {}))], t.data[o].forEach((e => {
                void 0 === e.Classification && (e.Classification = "")
            }));
            var a
        },
        p = () => {
            alert("Save As function needs to be updated to support classifications.")
        },
        u = () => {
            if (0 !== t.data.bs.length || 0 !== t.data.is.length) try {
                localStorage.setItem("uploadedFinancialDataPrevious", JSON.stringify(t.data)), alert(o("savedPreviousSuccess"))
            } catch (e) {
                alert("Error saving previous period data.")
            } else alert(o("noDataToSave"))
        },

        f = o => {
            const s = document.getElementById(`${o}Table`),
                l = r.tables[o],
                c = t.data[o],
                p = l.headers[a];
            s.innerHTML = `<thead><tr>${p.map((e=>`<th>${e}</th>`)).join("")}</tr></thead><tbody></tbody>`;
            const u = s.querySelector("tbody");

            let m = "";
            const groups = classificationStructure[o];
            for (const groupKey in groups) {
                const groupName = n(groupKey);
                m += `<optgroup label="${groupName}">`;
                const items = groups[groupKey];
                for (const itemKey of items) {
                    m += `<option value="${itemKey}">${n(itemKey)}</option>`;
                }
                m += `</optgroup>`;
            }

            c.forEach(((e, t) => {
                const a = document.createElement("tr");
                let s = "";
                l.fields.forEach((t => {
                    const a = e[t] || ("Value" === t ? 0 : "");
                    if ("Classification" === t) s += `
                        <td>
                            <select class="form-select form-select-sm" data-field="Classification">
                                <option value="">${n("opt_select")}</option>
                                ${m}
                            </select>
                        </td>`;
                    else {
                        s += `<td><input class="form-control form-control-sm" type="${"Value"===t?"number":"text"}" data-field="${t}" value="${a}"></td>`
                    }
                })), s += '<td><button class="btn btn-sm btn-outline-danger btn-delete"><i class="bi bi-trash"></i></button></td>', a.innerHTML = s;
                const r = a.querySelector('select[data-field="Classification"]');
                r && (r.value = e.Classification || ""), a.querySelectorAll("input, select").forEach((e => {
                    e.addEventListener("change", (e => {
                        const a = e.target.dataset.field;
                        c[t][a] = "number" === e.target.type ? i(e.target.value) : e.target.value, d()
                    }))
                })), a.querySelector(".btn-delete").addEventListener("click", (() => {
                    c.splice(t, 1), d(), f(o)
                })), u.appendChild(a)
            }))
        },

        m = () => Object.keys(r.tables).forEach((e => f(e))),

        v = () => {
            let e = r.requiredFields.map((e => {
                const o = s(e),
                    n = ((e, t) => {
                        const a = e.toLowerCase(),
                            o = (s(e) || "").toLowerCase();
                        for (const e of t) {
                            const t = String(e || "").toLowerCase().trim();
                            if (t === a || t === o) return e
                        }
                        return "account" === a && t.find((e => String(e).toLowerCase().trim().includes("item"))) ? t.find((e => String(e).toLowerCase().trim().includes("item"))) : "account" === a && t.find((e => String(e).toLowerCase().trim().includes("ÿßŸÑÿ®ŸÜÿØ"))) ? t.find((e => String(e).toLowerCase().trim().includes("ÿßŸÑÿ®ŸÜÿØ"))) : "value" === a && t.find((e => String(e).toLowerCase().trim().includes("amount"))) ? t.find((e => String(e).toLowerCase().trim().includes("amount"))) : "value" === a && t.find((e => String(e).toLowerCase().trim().includes("ÿßŸÑŸÇŸäŸÖÿ©"))) ? t.find((e => String(e).toLowerCase().trim().includes("ÿßŸÑŸÇŸäŸÖÿ©"))) : "classification" === a && t.find((e => String(e).toLowerCase().trim().includes("classification"))) ? t.find((e => String(e).toLowerCase().trim().includes("classification"))) : "classification" === a && t.find((e => String(e).toLowerCase().trim().includes("ÿ™ÿµŸÜŸäŸÅ"))) ? t.find((e => String(e).toLowerCase().trim().includes("ÿ™ÿµŸÜŸäŸÅ"))) : ""
                    })(e, t.fileHeaders);
                return `
            <div class="col-md-4 col-sm-12">
                <label for="map-${e}" class="form-label fw-bold">${o}</label>
                <select id="map-${e}" class="form-select form-select-sm" data-field-key="${e}">
                    <option value="">-- ${"ar"===a?"ÿ™ÿ¨ÿßŸáŸÑ":"Ignore"} --</option>
                    ${t.fileHeaders.map((e=>`<option value="${e}" ${e===n?"selected":""}>${e}</option>`)).join("")}
                </select>
            </div>`
            })).join("");
            const n = `
        <div class="col-md-12 col-sm-12 mt-3 pt-3 border-top">
            <label for="map-StatementType" class="form-label fw-bold">${o("mapToStatement")}</label>
            <select id="map-StatementType" class="form-select form-select">
                <option value="bs">${o("tabBS")}</option>
                <option value="is">${o("tabIS")}</option>
            </select>
        </div>`;
            l.columnMapper.innerHTML = e + n
        },

        b = e => {
            if (!e) return;
            l.fileNameDisplay.textContent = `File: ${e.name} | Size: ${(e.size/1024).toFixed(2)} KB`, l.filePreviewArea.classList.remove("d-none"), l.fileDropArea.classList.add("d-none"), l.previewSpinner.classList.remove("d-none"), l.filePreviewTable.innerHTML = "", l.columnMapper.innerHTML = "";
            const s = new FileReader;
            s.onload = e => {
                try {
                    const o = e.target.result,
                        s = XLSX.read(o, {
                            type: "array"
                        }),
                        n = s.SheetNames[0],
                        r = s.Sheets[n],
                        i = XLSX.utils.sheet_to_json(r, {
                            header: 0
                        });
                    if (0 === i.length) throw new Error("No data found in file.");
                    t.fileData = i, t.fileHeaders = Object.keys(i[0]), (() => {
                        if (0 === t.fileData.length) return void(l.filePreviewTable.innerHTML = `<p class="text-danger">${"ar"===a?"ÿßŸÑŸÖŸÑŸÅ ŸÅÿßÿ±ÿ∫ ÿ£Ÿà ŸÑÿß ŸäŸÖŸÉŸÜ ŸÇÿ±ÿßÿ°ÿ™Ÿá.":"File is empty or unreadable."}</p>`);
                        const e = t.fileHeaders,
                            o = t.fileData.slice(0, 5);
                        let s = '<table class="table table-sm table-bordered table-striped small">';
                        s += `<thead class="table-light"><tr>${e.map((e=>`<th>${e}</th>`)).join("")}</tr></thead>`, s += "<tbody>", o.forEach((t => {
                            s += `<tr>${e.map((e=>`<td>${t[e]||""}</td>`)).join("")}</tr>`
                        })), s += "</tbody></table>", l.filePreviewTable.innerHTML = s
                    })(), v(), l.previewSpinner.classList.add("d-none")
                } catch (e) {
                    console.error(e), alert(o("fileReadError")), g()
                }
            }, s.onerror = () => {
                alert(o("fileReadError")), g()
            }, s.readAsArrayBuffer(e) // <-- [FIX] You were not reading the file, I added this line.
        },
        g = () => {
            l.filePreviewArea.classList.add("d-none"), l.fileDropArea.classList.remove("d-none"), l.fileUploader.value = "", t.fileData = [], t.fileHeaders = []
        },

        h = () => {
            if (!confirm(o("confirmClearUpload"))) return;
            const e = {};
            l.columnMapper.querySelectorAll("select[data-field-key]").forEach((t => {
                e[t.dataset.fieldKey] = t.value
            }));
            const a = document.getElementById("map-StatementType").value;
            if (t.data[a] = [],
                t.fileData.forEach((o => {
                    const s = o[e.Classification] || "",
                        n = C(s),
                        l = {
                            Account: o[e.Account] || "",
                            Value: i(o[e.Value]),
                            Classification: n
                        },
                        c = {};
                    r.tables[a].fields.forEach((e => c[e] = l[e])), t.data[a].push(c)
                })),
                0 === t.data[a].length) {
                const e = e => e.reduce(((e, t) => ({ ...e,
                    [t]: "Value" === t ? 0 : ""
                })), {});
                t.data[a] = [e(r.tables[a].fields)]
            }
            d(), m();
            new bootstrap.Tab(l.manualTab).show();
            const s = document.getElementById(`${a}-tab`);
            if (s) {
                new bootstrap.Tab(s).show()
            }
            g(), alert(o("fileProcessingSuccess"))
        },

        C = e => {
            if (!e) return "";
            const t = String(e).toLowerCase().trim(),
                o = ["ar", "en"],
                // --- üü¢ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠ üü¢ ---
                // ŸÇŸÖÿ™ ÿ®ÿ™ÿµÿ≠Ÿäÿ≠ ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿßŸÑÿÆÿßÿ∑ÿ¶ÿ© ŸáŸÜÿß
                s = Object.keys(window.pageTranslations.ar).filter((e => e.startsWith("opt_")));
            for (const e of s)
                for (const a of o) {
                    const o = window.pageTranslations[a] ? .[e] || "";
                    if (o.toLowerCase().trim() === t) return e
                }
            for (const e of s)
                for (const a of o) {
                    const o = window.pageTranslations[a] ? .[e] || "";
                    // --- üü¢ ŸÜŸáÿßŸäÿ© ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠ üü¢ ---
                    if (o.toLowerCase().trim().includes(t)) return e
                }
            return ""
        };

    l.saveBtn.addEventListener("click", (() => {
        d(), alert(o("savedSuccess"))
    })), l.clearBtn.addEventListener("click", (() => {
        confirm(o("confirmClear")) && (localStorage.removeItem("uploadedFinancialData"), c(), d(), m())
    })), l.saveAsBtn.addEventListener("click", p), l.savePreviousBtn.addEventListener("click", u), l.tabContent.addEventListener("click", (e => {
        const a = e.target.closest("[data-table]");
        if (a) {
            const e = a.dataset.table,
                o = r.tables[e].fields.reduce(((e, t) => ({ ...e,
                    [t]: "Value" === t ? 0 : ""
                })), {});
            t.data[e].push(o), d(), f(e)
        }
    })), c(), m(), l.browseButton && (l.browseButton.addEventListener("click", (() => l.fileUploader.click())), l.fileDropArea.addEventListener("click", (() => l.fileUploader.click())), l.processFileBtn.addEventListener("click", h), l.fileUploader.addEventListener("change", (e => {
        e.target.files.length > 0 && b(e.target.files[0])
    })), ["dragenter", "dragover", "dragleave", "drop"].forEach((e => {
        l.fileDropArea.addEventListener(e, (e => {
            e.preventDefault(), e.stopPropagation()
        }), !1)
    })), ["dragenter", "dragover"].forEach((e => {
        l.fileDropArea.addEventListener(e, (() => l.fileDropArea.classList.add("border-success")), !1)
    })), ["dragleave", "drop"].forEach((e => {
        l.fileDropArea.addEventListener(e, (() => l.fileDropArea.classList.remove("border-success")), !1)
    })), l.fileDropArea.addEventListener("drop", (e => {
        const t = e.dataTransfer.files;
        t.length > 0 && (l.fileUploader.files = t, b(t[0]))
    }), !1))
}));
