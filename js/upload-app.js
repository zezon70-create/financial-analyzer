window.pageTranslations={
    ar:{
        pageTitle:"رفع وإدخال القوائم — المحلل المالي",
        pageHeader:"رفع وإدخال القوائم المالية",
        pageSubheader:"هذه الصفحة مخصصة لغير المتخصصين لرفع القوائم المالية الجاهزة أو إدخالها بسهولة.",
        actionsTitle:"أدوات التحكم",
        save:"تأكيد الحفظ",
        clear:"مسح الكل",
        saveForComparison:"حفظ نسخة للمقارنات",
        saveAsPlaceholder:"مثال: بيانات 2025",
        saveAs:"حفظ باسم",
        uploadTitle:"رفع ملف جاهز",
        uploadLabel:"يمكنك رفع ملف Excel أو CSV يحتوي على أي من القوائم المالية.",
        entryTitle:"إدخال البيانات اليدوي",
        tabBS:"الميزانية العمومية",
        tabIS:"قائمة الدخل",
        addBS:"إضافة بند للميزانية",
        addIS:"إضافة بند للدخل",
        confirmClear:"هل أنت متأكد من مسح جميع البيانات في كل الجداول؟",
        savedSuccess:"تم تأكيد الحفظ! (ملاحظة: يتم حفظ بياناتك تلقائياً عند كل تغيير)",
        noDataToSave:"لا توجد بيانات لحفظها.",
        saveAsSuccess:"تم حفظ البيانات بنجاح باسم",
        saveAsError:"الرجاء إدخال اسم لحفظ مجموعة البيانات.",
        savePrevious:"حفظ كفترة سابقة",
        savedPreviousSuccess:"تم حفظ بيانات الفترة السابقة بنجاح!",
        thClassification:"التصنيف (مهم جداً)",
        uploadFileSubtitle:"سيقوم النظام بتحليل الأعمدة. ستحتاج لتصنيف البنود يدوياً بعد الرفع.",
        fileProcessingSuccess:"تمت معالجة الملف بنجاح! يرجى مراجعة البيانات وتصنيف البنود في جدول الإدخال اليدوي.",
        manualEntryTab:"إدخال يدوي",
        uploadFileTab:"رفع ملف",
        uploadFileTitle:"رفع ملف القوائم المالية (Excel أو CSV)",
        uploadDragDrop:"اسحب وأفلت ملفك هنا، أو اضغط للاختيار",
        uploadSupportedFiles:"الملفات المدعومة: .xlsx, .xls, .csv",
        uploadBrowseButton:"تصفح الملفات",
        uploadFileReady:"الملف جاهز للمعالجة",
        loadingPreview:"جاري تحميل المعاينة...",
        dataPreview:"معاينة أول 5 صفوف:",
        columnMappingTitle:"مطابقة الأعمدة",
        columnMappingSubtitle:"الرجاء مطابقة الأعمدة من ملفك مع الحقول المطلوبة.",
        processFileButton:"معالجة الملف وملء الجداول",
        confirmClearUpload:"سيقوم هذا بمسح البيانات في الجدول الذي ستختاره. هل تريد المتابعة؟",
        fileReadError:"حدث خطأ أثناء قراءة الملف. الرجاء التأكد من أنه ملف Excel أو CSV صالح.",
        fieldAccount:"الحساب/البند",
        fieldValue:"القيمة",
        fieldClassification:"التصنيف (اختياري)",
        mapToStatement:"هذه البيانات تخص أي قائمة؟",
        "group_currentAssets": "الأصول المتداولة",
        "group_nonCurrentAssets": "الأصول غير المتداولة",
        "group_currentLiabilities": "الخصوم المتداولة",
        "group_nonCurrentLiabilities": "الخصوم غير المتداولة",
        "group_equity": "حقوق الملكية",
        "group_revenues": "الإيرادات والمكاسب",
        "group_expenses": "التكاليف والمصروفات",
        opt_select:"-- اختر التصنيف --",
        opt_cash:"النقدية وما في حكمها",
        opt_receivables:"العملاء والمدينون",
        opt_inventory:"المخزون",
        opt_otherCurrentAssets:"أصول متداولة أخرى",
        opt_fixedAssets:"أصول ثابتة (صافي)",
        opt_otherNonCurrentAssets:"أصول غير متداولة أخرى",
        opt_payables:"الموردون والدائنون",
        opt_shortTermDebt:"قروض قصيرة الأجل",
        opt_otherCurrentLiabilities:"خصوم متداولة أخرى",
        opt_longTermDebt:"قروض طويلة الأجل",
        opt_otherNonCurrentLiabilities:"خصوم غير متداولة أخرى",
        opt_equity:"حقوق الملكية",
        opt_revenue:"الإيرادات",
        opt_cogs:"تكلفة البضاعة المباعة (COGS)",
        opt_operatingExpense:"مصروفات تشغيلية (عمومية وإدارية وبيع)",
        opt_depreciation:"مصروف الإهلاك (يضاف هنا لو منفصل)",
        opt_interestExpense:"مصروفات فائدة",
        opt_taxExpense:"مصروفات ضريبية",
        opt_otherRevenue:"إيرادات أخرى",
        opt_otherExpense:"مصروفات أخرى"
    },
    en:{
        pageTitle:"Upload & Enter Statements — Financial Analyzer",
        pageHeader:"Upload & Enter Financial Statements",
        pageSubheader:"This page is for non-specialists to easily upload ready-made financial statements or enter them manually.",
        actionsTitle:"Controls",
        save:"Confirm Save",
        clear:"Clear All",
        saveForComparison:"Save a copy for comparisons",
        saveAsPlaceholder:"e.g., Data 2025",
        saveAs:"Save As",
        uploadTitle:"Upload a File",
        uploadLabel:"You can upload an Excel or CSV file containing any of the financial statements.",
        entryTitle:"Manual Data Entry",
        tabBS:"Balance Sheet",
        tabIS:"Income Statement",
        addBS:"Add Balance Sheet Item",
        addIS:"Add Income Item",
        confirmClear:"Are you sure you want to clear all data in all tables?",
        savedSuccess:"Save Confirmed! (Note: Your data auto-saves on every change)",
        noDataToSave:"No data to save.",
        saveAsSuccess:"Data saved successfully as",
        saveAsError:"Please enter a name to save the dataset.",
        savePrevious:"Save as Previous Period",
        savedPreviousSuccess:"Previous period data saved successfully!",
        thClassification:"Classification (Very Important)",
        uploadFileSubtitle:"The system will analyze columns. You will need to manually classify items after uploading.",
        fileProcessingSuccess:"File processed successfully! Please review the data and classify the items in the manual entry table.",
        manualEntryTab:"Manual Entry",
        uploadFileTab:"Upload File",
        uploadFileTitle:"Upload Financial Statements (Excel or CSV)",
        uploadDragDrop:"Drag & drop your file here, or click to browse",
        uploadSupportedFiles:"Supported files: .xlsx, .xls, .csv",
        uploadBrowseButton:"Browse Files",
        uploadFileReady:"File is ready to be processed",
        loadingPreview:"Loading preview...",
        dataPreview:"Preview of first 5 rows:",
        columnMappingTitle:"Column Mapping",
        columnMappingSubtitle:"Please match the columns from your file to the required fields.",
        processFileButton:"Process File and Populate Tables",
        confirmClearUpload:"This will clear the data in the selected table. Do you want to continue?",
        fileReadError:"An error occurred reading the file. Please ensure it's a valid Excel or CSV file.",
        fileProcessingSuccess:"File processed successfully! The selected table has been populated.",
        fieldAccount:"Account/Item",
        fieldValue:"Value",
        fieldClassification:"Classification (Optional)",
        mapToStatement:"Which statement does this data belong to?",
        "group_currentAssets": "Current Assets",
        "group_nonCurrentAssets": "Non-Current Assets",
        "group_currentLiabilities": "Current Liabilities",
        "group_nonCurrentLiabilities": "Non-Current Liabilities",
        "group_equity": "Equity",
        "group_revenues": "Revenues & Gains",
        "group_expenses": "Costs & Expenses",
        opt_select:"-- Select Classification --",
        opt_cash:"Cash and Equivalents",
        opt_receivables:"Accounts Receivable",
        opt_inventory:"Inventory",
        opt_otherCurrentAssets:"Other Current Assets",
        opt_fixedAssets:"Fixed Assets (Net)",
        opt_otherNonCurrentAssets:"Other Non-Current Assets",
        opt_payables:"Accounts Payable",
        opt_shortTermDebt:"Short-term Debt",
        opt_otherCurrentLiabilities:"Other Current Liabilities",
        opt_longTermDebt:"Long-term Debt",
        opt_otherNonCurrentLiabilities:"Other Non-Current Liabilities",
        opt_equity:"Equity",
        opt_revenue:"Revenue",
        opt_cogs:"Cost of Goods Sold (COGS)",
        opt_operatingExpense:"Operating Expenses (SG&A)",
        opt_depreciation:"Depreciation Expense (if separate)",
        opt_interestExpense:"Interest Expense",
        opt_taxExpense:"Tax Expense",
        opt_otherRevenue:"Other Revenue",
        opt_otherExpense:"Other Expense"
    }
}; // <-- (الإصلاح) هنا كانت الفاصلة (,)، وتم تصحيحها إلى فاصلة منقوطة (;)

document.addEventListener("DOMContentLoaded",(()=>{
    
    // --- (تطوير) هيكل التصنيفات الجديد المُجمّع ---
    const classificationStructure = {
        bs: {
            "group_currentAssets": ["opt_cash", "opt_receivables", "opt_inventory", "opt_otherCurrentAssets"],
            "group_nonCurrentAssets": ["opt_fixedAssets", "opt_otherNonCurrentAssets"],
            "group_currentLiabilities": ["opt_payables", "opt_shortTermDebt", "opt_otherCurrentLiabilities"],
            "group_nonCurrentLiabilities": ["opt_longTermDebt", "opt_otherNonCurrentLiabilities"],
            "group_equity": ["opt_equity"]
        },
        is: {
            "group_revenues": ["opt_revenue", "opt_otherRevenue"],
            "group_expenses": ["opt_cogs", "opt_operatingExpense", "opt_depreciation", "opt_interestExpense", "opt_taxExpense", "opt_otherExpense"]
        }
    };
    // (نهاية التطوير)

    const t={data:{bs:[],is:[]},fileData:[],fileHeaders:[]},
    a=localStorage.getItem("lang")||"ar",
    o=e=>window.pageTranslations[a]?.[e]||e,
    s=e=>window.pageTranslations[a]?.[`field${e}`]||e,
    n=e=>window.pageTranslations[a]?.[e]||e,
    l={saveAsNameInput:document.getElementById("saveAsName"),saveAsBtn:document.getElementById("saveAsBtn"),saveBtn:document.getElementById("saveBtn"),clearBtn:document.getElementById("clearBtn"),savePreviousBtn:document.getElementById("savePreviousBtn"),tabContent:document.querySelector(".tab-content"),fileDropArea:document.getElementById("fileDropArea"),fileUploader:document.getElementById("fileUploader"),browseButton:document.getElementById("browseButton"),fileNameDisplay:document.getElementById("fileNameDisplay"),filePreviewArea:document.getElementById("filePreviewArea"),previewSpinner:document.getElementById("previewSpinner"),filePreviewTable:document.getElementById("filePreviewTable"),columnMapper:document.getElementById("columnMapper"),processFileBtn:document.getElementById("processFileBtn"),manualTab:document.getElementById("manual-tab")},
    r={tables:{bs:{headers:{ar:["الحساب","القيمة","التصنيف (مهم جداً)","إجراء"],en:["Account","Value","Classification (Important)","Action"]},fields:["Account","Value","Classification"]},is:{headers:{ar:["البند","القيمة","التصنيف (مهم جداً)","إجراء"],en:["Item","Value","Classification (Important)","Action"]},fields:["Account","Value","Classification"]}},
    requiredFields:["Account","Value","Classification"],
    i=e=>parseFloat(String(e||"").replace(/,/g,""))||0,
    d=()=>{localStorage.setItem("uploadedFinancialData",JSON.stringify(t.data)),console.log("Auto-save successful!")},
    c=()=>{const e=JSON.parse(localStorage.getItem("uploadedFinancialData")||"{}");for(const o in r.tables)t.data[o]=e[o]?.length>0?e[o]:[(a=r.tables[o].fields,a.reduce(((e,t)=>({...e,[t]:"Value"===t?0:""})),{}))],t.data[o].forEach((e=>{void 0===e.Classification&&(e.Classification="")}));var a},
    p=()=>{alert("Save As function needs to be updated to support classifications.")},
    u=()=>{if(0!==t.data.bs.length||0!==t.data.is.length)try{localStorage.setItem("uploadedFinancialDataPrevious",JSON.stringify(t.data)),alert(o("savedPreviousSuccess"))}catch(e){alert("Error saving previous period data.")}else alert(o("noDataToSave"))},
    
    // --- (تطوير) دالة بناء الصفوف (f) ---
    f=o=>{
        const s=document.getElementById(`${o}Table`),
        l=r.tables[o],
        c=t.data[o],
        p=l.headers[a];
        s.innerHTML=`<thead><tr>${p.map((e=>`<th>${e}</th>`)).join("")}</tr></thead><tbody></tbody>`;
        const u=s.querySelector("tbody");

        // --- (تطوير) بناء القائمة المنسدلة المُجمّعة باستخدام <optgroup> ---
        let m = ""; // m = optionsHtml
        const groups = classificationStructure[o]; // e.g., classificationStructure['bs']
        for (const groupKey in groups) {
            const groupName = n(groupKey); // ترجمة اسم المجموعة
            m += `<optgroup label="${groupName}">`;
            const items = groups[groupKey]; // e.g., ["opt_cash", "opt_receivables"]
            for (const itemKey of items) {
                m += `<option value="${itemKey}">${n(itemKey)}</option>`;
            }
            m += `</optgroup>`;
        }
        // (نهاية التطوير)

        c.forEach(((e,t)=>{const a=document.createElement("tr");let s="";l.fields.forEach((t=>{const a=e[t]||("Value"===t?0:"");if("Classification"===t)s+=`\n                        <td>\n                            <select class="form-select form-select-sm" data-field="Classification">\n                                <option value="">${n("opt_select")}</option>\n                                ${m}\n                            </select>\n                        </td>`;else{s+=`<td><input class="form-control form-control-sm" type="${"Value"===t?"number":"text"}" data-field="${t}" value="${a}"></td>`}})),s+='<td><button class="btn btn-sm btn-outline-danger btn-delete"><i class="bi bi-trash"></i></button></td>',a.innerHTML=s;const r=a.querySelector('select[data-field="Classification"]');r&&(r.value=e.Classification||""),a.querySelectorAll("input, select").forEach((e=>{e.addEventListener("change",(e=>{const a=e.target.dataset.field;c[t][a]="number"===e.target.type?i(e.target.value):e.target.value,d()}))})),a.querySelector(".btn-delete").addEventListener("click",(()=>{c.splice(t,1),d(),f(o)})),u.appendChild(a)}))
    },
    // (نهاية تحديث الدالة)

    m=()=>Object.keys(r.tables).forEach((e=>f(e))),
    v=()=>{let e=r.requiredFields.map((e=>{const o=s(e),n=((e,t)=>{const a=e.toLowerCase(),o=(s(e)||"").toLowerCase();for(const e of t){const t=String(e||"").toLowerCase().trim();if(t===a||t===o)return e}return"account"===a&&t.find((e=>String(e).toLowerCase().trim().includes("item")))?t.find((e=>String(e).toLowerCase().trim().includes("item"))):"account"===a&&t.find((e=>String(e).toLowerCase().trim().includes("البند")))?t.find((e=>String(e).toLowerCase().trim().includes("البند"))):"value"===a&&t.find((e=>String(e).toLowerCase().trim().includes("amount")))?t.find((e=>String(e).toLowerCase().trim().includes("amount"))):"value"===a&&t.find((e=>String(e).toLowerCase().trim().includes("القيمة")))?t.find((e=>String(e).toLowerCase().trim().includes("القيمة"))):"classification"===a&&t.find((e=>String(e).toLowerCase().trim().includes("classification")))?t.find((e=>String(e).toLowerCase().trim().includes("classification"))):"classification"===a&&t.find((e=>String(e).toLowerCase().trim().includes("تصنيف")))?t.find((e=>String(e).toLowerCase().trim().includes("تصنيف"))):""})(e,t.fileHeaders);return`\n            <div class="col-md-4 col-sm-12">\n                <label for="map-${e}" class="form-label fw-bold">${o}</label>\n                <select id="map-${e}" class="form-select form-select-sm" data-field-key="${e}">\n                    <option value="">-- ${"ar"===a?"تجاهل":"Ignore"} --</option>\n                    ${t.fileHeaders.map((e=>`<option value="${e}" ${e===n?"selected":""}>${e}</option>`)).join("")}\n                </select>\n            </div>`})).join("");const n=`\n        <div class="col-md-12 col-sm-12 mt-3 pt-3 border-top">\n            <label for="map-StatementType" class="form-label fw-bold">${o("mapToStatement")}</label>\n            <select id="map-StatementType" class="form-select form-select">\n                <option value="bs">${o("tabBS")}</option>\n                <option value="is">${o("tabIS")}</option>\n            </select>\n        </div>`;l.columnMapper.innerHTML=e+n},
    b=e=>{if(!e)return;l.fileNameDisplay.textContent=`File: ${e.name} | Size: ${(e.size/1024).toFixed(2)} KB`,l.filePreviewArea.classList.remove("d-none"),l.fileDropArea.classList.add("d-none"),l.previewSpinner.classList.remove("d-none"),l.filePreviewTable.innerHTML="",l.columnMapper.innerHTML="";const s=new FileReader;s.onload=e=>{try{const o=e.target.result,s=XLSX.read(o,{type:"array"}),n=s.SheetNames[0],r=s.Sheets[n],i=XLSX.utils.sheet_to_json(r,{header:0});if(0===i.length)throw new Error("No data found in file.");t.fileData=i,t.fileHeaders=Object.keys(i[0]),(()=>{if(0===t.fileData.length)return void(l.filePreviewTable.innerHTML=`<p class="text-danger">${"ar"===a?"الملف فارغ أو لا يمكن قراءته.":"File is empty or unreadable."}</p>`);const e=t.fileHeaders,o=t.fileData.slice(0,5);let s='<table class="table table-sm table-bordered table-striped small">';s+=`<thead class="table-light"><tr>${e.map((e=>`<th>${e}</th>`)).join("")}</tr></thead>`,s+="<tbody>",o.forEach((t=>{s+=`<tr>${e.map((e=>`<td>${t[e]||""}</td>`)).join("")}</tr>`})),s+="</tbody></table>",l.filePreviewTable.innerHTML=s})(),v(),l.previewSpinner.classList.add("d-none")}catch(e){console.error(e),alert(o("fileReadError")),g()}},s.onerror=()=>{alert(o("fileReadError")),g()},
    g=()=>{l.filePreviewArea.classList.add("d-none"),l.fileDropArea.classList.remove("d-none"),l.fileUploader.value="",t.fileData=[],t.fileHeaders=[]},
    
    // --- (إصلاح) دالة معالجة الملف (y) ---
    y=()=>{if(!confirm(o("confirmClearUpload")))return;const e={};l.columnMapper.querySelectorAll("select[data-field-key]").forEach((t=>{e[t.dataset.fieldKey]=t.value}));const s=document.getElementById("map-StatementType").value;if(t.data[s]=[],
    
    // (إصلاح) تم تغيير 'o' إلى 'a' هنا
    t.fileData.forEach((a=>{const n=a[e.Classification]||"",l=C(n),i={Account:a[e.Account]||"",Value:i(a[e.Value]),Classification:l},d={};r.tables[s].fields.forEach((e=>d[e]=i[e])),t.data[s].push(d)})),
    // --- (نهاية الإصلاح) ---
    
    0===t.data[s].length){const e=e=>e.reduce(((e,t)=>({...e,[t]:"Value"===t?0:""})),{});t.data[s]=[e(r.tables[s].fields)]}d(),m();new bootstrap.Tab(l.manualTab).show();const n=document.getElementById(`${s}-tab`);if(n){new bootstrap.Tab(n).show()}g(),alert(o("fileProcessingSuccess"))},
    // (نهاية دالة y)

    C=e=>{if(!e)return"";const t=String(e).toLowerCase().trim(),o=["ar","en"],s=Object.keys(window.pageTranslations.ar).filter((e=>e.startsWith("opt_")));for(const e of s)for(const a of o){const o=window.pageTranslations[a]?.[e]||"";if(o.toLowerCase().trim()===t)return e}for(const e of s)for(const a of o){const o=window.pageTranslations[a]?.[e]||"";if(o.toLowerCase().trim().includes(t))return e}return""};
    l.saveBtn.addEventListener("click",(()=>{d(),alert(o("savedSuccess"))})),
    l.clearBtn.addEventListener("click",(()=>{confirm(o("confirmClear"))&&(localStorage.removeItem("uploadedFinancialData"),c(),d(),m())})),
    l.saveAsBtn.addEventListener("click",p),
    l.savePreviousBtn.addEventListener("click",u),
    l.tabContent.addEventListener("click",(e=>{const a=e.target.closest("[data-table]");if(a){const e=a.dataset.table,o=r.tables[e].fields.reduce(((e,t)=>({...e,[t]:"Value"===t?0:""})),{});t.data[e].push(o),d(),f(e)}})),
    c(),m(),l.browseButton&&(l.browseButton.addEventListener("click",(()=>l.fileUploader.click())),l.fileDropArea.addEventListener("click",(()=>l.fileUploader.click())),l.processFileBtn.addEventListener("click",y),l.fileUploader.addEventListener("change",(e=>{e.target.files.length>0&&b(e.target.files[0])})),["dragenter","dragover","dragleave","drop"].forEach((e=>{l.fileDropArea.addEventListener(e,(e=>{e.preventDefault(),e.stopPropagation()}),!1)})),["dragenter","dragover"].forEach((e=>{l.fileDropArea.addEventListener(e,(()=>l.fileDropArea.classList.add("border-success")),!1)})),["dragleave","drop"].forEach((e=>{l.fileDropArea.addEventListener(e,(()=>l.fileDropArea.classList.remove("border-success")),!1)})),l.fileDropArea.addEventListener("drop",(e=>{const t=e.dataTransfer.files;t.length>0&&(l.fileUploader.files=t,b(t[0]))}),!1))
}));