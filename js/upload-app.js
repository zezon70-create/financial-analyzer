window.pageTranslations={
    ar:{
        pageTitle:"Ø±ÙØ¹ ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… â€” Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ",
        pageHeader:"Ø±ÙØ¹ ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©",
        pageSubheader:"Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„ØºÙŠØ± Ø§Ù„Ù…ØªØ®ØµØµÙŠÙ† Ù„Ø±ÙØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø©.",
        actionsTitle:"Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ…",
        save:"ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸",
        clear:"Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„",
        saveForComparison:"Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª",
        saveAsPlaceholder:"Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù†Ø§Øª 2025",
        saveAs:"Ø­ÙØ¸ Ø¨Ø§Ø³Ù…",
        uploadTitle:"Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ø§Ù‡Ø²",
        uploadLabel:"ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø£Ùˆ CSV ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©.",
        entryTitle:"Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠ",
        tabBS:"Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©",
        tabIS:"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„",
        addBS:"Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©",
        addIS:"Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ù„Ù„Ø¯Ø®Ù„",
        confirmClear:"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ØŸ",
        savedSuccess:"ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸! (Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙƒÙ„ ØªØºÙŠÙŠØ±)",
        noDataToSave:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­ÙØ¸Ù‡Ø§.",
        saveAsSuccess:"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø§Ø³Ù…",
        saveAsError:"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ø­ÙØ¸ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.",
        savePrevious:"Ø­ÙØ¸ ÙƒÙØªØ±Ø© Ø³Ø§Ø¨Ù‚Ø©",
        savedPreviousSuccess:"ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!",
        thClassification:"Ø§Ù„ØªØµÙ†ÙŠÙ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)",
        uploadFileSubtitle:"Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©. Ø³ØªØ­ØªØ§Ø¬ Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹.",
        fileProcessingSuccess:"ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­! ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ.",
        manualEntryTab:"Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ",
        uploadFileTab:"Ø±ÙØ¹ Ù…Ù„Ù",
        uploadFileTitle:"Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Excel Ø£Ùˆ CSV)",
        uploadDragDrop:"Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù…Ù„ÙÙƒ Ù‡Ù†Ø§ØŒ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±",
        uploadSupportedFiles:"Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: .xlsx, .xls, .csv",
        uploadBrowseButton:"ØªØµÙØ­ Ø§Ù„Ù…Ù„ÙØ§Øª",
        uploadFileReady:"Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",
        loadingPreview:"Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...",
        dataPreview:"Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„ 5 ØµÙÙˆÙ:",
        columnMappingTitle:"Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©",
        columnMappingSubtitle:"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ù† Ù…Ù„ÙÙƒ Ù…Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.",
        processFileButton:"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù ÙˆÙ…Ù„Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„",
        confirmClearUpload:"Ø³ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø¨Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø°ÙŠ Ø³ØªØ®ØªØ§Ø±Ù‡. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ",
        fileReadError:"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù…Ù„Ù Excel Ø£Ùˆ CSV ØµØ§Ù„Ø­.",
        fieldAccount:"Ø§Ù„Ø­Ø³Ø§Ø¨/Ø§Ù„Ø¨Ù†Ø¯",
        fieldValue:"Ø§Ù„Ù‚ÙŠÙ…Ø©",
        
        // --- (ØªØ·ÙˆÙŠØ±) Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ ---
        fieldClassification:"Ø§Ù„ØªØµÙ†ÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
        mapToStatement:"Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ®Øµ Ø£ÙŠ Ù‚Ø§Ø¦Ù…Ø©ØŸ",

        // --- (ØªØ·ÙˆÙŠØ±) Ø¥Ø¶Ø§ÙØ© ØªØ±Ø¬Ù…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ---
        "group_currentAssets": "Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©",
        "group_nonCurrentAssets": "Ø§Ù„Ø£ØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©",
        "group_currentLiabilities": "Ø§Ù„Ø®ØµÙˆÙ… Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©",
        "group_nonCurrentLiabilities": "Ø§Ù„Ø®ØµÙˆÙ… ØºÙŠØ± Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©",
        "group_equity": "Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©",
        "group_revenues": "Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ÙƒØ§Ø³Ø¨",
        "group_expenses": "Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª",

        opt_select:"-- Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ --",
        opt_cash:"Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© ÙˆÙ…Ø§ ÙÙŠ Ø­ÙƒÙ…Ù‡Ø§",
        opt_receivables:"Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†",
        opt_inventory:"Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",
        opt_otherCurrentAssets:"Ø£ØµÙˆÙ„ Ù…ØªØ¯Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰",
        opt_fixedAssets:"Ø£ØµÙˆÙ„ Ø«Ø§Ø¨ØªØ© (ØµØ§ÙÙŠ)",
        opt_otherNonCurrentAssets:"Ø£ØµÙˆÙ„ ØºÙŠØ± Ù…ØªØ¯Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰",
        opt_payables:"Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù†ÙˆÙ†",
        opt_shortTermDebt:"Ù‚Ø±ÙˆØ¶ Ù‚ØµÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù„",
        opt_otherCurrentLiabilities:"Ø®ØµÙˆÙ… Ù…ØªØ¯Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰",
        opt_longTermDebt:"Ù‚Ø±ÙˆØ¶ Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ø£Ø¬Ù„",
        opt_otherNonCurrentLiabilities:"Ø®ØµÙˆÙ… ØºÙŠØ± Ù…ØªØ¯Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰",
        opt_equity:"Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©",
        opt_revenue:"Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª",
        opt_cogs:"ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© (COGS)",
        opt_operatingExpense:"Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ÙŠØ© (Ø¹Ù…ÙˆÙ…ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ¨ÙŠØ¹)",
        opt_depreciation:"Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ (ÙŠØ¶Ø§Ù Ù‡Ù†Ø§ Ù„Ùˆ Ù…Ù†ÙØµÙ„)",
        opt_interestExpense:"Ù…ØµØ±ÙˆÙØ§Øª ÙØ§Ø¦Ø¯Ø©",
        opt_taxExpense:"Ù…ØµØ±ÙˆÙØ§Øª Ø¶Ø±ÙŠØ¨ÙŠØ©",
        opt_otherRevenue:"Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰",
        opt_otherExpense:"Ù…ØµØ±ÙˆÙØ§Øª Ø£Ø®Ø±Ù‰"
    },
    en:{
        pageTitle:"Upload & Enter Statements â€” Financial Analyzer",
        pageHeader:"Upload & Enter Financial Statements",
        pageSubheader:"This page is for non-specialists to easily upload ready-made financial statements or enter them manually.",
        actionsTitle:"Controls",
        save:"Confirm Save",
        clear:"Clear All",
        saveForComparison:"Save a copy for comparisons",
        saveAsPlaceholder:"e.g., Data 2025",
        saveAs:"Save As",
        uploadTitle:"Upload a File",
        uploadLabel:"You can upload an Excel or CSV file containing any of the financial statements.",
        entryTitle:"Manual Data Entry",
        tabBS:"Balance Sheet",
        tabIS:"Income Statement",
        addBS:"Add Balance Sheet Item",
        addIS:"Add Income Item",
        confirmClear:"Are you sure you want to clear all data in all tables?",
        savedSuccess:"Save Confirmed! (Note: Your data auto-saves on every change)",
        noDataToSave:"No data to save.",
        saveAsSuccess:"Data saved successfully as",
        saveAsError:"Please enter a name to save the dataset.",
        savePrevious:"Save as Previous Period",
        savedPreviousSuccess:"Previous period data saved successfully!",
        thClassification:"Classification (Very Important)",
        uploadFileSubtitle:"The system will analyze columns. You will need to manually classify items after uploading.",
        fileProcessingSuccess:"File processed successfully! Please review the data and classify the items in the manual entry table.",
        manualEntryTab:"Manual Entry",
        uploadFileTab:"Upload File",
        uploadFileTitle:"Upload Financial Statements (Excel or CSV)",
        uploadDragDrop:"Drag & drop your file here, or click to browse",
        uploadSupportedFiles:"Supported files: .xlsx, .xls, .csv",
        uploadBrowseButton:"Browse Files",
        uploadFileReady:"File is ready to be processed",
        loadingPreview:"Loading preview...",
        dataPreview:"Preview of first 5 rows:",
        columnMappingTitle:"Column Mapping",
        columnMappingSubtitle:"Please match the columns from your file to the required fields.",
        processFileButton:"Process File and Populate Tables",
        confirmClearUpload:"This will clear the data in the selected table. Do you want to continue?",
        fileReadError:"An error occurred reading the file. Please ensure it's a valid Excel or CSV file.",
        fileProcessingSuccess:"File processed successfully! The selected table has been populated.",
        fieldAccount:"Account/Item",
        fieldValue:"Value",
        
        // --- (ØªØ·ÙˆÙŠØ±) Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ ---
        fieldClassification:"Classification (Optional)",
        mapToStatement:"Which statement does this data belong to?",
        
        // --- (ØªØ·ÙˆÙŠØ±) Ø¥Ø¶Ø§ÙØ© ØªØ±Ø¬Ù…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ---
        "group_currentAssets": "Current Assets",
        "group_nonCurrentAssets": "Non-Current Assets",
        "group_currentLiabilities": "Current Liabilities",
        "group_nonCurrentLiabilities": "Non-Current Liabilities",
        "group_equity": "Equity",
        "group_revenues": "Revenues & Gains",
        "group_expenses": "Costs & Expenses",

        opt_select:"-- Select Classification --",
        opt_cash:"Cash and Equivalents",
        opt_receivables:"Accounts Receivable",
        opt_inventory:"Inventory",
        opt_otherCurrentAssets:"Other Current Assets",
        opt_fixedAssets:"Fixed Assets (Net)",
        opt_otherNonCurrentAssets:"Other Non-Current Assets",
        opt_payables:"Accounts Payable",
        opt_shortTermDebt:"Short-term Debt",
        opt_otherCurrentLiabilities:"Other Current Liabilities",
        opt_longTermDebt:"Long-term Debt",
        opt_otherNonCurrentLiabilities:"Other Non-Current Liabilities",
        opt_equity:"Equity",
        opt_revenue:"Revenue",
        opt_cogs:"Cost of Goods Sold (COGS)",
        opt_operatingExpense:"Operating Expenses (SG&A)",
        opt_depreciation:"Depreciation Expense (if separate)",
        opt_interestExpense:"Interest Expense",
        opt_taxExpense:"Tax Expense",
        opt_otherRevenue:"Other Revenue",
        opt_otherExpense:"Other Expense"
    }
}; // <-- (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ) Ù‡Ù†Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙØ§ØµÙ„Ø© (,)ØŒ ÙˆØªÙ… ØªØµØ­ÙŠØ­Ù‡Ø§ Ø¥Ù„Ù‰ ÙØ§ØµÙ„Ø© Ù…Ù†Ù‚ÙˆØ·Ø© (;)

document.addEventListener("DOMContentLoaded",(()=>{
    
    // --- (ØªØ·ÙˆÙŠØ±) Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙØ¬Ù…Ù‘Ø¹ ---
    const classificationStructure = {
        bs: {
            "group_currentAssets": ["opt_cash", "opt_receivables", "opt_inventory", "opt_otherCurrentAssets"],
            "group_nonCurrentAssets": ["opt_fixedAssets", "opt_otherNonCurrentAssets"],
            "group_currentLiabilities": ["opt_payables", "opt_shortTermDebt", "opt_otherCurrentLiabilities"],
            "group_nonCurrentLiabilities": ["opt_longTermDebt", "opt_otherNonCurrentLiabilities"],
            "group_equity": ["opt_equity"]
        },
        is: {
            "group_revenues": ["opt_revenue", "opt_otherRevenue"],
            "group_expenses": ["opt_cogs", "opt_operatingExpense", "opt_depreciation", "opt_interestExpense", "opt_taxExpense", "opt_otherExpense"]
        }
    };
    // (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ·ÙˆÙŠØ±)

    // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨ØªØ§Ø¹Ùƒ (e) Ø§Ù„Ù‚Ø¯ÙŠÙ…ØŒ ØªÙ… Ø¯Ù…Ø¬Ù‡ Ù…Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§Øª
    const e = classificationStructure; // (ØªØ·ÙˆÙŠØ±) ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯
    
    const t={data:{bs:[],is:[]},fileData:[],fileHeaders:[]},
    a=localStorage.getItem("lang")||"ar",
    o=e=>window.pageTranslations[a]?.[e]||e,
    s=e=>window.pageTranslations[a]?.[`field${e}`]||e,
    n=e=>window.pageTranslations[a]?.[e]||e,
    l={saveAsNameInput:document.getElementById("saveAsName"),saveAsBtn:document.getElementById("saveAsBtn"),saveBtn:document.getElementById("saveBtn"),clearBtn:document.getElementById("clearBtn"),savePreviousBtn:document.getElementById("savePreviousBtn"),tabContent:document.querySelector(".tab-content"),fileDropArea:document.getElementById("fileDropArea"),fileUploader:document.getElementById("fileUploader"),browseButton:document.getElementById("browseButton"),fileNameDisplay:document.getElementById("fileNameDisplay"),filePreviewArea:document.getElementById("filePreviewArea"),previewSpinner:document.getElementById("previewSpinner"),filePreviewTable:document.getElementById("filePreviewTable"),columnMapper:document.getElementById("columnMapper"),processFileBtn:document.getElementById("processFileBtn"),manualTab:document.getElementById("manual-tab")},
    
    // --- ğŸŸ¢ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ğŸŸ¢ ---
    r={
        tables:{
            bs:{headers:{ar:["Ø§Ù„Ø­Ø³Ø§Ø¨","Ø§Ù„Ù‚ÙŠÙ…Ø©","Ø§Ù„ØªØµÙ†ÙŠÙ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)","Ø¥Ø¬Ø±Ø§Ø¡"],en:["Account","Value","Classification (Important)","Action"]},fields:["Account","Value","Classification"]},
            is:{headers:{ar:["Ø§Ù„Ø¨Ù†Ø¯","Ø§Ù„Ù‚ÙŠÙ…Ø©","Ø§Ù„ØªØµÙ†ÙŠÙ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)","Ø¥Ø¬Ø±Ø§Ø¡"],en:["Item","Value","Classification (Important)","Action"]},fields:["Account","Value","Classification"]}
        },
        
        // --- (ØªØ·ÙˆÙŠØ±) Ø¥Ø¶Ø§ÙØ© "Classification" Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø±ÙØ¹ ---
        // ØªÙ… Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„ÙŠÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØºÙŠØ± r
        requiredFields:["Account","Value","Classification"] 
    },
    // --- ğŸŸ¢ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ğŸŸ¢ ---
    
    i=e=>parseFloat(String(e||"").replace(/,/g,""))||0,
    d=()=>{localStorage.setItem("uploadedFinancialData",JSON.stringify(t.data)),console.log("Auto-save successful!")},
    c=()=>{const e=JSON.parse(localStorage.getItem("uploadedFinancialData")||"{}");for(const o in r.tables)t.data[o]=e[o]?.length>0?e[o]:[(a=r.tables[o].fields,a.reduce(((e,t)=>({...e,[t]:"Value"===t?0:""})),{}))],t.data[o].forEach((e=>{void 0===e.Classification&&(e.Classification="")}));var a},
    p=()=>{alert("Save As function needs to be updated to support classifications.")},
    u=()=>{if(0!==t.data.bs.length||0!==t.data.is.length)try{localStorage.setItem("uploadedFinancialDataPrevious",JSON.stringify(t.data)),alert(o("savedPreviousSuccess"))}catch(e){alert("Error saving previous period data.")}else alert(o("noDataToSave"))},
    
    // --- (ØªØ·ÙˆÙŠØ±) Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙÙˆÙ (f) ---
    f=o=>{
        const s=document.getElementById(`${o}Table`),
        l=r.tables[o],
        c=t.data[o],
        p=l.headers[a];
        s.innerHTML=`<thead><tr>${p.map((e=>`<th>${e}</th>`)).join("")}</tr></thead><tbody></tbody>`;
        const u=s.querySelector("tbody");

        // --- (ØªØ·ÙˆÙŠØ±) Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ù…ÙØ¬Ù…Ù‘Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… <optgroup> ---
        let m = ""; // m = optionsHtml
        const groups = classificationStructure[o]; // e.g., classificationStructure['bs']
        for (const groupKey in groups) {
            const groupName = n(groupKey); // ØªØ±Ø¬Ù…Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
            m += `<optgroup label="${groupName}">`;
            const items = groups[groupKey]; // e.g., ["opt_cash", "opt_receivables"]
            for (const itemKey of items) {
                m += `<option value="${itemKey}">${n(itemKey)}</option>`;
            }
            m += `</optgroup>`;
        }
        // (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ·ÙˆÙŠØ±)

        c.forEach(((e,t)=>{const a=document.createElement("tr");let s="";l.fields.forEach((t=>{const a=e[t]||("Value"===t?0:"");if("Classification"===t)s+=`\n                        <td>\n                            <select class="form-select form-select-sm" data-field="Classification">\n                                <option value="">${n("opt_select")}</option>\n                                ${m}\n                            </select>\n                        </td>`;else{s+=`<td><input class="form-control form-control-sm" type="${"Value"===t?"number":"text"}" data-field="${t}" value="${a}"></td>`}})),s+='<td><button class="btn btn-sm btn-outline-danger btn-delete"><i class="bi bi-trash"></i></button></td>',a.innerHTML=s;const r=a.querySelector('select[data-field="Classification"]');r&&(r.value=e.Classification||""),a.querySelectorAll("input, select").forEach((e=>{e.addEventListener("change",(e=>{const a=e.target.dataset.field;c[t][a]="number"===e.target.type?i(e.target.value):e.target.value,d()}))})),a.querySelector(".btn-delete").addEventListener("click",(()=>{c.splice(t,1),d(),f(o)})),u.appendChild(a)}))
    },
    // (Ù†Ù‡Ø§ÙŠØ© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ù„Ø©)

    m=()=>Object.keys(r.tables).forEach((e=>f(e))),
    
    // --- (ØªØ·ÙˆÙŠØ±) Ø¯Ø§Ù„Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (v) ---
    v=()=>{
        // Ù„Ø§Ø­Ø¸ Ø£Ù† requiredFields Ù‡Ù†Ø§ Ø³ØªØ¹Ù…Ù„ Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† r
        let e = r.requiredFields.map((e=>{ 
            const o=s(e),n=((e,t)=>{const a=e.toLowerCase(),o=(s(e)||"").toLowerCase();for(const e of t){const t=String(e||"").toLowerCase().trim();if(t===a||t===o)return e}return"account"===a&&t.find((e=>String(e).toLowerCase().trim().includes("item")))?t.find((e=>String(e).toLowerCase().trim().includes("item"))):"account"===a&&t.find((e=>String(e).toLowerCase().trim().includes("Ø§Ù„Ø¨Ù†Ø¯")))?t.find((e=>String(e).toLowerCase().trim().includes("Ø§Ù„Ø¨Ù†Ø¯"))):"value"===a&&t.find((e=>String(e).toLowerCase().trim().includes("amount")))?t.find((e=>String(e).toLowerCase().trim().includes("amount"))):"value"===a&&t.find((e=>String(e).toLowerCase().trim().includes("Ø§Ù„Ù‚ÙŠÙ…Ø©")))?t.find((e=>String(e).toLowerCase().trim().includes("Ø§Ù„Ù‚ÙŠÙ…Ø©"))):"classification"===a&&t.find((e=>String(e).toLowerCase().trim().includes("classification")))?t.find((e=>String(e).toLowerCase().trim().includes("classification"))):"classification"===a&&t.find((e=>String(e).toLowerCase().trim().includes("ØªØµÙ†ÙŠÙ")))?t.find((e=>String(e).toLowerCase().trim().includes("ØªØµÙ†ÙŠÙ"))):""})(e,t.fileHeaders);return`
            <div class="col-md-4 col-sm-12">
                <label for="map-${e}" class="form-label fw-bold">${o}</label>
                <select id="map-${e}" class="form-select form-select-sm" data-field-key="${e}">
                    <option value="">-- ${"ar"===a?"ØªØ¬Ø§Ù‡Ù„":"Ignore"} --</option>
                    ${t.fileHeaders.map((e=>`<option value="${e}" ${e===n?"selected":""}>${e}</option>`)).join("")}
                </select>
            </div>`})).join("");
        const n=`
        <div class="col-md-12 col-sm-12 mt-3 pt-3 border-top">
            <label for="map-StatementType" class="form-label fw-bold">${o("mapToStatement")}</label>
            <select id="map-StatementType" class="form-select form-select">
                <option value="bs">${o("tabBS")}</option>
                <option value="is">${o("tabIS")}</option>
            </select>
        </div>`;
        l.columnMapper.innerHTML=e+n
    },
    // (Ù†Ù‡Ø§ÙŠØ© ØªØ·ÙˆÙŠØ± Ø¯Ø§Ù„Ø© v)

    b=e=>{if(!e)return;l.fileNameDisplay.textContent=`File: ${e.name} | Size: ${(e.size/1024).toFixed(2)} KB`,l.filePreviewArea.classList.remove("d-none"),l.fileDropArea.classList.add("d-none"),l.previewSpinner.classList.remove("d-none"),l.filePreviewTable.innerHTML="",l.columnMapper.innerHTML="";const s=new FileReader;s.onload=e=>{try{const o=e.target.result,s=XLSX.read(o,{type:"array"}),n=s.SheetNames[0],r=s.Sheets[n],i=XLSX.utils.sheet_to_json(r,{header:0});if(0===i.length)throw new Error("No data found in file.");t.fileData=i,t.fileHeaders=Object.keys(i[0]),(()=>{if(0===t.fileData.length)return void(l.filePreviewTable.innerHTML=`<p class="text-danger">${"ar"===a?"Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡ØªÙ‡.":"File is empty or unreadable."}</p>`);const e=t.fileHeaders,o=t.fileData.slice(0,5);let s='<table class="table table-sm table-bordered table-striped small">';s+=`<thead class="table-light"><tr>${e.map((e=>`<th>${e}</th>`)).join("")}</tr></thead>`,s+="<tbody>",o.forEach((t=>{s+=`<tr>${e.map((e=>`<td>${t[e]||""}</td>`)).join("")}</tr>`})),s+="</tbody></table>",l.filePreviewTable.innerHTML=s})(),v(),l.previewSpinner.classList.add("d-none")}catch(e){console.error(e),alert(o("fileReadError")),g()}},s.onerror=()=>{alert(o("fileReadError")),g()},
    g=()=>{l.filePreviewArea.classList.add("d-none"),l.fileDropArea.classList.remove("d-none"),l.fileUploader.value="",t.fileData=[],t.fileHeaders=[]},
    
    // --- (ØªØ·ÙˆÙŠØ±) Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù (h) ---
    h=()=>{if(!confirm(o("confirmClearUpload")))return;const e={};l.columnMapper.querySelectorAll("select[data-field-key]").forEach((t=>{e[t.dataset.fieldKey]=t.value}));const a=document.getElementById("map-StatementType").value;if(t.data[a]=[],
    
    t.fileData.forEach((o=>{
        const s=o[e.Classification]||"", // (ØªØ·ÙˆÙŠØ±) Ø§Ù‚Ø±Ø£ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØµÙ†ÙŠÙ Ù…Ù† Ø§Ù„Ù…Ù„Ù
        n=C(s), // (ØªØ·ÙˆÙŠØ±) Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„
        l={Account:o[e.Account]||"",Value:i(o[e.Value]),Classification:n},
        c={};r.tables[a].fields.forEach((e=>c[e]=l[e])),t.data[a].push(c)
    // --- ğŸŸ¢ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ğŸŸ¢ ---
    // ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ÙˆØ³ ) Ø§Ù„Ø²Ø§Ø¦Ø¯ Ù…Ù† Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ
    }), 
    // --- ğŸŸ¢ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ğŸŸ¢ ---
    // --- (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ·ÙˆÙŠØ±) ---
    
    0===t.data[a].length){const e=e=>e.reduce(((e,t)=>({...e,[t]:"Value"===t?0:""})),{});t.data[a]=[e(r.tables[a].fields)]}d(),m();new bootstrap.Tab(l.manualTab).show();const s=document.getElementById(`${a}-tab`);if(s){new bootstrap.Tab(s).show()}g(),alert(o("fileProcessingSuccess"))},
    // (Ù†Ù‡Ø§ÙŠØ© Ø¯Ø§Ù„Ø© h)

    // --- (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙØªØ§Ø­ Ø§Ù„ØªØµÙ†ÙŠÙ ---
    C=e=>{if(!e)return"";const t=String(e).toLowerCase().trim(),o=["ar","en"],s=Object.keys(window.pageTranslations.ar).filter((e=>e.startsWith("opt_")));for(const e of s)for(const a of o){const o=window.pageTranslations[a]?.[e]||"";if(o.toLowerCase().trim()===t)return e}for(const e of s)for(const a of o){const o=window.pageTranslations[a]?.[e]||"";if(o.toLowerCase().trim().includes(t))return e}return""};
    // (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ©)

    l.saveBtn.addEventListener("click",(()=>{d(),alert(o("savedSuccess"))})),
    l.clearBtn.addEventListener("click",(()=>{confirm(o("confirmClear"))&&(localStorage.removeItem("uploadedFinancialData"),c(),d(),m())})),
    l.saveAsBtn.addEventListener("click",p),
    l.savePreviousBtn.addEventListener("click",u),
    l.tabContent.addEventListener("click",(e=>{const a=e.target.closest("[data-table]");if(a){const e=a.dataset.table,o=r.tables[e].fields.reduce(((e,t)=>({...e,[t]:"Value"===t?0:""})),{});t.data[e].push(o),d(),f(e)}})),
    c(),m(),l.browseButton&&(l.browseButton.addEventListener("click",(()=>l.fileUploader.click())),l.fileDropArea.addEventListener("click",(()=>l.fileUploader.click())),l.processFileBtn.addEventListener("click",h),l.fileUploader.addEventListener("change",(e=>{e.target.files.length>0&&b(e.target.files[0])})),["dragenter","dragover","dragleave","drop"].forEach((e=>{l.fileDropArea.addEventListener(e,(e=>{e.preventDefault(),e.stopPropagation()}),!1)})),["dragenter","dragover"].forEach((e=>{l.fileDropArea.addEventListener(e,(()=>l.fileDropArea.classList.add("border-success")),!1)})),["dragleave","drop"].forEach((e=>{l.fileDropArea.addEventListener(e,(()=>l.fileDropArea.classList.remove("border-success")),!1)})),l.fileDropArea.addEventListener("drop",(e=>{const t=e.dataTransfer.files;t.length>0&&(l.fileUploader.files=t,b(t[0]))}),!1))
}));
