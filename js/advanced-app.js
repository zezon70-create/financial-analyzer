// js/advanced-app.js (Based on YOUR working version + Industry Benchmarks Added Carefully)

window.pageTranslations = {
    ar: {
        // ... (ูู ุงูุชุฑุฌูุงุช ุงูุณุงุจูุฉ ูู ุงูููุฏ ุงูุฐู ุฃุฑุณูุชู) ...
        pageTitle: "ุงูุชุญูููุงุช ุงููุชูุฏูุฉ โ ุงููุญูู ุงููุงูู", pageHeader: "ุงูุชุญูููุงุช ุงููุชูุฏูุฉ", pageSubheader: "ุงุณุชุฎุฏู ุฃุฏูุงุช ุชุญููููุฉ ูุชุฎุตุตุฉ ููุญุตูู ุนูู ุฑุคู ุฃุนูู ุญูู ุฃุฏุงุก ุนููู.",
        tabRatios: "ุงููุณุจ ุงููุงููุฉ", tabBreakeven: "ุชุญููู ุงูุชุนุงุฏู", tabDupont: "ุชุญููู ุฏูุจููุช", tabVertical: "ุงูุชุญููู ุงูุฑุฃุณู", tabZScore: "ูููุฐุฌ Z-Score", tabCashFlow: "ุชุญููู ุงูุชุฏููุงุช ุงูููุฏูุฉ",
        summaryTitle: "ุงูููุฎุต ุงูุฐูู", alertsTitle: "ุชูุจููุงุช ููุคุดุฑุงุช ุฎุทุฑ", thRatio: "ุงููุณุจุฉ", thValue: "ุงููููุฉ", thComment: "ุชุนููู ุชุญูููู", liquidityRatios: "ูุณุจ ุงูุณูููุฉ", profitabilityRatios: "ูุณุจ ุงูุฑุจุญูุฉ", leverageRatios: "ูุณุจ ุงูุฑูุน ุงููุงูู", efficiencyRatios: "ูุณุจ ุงูููุงุกุฉ", currentRatio: "ูุณุจุฉ ุงูุชุฏุงูู", currentRatio_comment_high: "ุณูููุฉ ููุชุงุฒุฉ...", currentRatio_comment_good: "ุณูููุฉ ุฌูุฏุฉ...", currentRatio_comment_low: "ูุคุดุฑ ุฎุทุฑ...", quickRatio: "ูุณุจุฉ ุงูุณูููุฉ ุงูุณุฑูุนุฉ", quickRatio_comment_good: "ูุฏุฑุฉ ุฌูุฏุฉ...", quickRatio_comment_low: "ูุคุดุฑ ุฎุทุฑ...", netProfitMargin: "ูุงูุด ุตุงูู ุงูุฑุจุญ", netProfitMargin_comment_high: "ุฑุจุญูุฉ ููุชุงุฒุฉ...", netProfitMargin_comment_avg: "ุฑุจุญูุฉ ููุจููุฉ...", netProfitMargin_comment_low: "ุฎุณุงุฆุฑ...", grossProfitMargin: "ูุงูุด ุงูุฑุจุญ ุงูุฅุฌูุงูู", grossProfitMargin_comment_high: "ูุงูุด ููู...", grossProfitMargin_comment_low: "ูุงูุด ุถุนูู...", roa: "ุงูุนุงุฆุฏ ุนูู ุงูุฃุตูู (ROA)", roa_comment_high: "ููุงุกุฉ ุนุงููุฉ...", roa_comment_low: "ููุงุกุฉ ููุฎูุถุฉ...", roe: "ุงูุนุงุฆุฏ ุนูู ุญููู ุงูููููุฉ (ROE)", roe_comment_high: "ุนุงุฆุฏ ููุชุงุฒ...", roe_comment_low: "ุนุงุฆุฏ ุถุนูู...", debtToEquity: "ูุณุจุฉ ุงูุฏูู ุฅูู ุญููู ุงูููููุฉ", debtToEquity_comment_low: "ุฏูู ููุฎูุถ...", debtToEquity_comment_good: "ุฏูู ูุนุชุฏู...", debtToEquity_comment_high: "ุฏูู ูุฑุชูุน...", debtToAssets: "ูุณุจุฉ ุงูุฏูู ุฅูู ุงูุฃุตูู", debtToAssets_comment_low: "ูุถุน ุขูู...", debtToAssets_comment_high: "ูุฎุงุทุฑ ูุฑุชูุนุฉ...", assetTurnover: "ูุนุฏู ุฏูุฑุงู ุงูุฃุตูู", assetTurnover_comment_high: "ููุงุกุฉ ููุชุงุฒุฉ...", assetTurnover_comment_low: "ููุงุกุฉ ููุฎูุถุฉ...", summary_ok: "ุงููุถุน ุงููุงูู ูุจุฏู ูุณุชูุฑูุง...", summary_risk: "ุชูุฌุฏ ุจุนุถ ูุคุดุฑุงุช ุงูุฎุทุฑ...", alert_liquidity_risk: "๐ด ุฎุทุฑ ุณูููุฉ...", alert_leverage_risk: "๐ก ุชูุจูู ุฏูู ูุฑุชูุน...", alert_profit_risk: "๐ด ุฎุทุฑ ุฑุจุญูุฉ...", alert_ok: "๐ข ูุง ุชูุฌุฏ ูุคุดุฑุงุช ุฎุทุฑ ุญุฑุฌุฉ...", noDataForRatios: "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ูุญุณุงุจ ุงููุณุจ. ูุฑุฌู ุฅุฏุฎุงู ููุฒุงู ุงููุฑุงุฌุนุฉ ุฃููุงู.",
        beInputTitle: "ูุฏุฎูุงุช ุงูุญุณุงุจ", labelFixedCosts: "ุฅุฌูุงูู ุงูุชูุงููู ุงูุซุงุจุชุฉ", labelVariableCost: "ุงูุชูููุฉ ุงููุชุบูุฑุฉ ูููุญุฏุฉ", labelSellingPrice: "ุณุนุฑ ุจูุน ุงููุญุฏุฉ", btnCalculate: "ุงุญุณุจ", beResultsTitle: "ุงููุชุงุฆุฌ", bepUnits: "ููุทุฉ ุงูุชุนุงุฏู (ุจุงููุญุฏุงุช)", bepValue: "ููุทุฉ ุงูุชุนุงุฏู (ุจุงููููุฉ)", beChartTitle: "ุฑุณู ุจูุงูู ูููุทุฉ ุงูุชุนุงุฏู", errorPrice: "ุณุนุฑ ุงูุจูุน ูุฌุจ ุฃู ูููู ุฃุนูู ูู ุงูุชูููุฉ ุงููุชุบูุฑุฉ.", errorPositiveValues: "ุงูุฑุฌุงุก ุฅุฏุฎุงู ููู ููุฌุจุฉ.", revenue: 'ุงูุฅูุฑุงุฏุงุช', totalCosts: 'ุฅุฌูุงูู ุงูุชูุงููู', fixedCosts: 'ุงูุชูุงููู ุงูุซุงุจุชุฉ', unitsSold: 'ุงููุญุฏุงุช ุงููุจุงุนุฉ', value: 'ุงููููุฉ',
        dupontTitle: "ุชุญููู ุฏูุจููุช ููุนุงุฆุฏ ุนูู ุญููู ุงูููููุฉ", dupontDesc: "ูุณุงุนุฏ ูุฐุง ุงูุชุญููู ุนูู ุชูููู ุงูุนุงุฆุฏ ุนูู ุญููู ุงูููููุฉ (ROE)...", dupontEquation: "ูุนุงุฏูุฉ ุฏูุจููุช:", dupontCompNPM: "ูุงูุด ุตุงูู ุงูุฑุจุญ", dupontCompAT: "ุฏูุฑุงู ุงูุฃุตูู", dupontCompEM: "ูุถุงุนู ุญููู ุงูููููุฉ", dupontCompROE: "ุงูุนุงุฆุฏ ุนูู ุญููู ุงูููููุฉ", dupontDataWarning: "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ (ูู ููุฒุงู ุงููุฑุงุฌุนุฉ) ูุฅุฌุฑุงุก ุชุญููู ุฏูุจููุช.", dupontInterpretationHighROE: "๐ข ุงูุนุงุฆุฏ ุงููุฑุชูุน...", dupontInterpretationLowROE: "๐ก ุงูุนุงุฆุฏ ุงูููุฎูุถ...", dupontFactorProfitability: "ุฑุจุญูุฉ ุชุดุบูููุฉ ูููุฉ...", dupontFactorEfficiency: "ููุงุกุฉ ุฃุตูู ุนุงููุฉ...", dupontFactorLeverage: "ุงุณุชุฎุฏุงู ุงูุฑูุน ุงููุงูู...", dupontFactorLowProfitability: "ุฑุจุญูุฉ ุชุดุบูููุฉ ุถุนููุฉ...", dupontFactorLowEfficiency: "ููุงุกุฉ ุฃุตูู ููุฎูุถุฉ...", dupontFactorLowLeverage: "ุงุนุชูุงุฏ ููุฎูุถ ุนูู ุงูุฏููู...",
        verticalTitle: "ุงูุชุญููู ุงูุฑุฃุณู (ุงูููุงุฆู ุฐุงุช ุงูุญุฌู ุงูููุญุฏ)", verticalDesc: "ูุนุฑุถ ูู ุจูุฏ ูู ุงูููุงุฆู ุงููุงููุฉ ููุณุจุฉ ูุฆููุฉ...", verticalDataWarning: "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ (ูู ููุฒุงู ุงููุฑุงุฌุนุฉ) ูุฅุฌุฑุงุก ุงูุชุญููู ุงูุฑุฃุณู.", verticalBS: "ุงูููุฒุงููุฉ ุงูุนููููุฉ (% ูู ุฅุฌูุงูู ุงูุฃุตูู)", verticalIS: "ูุงุฆูุฉ ุงูุฏุฎู (% ูู ุตุงูู ุงูุฅูุฑุงุฏุงุช)", verticalAccount: "ุงูุญุณุงุจ", verticalValue: "ุงููููุฉ", verticalPercent: "ุงููุณุจุฉ %",
        zscoreTitle: "ูููุฐุฌ Altman Z-Score (ููุชูุจุค ุจุงูุฅููุงุณ)", zscoreDesc: "ูููุฐุฌ ุฅุญุตุงุฆู ูุณุชุฎุฏู ูุฌููุนุฉ ูู ุงููุณุจ ุงููุงููุฉ...", zscoreDataWarning: "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ูุญุณุงุจ ูููุฐุฌ Z-Score...", zscoreValueLabel: "ูููุฉ Z-Score:", zscoreInterpretation: "ุงูุชูุณูุฑ:", zscoreZoneSafe: "๐ข ููุทูุฉ ุขููุฉ", zscoreZoneGrey: "๐ก ููุทูุฉ ุฑูุงุฏูุฉ", zscoreZoneDistress: "๐ด ููุทูุฉ ุงูุฎุทุฑ", zscoreComponents: "ููููุงุช ุงููููุฐุฌ:", zscoreX1: "X1 (ุฑุฃุณ ุงููุงู ุงูุนุงูู / ุงูุฃุตูู):", zscoreX2: "X2 (ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ / ุงูุฃุตูู):", zscoreX3: "X3 (ุงูุฃุฑุจุงุญ ูุจู ุงูููุงุฆุฏ ูุงูุถุฑุงุฆุจ / ุงูุฃุตูู):", zscoreX4: "X4 (ุญููู ุงูููููุฉ / ุงูุฎุตูู):", zscoreX5: "X5 (ุงูุฅูุฑุงุฏุงุช / ุงูุฃุตูู):", zscoreRetainedEarningsNotFound: "(ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃุฑุจุงุญ ูุญุชุฌุฒุฉ)",
        cfTitle: "ุชุญููู ุงูุชุฏููุงุช ุงูููุฏูุฉ (ุชูุฏูุฑู)", cfDesc: "ููุฏู ูุฐุง ุงููุณู ุชูุฏูุฑูุง ููุงุฆูุฉ ุงูุชุฏููุงุช ุงูููุฏูุฉ...", cfDataWarning: "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ูุชูุฏูุฑ ุงูุชุฏููุงุช ุงูููุฏูุฉ.", cfStmtTitle: "ูุงุฆูุฉ ุงูุชุฏููุงุช ุงูููุฏูุฉ ุงูููุฏุฑุฉ", cfNetIncome: "ุตุงูู ุงูุฏุฎู", cfDepreciationAmortization: "ุงูุฅููุงู ูุงูุงุณุชููุงู (ููุฏุฑ)", cfChangesWC: "ุงูุชุบูุฑุงุช ูู ุฑุฃุณ ุงููุงู ุงูุนุงูู (ููุฏุฑ)", cfOperating: "ุงูุชุฏูู ุงูููุฏู ุงูุชุดุบููู", cfInvesting: "ุงูุชุฏูู ุงูููุฏู ุงูุงุณุชุซูุงุฑู (ููุฏุฑ)", cfFinancing: "ุงูุชุฏูู ุงูููุฏู ุงูุชููููู (ููุฏุฑ)", cfNetChange: "ุตุงูู ุงูุชุบูุฑ ูู ุงูููุฏูุฉ", cfRatiosTitle: "ูุณุจ ุงูุชุฏููุงุช ุงูููุฏูุฉ", cfRatioOCF: "ูุณุจุฉ ุงูุชุฏูู ุงูููุฏู ุงูุชุดุบููู", cfRatioFCF: "ุงูุชุฏูู ุงูููุฏู ุงูุญุฑ (ููุฏุฑ)", cfInterpretationPositiveOCF: "๐ข ุนูููุงุช ุงูุดุฑูุฉ ุชููุฏ ููุฏูุง.", cfInterpretationNegativeOCF: "๐ด ุนูููุงุช ุงูุดุฑูุฉ ุชุณุชููู ููุฏูุง.", cfInterpretationFCF: "ุงูุชุฏูู ุงูููุฏู ุงูุญุฑ...",

        // *** ADDED Benchmarking Translations ***
        selectIndustryLabel: "ุงุฎุชุฑ ูุทุงุน ุงูุตูุงุนุฉ ููููุงุฑูุฉ",
        selectIndustryDesc: "ุงุฎุชูุงุฑ ูุทุงุน ุณูุถูู ููุงุฑูุฉ ูุน ูุชูุณุทุงุช ุงูุตูุงุนุฉ ุฅูู ุฌุฏุงูู ุงููุณุจ.",
        thIndustryAvg: "ูุชูุณุท ุงูุตูุงุนุฉ",
        industry_general: "ุนุงู / ุบูุฑ ูุญุฏุฏ",
        industry_retail: "ุชุฌุงุฑุฉ ุงูุชุฌุฒุฆุฉ",
        industry_manufacturing: "ุงูุตูุงุนุฉ ุงูุชุญููููุฉ",
        industry_services: "ุงูุฎุฏูุงุช",
        industry_construction: "ุงูููุงููุงุช",
        comparison_better: "ุฃูุถู",
        comparison_worse: "ุฃุณูุฃ",
        comparison_similar: "ููุงุซู"

    },
    en: { // ... (English translations + Benchmarking added) ...
        pageTitle: "Advanced Analytics โ Financial Analyzer", pageHeader: "Advanced Analytics", pageSubheader: "Use specialized analytical tools...",
        tabRatios: "Financial Ratios", tabBreakeven: "Break-even Analysis", tabDupont: "DuPont Analysis", tabVertical: "Vertical Analysis", tabZScore: "Altman Z-Score", tabCashFlow: "Cash Flow Analysis",
        // ... (rest of English translations) ...
        noDataForRatios: "Insufficient data...", dupontDataWarning: "Insufficient data...", verticalDataWarning: "Insufficient data...", zscoreDataWarning: "Insufficient data...", cfDataWarning: "Insufficient data...",
        // *** ADDED Benchmarking Translations ***
        selectIndustryLabel: "Select Industry for Benchmarking",
        selectIndustryDesc: "Choosing an industry will add benchmark averages to the ratio tables.",
        thIndustryAvg: "Industry Avg.",
        industry_general: "General / Unspecified",
        industry_retail: "Retail Trade",
        industry_manufacturing: "Manufacturing",
        industry_services: "Services",
        industry_construction: "Construction",
        comparison_better: "Better",
        comparison_worse: "Worse",
        comparison_similar: "Similar"
    }
};

document.addEventListener('DOMContentLoaded', () => {

    const state = {
        financials: {}, ratios: {}, breakevenChart: null, hasValidData: false,
        rawData: { bsItems: [], isItems: [] },
        selectedIndustry: 'general' // *** ADDED state for selected industry ***
    };
    const lang = localStorage.getItem('lang') || 'ar';
    const t_page = (key) => window.pageTranslations[lang]?.[key] || `[${key}]`;

    const UI = { /* ... (All previous UI elements mapping) ... */
        smartSummary: document.getElementById('smartSummary'), alertsArea: document.getElementById('alertsArea'),
        fixedCosts: document.getElementById('fixedCosts'), variableCost: document.getElementById('variableCost'), sellingPrice: document.getElementById('sellingPrice'), calculateBreakeven: document.getElementById('calculateBreakeven'), breakevenResults: document.getElementById('breakevenResults'), bepUnitsResult: document.getElementById('bepUnitsResult'), bepValueResult: document.getElementById('bepValueResult'), breakevenChartCanvas: document.getElementById('breakevenChart'),
        dupontResultsContainer: document.getElementById('dupontResultsContainer'), dupontDataWarning: document.getElementById('dupontDataWarning'), dupontFormulaDisplay: document.getElementById('dupontFormulaDisplay'), dupontROE: document.getElementById('dupontROE'), dupontNPM: document.getElementById('dupontNPM'), dupontAT: document.getElementById('dupontAT'), dupontEM: document.getElementById('dupontEM'), dupontValueNPM: document.getElementById('dupontValueNPM'), dupontValueAT: document.getElementById('dupontValueAT'), dupontValueEM: document.getElementById('dupontValueEM'), dupontValueROE: document.getElementById('dupontValueROE'), dupontInterpretation: document.getElementById('dupontInterpretation'),
        verticalDataWarning: document.getElementById('verticalDataWarning'), verticalResultsContainer: document.getElementById('verticalResultsContainer'), verticalBSTable: document.getElementById('verticalBSTable'), verticalISTable: document.getElementById('verticalISTable'),
        zscoreDataWarning: document.getElementById('zscoreDataWarning'), zscoreResultsContainer: document.getElementById('zscoreResultsContainer'), zscoreValue: document.getElementById('zscoreValue'), zscoreInterpretation: document.getElementById('zscoreInterpretation'), zscoreFactorsList: document.getElementById('zscoreFactorsList'),
        cfDataWarning: document.getElementById('cfDataWarning'), cfResultsContainer: document.getElementById('cfResultsContainer'), cfStatementTableBody: document.getElementById('cfStatementTableBody'), cfValueOCFRatio: document.getElementById('cfValueOCFRatio'), cfValueFCF: document.getElementById('cfValueFCF'), cfInterpretation: document.getElementById('cfInterpretation'),
        // *** ADDED UI Element for Benchmarking ***
        industrySelect: document.getElementById('industrySelect')
    };

    // Helper functions (Unchanged)
    const toNum = (value) => parseFloat(String(value || '').replace(/,/g, '')) || 0;
    const formatPercent = (value, digits = 1) => isFinite(value) && !isNaN(value) ? `${(value * 100).toFixed(digits)}%` : "N/A";
    const formatRatio = (value, digits = 2) => isFinite(value) && !isNaN(value) ? value.toFixed(digits) : "N/A";
    const formatNumber = (value, digits = 0) => isFinite(value) && !isNaN(value) ? value.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits }) : "N/A";

     // *** ADDED: Industry Benchmark Data ***
     const industryBenchmarks = {
        general: {},
        retail: { currentRatio: 1.5, quickRatio: 0.5, netProfitMargin: 0.03, roe: 0.15, debtToEquity: 1.2, assetTurnover: 2.0, grossProfitMargin: 0.30 },
        manufacturing: { currentRatio: 1.8, quickRatio: 0.9, netProfitMargin: 0.06, roe: 0.12, debtToEquity: 0.8, assetTurnover: 1.0, grossProfitMargin: 0.35 },
        services: { currentRatio: 1.2, quickRatio: 1.0, netProfitMargin: 0.08, roe: 0.18, debtToEquity: 1.0, assetTurnover: 1.2, grossProfitMargin: 0.50 },
        construction: { currentRatio: 1.3, quickRatio: 0.8, netProfitMargin: 0.04, roe: 0.14, debtToEquity: 1.5, assetTurnover: 1.5, grossProfitMargin: 0.20 }
    };

    // ==============================================
    // === FINANCIAL CALCULATIONS (Unchanged from YOUR working version) ===
    // ==============================================
    const calculateFinancials = () => { /* ... (Function as in YOUR working version) ... */ state.financials = {}; state.rawData = { bsItems: [], isItems: [] }; state.hasValidData = false; let trialData; try { const rawDataString = localStorage.getItem('trialData'); if (!rawDataString) { console.warn("localStorage 'trialData' is missing."); return false; } trialData = JSON.parse(rawDataString); if (!Array.isArray(trialData) || trialData.length === 0 || (trialData.length === 1 && !trialData[0].Account && !toNum(trialData[0].Debit) && !toNum(trialData[0].Credit))) { console.warn("Parsed 'trialData' is empty or invalid."); return false; } } catch (e) { console.error("Error parsing 'trialData':", e); return false; } try { const f = { assets: 0, liabilities: 0, equity: 0, revenue: 0, cogs: 0, expenses: 0, netProfit: 0, grossProfit: 0, currentAssets: 0, inventory: 0, currentLiabilities: 0, retainedEarnings: 0, interestExpense: 0, taxExpense: 0, depreciationAmortization: 0, ppeNet: 0, longTermDebt: 0, shortTermDebt: 0, cashEquivalents: 0, ebit: 0, workingCapital: 0, ocf_estimated: 0, capex_estimated: 0, icf_estimated: 0, fcf_estimated: 0, netCashChange_estimated: 0, freeCashFlow_estimated: 0 }; trialData.forEach(row => { const value = (toNum(row.Debit)) - (toNum(row.Credit)); const mainType = row.MainType || ''; const subType = row.SubType || ''; const accountName = (row.Account || '').toLowerCase(); const rawItem = { account: row.Account || 'N/A', value: 0, mainType: mainType, subType: subType }; if (mainType.includes('ุงูุฃุตูู') || mainType.includes('Assets')) { f.assets += value; rawItem.value = value; state.rawData.bsItems.push(rawItem); if (subType.includes('ูุชุฏุงูู') || subType.includes('Current')) { f.currentAssets += value; if (subType.includes('ุงููุฎุฒูู') || subType.includes('Inventory') || accountName.includes('inventory') || accountName.includes('ูุฎุฒูู')) { f.inventory += value; } if (subType.includes('ุงูููุฏ') || subType.includes('Cash') || accountName.includes('cash') || accountName.includes('ููุฏ')) f.cashEquivalents += value; } else if (subType.includes('ุบูุฑ ูุชุฏุงูู') || subType.includes('Non-current') || subType.includes('ุซุงุจุชุฉ') || subType.includes('fixed')) { if(accountName.includes('ppe') || accountName.includes('fixed asset') || accountName.includes('ุฃุตูู ุซุงุจุชุฉ')) f.ppeNet += value; } } else if (mainType.includes('ุงูุฎุตูู') || mainType.includes('Liabilities')) { f.liabilities -= value; rawItem.value = -value; state.rawData.bsItems.push(rawItem); if (subType.includes('ูุชุฏุงูู') || subType.includes('Current')) { f.currentLiabilities -= value; if(subType.includes('ูุฑูุถ ูุตูุฑุฉ') || subType.includes('Short-term Loans') || accountName.includes('short term debt') || accountName.includes('ูุฑุถ ูุตูุฑ')) f.shortTermDebt -=value; } else if (subType.includes('ุบูุฑ ูุชุฏุงูู') || subType.includes('Non-current')) { if(subType.includes('ูุฑูุถ ุทูููุฉ') || subType.includes('Long-term Loans') || accountName.includes('long term debt') || accountName.includes('ูุฑุถ ุทููู')) f.longTermDebt -=value; } } else if (mainType.includes('ุญููู ุงูููููุฉ') || mainType.includes('Equity')) { f.equity -= value; rawItem.value = -value; state.rawData.bsItems.push(rawItem); if (subType.includes('ุงูุฃุฑุจุงุญ ุงููุญุชุฌุฒุฉ') || subType.includes('Retained Earnings') || accountName.includes('retained earnings') || accountName.includes('ุฃุฑุจุงุญ ูุญุชุฌุฒุฉ')) f.retainedEarnings -= value; } else if (mainType.includes('ูุงุฆูุฉ ุงูุฏุฎู') || mainType.includes('Income Statement')) { rawItem.mainType = 'Income Statement'; if (subType.includes('ุงูุฅูุฑุงุฏุงุช') || subType.includes('Revenue')) { f.revenue -= value; rawItem.value = -value; state.rawData.isItems.push(rawItem); } else if (subType.includes('ุชูููุฉ ุงููุจูุนุงุช') || subType.includes('COGS')) { f.cogs += value; rawItem.value = value; state.rawData.isItems.push(rawItem); } else { f.expenses += value; rawItem.value = value; state.rawData.isItems.push(rawItem); if (subType.includes('ูุงุฆุฏุฉ') || subType.includes('Interest') || accountName.includes('interest')) f.interestExpense += value; if (subType.includes('ุถุฑูุจูุฉ') || subType.includes('Tax') || accountName.includes('tax')) f.taxExpense += value; if (subType.includes('ุฅููุงู') || subType.includes('Depreciation') || accountName.includes('depreciation') || accountName.includes('amortization') || accountName.includes('ุฅููุงู') || accountName.includes('ุงุณุชููุงู')) f.depreciationAmortization += value; } } }); Object.keys(f).forEach(key => f[key] = f[key] || 0); f.grossProfit = f.revenue - f.cogs; f.netProfit = f.grossProfit - f.expenses; f.ebit = f.netProfit + f.interestExpense + f.taxExpense; f.workingCapital = f.currentAssets - f.currentLiabilities; f.ocf_estimated = f.netProfit + f.depreciationAmortization; f.capex_estimated = f.depreciationAmortization; f.icf_estimated = -f.capex_estimated; f.fcf_estimated = 0; f.netCashChange_estimated = f.ocf_estimated + f.icf_estimated + f.fcf_estimated; f.freeCashFlow_estimated = f.ocf_estimated - f.capex_estimated; const balanceCheck = f.assets - (f.liabilities + f.equity + f.netProfit); if (Math.abs(balanceCheck) > 1) console.warn(`Balance sheet check failed... Diff: ${balanceCheck.toFixed(2)}`); state.financials = f; state.hasValidData = true; console.log("Calculated Financials:", f); return true; } catch (e) { console.error("Error during financial calculations:", e); state.financials = {}; state.hasValidData = false; return false; } };
    const calculateAllRatios = () => { /* ... (Function as in YOUR working version) ... */ state.ratios = {}; if (!state.hasValidData) { console.warn("Financials invalid..."); return false; } const f = state.financials; try { const assets = f.assets || 0; const equity = f.equity || 0; const liabilities = f.liabilities || 0; const revenue = f.revenue || 0; const equityMultiplier = (equity !== 0 && assets !== 0) ? assets / equity : Infinity; const roeStandard = (equity !== 0) ? f.netProfit / equity : Infinity; const x1 = assets !== 0 ? f.workingCapital / assets : Infinity; const x2 = assets !== 0 ? f.retainedEarnings / assets : Infinity; const x3 = assets !== 0 ? f.ebit / assets : Infinity; const x4 = liabilities !== 0 ? equity / liabilities : Infinity; const x5 = assets !== 0 ? revenue / assets : 0; const zScore = (isFinite(x1) && isFinite(x2) && isFinite(x3) && isFinite(x4) && isFinite(x5)) ? (0.717 * x1) + (0.847 * x2) + (3.107 * x3) + (0.420 * x4) + (0.998 * x5) : NaN; state.ratios = { currentRatio: f.currentLiabilities !== 0 ? f.currentAssets / f.currentLiabilities : Infinity, quickRatio: f.currentLiabilities !== 0 ? (f.currentAssets - f.inventory) / f.currentLiabilities : Infinity, grossProfitMargin: revenue !== 0 ? f.grossProfit / revenue : 0, netProfitMargin: revenue !== 0 ? f.netProfit / revenue : 0, roa: assets !== 0 ? f.netProfit / assets : 0, roe: roeStandard, debtToAssets: assets !== 0 ? liabilities / assets : Infinity, debtToEquity: equity !== 0 ? liabilities / equity : Infinity, assetTurnover: x5, equityMultiplier: equityMultiplier, zScoreX1: x1, zScoreX2: x2, zScoreX3: x3, zScoreX4: x4, zScoreX5: x5, zScore: zScore, operatingCashFlowRatio: f.currentLiabilities !== 0 ? f.ocf_estimated / f.currentLiabilities : Infinity, freeCashFlow: f.freeCashFlow_estimated }; console.log("Calculated Ratios & Z-Score & CF:", state.ratios); return true; } catch(e) { console.error("Error calculating ratios:", e); state.ratios = {}; state.hasValidData = false; return false; } };

    // ==============================================
    // === RENDERING FUNCTIONS (Ratio section MODIFIED) ===
    // ==============================================

    // --- Render Ratios (MODIFIED FOR BENCHMARKS) ---
    const getRatioComment = (key, value) => { /* ... (original logic unchanged) ... */ };
    const renderRatioCategory = (divId, categoryTitleKey, ratioKeys) => {
        const container = document.getElementById(divId);
        if (!container) { console.error(`Element not found: ${divId}`); return; }
        if (!state.hasValidData) {
            container.innerHTML = `<h5 class="mb-3">${t_page(categoryTitleKey)}</h5> <p class="text-muted">${t_page('noDataForRatios')}</p>`; return;
        }

        // *** Benchmark Integration Logic (ADDED) ***
        const benchmarks = industryBenchmarks[state.selectedIndustry] || {};
        const showBenchmarks = state.selectedIndustry !== 'general';
        // *** End Benchmark Integration ***

        // *** MODIFIED Table Header ***
        let tableHTML = `<h5 class="mb-3">${t_page(categoryTitleKey)}</h5>
            <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead><tr>
                    <th>${t_page('thRatio')}</th>
                    <th class="text-end">${t_page('thValue')}</th>
                    ${showBenchmarks ? `<th class="text-end">${t_page('thIndustryAvg')}</th>` : ''}
                    <th>${t_page('thComment')}</th>
                </tr></thead>
                <tbody>`;

        ratioKeys.forEach(key => {
            const value = state.ratios && state.ratios.hasOwnProperty(key) ? state.ratios[key] : NaN;
            // *** Benchmark Integration Logic (ADDED) ***
            const benchmarkValue = benchmarks[key];

            const isPercentage = key.includes('Margin') || key.includes('roa') || key.includes('roe');
            const formattedValue = isPercentage ? formatPercent(value) : formatRatio(value);
            // *** Benchmark Integration Logic (ADDED) ***
            const formattedBenchmark = (showBenchmarks && typeof benchmarkValue !== 'undefined' && isFinite(benchmarkValue))
                ? (isPercentage ? formatPercent(benchmarkValue) : formatRatio(benchmarkValue))
                : '-';

            const comment = getRatioComment(key, value);

            // *** Benchmark Integration Logic (ADDED) ***
            let comparisonIndicator = '';
            let comparisonText = '';
            if (showBenchmarks && typeof benchmarkValue !== 'undefined' && isFinite(value) && isFinite(benchmarkValue)) {
                const tolerance = 0.1 * Math.abs(benchmarkValue);
                const isDebtRatio = key === 'debtToEquity' || key === 'debtToAssets';
                const isBetter = isDebtRatio ? value < benchmarkValue - tolerance : value > benchmarkValue + tolerance;
                const isWorse = isDebtRatio ? value > benchmarkValue + tolerance : value < benchmarkValue - tolerance;
                if (isBetter) { comparisonIndicator = '<i class="bi bi-arrow-up-circle-fill text-success ms-1"></i>'; comparisonText = `(${t_page('comparison_better')})`; }
                else if (isWorse) { comparisonIndicator = '<i class="bi bi-arrow-down-circle-fill text-danger ms-1"></i>'; comparisonText = `(${t_page('comparison_worse')})`; }
                else { comparisonIndicator = '<i class="bi bi-arrow-left-right text-warning ms-1"></i>'; comparisonText = `(${t_page('comparison_similar')})`; }
            }
             // *** End Benchmark Integration ***

            // *** MODIFIED Table Row ***
            tableHTML += `<tr>
                <td>${t_page(key)}</td>
                <td class="text-end"><strong>${formattedValue}</strong> ${comparisonIndicator} <small class="text-muted">${comparisonText}</small></td>
                ${showBenchmarks ? `<td class="text-end">${formattedBenchmark}</td>` : ''}
                <td class="text-muted small">${comment}</td>
            </tr>`;
        });
        container.innerHTML = tableHTML + `</tbody></table></div>`;
    };
    const renderSidebar = () => { /* ... (original logic unchanged) ... */ };

    // --- Render Break-even ---
    const calculateAndDisplayBreakeven = () => { /* ... (original logic unchanged) ... */ };
    const renderBreakevenChart = (fixed, variable, price, bepUnits) => { /* ... (original logic unchanged) ... */ };

    // --- Render DuPont ---
    const calculateAndDisplayDupont = () => { /* ... (original logic unchanged) ... */ };

    // --- Render Vertical Analysis ---
    const calculateAndDisplayVerticalAnalysis = () => { /* ... (original logic unchanged) ... */ };

    // --- Render Altman Z-Score ---
    const calculateAndDisplayZScore = () => { /* ... (original logic unchanged) ... */ };

    // --- Render Cash Flow Analysis ---
    const calculateAndDisplayCashFlowAnalysis = () => { /* ... (original logic unchanged) ... */ };


    // ==============================================
    // === RUN ANALYSIS & INITIALIZATION ===
    // ==============================================

    // --- Main analysis function (Unchanged) ---
    const runAnalysis = () => { /* ... (Function as in YOUR working version) ... */ console.log("Running full analysis..."); if (!calculateFinancials()) { state.hasValidData = false; } else { state.hasValidData = calculateAllRatios(); } renderRatioCategory('liquidityRatios', 'liquidityRatios', ['currentRatio', 'quickRatio']); renderRatioCategory('profitabilityRatios', 'profitabilityRatios', ['grossProfitMargin', 'netProfitMargin', 'roa', 'roe']); renderRatioCategory('leverageRatios', 'leverageRatios', ['debtToAssets', 'debtToEquity']); renderRatioCategory('efficiencyRatios', 'efficiencyRatios', ['assetTurnover']); renderSidebar(); return state.hasValidData; };

    // *** ADDED: Populate Industry Select Function ***
    const populateIndustrySelect = () => {
        if (!UI.industrySelect) { console.warn("Industry select dropdown not found."); return; }
        const industries = ['general', 'retail', 'manufacturing', 'services', 'construction'];
        UI.industrySelect.innerHTML = industries.map(key =>
            `<option value="${key}">${t_page(`industry_${key}`)}</option>`
        ).join('');
        state.selectedIndustry = localStorage.getItem('selectedIndustry') || 'general';
        UI.industrySelect.value = state.selectedIndustry;
    };

    // --- Initialize Page (MODIFIED) ---
    const init = () => {
        console.log("Initializing advanced page...");
        populateIndustrySelect(); // *** ADDED Call ***

        runAnalysis(); // Run analysis first

        // Add event listeners AFTER initial run
        if (UI.calculateBreakeven) { UI.calculateBreakeven.addEventListener('click', calculateAndDisplayBreakeven); }
        else { console.warn("Breakeven calculate button not found"); }

        // *** ADDED: Listener for Industry Select change ***
        if (UI.industrySelect) {
            UI.industrySelect.addEventListener('change', (e) => {
                state.selectedIndustry = e.target.value;
                localStorage.setItem('selectedIndustry', state.selectedIndustry);
                console.log(`Industry changed to: ${state.selectedIndustry}`);
                // Re-render only the ratio tables with new benchmark data
                renderRatioCategory('liquidityRatios', 'liquidityRatios', ['currentRatio', 'quickRatio']);
                renderRatioCategory('profitabilityRatios', 'profitabilityRatios', ['grossProfitMargin', 'netProfitMargin', 'roa', 'roe']);
                renderRatioCategory('leverageRatios', 'leverageRatios', ['debtToAssets', 'debtToEquity']);
                renderRatioCategory('efficiencyRatios', 'efficiencyRatios', ['assetTurnover']);
                if (typeof applyTranslations === 'function') { applyTranslations(); }
            });
        }

        // --- Tab Change Listeners (Unchanged from YOUR working version) ---
        const tabs = ['ratios', 'breakeven', 'dupont', 'vertical', 'zscore', 'cashflow'];
        tabs.forEach(tabId => {
            const tabElement = document.getElementById(`${tabId}-tab`);
            if (tabElement) {
                tabElement.addEventListener('shown.bs.tab', () => {
                     console.log(`${tabId} tab shown`);
                     if (!state.hasValidData) { runAnalysis(); } // Re-run analysis if no valid data
                     if (tabId === 'dupont') calculateAndDisplayDupont();
                     if (tabId === 'vertical') calculateAndDisplayVerticalAnalysis();
                     if (tabId === 'zscore') calculateAndDisplayZScore();
                     if (tabId === 'cashflow') calculateAndDisplayCashFlowAnalysis();
                     if (tabId === 'breakeven' && state.breakevenChart) { /* state.breakevenChart.resize(); */ }
                });
            } else { console.warn(`Tab button not found for ID: ${tabId}-tab`); }
        });

         // Initial display for dependent tabs (Unchanged from YOUR working version)
         calculateAndDisplayDupont(); calculateAndDisplayVerticalAnalysis(); calculateAndDisplayZScore(); calculateAndDisplayCashFlowAnalysis();

         // Apply translations (Unchanged from YOUR working version)
         if (typeof applyTranslations === 'function') { console.log("Applying translations..."); applyTranslations(); }
         else { console.warn("applyTranslations function not found."); }

         console.log("Advanced page initialized.");
    };

    // Run init (Unchanged from YOUR working version)
    if (document.getElementById('ratios-pane') && document.getElementById('cashflow-pane')) {
        init();
    } else {
        console.error("Critical tab pane elements were not found. Initialization stopped.");
    }
});
