// js/advanced-app.js

window.pageTranslations = {
    ar: {
        pageTitle: "ุงูุชุญูููุงุช ุงููุชูุฏูุฉ โ ุงููุญูู ุงููุงูู",
        pageHeader: "ุงูุชุญูููุงุช ุงููุชูุฏูุฉ",
        pageSubheader: "ุงุณุชุฎุฏู ุฃุฏูุงุช ุชุญููููุฉ ูุชุฎุตุตุฉ ููุญุตูู ุนูู ุฑุคู ุฃุนูู ุญูู ุฃุฏุงุก ุนููู.",
        tabRatios: "ุงููุณุจ ุงููุงููุฉ",
        tabBreakeven: "ุชุญููู ุงูุชุนุงุฏู",
        tabDupont: "ุชุญููู ุฏูุจููุช",
        summaryTitle: "ุงูููุฎุต ุงูุฐูู",
        alertsTitle: "ุชูุจููุงุช ููุคุดุฑุงุช ุฎุทุฑ",
        thRatio: "ุงููุณุจุฉ",
        thValue: "ุงููููุฉ",
        thComment: "ุชุนููู ุชุญูููู",
        liquidityRatios: "ูุณุจ ุงูุณูููุฉ",
        profitabilityRatios: "ูุณุจ ุงูุฑุจุญูุฉ",
        leverageRatios: "ูุณุจ ุงูุฑูุน ุงููุงูู",
        efficiencyRatios: "ูุณุจ ุงูููุงุกุฉ",
        currentRatio: "ูุณุจุฉ ุงูุชุฏุงูู",
        currentRatio_comment_high: "ุณูููุฉ ููุชุงุฒุฉ. ูุฏุฑุฉ ุนุงููุฉ ุนูู ุณุฏุงุฏ ุงูุงูุชุฒุงูุงุช ูุตูุฑุฉ ุงูุฃุฌู.",
        currentRatio_comment_good: "ุณูููุฉ ุฌูุฏุฉ. ุงููุถุน ุขูู ูู ุงููุฏู ุงููุตูุฑ.",
        currentRatio_comment_low: "ูุคุดุฑ ุฎุทุฑ. ูุฏ ุชูุงุฌู ุงูุดุฑูุฉ ุตุนูุจุฉ ูู ุณุฏุงุฏ ุฏููููุง ูุตูุฑุฉ ุงูุฃุฌู.",
        quickRatio: "ูุณุจุฉ ุงูุณูููุฉ ุงูุณุฑูุนุฉ",
        quickRatio_comment_good: "ูุฏุฑุฉ ุฌูุฏุฉ ุนูู ุชุบุทูุฉ ุงูุงูุชุฒุงูุงุช ุงูุนุงุฌูุฉ ุฏูู ุงูุงุนุชูุงุฏ ุนูู ุงููุฎุฒูู.",
        quickRatio_comment_low: "ูุคุดุฑ ุฎุทุฑ. ุงุนุชูุงุฏ ูุจูุฑ ุนูู ุจูุน ุงููุฎุฒูู ูุชุบุทูุฉ ุงูุฏููู ุงูุนุงุฌูุฉ.",
        netProfitMargin: "ูุงูุด ุตุงูู ุงูุฑุจุญ",
        netProfitMargin_comment_high: "ุฑุจุญูุฉ ููุชุงุฒุฉ. ููุงุกุฉ ุนุงููุฉ ูู ุชุญููู ุงูุฅูุฑุงุฏุงุช ุฅูู ุฃุฑุจุงุญ.",
        netProfitMargin_comment_avg: "ุงูุดุฑูุฉ ุชุญูู ุฃุฑุจุงุญูุง ูููู ูููู ุชุญุณูู ุงููุงูุด.",
        netProfitMargin_comment_low: "ุงูุดุฑูุฉ ุชุญูู ุฎุณุงุฆุฑ. ูุฌุจ ูุฑุงุฌุนุฉ ูููู ุงูุชูุงููู ูุงูุชุณุนูุฑ.",
        grossProfitMargin: "ูุงูุด ุงูุฑุจุญ ุงูุฅุฌูุงูู",
        grossProfitMargin_comment_high: "ูุงูุด ููู. ุชุญูู ููุชุงุฒ ูู ุชูููุฉ ุงููุจูุนุงุช.",
        grossProfitMargin_comment_low: "ูุงูุด ุถุนูู. ูุฌุจ ูุฑุงุฌุนุฉ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ ุฃู ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุณุนูุฑ.",
        roa: "ุงูุนุงุฆุฏ ุนูู ุงูุฃุตูู (ROA)",
        roa_comment_high: "ููุงุกุฉ ุนุงููุฉ ูู ุงุณุชุฎุฏุงู ุงูุฃุตูู ูุชูููุฏ ุงูุฃุฑุจุงุญ.",
        roa_comment_low: "ููุงุกุฉ ููุฎูุถุฉ. ุงูุฃุตูู ูุง ุชููุฏ ุฃุฑุจุงุญูุง ูุงููุฉ.",
        roe: "ุงูุนุงุฆุฏ ุนูู ุญููู ุงูููููุฉ (ROE)",
        roe_comment_high: "ุนุงุฆุฏ ููุชุงุฒ ูููุณุงูููู. ุงูุดุฑูุฉ ุชุณุชุฎุฏู ุงุณุชุซูุงุฑุงุชูู ุจูุนุงููุฉ ุนุงููุฉ.",
        roe_comment_low: "ุนุงุฆุฏ ุถุนูู ูููุณุงูููู. ูุฌุจ ุชุญุณูู ุงูุฑุจุญูุฉ ุฃู ููุงุกุฉ ุฑุฃุณ ุงููุงู.",
        debtToEquity: "ูุณุจุฉ ุงูุฏูู ุฅูู ุญููู ุงูููููุฉ",
        debtToEquity_comment_low: "ูุณุชูู ุฏูู ููุฎูุถ ููุญุงูุธ. ุชุนุชูุฏ ุงูุดุฑูุฉ ุนูู ุงูุชูููู ุงูุฐุงุชู.",
        debtToEquity_comment_good: "ูุณุชูู ุฏูู ูุนุชุฏู ููุชูุงุฒู.",
        debtToEquity_comment_high: "ูุณุชูู ุฏูู ูุฑุชูุน. ูุฏ ูุดูุฑ ุฅูู ูุฎุงุทุฑ ูุงููุฉ ุนุงููุฉ.",
        debtToAssets: "ูุณุจุฉ ุงูุฏูู ุฅูู ุงูุฃุตูู",
        debtToAssets_comment_low: "ุฌุฒุก ุตุบูุฑ ูู ุงูุฃุตูู ูููู ุจุงูุฏููู. ูุถุน ุขูู.",
        debtToAssets_comment_high: "ุฌุฒุก ูุจูุฑ ูู ุงูุฃุตูู ูููู ุจุงูุฏููู. ูุฎุงุทุฑ ูุฑุชูุนุฉ.",
        assetTurnover: "ูุนุฏู ุฏูุฑุงู ุงูุฃุตูู",
        assetTurnover_comment_high: "ููุงุกุฉ ููุชุงุฒุฉ ูู ุงุณุชุฎุฏุงู ุงูุฃุตูู ูุชูููุฏ ุงููุจูุนุงุช.",
        assetTurnover_comment_low: "ููุงุกุฉ ููุฎูุถุฉ. ูุฏ ุชููู ููุงู ุฃุตูู ุนุงุทูุฉ ุฃู ุถุนู ูู ุงููุจูุนุงุช.",
        summary_ok: "ุงููุถุน ุงููุงูู ูุจุฏู ูุณุชูุฑูุง. ุงูุฑุจุญูุฉ ูุงูุณูููุฉ ุถูู ุงููุทุงูุงุช ุงูููุจููุฉ.",
        summary_risk: "ุชูุฌุฏ ุจุนุถ ูุคุดุฑุงุช ุงูุฎุทุฑ. ุงูุฑุจุญูุฉ ุฃู ุงูุณูููุฉ ูุฏ ุชุญุชุงุฌ ุฅูู ุงูุชูุงู ููุฑู.",
        alert_liquidity_risk: "๐ด ุฎุทุฑ ุณูููุฉ: ูุณุจุฉ ุงูุชุฏุงูู ุฃูู ูู 1.",
        alert_leverage_risk: "๐ก ุชูุจูู: ูุณุจุฉ ุงูุฏูู ุฅูู ุญููู ุงูููููุฉ ูุฑุชูุนุฉ.",
        alert_profit_risk: "๐ด ุฎุทุฑ ุฑุจุญูุฉ: ุงูุดุฑูุฉ ุชุญูู ุตุงูู ุฎุณุงุฑุฉ.",
        alert_ok: "๐ข ูุง ุชูุฌุฏ ูุคุดุฑุงุช ุฎุทุฑ ุญุฑุฌุฉ ุจูุงุกู ุนูู ุงููุณุจ ุงูุฃุณุงุณูุฉ.",
        noDataForRatios: "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ูุญุณุงุจ ุงููุณุจ. ูุฑุฌู ุฅุฏุฎุงู ููุฒุงู ุงููุฑุงุฌุนุฉ ุฃููุงู.",
        beInputTitle: "ูุฏุฎูุงุช ุงูุญุณุงุจ",
        labelFixedCosts: "ุฅุฌูุงูู ุงูุชูุงููู ุงูุซุงุจุชุฉ",
        labelVariableCost: "ุงูุชูููุฉ ุงููุชุบูุฑุฉ ูููุญุฏุฉ",
        labelSellingPrice: "ุณุนุฑ ุจูุน ุงููุญุฏุฉ",
        btnCalculate: "ุงุญุณุจ",
        beResultsTitle: "ุงููุชุงุฆุฌ",
        bepUnits: "ููุทุฉ ุงูุชุนุงุฏู (ุจุงููุญุฏุงุช)",
        bepValue: "ููุทุฉ ุงูุชุนุงุฏู (ุจุงููููุฉ)",
        beChartTitle: "ุฑุณู ุจูุงูู ูููุทุฉ ุงูุชุนุงุฏู",
        errorPrice: "ูุฌุจ ุฃู ูููู ุณุนุฑ ุงูุจูุน ุฃุนูู ูู ุงูุชูููุฉ ุงููุชุบูุฑุฉ.",
        errorPositiveValues: "ุงูุฑุฌุงุก ุฅุฏุฎุงู ููู ููุฌุจุฉ.",
        dupontTitle: "ุชุญููู ุฏูุจููุช ููุนุงุฆุฏ ุนูู ุญููู ุงูููููุฉ",
        dupontDesc: "ูุณุงุนุฏ ูุฐุง ุงูุชุญููู ุนูู ุชูููู ุงูุนุงุฆุฏ ุนูู ุญููู ุงูููููุฉ (ROE) ุฅูู ููููุงุชู ุงูุฑุฆูุณูุฉ: ููุงุกุฉ ุงูุชุดุบูู (ูุงูุด ุตุงูู ุงูุฑุจุญ)ุ ููุงุกุฉ ุงุณุชุฎุฏุงู ุงูุฃุตูู (ุฏูุฑุงู ุงูุฃุตูู)ุ ูุงูุฑูุน ุงููุงูู (ูุถุงุนู ุญููู ุงูููููุฉ).",
        dupontEquation: "ูุนุงุฏูุฉ ุฏูุจููุช:",
        dupontCompNPM: "ูุงูุด ุตุงูู ุงูุฑุจุญ",
        dupontCompAT: "ุฏูุฑุงู ุงูุฃุตูู",
        dupontCompEM: "ูุถุงุนู ุญููู ุงูููููุฉ",
        dupontCompROE: "ุงูุนุงุฆุฏ ุนูู ุญููู ุงูููููุฉ",
        dupontDataWarning: "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ (ูู ููุฒุงู ุงููุฑุงุฌุนุฉ) ูุฅุฌุฑุงุก ุชุญููู ุฏูุจููุช.",
        dupontInterpretationHighROE: "๐ข ุงูุนุงุฆุฏ ุงููุฑุชูุน ุนูู ุญููู ุงูููููุฉ ูุฏููุน ุจุดูู ุฃุณุงุณู ุจู:",
        dupontInterpretationLowROE: "๐ก ุงูุนุงุฆุฏ ุงูููุฎูุถ ุนูู ุญููู ุงูููููุฉ ูุฏ ูููู ุจุณุจุจ:",
        dupontFactorProfitability: "ุฑุจุญูุฉ ุชุดุบูููุฉ ูููุฉ (ูุงูุด ุตุงูู ุฑุจุญ ูุฑุชูุน).",
        dupontFactorEfficiency: "ููุงุกุฉ ุนุงููุฉ ูู ุงุณุชุฎุฏุงู ุงูุฃุตูู (ุฏูุฑุงู ุฃุตูู ูุฑุชูุน).",
        dupontFactorLeverage: "ุงุณุชุฎุฏุงู ุงูุฑูุน ุงููุงูู (ูุถุงุนู ุญููู ููููุฉ ูุฑุชูุน - ูุฏ ูุฒูุฏ ุงููุฎุงุทุฑ).",
        dupontFactorLowProfitability: "ุฑุจุญูุฉ ุชุดุบูููุฉ ุถุนููุฉ (ูุงูุด ุตุงูู ุฑุจุญ ููุฎูุถ).",
        dupontFactorLowEfficiency: "ููุงุกุฉ ููุฎูุถุฉ ูู ุงุณุชุฎุฏุงู ุงูุฃุตูู (ุฏูุฑุงู ุฃุตูู ููุฎูุถ).",
        dupontFactorLowLeverage: "ุงุนุชูุงุฏ ููุฎูุถ ุนูู ุงูุฏููู (ูุถุงุนู ุญููู ููููุฉ ููุฎูุถ - ุฃูุซุฑ ุฃูุงููุง ูููู ูุฏ ูุญุฏ ูู ุงูุนุงุฆุฏ).",
        // Additional keys for BE chart labels if needed
        revenue: 'ุงูุฅูุฑุงุฏุงุช',
        totalCosts: 'ุฅุฌูุงูู ุงูุชูุงููู',
        fixedCosts: 'ุงูุชูุงููู ุงูุซุงุจุชุฉ',
        unitsSold: 'ุงููุญุฏุงุช ุงููุจุงุนุฉ',
        value: 'ุงููููุฉ'
    },
    en: {
        pageTitle: "Advanced Analytics โ Financial Analyzer",
        pageHeader: "Advanced Analytics", 
        pageSubheader: "Use specialized analytical tools to gain deeper insights into your business performance.", 
        tabRatios: "Financial Ratios",
        tabBreakeven: "Break-even Analysis",
        tabDupont: "DuPont Analysis",
        summaryTitle: "Smart Summary",
        alertsTitle: "Alerts & Risk Indicators",
        thRatio: "Ratio",
        thValue: "Value",
        thComment: "Analytical Commentary",
        liquidityRatios: "Liquidity Ratios",
        profitabilityRatios: "Profitability Ratios",
        leverageRatios: "Leverage Ratios",
        efficiencyRatios: "Efficiency Ratios",
        currentRatio: "Current Ratio",
        currentRatio_comment_high: "Excellent liquidity. High ability to meet short-term obligations.",
        currentRatio_comment_good: "Good liquidity. The situation is safe in the short term.",
        currentRatio_comment_low: "Risk indicator. The company may face difficulty paying its short-term debts.",
        quickRatio: "Quick Ratio (Acid-Test)",
        quickRatio_comment_good: "Good ability to cover immediate liabilities without relying on inventory.",
        quickRatio_comment_low: "Risk indicator. Heavy reliance on selling inventory to cover urgent debts.",
        netProfitMargin: "Net Profit Margin",
        netProfitMargin_comment_high: "Excellent profitability. High efficiency in converting revenue into profit.",
        netProfitMargin_comment_avg: "The company is profitable, but the margin can be improved.",
        netProfitMargin_comment_low: "The company is incurring losses. Cost structure and pricing must be reviewed.",
        grossProfitMargin: "Gross Profit Margin",
        grossProfitMargin_comment_high: "Strong margin. Excellent control over cost of sales.",
        grossProfitMargin_comment_low: "Weak margin. Cost of goods sold or pricing strategy must be reviewed.",
        roa: "Return on Assets (ROA)",
        roa_comment_high: "High efficiency in using assets to generate profits.",
        roa_comment_low: "Low efficiency. Assets are not generating enough profit.",
        roe: "Return on Equity (ROE)",
        roe_comment_high: "Excellent return for shareholders. The company is using their investment very effectively.",
        roe_comment_low: "Weak return for shareholders. Profitability or capital efficiency needs improvement.",
        debtToEquity: "Debt-to-Equity Ratio",
        debtToEquity_comment_low: "Low and conservative debt level. The company relies on self-financing.",
        debtToEquity_comment_good: "Moderate and balanced debt level.",
        debtToEquity_comment_high: "High debt level. May indicate high financial risk.",
        debtToAssets: "Debt-to-Assets Ratio",
        debtToAssets_comment_low: "A small portion of assets is financed by debt. Safe position.",
        debtToAssets_comment_high: "A large portion of assets is financed by debt. High risk.",
        assetTurnover: "Asset Turnover Ratio",
        assetTurnover_comment_high: "Excellent efficiency in using assets to generate sales.",
        assetTurnover_comment_low: "Low efficiency. There might be idle assets or weak sales.",
        summary_ok: "The financial position appears stable. Profitability and liquidity are within acceptable ranges.",
        summary_risk: "Some risk indicators are present. Profitability or liquidity may require immediate attention.",
        alert_liquidity_risk: "๐ด Liquidity Risk: Current ratio is less than 1.",
        alert_leverage_risk: "๐ก Warning: Debt-to-Equity ratio is high.",
        alert_profit_risk: "๐ด Profitability Risk: The company is recording a net loss.",
        alert_ok: "๐ข No critical risk indicators based on key ratios.",
        noDataForRatios: "Insufficient data to calculate ratios. Please enter trial balance data first.",
        beInputTitle: "Calculation Inputs",
        labelFixedCosts: "Total Fixed Costs",
        labelVariableCost: "Variable Cost Per Unit",
        labelSellingPrice: "Selling Price Per Unit",
        btnCalculate: "Calculate",
        beResultsTitle: "Results",
        bepUnits: "Break-even Point (Units)",
        bepValue: "Break-even Point (Value)",
        beChartTitle: "Break-even Point Chart",
        errorPrice: "Selling price must be higher than variable cost.",
        errorPositiveValues: "Please enter positive values.",
        dupontTitle: "DuPont Analysis for ROE",
        dupontDesc: "This analysis breaks down Return on Equity (ROE) into its key components: operating efficiency (Net Profit Margin), asset use efficiency (Asset Turnover), and financial leverage (Equity Multiplier).",
        dupontEquation: "DuPont Equation:",
        dupontCompNPM: "Net Profit Margin",
        dupontCompAT: "Asset Turnover",
        dupontCompEM: "Equity Multiplier",
        dupontCompROE: "Return on Equity",
        dupontDataWarning: "Insufficient data (from Trial Balance) available to perform DuPont analysis.",
        dupontInterpretationHighROE: "๐ข High ROE is primarily driven by:",
        dupontInterpretationLowROE: "๐ก Low ROE may be due to:",
        dupontFactorProfitability: "Strong operating profitability (high Net Profit Margin).",
        dupontFactorEfficiency: "High asset efficiency (high Asset Turnover).",
        dupontFactorLeverage: "Use of financial leverage (high Equity Multiplier - potentially risky).",
        dupontFactorLowProfitability: "Weak operating profitability (low Net Profit Margin).",
        dupontFactorLowEfficiency: "Low asset efficiency (low Asset Turnover).",
        dupontFactorLowLeverage: "Low reliance on debt (low Equity Multiplier - safer but may limit returns).",
        // Additional keys for BE chart labels if needed
        revenue: 'Revenue',
        totalCosts: 'Total Costs',
        fixedCosts: 'Fixed Costs',
        unitsSold: 'Units Sold',
        value: 'Value'
    }
};

document.addEventListener('DOMContentLoaded', () => {

    const state = { 
        financials: {}, 
        ratios: {},
        breakevenChart: null 
    };
    const lang = localStorage.getItem('lang') || 'ar';
    // Ensure t_page handles potential missing keys gracefully
    const t_page = (key) => window.pageTranslations[lang]?.[key] || `[${key}]`; // Show key if missing

    const UI = {
        // Ratio UI elements
        smartSummary: document.getElementById('smartSummary'),
        alertsArea: document.getElementById('alertsArea'),
        // Breakeven UI elements
        fixedCosts: document.getElementById('fixedCosts'),
        variableCost: document.getElementById('variableCost'),
        sellingPrice: document.getElementById('sellingPrice'),
        calculateBreakeven: document.getElementById('calculateBreakeven'),
        breakevenResults: document.getElementById('breakevenResults'),
        bepUnitsResult: document.getElementById('bepUnitsResult'),
        bepValueResult: document.getElementById('bepValueResult'),
        breakevenChartCanvas: document.getElementById('breakevenChart'),
        // DuPont UI elements
        dupontResultsContainer: document.getElementById('dupontResultsContainer'),
        dupontDataWarning: document.getElementById('dupontDataWarning'),
        dupontFormulaDisplay: document.getElementById('dupontFormulaDisplay'),
        dupontROE: document.getElementById('dupontROE'),
        dupontNPM: document.getElementById('dupontNPM'),
        dupontAT: document.getElementById('dupontAT'),
        dupontEM: document.getElementById('dupontEM'),
        dupontValueNPM: document.getElementById('dupontValueNPM'),
        dupontValueAT: document.getElementById('dupontValueAT'),
        dupontValueEM: document.getElementById('dupontValueEM'),
        dupontValueROE: document.getElementById('dupontValueROE'),
        dupontInterpretation: document.getElementById('dupontInterpretation')
    };
    
    // Helper functions
    const toNum = (value) => parseFloat(String(value || '').replace(/,/g, '')) || 0;
    const formatPercent = (value) => isFinite(value) ? `${(value * 100).toFixed(1)}%` : "N/A";
    const formatRatio = (value) => isFinite(value) ? value.toFixed(2) : "N/A";

    // ==============================================
    // === FINANCIAL RATIO FUNCTIONS (Original + Refined) ===
    // ==============================================

    const calculateFinancials = () => {
        state.financials = {}; // Reset financials
        const trialData = JSON.parse(localStorage.getItem('trialData') || '[]');
        // Check for valid data (more than just an empty array or array with one empty row)
        if (trialData.length === 0 || (trialData.length === 1 && !trialData[0].Account && !toNum(trialData[0].Debit) && !toNum(trialData[0].Credit))) {
             console.warn("No valid trialData found for ratio calculation.");
             return false; // Indicate failure
        }

        const f = {
            assets: 0, liabilities: 0, equity: 0, revenue: 0, cogs: 0, expenses: 0, netProfit: 0, grossProfit: 0,
            currentAssets: 0, inventory: 0, currentLiabilities: 0
        };
        trialData.forEach(row => {
            const value = (toNum(row.Debit)) - (toNum(row.Credit));
            const mainType = row.MainType || '';
            const subType = row.SubType || '';
            const accountName = (row.Account || '').toLowerCase();

            if (mainType.includes('ุงูุฃุตูู') || mainType.includes('Assets')) {
                f.assets += value;
                if (subType.includes('ูุชุฏุงูู') || subType.includes('Current')) {
                    f.currentAssets += value;
                    if (subType.includes('ุงููุฎุฒูู') || subType.includes('Inventory') || accountName.includes('inventory') || accountName.includes('ูุฎุฒูู')) {
                         f.inventory += value;
                    }
                }
            } else if (mainType.includes('ุงูุฎุตูู') || mainType.includes('Liabilities')) {
                f.liabilities -= value; 
                if (subType.includes('ูุชุฏุงูู') || subType.includes('Current')) f.currentLiabilities -= value;
            } else if (mainType.includes('ุญููู ุงูููููุฉ') || mainType.includes('Equity')) {
                f.equity -= value; 
            } else if (mainType.includes('ูุงุฆูุฉ ุงูุฏุฎู') || mainType.includes('Income Statement')) {
                if (subType.includes('ุงูุฅูุฑุงุฏุงุช') || subType.includes('Revenue')) f.revenue -= value; 
                else if (subType.includes('ุชูููุฉ ุงููุจูุนุงุช') || subType.includes('COGS')) f.cogs += value; 
                else f.expenses += value; 
            }
        });
        
        // Ensure values are numbers, default to 0
        Object.keys(f).forEach(key => f[key] = f[key] || 0);

        f.grossProfit = f.revenue - f.cogs;
        f.netProfit = f.grossProfit - f.expenses;
        
        // Balance Sheet Check (A = L + E + Current Period Profit/Loss)
        const balanceCheck = f.assets - (f.liabilities + f.equity + f.netProfit);
        if (Math.abs(balanceCheck) > 1) { // Allow for small rounding diffs
             console.warn(`Balance sheet check failed: Assets (${f.assets.toFixed(2)}) != L+E+NP (${(f.liabilities + f.equity + f.netProfit).toFixed(2)}). Difference: ${balanceCheck.toFixed(2)}`);
             // Maybe display a warning to the user if the difference is significant
        }

        state.financials = f;
        console.log("Calculated Financials:", f);
        return true; // Indicate success
    };

    const calculateAllRatios = () => {
        state.ratios = {}; // Reset ratios
        const f = state.financials;
        if (!f || Object.keys(f).length === 0) {
             console.warn("Financials not calculated, skipping ratio calculation.");
             return false; // Indicate failure
        }
        
        // Calculate Equity Multiplier (Leverage for DuPont) - Handle zero or negative equity
        const equityMultiplier = (f.equity !== 0 && f.assets !== 0) ? f.assets / f.equity : Infinity; 
        
        // Calculate standard ROE - Handle zero or negative equity
        const roeStandard = (f.equity !== 0) ? f.netProfit / f.equity : Infinity; 

        state.ratios = {
            currentRatio: f.currentLiabilities !== 0 ? f.currentAssets / f.currentLiabilities : Infinity,
            quickRatio: f.currentLiabilities !== 0 ? (f.currentAssets - f.inventory) / f.currentLiabilities : Infinity,
            grossProfitMargin: f.revenue !== 0 ? f.grossProfit / f.revenue : 0,
            netProfitMargin: f.revenue !== 0 ? f.netProfit / f.revenue : 0,
            roa: f.assets !== 0 ? f.netProfit / f.assets : 0,
            roe: roeStandard, // Standard ROE calculation
            debtToAssets: f.assets !== 0 ? f.liabilities / f.assets : Infinity,
            debtToEquity: f.equity !== 0 ? f.liabilities / f.equity : Infinity,
            assetTurnover: f.assets !== 0 ? f.revenue / f.assets : 0,
            equityMultiplier: equityMultiplier // Assets / Equity
        };
        console.log("Calculated Ratios (incl. EM):", state.ratios);
        return true; // Indicate success
    };

    const getRatioComment = (key, value) => {
        if (!isFinite(value)) return "N/A";
        // (Original comment logic remains unchanged)
        if (key === 'currentRatio') { if (value >= 2) return t_page('currentRatio_comment_high'); if (value >= 1) return t_page('currentRatio_comment_good'); return t_page('currentRatio_comment_low'); }
        if (key === 'quickRatio') { if (value >= 1) return t_page('quickRatio_comment_good'); return t_page('quickRatio_comment_low'); }
        if (key === 'netProfitMargin') { if (value >= 0.15) return t_page('netProfitMargin_comment_high'); if (value > 0) return t_page('netProfitMargin_comment_avg'); return t_page('netProfitMargin_comment_low'); }
        if (key === 'grossProfitMargin') { return value >= 0.4 ? t_page('grossProfitMargin_comment_high') : t_page('grossProfitMargin_comment_low'); }
        if (key === 'roa') { return value >= 0.05 ? t_page('roa_comment_high') : t_page('roa_comment_low'); }
        if (key === 'roe') { return value >= 0.15 ? t_page('roe_comment_high') : t_page('roe_comment_low'); }
        if (key === 'debtToEquity') { if (value < 0.5) return t_page('debtToEquity_comment_low'); if (value <= 1.5) return t_page('debtToEquity_comment_good'); return t_page('debtToEquity_comment_high'); }
        if (key === 'debtToAssets') { return value < 0.4 ? t_page('debtToAssets_comment_low') : t_page('debtToAssets_comment_high'); }
        if (key === 'assetTurnover') { return value >= 1 ? t_page('assetTurnover_comment_high') : t_page('assetTurnover_comment_low'); }
        return "";
    };

    const renderRatioCategory = (divId, categoryTitleKey, ratioKeys) => {
        const container = document.getElementById(divId);
        if (!container) { console.error(`Element not found: ${divId}`); return; }
        
        // Use state.hasRatioData flag set by runAnalysis
        if (!state.hasRatioData) {
             container.innerHTML = `<h5 class="mb-3">${t_page(categoryTitleKey)}</h5> <p class="text-muted">${t_page('noDataForRatios')}</p>`;
             return;
        }

        let tableHTML = `<h5 class="mb-3">${t_page(categoryTitleKey)}</h5>
            <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead><tr><th>${t_page('thRatio')}</th><th>${t_page('thValue')}</th><th>${t_page('thComment')}</th></tr></thead>
                <tbody>`;
        ratioKeys.forEach(key => {
            const value = state.ratios[key];
            // Refined formatting logic
            const isPercentage = key.includes('Margin') || key.includes('roa') || key.includes('roe');
            const formattedValue = isPercentage ? formatPercent(value) : formatRatio(value);
            const comment = getRatioComment(key, value);
            tableHTML += `<tr>
                <td>${t_page(key)}</td>
                <td><strong>${formattedValue}</strong></td>
                <td class="text-muted small">${comment}</td>
            </tr>`;
        });
        container.innerHTML = tableHTML + `</tbody></table></div>`;
    };

    const renderSidebar = () => {
        // Use state.hasRatioData flag
        if (!state.hasRatioData) {
            UI.smartSummary.textContent = lang === 'ar' ? 'ูุฑุฌู ุฅุฏุฎุงู ุจูุงูุงุช ูุญุณุงุจ ุงูููุฎุต.' : 'Please enter data to calculate summary.';
            UI.alertsArea.innerHTML = `<div>${lang === 'ar' ? 'ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ููุชูุจููุงุช.' : 'Insufficient data for alerts.'}</div>`;
            return;
        }

        const { netProfitMargin, currentRatio, debtToEquity } = state.ratios;
        UI.smartSummary.textContent = netProfitMargin > 0 && currentRatio > 1.5 ? t_page('summary_ok') : t_page('summary_risk');

        const alerts = [];
        if (currentRatio < 1 && isFinite(currentRatio)) alerts.push(t_page('alert_liquidity_risk'));
        if (debtToEquity > 2 && isFinite(debtToEquity)) alerts.push(t_page('alert_leverage_risk'));
        if (netProfitMargin < 0 && isFinite(netProfitMargin)) alerts.push(t_page('alert_profit_risk'));
        UI.alertsArea.innerHTML = alerts.length > 0 ? alerts.map(alert => `<div>${alert}</div>`).join('') : `<div>${t_page('alert_ok')}</div>`;
    };

    const runAnalysis = () => {
        state.hasRatioData = false; // Reset flag
        if (!calculateFinancials()) {
             // Clear displays if financials calculation failed
             renderRatioCategory('liquidityRatios', 'liquidityRatios', []);
             renderRatioCategory('profitabilityRatios', 'profitabilityRatios', []);
             renderRatioCategory('leverageRatios', 'leverageRatios', []);
             renderRatioCategory('efficiencyRatios', 'efficiencyRatios', []);
             renderSidebar(); 
             return false; 
        }
        if (!calculateAllRatios()) {
             // Clear displays if ratio calculation failed
             renderRatioCategory('liquidityRatios', 'liquidityRatios', []);
             renderRatioCategory('profitabilityRatios', 'profitabilityRatios', []);
             renderRatioCategory('leverageRatios', 'leverageRatios', []);
             renderRatioCategory('efficiencyRatios', 'efficiencyRatios', []);
             renderSidebar();
             return false; 
        }

        // If both succeeded, set flag and render
        state.hasRatioData = true; 
        renderRatioCategory('liquidityRatios', 'liquidityRatios', ['currentRatio', 'quickRatio']);
        renderRatioCategory('profitabilityRatios', 'profitabilityRatios', ['grossProfitMargin', 'netProfitMargin', 'roa', 'roe']);
        renderRatioCategory('leverageRatios', 'leverageRatios', ['debtToAssets', 'debtToEquity']);
        renderRatioCategory('efficiencyRatios', 'efficiencyRatios', ['assetTurnover']);
        renderSidebar();
        return true; // Indicate success
    };

    // ==============================================
    // === BREAKEVEN ANALYSIS FUNCTIONS (NEW) ===
    // ==============================================

    const calculateAndDisplayBreakeven = () => {
        const fixed = toNum(UI.fixedCosts.value);
        const variable = toNum(UI.variableCost.value);
        const price = toNum(UI.sellingPrice.value);

        if (price <= 0 || variable < 0 || fixed < 0) {
             alert(t_page('errorPositiveValues'));
             return;
        }
        if (price <= variable) {
            alert(t_page('errorPrice'));
            return;
        }

        const contributionMargin = price - variable;
        const bepUnits = fixed / contributionMargin;
        const bepValue = bepUnits * price;

        UI.bepUnitsResult.textContent = Math.ceil(bepUnits).toLocaleString();
        UI.bepValueResult.textContent = bepValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        UI.breakevenResults.style.display = 'block';
        renderBreakevenChart(fixed, variable, price, bepUnits);
    };

    const renderBreakevenChart = (fixed, variable, price, bepUnits) => {
        if (!UI.breakevenChartCanvas) return; // Exit if canvas not found
        if (state.breakevenChart) {
            state.breakevenChart.destroy();
        }
        let maxUnits = 100; 
        if (bepUnits > 0 && isFinite(bepUnits)) {
             maxUnits = Math.max(100, Math.ceil(bepUnits * 2 / 10) * 10);
        } else if (fixed === 0 && price > variable) { // If BEP is 0 because no fixed costs
            maxUnits = 100; // Show a default range anyway
        } else if (price <= variable) { // Should not happen due to check, but safety
            maxUnits = 100; 
        }
        
        const step = maxUnits / 10;
        const labels = Array.from({ length: 11 }, (_, i) => Math.round(step * i)); 
        const fixedCostsData = labels.map(() => fixed);
        const totalCostsData = labels.map(unit => fixed + (variable * unit));
        const revenueData = labels.map(unit => price * unit);

        const ctx = UI.breakevenChartCanvas.getContext('2d');
        state.breakevenChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: t_page('revenue'), data: revenueData, borderColor: 'rgba(75, 192, 192, 1)', fill: false, tension: 0.1 },
                    { label: t_page('totalCosts'), data: totalCostsData, borderColor: 'rgba(255, 99, 132, 1)', fill: false, tension: 0.1 },
                    { label: t_page('fixedCosts'), data: fixedCostsData, borderColor: 'rgba(255, 159, 64, 1)', borderDash: [5, 5], fill: false, tension: 0.1 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index', },
                scales: { x: { title: { display: true, text: t_page('unitsSold') } }, y: { title: { display: true, text: t_page('value') }, beginAtZero: true } },
                plugins: { tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`; } } } }
            }
        });
    };
    
    // ==============================================
    // === DUPONT ANALYSIS FUNCTIONS (NEW + Refined) ===
    // ==============================================
    
    const calculateAndDisplayDupont = () => {
         // Use state.hasRatioData flag set by runAnalysis
         if (!state.hasRatioData) {
             if(UI.dupontDataWarning) {
                 UI.dupontDataWarning.textContent = t_page('dupontDataWarning');
                 UI.dupontDataWarning.style.display = 'block';
             }
             if(UI.dupontFormulaDisplay) UI.dupontFormulaDisplay.style.display = 'none';
             if(UI.dupontInterpretation) UI.dupontInterpretation.innerHTML = '';
             // Ensure cards show N/A
             if(UI.dupontValueNPM) UI.dupontValueNPM.textContent = 'N/A';
             if(UI.dupontValueAT) UI.dupontValueAT.textContent = 'N/A';
             if(UI.dupontValueEM) UI.dupontValueEM.textContent = 'N/A';
             if(UI.dupontValueROE) UI.dupontValueROE.textContent = 'N/A';
             return; // Stop execution
         }

        // --- Data is available ---
        if(UI.dupontDataWarning) UI.dupontDataWarning.style.display = 'none';
        if(UI.dupontFormulaDisplay) UI.dupontFormulaDisplay.style.display = 'block';

        const npm = state.ratios.netProfitMargin;
        const at = state.ratios.assetTurnover;
        const em = state.ratios.equityMultiplier; 
        
        // Calculate ROE using DuPont components 
        const dupontROE = (isFinite(npm) && isFinite(at) && isFinite(em)) ? npm * at * em : Infinity;

        // Display formula components
        if(UI.dupontROE) UI.dupontROE.textContent = formatPercent(dupontROE);
        if(UI.dupontNPM) UI.dupontNPM.textContent = formatPercent(npm);
        if(UI.dupontAT) UI.dupontAT.textContent = formatRatio(at);
        if(UI.dupontEM) UI.dupontEM.textContent = formatRatio(em);

        // Display individual component values in cards
        if(UI.dupontValueNPM) UI.dupontValueNPM.textContent = formatPercent(npm);
        if(UI.dupontValueAT) UI.dupontValueAT.textContent = formatRatio(at);
        if(UI.dupontValueEM) UI.dupontValueEM.textContent = formatRatio(em);
        if(UI.dupontValueROE) UI.dupontValueROE.textContent = formatPercent(dupontROE); // Use DuPont calculated ROE

        // Basic Interpretation - only if dupontROE is a valid number
        let interpretation = '';
        if (isFinite(dupontROE)) {
            const highROE = dupontROE >= 0.15; 
            interpretation += highROE ? `<p>${t_page('dupontInterpretationHighROE')}</p><ul>` : `<p>${t_page('dupontInterpretationLowROE')}</p><ul>`;
            
            // Check individual factors only if they are valid numbers
            if (isFinite(npm)) {
                if (npm >= 0.10) interpretation += `<li>${t_page('dupontFactorProfitability')}</li>`;
                else if (npm < 0.05) interpretation += `<li>${t_page('dupontFactorLowProfitability')}</li>`;
            }
            if (isFinite(at)) {
                if (at >= 1.0) interpretation += `<li>${t_page('dupontFactorEfficiency')}</li>`;
                else if (at < 0.5) interpretation += `<li>${t_page('dupontFactorLowEfficiency')}</li>`;
            }
             if (isFinite(em)) {
                if (em > 2.5) interpretation += `<li>${t_page('dupontFactorLeverage')}</li>`;
                else if (em < 1.5) interpretation += `<li>${t_page('dupontFactorLowLeverage')}</li>`;
             }
            
            interpretation += `</ul>`;
            if (interpretation.endsWith('<ul></ul>')) { // Handle cases where no specific factor stood out
                 interpretation = `<p>${lang === 'ar' ? 'ุงูุนูุงูู ูุชูุงุฒูุฉ ุฃู ุงูุจูุงูุงุช ุบูุฑ ูุงููุฉ ูุชูููู ุฏููู.' : 'Factors appear balanced or data insufficient for precise assessment.'}</p>`;
            }
        } else {
             interpretation = `<p class="text-danger">${lang === 'ar' ? 'ูุง ูููู ุญุณุงุจ ุงูุชูุณูุฑ ุจุณุจุจ ููู ุบูุฑ ุตุงูุญุฉ (ูุฏ ูููู ุจุณุจุจ ุญููู ููููุฉ ุตูุฑูุฉ ุฃู ุณุงูุจุฉ).' : 'Interpretation cannot be calculated due to invalid values (possibly zero or negative equity).'}</p>`;
        }
        
        if(UI.dupontInterpretation) UI.dupontInterpretation.innerHTML = interpretation;
    };

    // ==============================================
    // === INITIALIZATION ===
    // ==============================================

    const init = () => {
        // Run analysis initially to get data for all tabs
        runAnalysis(); 

        // Add event listener for Breakeven calculation
        if (UI.calculateBreakeven) {
             UI.calculateBreakeven.addEventListener('click', calculateAndDisplayBreakeven);
        }

        // --- Tab Change Listeners ---
        const ratiosTab = document.getElementById('ratios-tab');
        const breakevenTab = document.getElementById('breakeven-tab');
        const dupontTab = document.getElementById('dupont-tab');

        if (ratiosTab) {
            ratiosTab.addEventListener('shown.bs.tab', () => {
                console.log("Ratios tab shown");
                // Maybe re-run analysis if data could have been updated elsewhere
                // runAnalysis(); 
                // calculateAndDisplayDupont(); // Keep DuPont updated
            });
        }
        if (breakevenTab) {
            breakevenTab.addEventListener('shown.bs.tab', () => {
                console.log("Breakeven tab shown");
                 // Re-render chart maybe if needed
                // if(state.breakevenChart) state.breakevenChart.resize();
            });
        }
         if (dupontTab) {
            dupontTab.addEventListener('shown.bs.tab', () => {
                 console.log("DuPont tab shown");
                 // Ensure analysis data is fresh before displaying DuPont
                 runAnalysis(); // Re-run analysis to get latest financials/ratios
                 calculateAndDisplayDupont(); // Then display DuPont
            });
         }
         
         // Initial calculation for DuPont (will show warning if runAnalysis failed)
         calculateAndDisplayDupont(); 
         
         // Apply translations after initial content rendering
         // Assuming applyTranslations is globally available from main.js
         if (typeof applyTranslations === 'function') {
            applyTranslations();
         }
    };

    // Ensure necessary UI elements exist before running init
    if (UI.smartSummary && UI.fixedCosts && UI.dupontResultsContainer) {
        init();
    } else {
        console.error("One or more critical UI elements for advanced-app.js were not found. Initialization stopped.");
    }
});
