const dashboardTranslations={ar:{pageTitle:"لوحة التحكم — المحلل المالي",pageHeader:"لوحة التحكم المالية",pageSubheader:"نظرة عامة مرئية على أهم مؤشرات الأداء المالي لشركتك.",exportPdf:"تصدير PDF",kpi_netProfit:"صافي الربح (آخر فترة)",kpi_netProfitMargin:"هامش صافي الربح",kpi_currentRatio:"نسبة التداول",kpi_roe:"العائد على حقوق الملكية",kpi_zscore:"مؤشر Z-Score (خطر الإفلاس)",chartProfitTitle:"تحليل الربحية (آخر فترة)",chartStructureTitle:"الهيكل المالي (آخر فترة)",summaryTitle:"ملخص الأداء الذكي (آخر فترة)",alertsTitle:"تنبيهات وملاحظات (آخر فترة)",revenue:"الإيرادات",grossProfit:"مجمل الربح",netProfit:"صافي الربح",assets:"الأصول",liabilities:"الخصوم",equity:"حقوق الملكية",loadingData:"جاري تحميل البيانات...",noData:"لا توجد بيانات قوائم مالية مُجهزة. يرجى تشغيل صفحة 'التقارير' أولاً لإنشاء القوائم.",summary_profit:"أداء جيد. الشركة تحقق ربحية ويمكنها تغطية التزاماتها قصيرة الأجل بشكل مريح.",summary_loss:"يتطلب الانتباه. الشركة تواجه تحديات في الربحية ويجب مراقبة وضع السيولة.",alert_liquidity_risk:"🔴 خطر سيولة: نسبة التداول أقل من 1.",alert_leverage_risk:"🟡 تنبيه: نسبة الدين إلى حقوق الملكية مرتفعة.",alert_profit_risk:"🔴 خطر ربحية: الشركة تحقق صافي خسارة.",alert_ok:"🟢 لا توجد مؤشرات خطر حرجة بناءً على النسب الأساسية.",zscore_safe:"منطقة آمنة",zscore_grey:"منطقة رمادية",zscore_distress:"منطقة الخطر",trend_kpi_netProfit:"صافي الربح (آخر فترة)",trend_kpi_revenue:"الإيرادات (آخر فترة)",trend_kpi_currentRatio:"نسبة التداول (آخر فترة)",chartProfitTrendTitle:"اتجاهات الربحية عبر الفترات",chartRatiosTrendTitle:"اتجاهات النسب الرئيسية عبر الفترات",trend_netProfit:"صافي الربح",trend_revenue:"الإيرادات",trend_currentRatio:"نسبة التداول",trend_netProfitMargin:"هامش صافي الربح",trend_zscore:"مؤشر Z-Score"},en:{pageTitle:"Dashboard — Financial Analyzer",pageHeader:"Financial Dashboard",pageSubheader:"A visual overview of your company's key financial performance indicators.",exportPdf:"Export PDF",kpi_netProfit:"Net Profit (Current)",kpi_netProfitMargin:"Net Profit Margin",kpi_currentRatio:"Current Ratio",kpi_roe:"Return on Equity (ROE)",kpi_zscore:"Z-Score (Bankruptcy Risk)",chartProfitTitle:"Profitability Analysis (Current)",chartStructureTitle:"Financial Structure (Current)",summaryTitle:"Smart Performance Summary (Current)",alertsTitle:"Alerts & Observations (Current)",revenue:"Revenue",grossProfit:"Gross Profit",netProfit:"Net Profit",assets:"Assets",liabilities:"Liabilities",equity:"Equity",loadingData:"Loading data...",noData:"No processed financial statements found. Please run the 'Report' page first to generate statements.",summary_profit:"Good performance. The company is profitable and can comfortably cover its short-term obligations.",summary_loss:"Attention required. The company faces profitability challenges and liquidity should be monitored.",alert_liquidity_risk:"🔴 Liquidity Risk: Current Ratio is below 1.",alert_leverage_risk:"🟡 Warning: Debt to Equity ratio is high.",alert_profit_risk:"🔴 Profitability Risk: The company is reporting a net loss.",alert_ok:"🟢 No critical risk indicators found based on core ratios.",zscore_safe:"Safe Zone",zscore_grey:"Grey Zone",zscore_distress:"Distress Zone",trend_kpi_netProfit:"Net Profit (Current)",trend_kpi_revenue:"Revenue (Current)",trend_kpi_currentRatio:"Current Ratio (Current)",chartProfitTrendTitle:"Profitability Trends Over Periods",chartRatiosTrendTitle:"Key Ratio Trends Over Periods",trend_netProfit:"Net Profit",trend_revenue:"Revenue",trend_currentRatio:"Current Ratio",trend_netProfitMargin:"Net Profit Margin",trend_zscore:"Z-Score"}};window.pageTranslations=window.pageTranslations||{},window.pageTranslations.ar={...window.pageTranslations.ar||{},...dashboardTranslations.ar||{}},window.pageTranslations.en={...window.pageTranslations.en||{},...dashboardTranslations.en||{}},document.addEventListener("DOMContentLoaded",(()=>{setTimeout((()=>{console.log("[DEBUG] Initializing dashboard-app.js after delay...");const e={statementsCurrent:null,statementsPrevious:null,metricsCurrent:null,metricsPrevious:null,charts:{},hasDataCurrent:!1,hasDataPrevious:!1},t=localStorage.getItem("lang")||"ar",r=e=>window.pageTranslations[t]?.[e]||`[${e}]`,a={loadingMessage:document.getElementById("loadingMessage"),singlePeriodView:document.getElementById("singlePeriodView"),gaugeCurrentRatio:document.getElementById("gaugeCurrentRatio")?.getContext("2d"),gaugeNetProfitMargin:document.getElementById("gaugeNetProfitMargin")?.getContext("2d"),gaugeZScore:document.getElementById("gaugeZScore")?.getContext("2d"),gaugeCurrentRatioValue:document.getElementById("gaugeCurrentRatioValue"),gaugeNetProfitMarginValue:document.getElementById("gaugeNetProfitMarginValue"),gaugeZScoreValue:document.getElementById("gaugeZScoreValue"),kpiNetProfitValue:document.getElementById("kpiNetProfitValue"),profitabilityChart:document.getElementById("profitabilityChart")?.getContext("2d"),structureChart:document.getElementById("structureChart")?.getContext("2d"),performanceSummary:document.getElementById("performanceSummary"),alertsArea:document.getElementById("alertsArea"),trendAnalysisView:document.getElementById("trendAnalysisView"),trendNetProfit:document.getElementById("trendNetProfit"),trendRevenue:document.getElementById("trendRevenue"),trendCurrentRatio:document.getElementById("trendCurrentRatio"),profitTrendChart:document.getElementById("profitTrendChart")?.getContext("2d"),ratiosTrendChart:document.getElementById("ratiosTrendChart")?.getContext("2d"),exportPdfBtn:document.getElementById("exportPdfBtn")},i=e=>isFinite(e)&&!isNaN(e)?e.toLocaleString(void 0,{minimumFractionDigits:0,maximumFractionDigits:0}):"N/A",n=e=>{if(!e||!e.totals)return null;const t=e.totals,r=t.totalAssets||0,a=t.totalEquity||0,i=t.totalLiabilities||0,n=t.totalRevenue||0,o=t.netProfit||0,s=t.ebit||0,l=t.workingCapital||0,d=t.retainedEarnings||0,u=t.totalCurrentAssets||0,c=t.totalCurrentLiabilities||0,g=0!==r?l/r:1/0,f=0!==r?d/r:1/0,p=0!==r?s/r:1/0,m=0!==i?a/i:1/0,y=0!==r?n/r:0,P=isFinite(g)&&isFinite(f)&&isFinite(p)&&isFinite(m)&&isFinite(y)?.717*g+.847*f+3.107*p+.42*m+.998*y:NaN,h={revenue:n,grossProfit:t.grossProfit||0,netProfit:o,assets:r,liabilities:i,equity:a,currentRatio:c>0?u/c:1/0,debtToEquity:a>0?i/a:1/0,netProfitMargin:n>0?o/n:0,zScore:P};return console.log("[DEBUG] Dashboard metrics calculated:",h),h},o=(e,t,r,a)=>{const i={datasets:[{data:[t,r-t],backgroundColor:[a.value,a.background],borderColor:[a.value,a.background],borderWidth:1}]};return new Chart(e,{type:"doughnut",data:i,options:{responsive:!0,maintainAspectRatio:!1,circumference:180,rotation:270,cutout:"75%",plugins:{legend:{display:!1},tooltip:{enabled:!1}}}})},s=t=>{const{netProfit:r,netProfitMargin:n,currentRatio:s,zScore:l}=t;if(a.gaugeCurrentRatio){const t=isFinite(s)?s:0,r=3,i=t<1?"#dc3545":t<1.8?"#ffc107":"#198754";e.charts.gaugeCR&&e.charts.gaugeCR.destroy(),e.charts.gaugeCR=o(a.gaugeCurrentRatio,Math.min(t,r),r,{value:i,background:"var(--bs-tertiary-bg)"}),a.gaugeCurrentRatioValue.textContent=isFinite(s)?s.toFixed(2):"N/A",a.gaugeCurrentRatioValue.style.color=i}if(a.gaugeNetProfitMargin){const t=isFinite(n)?n:0,r=.25,i=t<0?"#dc3545":t<.05?"#ffc107":"#198754";e.charts.gaugeNPM&&e.charts.gaugeNPM.destroy(),e.charts.gaugeNPM=o(a.gaugeNetProfitMargin,Math.abs(t),r,{value:i,background:"var(--bs-tertiary-bg)"}),a.gaugeNetProfitMarginValue.textContent=isFinite(n)?`${(100*n).toFixed(1)}%`:"N/A",a.gaugeNetProfitMarginValue.style.color=i}if(a.gaugeZScore){const t=isFinite(l)?l:0,r=4,i=t<1.23?"#dc3545":t<2.9?"#ffc107":"#198754";e.charts.gaugeZ&&e.charts.gaugeZ.destroy(),e.charts.gaugeZ=o(a.gaugeZScore,Math.min(Math.max(t,0),r),r,{value:i,background:"var(--bs-tertiary-bg)"}),a.gaugeZScoreValue.textContent=isFinite(l)?l.toFixed(3):"N/A",a.gaugeZScoreValue.style.color=i}a.kpiNetProfitValue&&(a.kpiNetProfitValue.textContent=i(r),a.kpiNetProfitValue.style.color=r<0?"#dc3545":"#198754")},l=t=>{const{revenue:n,grossProfit:o,netProfit:s,liabilities:l,equity:d}=t;a.profitabilityChart?(e.charts.profitability&&e.charts.profitability.destroy(),e.charts.profitability=new Chart(a.profitabilityChart,{type:"bar",data:{labels:[r("revenue"),r("grossProfit"),r("netProfit")],datasets:[{data:[n,o,s],backgroundColor:["#0d6efd","#6f42c1",s<0?"#dc3545":"#198754"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})):console.error("[DEBUG] profitabilityChart canvas context not found."),a.structureChart?(e.charts.structure&&e.charts.structure.destroy(),e.charts.structure=new Chart(a.structureChart,{type:"doughnut",data:{labels:[r("liabilities"),r("equity")],datasets:[{data:[l,d],backgroundColor:["#ffc107","#20c997"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{callbacks:{label:function(e){let t=e.label||"",r=e.raw||0,a=(r/(e.chart.getDataVisibility(0)?e.chart.getDatasetMeta(0).total:0)*100).toFixed(1)+"%";return`${t}: ${i(r)} (${a})`}}}}}})):console.error("[DEBUG] structureChart canvas context not found.")},d=e=>{if(!a.performanceSummary||!a.alertsArea)return void console.error("[DEBUG] Summary or Alerts elements not found.");const{netProfitMargin:t,currentRatio:i,debtToEquity:n}=e;a.performanceSummary.textContent=r(t>0&&i>1.5?"summary_profit":"summary_loss");const o=[];i<1&&isFinite(i)&&o.push({text:r("alert_liquidity_risk"),class:"list-group-item-danger"}),n>2&&isFinite(n)&&o.push({text:r("alert_leverage_risk"),class:"list-group-item-warning"}),t<0&&isFinite(t)&&o.push({text:r("alert_profit_risk"),class:"list-group-item-danger"}),o.length>0?a.alertsArea.innerHTML=o.map((e=>`<li class="list-group-item ${e.class}">${e.text}</li>`)).join(""):a.alertsArea.innerHTML=`<li class="list-group-item list-group-item-success">${r("alert_ok")}</li>`};console.log("[DEBUG] Bypassing library load wait. Proceeding with dashboard logic..."),"function"==typeof window.applyTranslations?(console.log("[DEBUG] Applying translations (dashboard-app.js)..."),window.applyTranslations()):console.error("[!!! DEBUG !!!] applyTranslations function not found. Check main.js"),(()=>{console.log("[DEBUG] Loading processed data from localStorage...");const t=localStorage.getItem("financialDataCurrent"),r=localStorage.getItem("financialDataPrevious");if(e.hasDataCurrent=!1,e.hasDataPrevious=!1,e.statementsCurrent=null,e.statementsPrevious=null,t)try{e.statementsCurrent=JSON.parse(t),e.statementsCurrent&&e.statementsCurrent.totals?(e.hasDataCurrent=!0,console.log("[DEBUG] Loaded 'financialDataCurrent' successfully.")):console.warn("[DEBUG] 'financialDataCurrent' found but format is invalid.")}catch(e){console.error("Error parsing 'financialDataCurrent':",e)}else console.warn("[DEBUG] 'financialDataCurrent' not found. Run 'Report' page first.");if(r)try{e.statementsPrevious=JSON.parse(r),e.statementsPrevious&&e.statementsPrevious.totals?(e.hasDataPrevious=!0,console.log("[DEBUG] Loaded 'financialDataPrevious' successfully.")):console.warn("[DEBUG] 'financialDataPrevious' found but format is invalid.")}catch(e){console.error("Error parsing 'financialDataPrevious':",e)}else console.warn("[DEBUG] 'financialDataPrevious' not found.");return e.hasDataCurrent})()?(e.metricsCurrent=n(e.statementsCurrent),e.metricsCurrent?(e.hasDataPrevious?(e.metricsPrevious=n(e.statementsPrevious),e.metricsPrevious?(console.log("[DEBUG] Previous data found. Showing Trend Analysis View."),a.loadingMessage&&(a.loadingMessage.style.display="none"),a.singlePeriodView&&(a.singlePeriodView.style.display="none"),a.trendAnalysisView&&(a.trendAnalysisView.style.display="block"),((e,t)=>{const r=e,n=t,o=(e,t)=>{if(!n||!isFinite(e)||!isFinite(t)||0===t)return"";const r=(e-t)/Math.abs(t);return Math.abs(r)<.001?'<span class="ms-2 text-muted small">(0%)</span>':`<span class="ms-2 ${r>0?"text-success":"text-danger"} small"><i class="bi ${r>0?"bi-arrow-up":"bi-arrow-down"}"></i> ${(100*r).toFixed(1)}%</span>`};a.trendNetProfit&&(a.trendNetProfit.innerHTML=`${i(r.netProfit)} ${o(r.netProfit,n?.netProfit)}`,a.trendNetProfit.style.color=r.netProfit<0?"#dc3545":"#198754"),a.trendRevenue&&(a.trendRevenue.innerHTML=`${i(r.revenue)} ${o(r.revenue,n?.revenue)}`),a.trendCurrentRatio&&(a.trendCurrentRatio.innerHTML=`${r.currentRatio.toFixed(2)} ${o(r.currentRatio,n?.currentRatio)}`,a.trendCurrentRatio.style.color=r.currentRatio<1?"#dc3545":"var(--bs-primary-text-emphasis)")})(e.metricsCurrent,e.metricsPrevious),((t,i)=>{const n=[r("thPreviousPeriod"),r("thCurrentPeriod")],o=[i,t];a.profitTrendChart&&(e.charts.profitTrend&&e.charts.profitTrend.destroy(),e.charts.profitTrend=new Chart(a.profitTrendChart,{type:"line",data:{labels:n,datasets:[{label:r("trend_revenue"),data:o.map((e=>e.revenue)),borderColor:"#0d6efd",tension:.1},{label:r("trend_netProfit"),data:o.map((e=>e.netProfit)),borderColor:"#198754",tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1}})),a.ratiosTrendChart&&(e.charts.ratiosTrend&&e.charts.ratiosTrend.destroy(),e.charts.ratiosTrend=new Chart(a.ratiosTrendChart,{type:"line",data:{labels:n,datasets:[{label:r("trend_currentRatio"),data:o.map((e=>e.currentRatio)),borderColor:"#ffc107",tension:.1,yAxisID:"y"},{label:r("trend_netProfitMargin"),data:o.map((e=>e.netProfitMargin)),borderColor:"#6f42c1",tension:.1,yAxisID:"yPercent"},{label:r("trend_zscore"),data:o.map((e=>e.zScore)),borderColor:"#dc3545",tension:.1,yAxisID:"y"}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{type:"linear",display:!0,position:"left",title:{display:!0,text:"Ratio Value"}},yPercent:{type:"linear",display:!0,position:"right",grid:{drawOnChartArea:!1},title:{display:!0,text:"Percentage %"},ticks:{callback:e=>(100*e).toFixed(0)+"%"}}}}}))})(e.metricsCurrent,e.metricsPrevious)):(console.warn("[DEBUG] Previous data found but failed to calculate metrics. Falling back to Single Period View."),e.hasDataPrevious=!1,a.loadingMessage&&(a.loadingMessage.style.display="none"),a.trendAnalysisView&&(a.trendAnalysisView.style.display="none"),a.singlePeriodView&&(a.singlePeriodView.style.display="block"),s(e.metricsCurrent),l(e.metricsCurrent),d(e.metricsCurrent))):(console.log("[DEBUG] Only current data found. Showing Single Period View."),a.loadingMessage&&(a.loadingMessage.style.display="none"),a.trendAnalysisView&&(a.trendAnalysisView.style.display="none"),a.singlePeriodView&&(a.singlePeriodView.style.display="block"),s(e.metricsCurrent),l(e.metricsCurrent),d(e.metricsCurrent)),a.exportPdfBtn?a.exportPdfBtn.addEventListener("click",(()=>{if(!e.hasDataCurrent)return void alert(r("noData"));console.log("Exporting dashboard to PDF...");const t=document.getElementById("dashboard-content");if("function"==typeof html2pdf){const e={margin:[.5,.5,.5,.5],filename:"Dashboard_Report.pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,windowWidth:1400},jsPDF:{unit:"in",format:"letter",orientation:"landscape"}};html2pdf().from(t).set(e).save()}else console.error("html2pdf library is not loaded."),alert("PDF export failed. Library not loaded.")})):console.warn("Export PDF button not found")):(console.error("[DEBUG] Failed to calculate metrics for current period."),a.loadingMessage&&(a.loadingMessage.textContent=r("noData"),a.loadingMessage.classList.remove("alert-warning"),a.loadingMessage.classList.add("alert-danger")))):(console.log("[DEBUG] No processed data found at all."),a.loadingMessage&&(a.loadingMessage.textContent=r("noData"),a.loadingMessage.classList.remove("alert-warning"),a.loadingMessage.classList.add("alert-danger")),a.singlePeriodView&&(a.singlePeriodView.style.display="none"),a.trendAnalysisView&&(a.trendAnalysisView.style.display="none"))}),100)}));
